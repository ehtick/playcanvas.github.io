/**
 * @license
 * PlayCanvas Engine v1.62.0-dev revision 7d088032c (DEBUG PROFILER)
 * Copyright 2011-2023 PlayCanvas Ltd. All rights reserved.
 */
import { TRACEID_RENDER_PASS, TRACEID_RENDER_PASS_DETAIL } from '../core/constants.js';
import { Debug } from '../core/debug.js';
import { Tracing } from '../core/tracing.js';
import { DEVICETYPE_WEBGPU } from '../platform/graphics/constants.js';

/**
 * A frame graph represents a single rendering frame as a sequence of render passes.
 *
 * @ignore
 */
class FrameGraph {
  constructor() {
    this.renderPasses = [];
    this.renderTargetMap = new Map();
  }
  /**
   * Add a render pass to the frame.
   *
   * @param {import('../platform/graphics/render-pass.js').RenderPass} renderPass - The render
   * pass to add.
   */
  addRenderPass(renderPass) {
    this.renderPasses.push(renderPass);
  }
  reset() {
    this.renderPasses.length = 0;
  }
  compile() {
    const renderTargetMap = this.renderTargetMap;
    const renderPasses = this.renderPasses;
    for (let i = 0; i < renderPasses.length; i++) {
      const renderPass = renderPasses[i];
      const renderTarget = renderPass.renderTarget;

      // if using a target, or null which represents the default framebuffer
      if (renderTarget !== undefined) {
        // previous pass using the same render target
        const prevPass = renderTargetMap.get(renderTarget);
        if (prevPass) {
          // if we use the RT without clearing, make sure the previous pass stores data
          if (!renderPass.colorOps.clear) {
            prevPass.colorOps.store = true;
          }
          if (!renderPass.depthStencilOps.clearDepth) {
            prevPass.depthStencilOps.storeDepth = true;
          }
          if (!renderPass.depthStencilOps.clearStencil) {
            prevPass.depthStencilOps.storeStencil = true;
          }
        }

        // add the pass to the map
        renderTargetMap.set(renderTarget, renderPass);
      }
    }

    // Walk over render passes to find passes rendering to the same cubemap texture.
    // If those passes are separated only by passes not requiring cubemap (shadows ..),
    // we skip the mipmap generation till the last rendering to the cubemap, to avoid
    // mipmaps being generated after each face.
    /** @type {import('../platform/graphics/texture.js').Texture} */
    let lastCubeTexture = null;
    /** @type {import('../platform/graphics/render-pass.js').RenderPass} */
    let lastCubeRenderPass = null;
    for (let i = 0; i < renderPasses.length; i++) {
      const renderPass = renderPasses[i];
      const renderTarget = renderPass.renderTarget;
      const thisTexture = renderTarget == null ? void 0 : renderTarget.colorBuffer;
      if (thisTexture != null && thisTexture.cubemap) {
        // if previous pass used the same cubemap texture, it does not need mipmaps generated
        if (lastCubeTexture === thisTexture) {
          lastCubeRenderPass.colorOps.mipmaps = false;
        }
        lastCubeTexture = renderTarget.colorBuffer;
        lastCubeRenderPass = renderPass;
      } else if (renderPass.requiresCubemaps) {
        // if the cubemap is required, break the cubemap rendering chain
        lastCubeTexture = null;
        lastCubeRenderPass = null;
      }
    }

    // handle what's left in the map - last passes rendering to each render target
    renderTargetMap.forEach((renderPass, renderTarget) => {
      // default framebuffer
      if (renderTarget === null) {
        // store the multisampled buffer
        renderPass.colorOps.store = true;

        // no resolve, no mipmaps
        renderPass.colorOps.resolve = false;
        renderPass.colorOps.mipmaps = false;
      }
    });
    renderTargetMap.clear();
  }
  render(device) {
    this.compile();
    const renderPasses = this.renderPasses;
    for (let i = 0; i < renderPasses.length; i++) {
      renderPasses[i].render();
    }
    this.log(device);
  }
  log(device) {
    if (Tracing.get(TRACEID_RENDER_PASS) || Tracing.get(TRACEID_RENDER_PASS_DETAIL)) {
      this.renderPasses.forEach((renderPass, index) => {
        var _rt$colorBuffer, _rt, _rt2, _rt3, _rt4;
        let rt = renderPass.renderTarget;
        if (rt === null && device.deviceType === DEVICETYPE_WEBGPU) {
          rt = device.frameBuffer;
        }
        const hasColor = (_rt$colorBuffer = (_rt = rt) == null ? void 0 : _rt.colorBuffer) != null ? _rt$colorBuffer : (_rt2 = rt) == null ? void 0 : _rt2.impl.assignedColorTexture;
        const hasDepth = (_rt3 = rt) == null ? void 0 : _rt3.depth;
        const hasStencil = (_rt4 = rt) == null ? void 0 : _rt4.stencil;
        const rtInfo = rt === undefined ? '' : ` RT: ${rt ? rt.name : 'NULL'} ` + `${hasColor ? '[Color]' : ''}` + `${hasDepth ? '[Depth]' : ''}` + `${hasStencil ? '[Stencil]' : ''}` + `${renderPass.samples > 0 ? ' samples: ' + renderPass.samples : ''}`;
        Debug.trace(TRACEID_RENDER_PASS, `${index.toString().padEnd(2, ' ')}: ${renderPass.name.padEnd(20, ' ')}` + rtInfo.padEnd(30));
        if (renderPass.colorOps && hasColor) {
          Debug.trace(TRACEID_RENDER_PASS_DETAIL, `    colorOps: ` + `${renderPass.colorOps.clear ? 'clear' : 'load'}->` + `${renderPass.colorOps.store ? 'store' : 'discard'} ` + `${renderPass.colorOps.resolve ? 'resolve ' : ''}` + `${renderPass.colorOps.mipmaps ? 'mipmaps ' : ''}`);
        }
        if (renderPass.depthStencilOps) {
          if (hasDepth) {
            Debug.trace(TRACEID_RENDER_PASS_DETAIL, `    depthOps: ` + `${renderPass.depthStencilOps.clearDepth ? 'clear' : 'load'}->` + `${renderPass.depthStencilOps.storeDepth ? 'store' : 'discard'}`);
          }
          if (hasStencil) {
            Debug.trace(TRACEID_RENDER_PASS_DETAIL, `    stencOps: ` + `${renderPass.depthStencilOps.clearStencil ? 'clear' : 'load'}->` + `${renderPass.depthStencilOps.storeStencil ? 'store' : 'discard'}`);
          }
        }
      });
    }
  }
}

export { FrameGraph };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnJhbWUtZ3JhcGguanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zY2VuZS9mcmFtZS1ncmFwaC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUUkFDRUlEX1JFTkRFUl9QQVNTLCBUUkFDRUlEX1JFTkRFUl9QQVNTX0RFVEFJTCB9IGZyb20gJy4uL2NvcmUvY29uc3RhbnRzLmpzJztcbmltcG9ydCB7IERlYnVnIH0gZnJvbSAnLi4vY29yZS9kZWJ1Zy5qcyc7XG5pbXBvcnQgeyBUcmFjaW5nIH0gZnJvbSAnLi4vY29yZS90cmFjaW5nLmpzJztcbmltcG9ydCB7IERFVklDRVRZUEVfV0VCR1BVIH0gZnJvbSAnLi4vcGxhdGZvcm0vZ3JhcGhpY3MvY29uc3RhbnRzLmpzJztcblxuLyoqXG4gKiBBIGZyYW1lIGdyYXBoIHJlcHJlc2VudHMgYSBzaW5nbGUgcmVuZGVyaW5nIGZyYW1lIGFzIGEgc2VxdWVuY2Ugb2YgcmVuZGVyIHBhc3Nlcy5cbiAqXG4gKiBAaWdub3JlXG4gKi9cbmNsYXNzIEZyYW1lR3JhcGgge1xuICAgIC8qKiBAdHlwZSB7aW1wb3J0KCcuLi9wbGF0Zm9ybS9ncmFwaGljcy9yZW5kZXItcGFzcy5qcycpLlJlbmRlclBhc3NbXX0gKi9cbiAgICByZW5kZXJQYXNzZXMgPSBbXTtcblxuICAgIC8qKlxuICAgICAqIE1hcCB1c2VkIGR1cmluZyBmcmFtZSBncmFwaCBjb21waWxhdGlvbi4gSXQgbWFwcyBhIHJlbmRlciB0YXJnZXQgdG8gaXRzIHByZXZpb3VzIG9jY3VycmVuY2UuXG4gICAgICpcbiAgICAgKiAgQHR5cGUge01hcDxpbXBvcnQoJy4uL3BsYXRmb3JtL2dyYXBoaWNzL3JlbmRlci10YXJnZXQuanMnKS5SZW5kZXJUYXJnZXQsIGltcG9ydCgnLi4vcGxhdGZvcm0vZ3JhcGhpY3MvcmVuZGVyLXBhc3MuanMnKS5SZW5kZXJQYXNzPn1cbiAgICAgKi9cbiAgICByZW5kZXJUYXJnZXRNYXAgPSBuZXcgTWFwKCk7XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSByZW5kZXIgcGFzcyB0byB0aGUgZnJhbWUuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge2ltcG9ydCgnLi4vcGxhdGZvcm0vZ3JhcGhpY3MvcmVuZGVyLXBhc3MuanMnKS5SZW5kZXJQYXNzfSByZW5kZXJQYXNzIC0gVGhlIHJlbmRlclxuICAgICAqIHBhc3MgdG8gYWRkLlxuICAgICAqL1xuICAgIGFkZFJlbmRlclBhc3MocmVuZGVyUGFzcykge1xuICAgICAgICB0aGlzLnJlbmRlclBhc3Nlcy5wdXNoKHJlbmRlclBhc3MpO1xuICAgIH1cblxuICAgIHJlc2V0KCkge1xuICAgICAgICB0aGlzLnJlbmRlclBhc3Nlcy5sZW5ndGggPSAwO1xuICAgIH1cblxuICAgIGNvbXBpbGUoKSB7XG5cbiAgICAgICAgY29uc3QgcmVuZGVyVGFyZ2V0TWFwID0gdGhpcy5yZW5kZXJUYXJnZXRNYXA7XG4gICAgICAgIGNvbnN0IHJlbmRlclBhc3NlcyA9IHRoaXMucmVuZGVyUGFzc2VzO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlbmRlclBhc3Nlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgY29uc3QgcmVuZGVyUGFzcyA9IHJlbmRlclBhc3Nlc1tpXTtcbiAgICAgICAgICAgIGNvbnN0IHJlbmRlclRhcmdldCA9IHJlbmRlclBhc3MucmVuZGVyVGFyZ2V0O1xuXG4gICAgICAgICAgICAvLyBpZiB1c2luZyBhIHRhcmdldCwgb3IgbnVsbCB3aGljaCByZXByZXNlbnRzIHRoZSBkZWZhdWx0IGZyYW1lYnVmZmVyXG4gICAgICAgICAgICBpZiAocmVuZGVyVGFyZ2V0ICE9PSB1bmRlZmluZWQpIHtcblxuICAgICAgICAgICAgICAgIC8vIHByZXZpb3VzIHBhc3MgdXNpbmcgdGhlIHNhbWUgcmVuZGVyIHRhcmdldFxuICAgICAgICAgICAgICAgIGNvbnN0IHByZXZQYXNzID0gcmVuZGVyVGFyZ2V0TWFwLmdldChyZW5kZXJUYXJnZXQpO1xuICAgICAgICAgICAgICAgIGlmIChwcmV2UGFzcykge1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIGlmIHdlIHVzZSB0aGUgUlQgd2l0aG91dCBjbGVhcmluZywgbWFrZSBzdXJlIHRoZSBwcmV2aW91cyBwYXNzIHN0b3JlcyBkYXRhXG4gICAgICAgICAgICAgICAgICAgIGlmICghcmVuZGVyUGFzcy5jb2xvck9wcy5jbGVhcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJldlBhc3MuY29sb3JPcHMuc3RvcmUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICghcmVuZGVyUGFzcy5kZXB0aFN0ZW5jaWxPcHMuY2xlYXJEZXB0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJldlBhc3MuZGVwdGhTdGVuY2lsT3BzLnN0b3JlRGVwdGggPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICghcmVuZGVyUGFzcy5kZXB0aFN0ZW5jaWxPcHMuY2xlYXJTdGVuY2lsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcmV2UGFzcy5kZXB0aFN0ZW5jaWxPcHMuc3RvcmVTdGVuY2lsID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIGFkZCB0aGUgcGFzcyB0byB0aGUgbWFwXG4gICAgICAgICAgICAgICAgcmVuZGVyVGFyZ2V0TWFwLnNldChyZW5kZXJUYXJnZXQsIHJlbmRlclBhc3MpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gV2FsayBvdmVyIHJlbmRlciBwYXNzZXMgdG8gZmluZCBwYXNzZXMgcmVuZGVyaW5nIHRvIHRoZSBzYW1lIGN1YmVtYXAgdGV4dHVyZS5cbiAgICAgICAgLy8gSWYgdGhvc2UgcGFzc2VzIGFyZSBzZXBhcmF0ZWQgb25seSBieSBwYXNzZXMgbm90IHJlcXVpcmluZyBjdWJlbWFwIChzaGFkb3dzIC4uKSxcbiAgICAgICAgLy8gd2Ugc2tpcCB0aGUgbWlwbWFwIGdlbmVyYXRpb24gdGlsbCB0aGUgbGFzdCByZW5kZXJpbmcgdG8gdGhlIGN1YmVtYXAsIHRvIGF2b2lkXG4gICAgICAgIC8vIG1pcG1hcHMgYmVpbmcgZ2VuZXJhdGVkIGFmdGVyIGVhY2ggZmFjZS5cbiAgICAgICAgLyoqIEB0eXBlIHtpbXBvcnQoJy4uL3BsYXRmb3JtL2dyYXBoaWNzL3RleHR1cmUuanMnKS5UZXh0dXJlfSAqL1xuICAgICAgICBsZXQgbGFzdEN1YmVUZXh0dXJlID0gbnVsbDtcbiAgICAgICAgLyoqIEB0eXBlIHtpbXBvcnQoJy4uL3BsYXRmb3JtL2dyYXBoaWNzL3JlbmRlci1wYXNzLmpzJykuUmVuZGVyUGFzc30gKi9cbiAgICAgICAgbGV0IGxhc3RDdWJlUmVuZGVyUGFzcyA9IG51bGw7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmVuZGVyUGFzc2VzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCByZW5kZXJQYXNzID0gcmVuZGVyUGFzc2VzW2ldO1xuICAgICAgICAgICAgY29uc3QgcmVuZGVyVGFyZ2V0ID0gcmVuZGVyUGFzcy5yZW5kZXJUYXJnZXQ7XG4gICAgICAgICAgICBjb25zdCB0aGlzVGV4dHVyZSA9IHJlbmRlclRhcmdldD8uY29sb3JCdWZmZXI7XG5cbiAgICAgICAgICAgIGlmICh0aGlzVGV4dHVyZT8uY3ViZW1hcCkge1xuXG4gICAgICAgICAgICAgICAgLy8gaWYgcHJldmlvdXMgcGFzcyB1c2VkIHRoZSBzYW1lIGN1YmVtYXAgdGV4dHVyZSwgaXQgZG9lcyBub3QgbmVlZCBtaXBtYXBzIGdlbmVyYXRlZFxuICAgICAgICAgICAgICAgIGlmIChsYXN0Q3ViZVRleHR1cmUgPT09IHRoaXNUZXh0dXJlKSB7XG4gICAgICAgICAgICAgICAgICAgIGxhc3RDdWJlUmVuZGVyUGFzcy5jb2xvck9wcy5taXBtYXBzID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgbGFzdEN1YmVUZXh0dXJlID0gcmVuZGVyVGFyZ2V0LmNvbG9yQnVmZmVyO1xuICAgICAgICAgICAgICAgIGxhc3RDdWJlUmVuZGVyUGFzcyA9IHJlbmRlclBhc3M7XG5cbiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVuZGVyUGFzcy5yZXF1aXJlc0N1YmVtYXBzKSB7XG5cbiAgICAgICAgICAgICAgICAvLyBpZiB0aGUgY3ViZW1hcCBpcyByZXF1aXJlZCwgYnJlYWsgdGhlIGN1YmVtYXAgcmVuZGVyaW5nIGNoYWluXG4gICAgICAgICAgICAgICAgbGFzdEN1YmVUZXh0dXJlID0gbnVsbDtcbiAgICAgICAgICAgICAgICBsYXN0Q3ViZVJlbmRlclBhc3MgPSBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gaGFuZGxlIHdoYXQncyBsZWZ0IGluIHRoZSBtYXAgLSBsYXN0IHBhc3NlcyByZW5kZXJpbmcgdG8gZWFjaCByZW5kZXIgdGFyZ2V0XG4gICAgICAgIHJlbmRlclRhcmdldE1hcC5mb3JFYWNoKChyZW5kZXJQYXNzLCByZW5kZXJUYXJnZXQpID0+IHtcblxuICAgICAgICAgICAgLy8gZGVmYXVsdCBmcmFtZWJ1ZmZlclxuICAgICAgICAgICAgaWYgKHJlbmRlclRhcmdldCA9PT0gbnVsbCkge1xuXG4gICAgICAgICAgICAgICAgLy8gc3RvcmUgdGhlIG11bHRpc2FtcGxlZCBidWZmZXJcbiAgICAgICAgICAgICAgICByZW5kZXJQYXNzLmNvbG9yT3BzLnN0b3JlID0gdHJ1ZTtcblxuICAgICAgICAgICAgICAgIC8vIG5vIHJlc29sdmUsIG5vIG1pcG1hcHNcbiAgICAgICAgICAgICAgICByZW5kZXJQYXNzLmNvbG9yT3BzLnJlc29sdmUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICByZW5kZXJQYXNzLmNvbG9yT3BzLm1pcG1hcHMgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmVuZGVyVGFyZ2V0TWFwLmNsZWFyKCk7XG4gICAgfVxuXG4gICAgcmVuZGVyKGRldmljZSkge1xuXG4gICAgICAgIHRoaXMuY29tcGlsZSgpO1xuXG4gICAgICAgIGNvbnN0IHJlbmRlclBhc3NlcyA9IHRoaXMucmVuZGVyUGFzc2VzO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlbmRlclBhc3Nlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgcmVuZGVyUGFzc2VzW2ldLnJlbmRlcigpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5sb2coZGV2aWNlKTtcbiAgICB9XG5cbiAgICBsb2coZGV2aWNlKSB7XG4gICAgICAgIC8vICNpZiBfREVCVUdcbiAgICAgICAgaWYgKFRyYWNpbmcuZ2V0KFRSQUNFSURfUkVOREVSX1BBU1MpIHx8IFRyYWNpbmcuZ2V0KFRSQUNFSURfUkVOREVSX1BBU1NfREVUQUlMKSkge1xuXG4gICAgICAgICAgICB0aGlzLnJlbmRlclBhc3Nlcy5mb3JFYWNoKChyZW5kZXJQYXNzLCBpbmRleCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgbGV0IHJ0ID0gcmVuZGVyUGFzcy5yZW5kZXJUYXJnZXQ7XG4gICAgICAgICAgICAgICAgaWYgKHJ0ID09PSBudWxsICYmIGRldmljZS5kZXZpY2VUeXBlID09PSBERVZJQ0VUWVBFX1dFQkdQVSkge1xuICAgICAgICAgICAgICAgICAgICBydCA9IGRldmljZS5mcmFtZUJ1ZmZlcjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc3QgaGFzQ29sb3IgPSBydD8uY29sb3JCdWZmZXIgPz8gcnQ/LmltcGwuYXNzaWduZWRDb2xvclRleHR1cmU7XG4gICAgICAgICAgICAgICAgY29uc3QgaGFzRGVwdGggPSBydD8uZGVwdGg7XG4gICAgICAgICAgICAgICAgY29uc3QgaGFzU3RlbmNpbCA9IHJ0Py5zdGVuY2lsO1xuICAgICAgICAgICAgICAgIGNvbnN0IHJ0SW5mbyA9IHJ0ID09PSB1bmRlZmluZWQgPyAnJyA6IGAgUlQ6ICR7KHJ0ID8gcnQubmFtZSA6ICdOVUxMJyl9IGAgK1xuICAgICAgICAgICAgICAgICAgICBgJHtoYXNDb2xvciA/ICdbQ29sb3JdJyA6ICcnfWAgK1xuICAgICAgICAgICAgICAgICAgICBgJHtoYXNEZXB0aCA/ICdbRGVwdGhdJyA6ICcnfWAgK1xuICAgICAgICAgICAgICAgICAgICBgJHtoYXNTdGVuY2lsID8gJ1tTdGVuY2lsXScgOiAnJ31gICtcbiAgICAgICAgICAgICAgICAgICAgYCR7KHJlbmRlclBhc3Muc2FtcGxlcyA+IDAgPyAnIHNhbXBsZXM6ICcgKyByZW5kZXJQYXNzLnNhbXBsZXMgOiAnJyl9YDtcblxuICAgICAgICAgICAgICAgIERlYnVnLnRyYWNlKFRSQUNFSURfUkVOREVSX1BBU1MsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYCR7aW5kZXgudG9TdHJpbmcoKS5wYWRFbmQoMiwgJyAnKX06ICR7cmVuZGVyUGFzcy5uYW1lLnBhZEVuZCgyMCwgJyAnKX1gICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBydEluZm8ucGFkRW5kKDMwKSk7XG5cbiAgICAgICAgICAgICAgICBpZiAocmVuZGVyUGFzcy5jb2xvck9wcyAmJiBoYXNDb2xvcikge1xuICAgICAgICAgICAgICAgICAgICBEZWJ1Zy50cmFjZShUUkFDRUlEX1JFTkRFUl9QQVNTX0RFVEFJTCwgYCAgICBjb2xvck9wczogYCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGAke3JlbmRlclBhc3MuY29sb3JPcHMuY2xlYXIgPyAnY2xlYXInIDogJ2xvYWQnfS0+YCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGAke3JlbmRlclBhc3MuY29sb3JPcHMuc3RvcmUgPyAnc3RvcmUnIDogJ2Rpc2NhcmQnfSBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYCR7cmVuZGVyUGFzcy5jb2xvck9wcy5yZXNvbHZlID8gJ3Jlc29sdmUgJyA6ICcnfWAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHtyZW5kZXJQYXNzLmNvbG9yT3BzLm1pcG1hcHMgPyAnbWlwbWFwcyAnIDogJyd9YCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHJlbmRlclBhc3MuZGVwdGhTdGVuY2lsT3BzKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc0RlcHRoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBEZWJ1Zy50cmFjZShUUkFDRUlEX1JFTkRFUl9QQVNTX0RFVEFJTCwgYCAgICBkZXB0aE9wczogYCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHtyZW5kZXJQYXNzLmRlcHRoU3RlbmNpbE9wcy5jbGVhckRlcHRoID8gJ2NsZWFyJyA6ICdsb2FkJ30tPmAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYCR7cmVuZGVyUGFzcy5kZXB0aFN0ZW5jaWxPcHMuc3RvcmVEZXB0aCA/ICdzdG9yZScgOiAnZGlzY2FyZCd9YCk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAoaGFzU3RlbmNpbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgRGVidWcudHJhY2UoVFJBQ0VJRF9SRU5ERVJfUEFTU19ERVRBSUwsIGAgICAgc3RlbmNPcHM6IGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYCR7cmVuZGVyUGFzcy5kZXB0aFN0ZW5jaWxPcHMuY2xlYXJTdGVuY2lsID8gJ2NsZWFyJyA6ICdsb2FkJ30tPmAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYCR7cmVuZGVyUGFzcy5kZXB0aFN0ZW5jaWxPcHMuc3RvcmVTdGVuY2lsID8gJ3N0b3JlJyA6ICdkaXNjYXJkJ31gKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIC8vICNlbmRpZlxuICAgIH1cbn1cblxuZXhwb3J0IHsgRnJhbWVHcmFwaCB9O1xuIl0sIm5hbWVzIjpbIkZyYW1lR3JhcGgiLCJyZW5kZXJQYXNzZXMiLCJyZW5kZXJUYXJnZXRNYXAiLCJNYXAiLCJhZGRSZW5kZXJQYXNzIiwicmVuZGVyUGFzcyIsInB1c2giLCJyZXNldCIsImxlbmd0aCIsImNvbXBpbGUiLCJpIiwicmVuZGVyVGFyZ2V0IiwidW5kZWZpbmVkIiwicHJldlBhc3MiLCJnZXQiLCJjb2xvck9wcyIsImNsZWFyIiwic3RvcmUiLCJkZXB0aFN0ZW5jaWxPcHMiLCJjbGVhckRlcHRoIiwic3RvcmVEZXB0aCIsImNsZWFyU3RlbmNpbCIsInN0b3JlU3RlbmNpbCIsInNldCIsImxhc3RDdWJlVGV4dHVyZSIsImxhc3RDdWJlUmVuZGVyUGFzcyIsInRoaXNUZXh0dXJlIiwiY29sb3JCdWZmZXIiLCJjdWJlbWFwIiwibWlwbWFwcyIsInJlcXVpcmVzQ3ViZW1hcHMiLCJmb3JFYWNoIiwicmVzb2x2ZSIsInJlbmRlciIsImRldmljZSIsImxvZyIsIlRyYWNpbmciLCJUUkFDRUlEX1JFTkRFUl9QQVNTIiwiVFJBQ0VJRF9SRU5ERVJfUEFTU19ERVRBSUwiLCJpbmRleCIsInJ0IiwiZGV2aWNlVHlwZSIsIkRFVklDRVRZUEVfV0VCR1BVIiwiZnJhbWVCdWZmZXIiLCJoYXNDb2xvciIsImltcGwiLCJhc3NpZ25lZENvbG9yVGV4dHVyZSIsImhhc0RlcHRoIiwiZGVwdGgiLCJoYXNTdGVuY2lsIiwic3RlbmNpbCIsInJ0SW5mbyIsIm5hbWUiLCJzYW1wbGVzIiwiRGVidWciLCJ0cmFjZSIsInRvU3RyaW5nIiwicGFkRW5kIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBS0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU1BLFVBQVUsQ0FBQztBQUFBLEVBQUEsV0FBQSxHQUFBO0lBQUEsSUFFYkMsQ0FBQUEsWUFBWSxHQUFH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
