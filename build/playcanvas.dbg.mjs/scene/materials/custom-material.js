import { ShaderProcessorOptions } from '../../platform/graphics/shader-processor-options.js';
import { SHADERDEF_SKIN, SHADERDEF_SCREENSPACE, SHADERDEF_INSTANCING, SHADERDEF_MORPH_POSITION, SHADERDEF_MORPH_NORMAL, SHADERDEF_MORPH_TEXTURE_BASED, MASK_AFFECT_DYNAMIC, LIGHTTYPE_DIRECTIONAL, LIGHTTYPE_OMNI, LIGHTTYPE_SPOT } from '../constants.js';
import { getProgramLibrary } from '../shader-lib/get-program-library.js';
import { LitOptions } from './lit-options.js';
import { collectLights } from './lit-material-common.js';
import { Material } from './material.js';
import { custom } from '../shader-lib/programs/custom.js';

/**
 * A custom material provides a custom front-end part of a lit material
 *
 * @augments Material
 */

class CustomMaterial extends Material {
  /**
   * Create a new custom material instance.
   */
  constructor() {
    super();
    this._litOptions = new LitOptions();
    this._argumentsChunk = "";
  }
  set litOptions(value) {
    this._litOptions = value;
  }
  get litOptions() {
    return this._litOptions;
  }
  set argumentsChunk(value) {
    this._argumentsChunk = value;
  }
  get argumentsChunk() {
    return this._argumentsChunk;
  }
  getShaderVariant(device, scene, objDefs, staticLightList, pass, sortedLights, viewUniformFormat, viewBindGroupFormat, vertexFormat) {
    const options = {
      skin: objDefs && (objDefs & SHADERDEF_SKIN) !== 0,
      screenSpace: objDefs && (objDefs & SHADERDEF_SCREENSPACE) !== 0,
      useInstancing: objDefs && (objDefs & SHADERDEF_INSTANCING) !== 0,
      useMorphPosition: objDefs && (objDefs & SHADERDEF_MORPH_POSITION) !== 0,
      useMorphNormal: objDefs && (objDefs & SHADERDEF_MORPH_NORMAL) !== 0,
      useMorphTextureBased: objDefs && (objDefs & SHADERDEF_MORPH_TEXTURE_BASED) !== 0,
      pass: pass,
      litOptions: this._litOptions
    };
    const lightsFiltered = [];
    const mask = objDefs ? objDefs >> 16 : MASK_AFFECT_DYNAMIC;
    this._litOptions.lightMaskDynamic = !!(mask & MASK_AFFECT_DYNAMIC);
    collectLights(LIGHTTYPE_DIRECTIONAL, sortedLights[LIGHTTYPE_DIRECTIONAL], lightsFiltered, mask);
    collectLights(LIGHTTYPE_OMNI, sortedLights[LIGHTTYPE_OMNI], lightsFiltered, mask, staticLightList);
    collectLights(LIGHTTYPE_SPOT, sortedLights[LIGHTTYPE_SPOT], lightsFiltered, mask, staticLightList);
    this._litOptions.lights = lightsFiltered;
    options.customLitArguments = this._argumentsChunk;
    const processingOptions = new ShaderProcessorOptions(viewUniformFormat, viewBindGroupFormat, vertexFormat);
    const library = getProgramLibrary(device);
    library.register('custom', custom);
    const shader = library.getProgram('custom', options, processingOptions);
    this._dirtyShader = false;
    return shader;
  }
}

export { CustomMaterial };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3VzdG9tLW1hdGVyaWFsLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvc2NlbmUvbWF0ZXJpYWxzL2N1c3RvbS1tYXRlcmlhbC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTaGFkZXJQcm9jZXNzb3JPcHRpb25zIH0gZnJvbSAnLi4vLi4vcGxhdGZvcm0vZ3JhcGhpY3Mvc2hhZGVyLXByb2Nlc3Nvci1vcHRpb25zLmpzJztcbmltcG9ydCB7IExJR0hUVFlQRV9ESVJFQ1RJT05BTCwgTElHSFRUWVBFX09NTkksIExJR0hUVFlQRV9TUE9ULCBNQVNLX0FGRkVDVF9EWU5BTUlDLCBTSEFERVJERUZfSU5TVEFOQ0lORywgU0hBREVSREVGX01PUlBIX05PUk1BTCwgU0hBREVSREVGX01PUlBIX1BPU0lUSU9OLCBTSEFERVJERUZfTU9SUEhfVEVYVFVSRV9CQVNFRCwgU0hBREVSREVGX1NDUkVFTlNQQUNFLCBTSEFERVJERUZfU0tJTiB9IGZyb20gXCIuLi9jb25zdGFudHNcIjtcbmltcG9ydCB7IGdldFByb2dyYW1MaWJyYXJ5IH0gZnJvbSBcIi4uL3NoYWRlci1saWIvZ2V0LXByb2dyYW0tbGlicmFyeVwiO1xuaW1wb3J0IHsgTGl0T3B0aW9ucyB9IGZyb20gXCIuL2xpdC1vcHRpb25zXCI7XG5pbXBvcnQgeyBjb2xsZWN0TGlnaHRzIH0gZnJvbSBcIi4vbGl0LW1hdGVyaWFsLWNvbW1vbi5qc1wiO1xuaW1wb3J0IHsgTWF0ZXJpYWwgfSBmcm9tICcuL21hdGVyaWFsLmpzJztcbmltcG9ydCB7IGN1c3RvbSB9IGZyb20gJy4uL3NoYWRlci1saWIvcHJvZ3JhbXMvY3VzdG9tLmpzJztcblxuLyoqXG4gKiBBIGN1c3RvbSBtYXRlcmlhbCBwcm92aWRlcyBhIGN1c3RvbSBmcm9udC1lbmQgcGFydCBvZiBhIGxpdCBtYXRlcmlhbFxuICpcbiAqIEBhdWdtZW50cyBNYXRlcmlhbFxuICovXG5cblxuY2xhc3MgQ3VzdG9tTWF0ZXJpYWwgZXh0ZW5kcyBNYXRlcmlhbCB7XG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgbmV3IGN1c3RvbSBtYXRlcmlhbCBpbnN0YW5jZS5cbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICB0aGlzLl9saXRPcHRpb25zID0gbmV3IExpdE9wdGlvbnMoKTtcbiAgICAgICAgdGhpcy5fYXJndW1lbnRzQ2h1bmsgPSBcIlwiO1xuICAgIH1cblxuICAgIHNldCBsaXRPcHRpb25zKHZhbHVlKSB7XG4gICAgICAgIHRoaXMuX2xpdE9wdGlvbnMgPSB2YWx1ZTtcbiAgICB9XG5cbiAgICBnZXQgbGl0T3B0aW9ucygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2xpdE9wdGlvbnM7XG4gICAgfVxuXG4gICAgc2V0IGFyZ3VtZW50c0NodW5rKHZhbHVlKSB7XG4gICAgICAgIHRoaXMuX2FyZ3VtZW50c0NodW5rID0gdmFsdWU7XG4gICAgfVxuXG4gICAgZ2V0IGFyZ3VtZW50c0NodW5rKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fYXJndW1lbnRzQ2h1bms7XG4gICAgfVxuXG4gICAgZ2V0U2hhZGVyVmFyaWFudChkZXZpY2UsIHNjZW5lLCBvYmpEZWZzLCBzdGF0aWNMaWdodExpc3QsIHBhc3MsIHNvcnRlZExpZ2h0cywgdmlld1VuaWZvcm1Gb3JtYXQsIHZpZXdCaW5kR3JvdXBGb3JtYXQsIHZlcnRleEZvcm1hdCkge1xuXG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICAgICAgICBza2luOiBvYmpEZWZzICYmIChvYmpEZWZzICYgU0hBREVSREVGX1NLSU4pICE9PSAwLFxuICAgICAgICAgICAgc2NyZWVuU3BhY2U6IG9iakRlZnMgJiYgKG9iakRlZnMgJiBTSEFERVJERUZfU0NSRUVOU1BBQ0UpICE9PSAwLFxuICAgICAgICAgICAgdXNlSW5zdGFuY2luZzogb2JqRGVmcyAmJiAob2JqRGVmcyAmIFNIQURFUkRFRl9JTlNUQU5DSU5HKSAhPT0gMCxcbiAgICAgICAgICAgIHVzZU1vcnBoUG9zaXRpb246IG9iakRlZnMgJiYgKG9iakRlZnMgJiBTSEFERVJERUZfTU9SUEhfUE9TSVRJT04pICE9PSAwLFxuICAgICAgICAgICAgdXNlTW9ycGhOb3JtYWw6IG9iakRlZnMgJiYgKG9iakRlZnMgJiBTSEFERVJERUZfTU9SUEhfTk9STUFMKSAhPT0gMCxcbiAgICAgICAgICAgIHVzZU1vcnBoVGV4dHVyZUJhc2VkOiBvYmpEZWZzICYmIChvYmpEZWZzICYgU0hBREVSREVGX01PUlBIX1RFWFRVUkVfQkFTRUQpICE9PSAwLFxuXG4gICAgICAgICAgICBwYXNzOiBwYXNzLFxuICAgICAgICAgICAgbGl0T3B0aW9uczogdGhpcy5fbGl0T3B0aW9uc1xuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IGxpZ2h0c0ZpbHRlcmVkID0gW107XG4gICAgICAgIGNvbnN0IG1hc2sgPSBvYmpEZWZzID8gKG9iakRlZnMgPj4gMTYpIDogTUFTS19BRkZFQ1RfRFlOQU1JQztcbiAgICAgICAgdGhpcy5fbGl0T3B0aW9ucy5saWdodE1hc2tEeW5hbWljID0gISEobWFzayAmIE1BU0tfQUZGRUNUX0RZTkFNSUMpO1xuXG4gICAgICAgIGNvbGxlY3RMaWdodHMoTElHSFRUWVBFX0RJUkVDVElPTkFMLCBzb3J0ZWRMaWdodHNbTElHSFRUWVBFX0RJUkVDVElPTkFMXSwgbGlnaHRzRmlsdGVyZWQsIG1hc2spO1xuICAgICAgICBjb2xsZWN0TGlnaHRzKExJR0hUVFlQRV9PTU5JLCBzb3J0ZWRMaWdodHNbTElHSFRUWVBFX09NTkldLCBsaWdodHNGaWx0ZXJlZCwgbWFzaywgc3RhdGljTGlnaHRMaXN0KTtcbiAgICAgICAgY29sbGVjdExpZ2h0cyhMSUdIVFRZUEVfU1BPVCwgc29ydGVkTGlnaHRzW0xJR0hUVFlQRV9TUE9UXSwgbGlnaHRzRmlsdGVyZWQsIG1hc2ssIHN0YXRpY0xpZ2h0TGlzdCk7XG5cbiAgICAgICAgdGhpcy5fbGl0T3B0aW9ucy5saWdodHMgPSBsaWdodHNGaWx0ZXJlZDtcbiAgICAgICAgb3B0aW9ucy5jdXN0b21MaXRBcmd1bWVudHMgPSB0aGlzLl9hcmd1bWVudHNDaHVuaztcblxuICAgICAgICBjb25zdCBwcm9jZXNzaW5nT3B0aW9ucyA9IG5ldyBTaGFkZXJQcm9jZXNzb3JPcHRpb25zKHZpZXdVbmlmb3JtRm9ybWF0LCB2aWV3QmluZEdyb3VwRm9ybWF0LCB2ZXJ0ZXhGb3JtYXQpO1xuXG4gICAgICAgIGNvbnN0IGxpYnJhcnkgPSBnZXRQcm9ncmFtTGlicmFyeShkZXZpY2UpO1xuICAgICAgICBsaWJyYXJ5LnJlZ2lzdGVyKCdjdXN0b20nLCBjdXN0b20pO1xuICAgICAgICBjb25zdCBzaGFkZXIgPSBsaWJyYXJ5LmdldFByb2dyYW0oJ2N1c3RvbScsIG9wdGlvbnMsIHByb2Nlc3NpbmdPcHRpb25zKTtcblxuICAgICAgICB0aGlzLl9kaXJ0eVNoYWRlciA9IGZhbHNlO1xuICAgICAgICByZXR1cm4gc2hhZGVyO1xuICAgIH1cbn1cblxuZXhwb3J0IHsgQ3VzdG9tTWF0ZXJpYWwgfTtcbiJdLCJuYW1lcyI6WyJDdXN0b21NYXRlcmlhbCIsIk1hdGVyaWFsIiwiY29uc3RydWN0b3IiLCJfbGl0T3B0aW9ucyIsIkxpdE9wdGlvbnMiLCJfYXJndW1lbnRzQ2h1bmsiLCJsaXRPcHRpb25zIiwidmFsdWUiLCJhcmd1bWVudHNDaHVuayIsImdldFNoYWRlclZhcmlhbnQiLCJkZXZpY2UiLCJzY2VuZSIsIm9iakRlZnMiLCJzdGF0aWNMaWdodExpc3QiLCJwYXNzIiwic29ydGVkTGlnaHRzIiwidmlld1VuaWZvcm1Gb3JtYXQiLCJ2aWV3QmluZEdyb3VwRm9ybWF0IiwidmVydGV4Rm9ybWF0Iiwib3B0aW9ucyIsInNraW4iLCJTSEFERVJERUZfU0tJTiIsInNjcmVlblNwYWNlIiwiU0hBREVSREVGX1NDUkVFTlNQQUNFIiwidXNlSW5zdGFuY2luZyIsIlNIQURFUkRFRl9JTlNUQU5DSU5HIiwidXNlTW9ycGhQb3NpdGlvbiIsIlNIQURFUkRFRl9NT1JQSF9QT1NJVElPTiIsInVzZU1vcnBoTm9ybWFsIiwiU0hBREVSREVGX01PUlBIX05PUk1BTCIsInVzZU1vcnBoVGV4dHVyZUJhc2VkIiwiU0hBREVSREVGX01PUlBIX1RFWFRVUkVfQkFTRUQiLCJsaWdodHNGaWx0ZXJlZCIsIm1hc2siLCJNQVNLX0FGRkVDVF9EWU5BTUlDIiwibGlnaHRNYXNrRHluYW1pYyIsImNvbGxlY3RMaWdodHMiLCJMSUdIVFRZUEVfRElSRUNUSU9OQUwiLCJMSUdIVFRZUEVfT01OSSIsIkxJR0hUVFlQRV9TUE9UIiwibGlnaHRzIiwiY3VzdG9tTGl0QXJndW1lbnRzIiwicHJvY2Vzc2luZ09wdGlvbnMiLCJTaGFkZXJQcm9jZXNzb3JPcHRpb25zIiwibGlicmFyeSIsImdldFByb2dyYW1MaWJyYXJ5IiwicmVnaXN0ZXIiLCJjdXN0b20iLCJzaGFkZXIiLCJnZXRQcm9ncmFtIiwiX2RpcnR5U2hhZGVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQVFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBR0EsTUFBTUEsY0FBYyxTQUFTQyxRQUFRLENBQUM7QUFDbEM7QUFDSjtBQUNBO0FBQ0lDLEVBQUFBLFdBQVdBLEdBQUc7QUFDVixJQUFBLEtBQUssRUFBRSxDQUFBO0FBRVAsSUFBQSxJQUFJLENBQUNDLFdBQVcsR0FBRyxJQUFJQyxVQUFVLEVBQUUsQ0FBQTtJQUNuQyxJQUFJLENBQUNDLGVBQWUsR0FBRyxFQUFFLENBQUE7QUFDN0IsR0FBQTtFQUVBLElBQUlDLFVBQVVBLENBQUNDLEtBQUssRUFBRTtJQUNsQixJQUFJLENBQUNKLFdBQVcsR0FBR0ksS0FBSyxDQUFBO0FBQzVCLEdBQUE7RUFFQSxJQUFJRCxVQUFVQSxHQUFHO0lBQ2IsT0FBTyxJQUFJLENBQUNILFdBQVcsQ0FBQTtBQUMzQixHQUFBO0VBRUEsSUFBSUssY0FBY0EsQ0FBQ0QsS0FBSyxFQUFFO0lBQ3RCLElBQUksQ0FBQ0YsZUFBZSxHQUFHRSxLQUFLLENBQUE7QUFDaEMsR0FBQTtFQUVBLElBQUlDLGNBQWNBLEdBQUc7SUFD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
