/**
 * @license
 * PlayCanvas Engine v1.57.0 revision f1998a31e (DEBUG PROFILER)
 * Copyright 2011-2022 PlayCanvas Ltd. All rights reserved.
 */
import { Vec2 } from '../../math/vec2.js';
import { Vec4 } from '../../math/vec4.js';
import { RenderTarget } from '../../graphics/render-target.js';
import { SHADOW_PCF3, LIGHTTYPE_SPOT, LIGHTTYPE_OMNI } from '../constants.js';
import { CookieRenderer } from '../renderer/cookie-renderer.js';
import { ShadowMap } from '../renderer/shadow-map.js';

const _tempArray = [];
const _tempArray2 = [];

const _viewport = new Vec4();

const _scissor = new Vec4();

class Slot {
  constructor(rect) {
    this.size = Math.floor(rect.w * 1024);
    this.used = false;
    this.lightId = -1;
    this.rect = rect;
  }

}

class LightTextureAtlas {
  constructor(device) {
    this.device = device;
    this.version = 1;
    this.shadowAtlasResolution = 2048;
    this.shadowAtlas = null;
    this.shadowEdgePixels = 3;
    this.cookieAtlasResolution = 2048;
    this.cookieAtlas = null;
    this.cookieRenderTarget = null;
    this.slots = [];
    this.atlasSplit = [];
    this.cubeSlotsOffsets = [new Vec2(0, 0), new Vec2(0, 1), new Vec2(1, 0), new Vec2(1, 1), new Vec2(2, 0), new Vec2(2, 1)];
    this.scissorVec = new Vec4();
    this.allocateShadowAtlas(1);
    this.allocateCookieAtlas(1);
    this.allocateUniforms();
  }

  destroy() {
    this.destroyShadowAtlas();
    this.destroyCookieAtlas();
  }

  destroyShadowAtlas() {
    if (this.shadowAtlas) {
      this.shadowAtlas.destroy();
      this.shadowAtlas = null;
    }
  }

  destroyCookieAtlas() {
    if (this.cookieAtlas) {
      this.cookieAtlas.destroy();
      this.cookieAtlas = null;
    }

    if (this.cookieRenderTarget) {
      this.cookieRenderTarget.destroy();
      this.cookieRenderTarget = null;
    }
  }

  allocateShadowAtlas(resolution) {
    if (!this.shadowAtlas || this.shadowAtlas.texture.width !== resolution) {
      this.version++;
      this.destroyShadowAtlas();
      this.shadowAtlas = ShadowMap.createAtlas(this.device, resolution, SHADOW_PCF3);
      this.shadowAtlas.cached = true;
      const scissorOffset = 4 / this.shadowAtlasResolution;
      this.scissorVec.set(scissorOffset, scissorOffset, -2 * scissorOffset, -2 * scissorOffset);
    }
  }

  allocateCookieAtlas(resolution) {
    if (!this.cookieAtlas || this.cookieAtlas.width !== resolution) {
      this.version++;
      this.destroyCookieAtlas();
      this.cookieAtlas = CookieRenderer.createTexture(this.device, resolution);
      this.cookieRenderTarget = new RenderTarget({
        colorBuffer: this.cookieAtlas,
        depth: false,
        flipY: true
      });
    }
  }

  allocateUniforms() {
    this._shadowAtlasTextureId = this.device.scope.resolve('shadowAtlasTexture');
    this._shadowAtlasParamsId = this.device.scope.resolve('shadowAtlasParams');
    this._shadowAtlasParams = new Float32Array(2);
    this._cookieAtlasTextureId = this.device.scope.resolve('cookieAtlasTexture');
  }

  updateUniforms() {
    const isShadowFilterPcf = true;
    const rt = this.shadowAtlas.renderTargets[0];
    const shadowBuffer = this.device.webgl2 && isShadowFilterPcf ? rt.depthBuffer : rt.colorBuffer;

    this._shadowAtlasTextureId.setValue(shadowBuffer);

    this._shadowAtlasParams[0] = this.shadowAtlasResolution;
    this._shadowAtlasParams[1] = this.shadowEdgePixels;

    this._shadowAtlasParamsId.setValue(this._shadowAtlasParams);

    this._cookieAtlasTextureId.setValue(this.cookieAtlas);
  }

  subdivide(numLights, lightingParams) {
    let atlasSplit = lightingParams.atlasSplit;

    if (!atlasSplit) {
      const gridSize = Math.ceil(Math.sqrt(numLights));
      atlasSplit = _tempArray2;
      atlasSplit[0] = gridSize;
      atlasSplit.length = 1;
    }

    const arraysEqual = (a, b) => a.length === b.length && a.every((v, i) => v === b[i]);

    if (!arraysEqual(atlasSplit, this.atlasSplit)) {
      this.version++;
      this.slots.length = 0;
      this.atlasSplit.length = 0;
      this.atlasSplit.push(...atlasSplit);
      const splitCount = this.atlasSplit[0];

      if (splitCount > 1) {
        const invSize = 1 / splitCount;

        for (let i = 0; i < splitCount; i++) {
          for (let j = 0; j < splitCount; j++) {
            const rect = new Vec4(i * invSize, j * invSize, invSize, invSize);
            const nextLevelSplit = this.atlasSplit[1 + i * splitCount + j];

            if (nextLevelSplit > 1) {
              for (let x = 0; x < nextLevelSplit; x++) {
                for (let y = 0; y < nextLevelSplit; y++) {
                  const invSizeNext = invSize / nextLevelSplit;
                  const rectNext = new Vec4(rect.x + x * invSizeNext, rect.y + y * invSizeNext, invSizeNext, invSizeNext);
                  this.slots.push(new Slot(rectNext));
                }
              }
            } else {
              this.slots.push(new Slot(rect));
            }
          }
        }
      } else {
        this.slots.push(new Slot(new Vec4(0, 0, 1, 1)));
      }

      this.slots.sort((a, b) => {
        return b.size - a.size;
      });
    }
  }

  collectLights(spotLights, omniLights, lightingParams) {
    const cookiesEnabled = lightingParams.cookiesEnabled;
    const shadowsEnabled = lightingParams.shadowsEnabled;
    let needsShadowAtlas = false;
    let needsCookieAtlas = false;
    const lights = _tempArray;
    lights.length = 0;

    const processLights = list => {
      for (let i = 0; i < list.length; i++) {
        const light = list[i];

        if (light.visibleThisFrame) {
          const lightShadow = shadowsEnabled && light.castShadows;
          const lightCookie = cookiesEnabled && !!light.cookie;
          needsShadowAtlas || (needsShadowAtlas = lightShadow);
          needsCookieAtlas || (needsCookieAtlas = lightCookie);

          if (lightShadow || lightCookie) {
            lights.push(light);
          }
        }
      }
    };

    if (cookiesEnabled || shadowsEnabled) {
      processLights(spotLights);
      processLights(omniLights);
    }

    lights.sort((a, b) => {
      return b.maxScreenSize - a.maxScreenSize;
    });

    if (needsShadowAtlas) {
      this.allocateShadowAtlas(this.shadowAtlasResolution);
    }

    if (needsCookieAtlas) {
      this.allocateCookieAtlas(this.cookieAtlasResolution);
    }

    if (needsShadowAtlas || needsCookieAtlas) {
      this.subdivide(lights.length, lightingParams);
    }

    return lights;
  }

  setupSlot(light, rect) {
    light.atlasViewport.copy(rect);
    const faceCount = light.numShadowFaces;

    for (let face = 0; face < faceCount; face++) {
      if (light.castShadows || light._cookie) {
        _viewport.copy(rect);

        _scissor.copy(rect);

        if (light._type === LIGHTTYPE_SPOT) {
          _viewport.add(this.scissorVec);
        }

        if (light._type === LIGHTTYPE_OMNI) {
          const smallSize = _viewport.z / 3;
          const offset = this.cubeSlotsOffsets[face];
          _viewport.x += smallSize * offset.x;
          _viewport.y += smallSize * offset.y;
          _viewport.z = smallSize;
          _viewport.w = smallSize;

          _scissor.copy(_viewport);
        }

        if (light.castShadows) {
          const lightRenderData = light.getRenderData(null, face);
          lightRenderData.shadowViewport.copy(_viewport);
          lightRenderData.shadowScissor.copy(_scissor);
        }
      }
    }
  }

  assignSlot(light, slotIndex, slotReassigned) {
    light.atlasViewportAllocated = true;
    const slot = this.slots[slotIndex];
    slot.lightId = light.id;
    slot.used = true;

    if (slotReassigned) {
      light.atlasSlotUpdated = true;
      light.atlasVersion = this.version;
      light.atlasSlotIndex = slotIndex;
    }
  }

  update(spotLights, omniLights, lightingParams) {
    this.shadowAtlasResolution = lightingParams.shadowAtlasResolution;
    this.cookieAtlasResolution = lightingParams.cookieAtlasResolution;
    const lights = this.collectLights(spotLights, omniLights, lightingParams);

    if (lights.length > 0) {
      const slots = this.slots;

      for (let i = 0; i < slots.length; i++) {
        slots[i].used = false;
      }

      const assignCount = Math.min(lights.length, slots.length);

      for (let i = 0; i < assignCount; i++) {
        const light = lights[i];
        if (light.castShadows) light._shadowMap = this.shadowAtlas;
        const previousSlot = slots[light.atlasSlotIndex];

        if (light.atlasVersion === this.version && light.id === (previousSlot == null ? void 0 : previousSlot.lightId)) {
          const _previousSlot = slots[light.atlasSlotIndex];

          if (_previousSlot.size === slots[i].size && !_previousSlot.used) {
            this.assignSlot(light, light.atlasSlotIndex, false);
          }
        }
      }

      let usedCount = 0;

      for (let i = 0; i < assignCount; i++) {
        while (usedCount < slots.length && slots[usedCount].used) usedCount++;

        const light = lights[i];

        if (!light.atlasViewportAllocated) {
          this.assignSlot(light, usedCount, true);
        }

        const slot = slots[light.atlasSlotIndex];
        this.setupSlot(light, slot.rect);
      }
    }

    this.updateUniforms();
  }

}

export { LightTextureAtlas };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlnaHQtdGV4dHVyZS1hdGxhcy5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3NjZW5lL2xpZ2h0aW5nL2xpZ2h0LXRleHR1cmUtYXRsYXMuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVmVjMiB9IGZyb20gJy4uLy4uL21hdGgvdmVjMi5qcyc7XG5pbXBvcnQgeyBWZWM0IH0gZnJvbSAnLi4vLi4vbWF0aC92ZWM0LmpzJztcblxuaW1wb3J0IHsgUmVuZGVyVGFyZ2V0IH0gZnJvbSAnLi4vLi4vZ3JhcGhpY3MvcmVuZGVyLXRhcmdldC5qcyc7XG5cbmltcG9ydCB7IExJR0hUVFlQRV9PTU5JLCBMSUdIVFRZUEVfU1BPVCwgU0hBRE9XX1BDRjMgfSBmcm9tICcuLi9jb25zdGFudHMuanMnO1xuaW1wb3J0IHsgQ29va2llUmVuZGVyZXIgfSBmcm9tICcuLi9yZW5kZXJlci9jb29raWUtcmVuZGVyZXIuanMnO1xuaW1wb3J0IHsgU2hhZG93TWFwIH0gZnJvbSAnLi4vcmVuZGVyZXIvc2hhZG93LW1hcC5qcyc7XG5cbmNvbnN0IF90ZW1wQXJyYXkgPSBbXTtcbmNvbnN0IF90ZW1wQXJyYXkyID0gW107XG5jb25zdCBfdmlld3BvcnQgPSBuZXcgVmVjNCgpO1xuY29uc3QgX3NjaXNzb3IgPSBuZXcgVmVjNCgpO1xuXG5jbGFzcyBTbG90IHtcbiAgICBjb25zdHJ1Y3RvcihyZWN0KSB7XG4gICAgICAgIHRoaXMuc2l6ZSA9IE1hdGguZmxvb3IocmVjdC53ICogMTAyNCk7ICAvLyBzaXplIG5vcm1hbGl6ZWQgdG8gMTAyNCBhdGxhc1xuICAgICAgICB0aGlzLnVzZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5saWdodElkID0gLTE7ICAvLyBpZCBvZiB0aGUgbGlnaHQgdXNpbmcgdGhlIHNsb3RcbiAgICAgICAgdGhpcy5yZWN0ID0gcmVjdDtcbiAgICB9XG59XG5cbi8vIEEgY2xhc3MgaGFuZGxpbmcgcnVudGltZSBhbGxvY2F0aW9uIG9mIHNsb3RzIGluIGEgdGV4dHVyZS4gSXQgaXMgdXNlZCB0byBhbGxvY2F0ZSBzbG90cyBpbiB0aGUgc2hhZG93IGFuZCBjb29raWUgYXRsYXMuXG5jbGFzcyBMaWdodFRleHR1cmVBdGxhcyB7XG4gICAgY29uc3RydWN0b3IoZGV2aWNlKSB7XG5cbiAgICAgICAgdGhpcy5kZXZpY2UgPSBkZXZpY2U7XG4gICAgICAgIHRoaXMudmVyc2lvbiA9IDE7ICAgLy8gaW5jcmVtZW50ZWQgZWFjaCB0aW1lIHNsb3QgY29uZmlndXJhdGlvbiBjaGFuZ2VzXG5cbiAgICAgICAgdGhpcy5zaGFkb3dBdGxhc1Jlc29sdXRpb24gPSAyMDQ4O1xuICAgICAgICB0aGlzLnNoYWRvd0F0bGFzID0gbnVsbDtcblxuICAgICAgICAvLyBudW1iZXIgb2YgYWRkaXRpb25hbCBwaXhlbHMgdG8gcmVuZGVyIHBhc3QgdGhlIHJlcXVpcmVkIHNoYWRvdyBjYW1lcmEgYW5nbGUgKDkwZGVnIGZvciBvbW5pLCBvdXRlciBmb3Igc3BvdCkgb2YgdGhlIHNoYWRvdyBjYW1lcmEgZm9yIGNsdXN0ZXJlZCBsaWdodHMuXG4gICAgICAgIC8vIFRoaXMgbmVlZHMgdG8gYmUgYSBwaXhlbCBtb3JlIHRoYW4gYSBzaGFkb3cgZmlsdGVyIG5lZWRzIHRvIGFjY2Vzcy5cbiAgICAgICAgdGhpcy5zaGFkb3dFZGdlUGl4ZWxzID0gMztcblxuICAgICAgICB0aGlzLmNvb2tpZUF0bGFzUmVzb2x1dGlvbiA9IDIwNDg7XG4gICAgICAgIHRoaXMuY29va2llQXRsYXMgPSBudWxsO1xuICAgICAgICB0aGlzLmNvb2tpZVJlbmRlclRhcmdldCA9IG51bGw7XG5cbiAgICAgICAgLy8gYXZhaWxhYmxlIHNsb3RzIChvZiB0eXBlIFNsb3QpXG4gICAgICAgIHRoaXMuc2xvdHMgPSBbXTtcblxuICAgICAgICAvLyBjdXJyZW50IHN1YmRpdmlzaW9uIHN0cmF0ZWd5IC0gbWF0Y2hlcyBmb3JtYXQgb2YgTGlnaHRpbmdQYXJhbXMuYXRsYXNTcGxpdFxuICAgICAgICB0aGlzLmF0bGFzU3BsaXQgPSBbXTtcblxuICAgICAgICAvLyBvZmZzZXRzIHRvIGluZGl2aWR1YWwgZmFjZXMgb2YgYSBjdWJlbWFwIGluc2lkZSAzeDMgZ3JpZCBpbiBhbiBhdGxhcyBzbG90XG4gICAgICAgIHRoaXMuY3ViZVNsb3RzT2Zmc2V0cyA9IFtcbiAgICAgICAgICAgIG5ldyBWZWMyKDAsIDApLFxuICAgICAgICAgICAgbmV3IFZlYzIoMCwgMSksXG4gICAgICAgICAgICBuZXcgVmVjMigxLCAwKSxcbiAgICAgICAgICAgIG5ldyBWZWMyKDEsIDEpLFxuICAgICAgICAgICAgbmV3IFZlYzIoMiwgMCksXG4gICAgICAgICAgICBuZXcgVmVjMigyLCAxKVxuICAgICAgICBdO1xuXG4gICAgICAgIC8vIGhhbmRsZXMgZ2FwIGJldHdlZW4gc2xvdHNcbiAgICAgICAgdGhpcy5zY2lzc29yVmVjID0gbmV3IFZlYzQoKTtcblxuICAgICAgICB0aGlzLmFsbG9jYXRlU2hhZG93QXRsYXMoMSk7ICAvLyBwbGFjZWhvbGRlciBhcyBzaGFkZXIgcmVxdWlyZXMgaXRcbiAgICAgICAgdGhpcy5hbGxvY2F0ZUNvb2tpZUF0bGFzKDEpOyAgLy8gcGxhY2Vob2xkZXIgYXMgc2hhZGVyIHJlcXVpcmVzIGl0XG4gICAgICAgIHRoaXMuYWxsb2NhdGVVbmlmb3JtcygpO1xuICAgIH1cblxuICAgIGRlc3Ryb3koKSB7XG4gICAgICAgIHRoaXMuZGVzdHJveVNoYWRvd0F0bGFzKCk7XG4gICAgICAgIHRoaXMuZGVzdHJveUNvb2tpZUF0bGFzKCk7XG4gICAgfVxuXG4gICAgZGVzdHJveVNoYWRvd0F0bGFzKCkge1xuICAgICAgICBpZiAodGhpcy5zaGFkb3dBdGxhcykge1xuICAgICAgICAgICAgdGhpcy5zaGFkb3dBdGxhcy5kZXN0cm95KCk7XG4gICAgICAgICAgICB0aGlzLnNoYWRvd0F0bGFzID0gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGRlc3Ryb3lDb29raWVBdGxhcygpIHtcbiAgICAgICAgaWYgKHRoaXMuY29va2llQXRsYXMpIHtcbiAgICAgICAgICAgIHRoaXMuY29va2llQXRsYXMuZGVzdHJveSgpO1xuICAgICAgICAgICAgdGhpcy5jb29raWVBdGxhcyA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuY29va2llUmVuZGVyVGFyZ2V0KSB7XG4gICAgICAgICAgICB0aGlzLmNvb2tpZVJlbmRlclRhcmdldC5kZXN0cm95KCk7XG4gICAgICAgICAgICB0aGlzLmNvb2tpZVJlbmRlclRhcmdldCA9IG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhbGxvY2F0ZVNoYWRvd0F0bGFzKHJlc29sdXRpb24pIHtcbiAgICAgICAgaWYgKCF0aGlzLnNoYWRvd0F0bGFzIHx8IHRoaXMuc2hhZG93QXRsYXMudGV4dHVyZS53aWR0aCAhPT0gcmVzb2x1dGlvbikge1xuXG4gICAgICAgICAgICAvLyBjb250ZW50IG9mIGF0bGFzIGlzIGxvc3QsIGZvcmNlIHJlLXJlbmRlciBvZiBzdGF0aWMgc2hhZG93c1xuICAgICAgICAgICAgdGhpcy52ZXJzaW9uKys7XG5cbiAgICAgICAgICAgIHRoaXMuZGVzdHJveVNoYWRvd0F0bGFzKCk7XG4gICAgICAgICAgICB0aGlzLnNoYWRvd0F0bGFzID0gU2hhZG93TWFwLmNyZWF0ZUF0bGFzKHRoaXMuZGV2aWNlLCByZXNvbHV0aW9uLCBTSEFET1dfUENGMyk7XG5cbiAgICAgICAgICAgIC8vIGF2b2lkIGl0IGJlaW5nIGRlc3Ryb3llZCBieSBsaWdodHNcbiAgICAgICAgICAgIHRoaXMuc2hhZG93QXRsYXMuY2FjaGVkID0gdHJ1ZTtcblxuICAgICAgICAgICAgLy8gbGVhdmUgZ2FwIGJldHdlZW4gaW5kaXZpZHVhbCB0aWxlcyB0byBhdm9pZCBzaGFkb3cgLyBjb29raWUgc2FtcGxpbmcgb3RoZXIgdGlsZXMgKGVub3VnaCBmb3IgUENGNSlcbiAgICAgICAgICAgIC8vIG5vdGUgdGhhdCB0aGlzIG9ubHkgZmFkZXMgLyByZW1vdmVzIHNoYWRvd3Mgb24gdGhlIGVkZ2VzLCB3aGljaCBpcyBzdGlsbCBub3QgY29ycmVjdCAtIGEgc2hhZGVyIGNsaXBwaW5nIGlzIG5lZWRlZD9cbiAgICAgICAgICAgIGNvbnN0IHNjaXNzb3JPZmZzZXQgPSA0IC8gdGhpcy5zaGFkb3dBdGxhc1Jlc29sdXRpb247XG4gICAgICAgICAgICB0aGlzLnNjaXNzb3JWZWMuc2V0KHNjaXNzb3JPZmZzZXQsIHNjaXNzb3JPZmZzZXQsIC0yICogc2Npc3Nvck9mZnNldCwgLTIgKiBzY2lzc29yT2Zmc2V0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFsbG9jYXRlQ29va2llQXRsYXMocmVzb2x1dGlvbikge1xuICAgICAgICBpZiAoIXRoaXMuY29va2llQXRsYXMgfHwgdGhpcy5jb29raWVBdGxhcy53aWR0aCAhPT0gcmVzb2x1dGlvbikge1xuXG4gICAgICAgICAgICAvLyBjb250ZW50IG9mIGF0bGFzIGlzIGxvc3QsIGZvcmNlIHJlLXJlbmRlciBvZiBzdGF0aWMgY29va2llc1xuICAgICAgICAgICAgdGhpcy52ZXJzaW9uKys7XG5cbiAgICAgICAgICAgIHRoaXMuZGVzdHJveUNvb2tpZUF0bGFzKCk7XG4gICAgICAgICAgICB0aGlzLmNvb2tpZUF0bGFzID0gQ29va2llUmVuZGVyZXIuY3JlYXRlVGV4dHVyZSh0aGlzLmRldmljZSwgcmVzb2x1dGlvbik7XG5cbiAgICAgICAgICAgIHRoaXMuY29va2llUmVuZGVyVGFyZ2V0ID0gbmV3IFJlbmRlclRhcmdldCh7XG4gICAgICAgICAgICAgICAgY29sb3JCdWZmZXI6IHRoaXMuY29va2llQXRsYXMsXG4gICAgICAgICAgICAgICAgZGVwdGg6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGZsaXBZOiB0cnVlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFsbG9jYXRlVW5pZm9ybXMoKSB7XG4gICAgICAgIHRoaXMuX3NoYWRvd0F0bGFzVGV4dHVyZUlkID0gdGhpcy5kZXZpY2Uuc2NvcGUucmVzb2x2ZSgnc2hhZG93QXRsYXNUZXh0dXJlJyk7XG4gICAgICAgIHRoaXMuX3NoYWRvd0F0bGFzUGFyYW1zSWQgPSB0aGlzLmRldmljZS5zY29wZS5yZXNvbHZlKCdzaGFkb3dBdGxhc1BhcmFtcycpO1xuICAgICAgICB0aGlzLl9zaGFkb3dBdGxhc1BhcmFtcyA9IG5ldyBGbG9hdDMyQXJyYXkoMik7XG5cbiAgICAgICAgdGhpcy5fY29va2llQXRsYXNUZXh0dXJlSWQgPSB0aGlzLmRldmljZS5zY29wZS5yZXNvbHZlKCdjb29raWVBdGxhc1RleHR1cmUnKTtcbiAgICB9XG5cbiAgICB1cGRhdGVVbmlmb3JtcygpIHtcblxuICAgICAgICAvLyBzaGFkb3cgYXRsYXMgdGV4dHVyZVxuICAgICAgICBjb25zdCBpc1NoYWRvd0ZpbHRlclBjZiA9IHRydWU7XG4gICAgICAgIGNvbnN0IHJ0ID0gdGhpcy5zaGFkb3dBdGxhcy5yZW5kZXJUYXJnZXRzWzBdO1xuICAgICAgICBjb25zdCBzaGFkb3dCdWZmZXIgPSAodGhpcy5kZXZpY2Uud2ViZ2wyICYmIGlzU2hhZG93RmlsdGVyUGNmKSA/IHJ0LmRlcHRoQnVmZmVyIDogcnQuY29sb3JCdWZmZXI7XG4gICAgICAgIHRoaXMuX3NoYWRvd0F0bGFzVGV4dHVyZUlkLnNldFZhbHVlKHNoYWRvd0J1ZmZlcik7XG5cbiAgICAgICAgLy8gc2hhZG93IGF0bGFzIHBhcmFtc1xuICAgICAgICB0aGlzLl9zaGFkb3dBdGxhc1BhcmFtc1swXSA9IHRoaXMuc2hhZG93QXRsYXNSZXNvbHV0aW9uO1xuICAgICAgICB0aGlzLl9zaGFkb3dBdGxhc1BhcmFtc1sxXSA9IHRoaXMuc2hhZG93RWRnZVBpeGVscztcbiAgICAgICAgdGhpcy5fc2hhZG93QXRsYXNQYXJhbXNJZC5zZXRWYWx1ZSh0aGlzLl9zaGFkb3dBdGxhc1BhcmFtcyk7XG5cbiAgICAgICAgLy8gY29va2llIGF0bGFzIHRleHR1cmVzXG4gICAgICAgIHRoaXMuX2Nvb2tpZUF0bGFzVGV4dHVyZUlkLnNldFZhbHVlKHRoaXMuY29va2llQXRsYXMpO1xuICAgIH1cblxuICAgIHN1YmRpdmlkZShudW1MaWdodHMsIGxpZ2h0aW5nUGFyYW1zKSB7XG5cbiAgICAgICAgbGV0IGF0bGFzU3BsaXQgPSBsaWdodGluZ1BhcmFtcy5hdGxhc1NwbGl0O1xuXG4gICAgICAgIC8vIGlmIG5vIHVzZXIgc3BlY2lmaWVkIHN1YmRpdmlzaW9uXG4gICAgICAgIGlmICghYXRsYXNTcGxpdCkge1xuXG4gICAgICAgICAgICAvLyBzcGxpdCB0byBlcXVhbCBudW1iZXIgb2Ygc3F1YXJlc1xuICAgICAgICAgICAgY29uc3QgZ3JpZFNpemUgPSBNYXRoLmNlaWwoTWF0aC5zcXJ0KG51bUxpZ2h0cykpO1xuICAgICAgICAgICAgYXRsYXNTcGxpdCA9IF90ZW1wQXJyYXkyO1xuICAgICAgICAgICAgYXRsYXNTcGxpdFswXSA9IGdyaWRTaXplO1xuICAgICAgICAgICAgYXRsYXNTcGxpdC5sZW5ndGggPSAxO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gY29tcGFyZSB0d28gYXJyYXlzXG4gICAgICAgIGNvbnN0IGFycmF5c0VxdWFsID0gKGEsIGIpID0+IGEubGVuZ3RoID09PSBiLmxlbmd0aCAmJiBhLmV2ZXJ5KCh2LCBpKSA9PiB2ID09PSBiW2ldKTtcblxuICAgICAgICAvLyBpZiB0aGUgc3BsaXQgaGFzIGNoYW5nZWQsIHJlZ2VuZXJhdGUgc2xvdHNcbiAgICAgICAgaWYgKCFhcnJheXNFcXVhbChhdGxhc1NwbGl0LCB0aGlzLmF0bGFzU3BsaXQpKSB7XG5cbiAgICAgICAgICAgIHRoaXMudmVyc2lvbisrO1xuICAgICAgICAgICAgdGhpcy5zbG90cy5sZW5ndGggPSAwO1xuXG4gICAgICAgICAgICAvLyBzdG9yZSBjdXJyZW50IHNldHRpbmdzXG4gICAgICAgICAgICB0aGlzLmF0bGFzU3BsaXQubGVuZ3RoID0gMDtcbiAgICAgICAgICAgIHRoaXMuYXRsYXNTcGxpdC5wdXNoKC4uLmF0bGFzU3BsaXQpO1xuXG4gICAgICAgICAgICAvLyBnZW5lcmF0ZSB0b3AgbGV2ZWwgc3BsaXRcbiAgICAgICAgICAgIGNvbnN0IHNwbGl0Q291bnQgPSB0aGlzLmF0bGFzU3BsaXRbMF07XG4gICAgICAgICAgICBpZiAoc3BsaXRDb3VudCA+IDEpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBpbnZTaXplID0gMSAvIHNwbGl0Q291bnQ7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzcGxpdENvdW50OyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBzcGxpdENvdW50OyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY3QgPSBuZXcgVmVjNChpICogaW52U2l6ZSwgaiAqIGludlNpemUsIGludlNpemUsIGludlNpemUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV4dExldmVsU3BsaXQgPSB0aGlzLmF0bGFzU3BsaXRbMSArIGkgKiBzcGxpdENvdW50ICsgal07XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIG5lZWQgdG8gc3BsaXQgYWdhaW5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0TGV2ZWxTcGxpdCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCB4ID0gMDsgeCA8IG5leHRMZXZlbFNwbGl0OyB4KyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgeSA9IDA7IHkgPCBuZXh0TGV2ZWxTcGxpdDsgeSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnZTaXplTmV4dCA9IGludlNpemUgLyBuZXh0TGV2ZWxTcGxpdDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY3ROZXh0ID0gbmV3IFZlYzQocmVjdC54ICsgeCAqIGludlNpemVOZXh0LCByZWN0LnkgKyB5ICogaW52U2l6ZU5leHQsIGludlNpemVOZXh0LCBpbnZTaXplTmV4dCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNsb3RzLnB1c2gobmV3IFNsb3QocmVjdE5leHQpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zbG90cy5wdXNoKG5ldyBTbG90KHJlY3QpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gc2luZ2xlIHNsb3RcbiAgICAgICAgICAgICAgICB0aGlzLnNsb3RzLnB1c2gobmV3IFNsb3QobmV3IFZlYzQoMCwgMCwgMSwgMSkpKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gc29ydCBzbG90cyBkZXNjZW5kaW5nXG4gICAgICAgICAgICB0aGlzLnNsb3RzLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gYi5zaXplIC0gYS5zaXplO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb2xsZWN0TGlnaHRzKHNwb3RMaWdodHMsIG9tbmlMaWdodHMsIGxpZ2h0aW5nUGFyYW1zKSB7XG5cbiAgICAgICAgY29uc3QgY29va2llc0VuYWJsZWQgPSBsaWdodGluZ1BhcmFtcy5jb29raWVzRW5hYmxlZDtcbiAgICAgICAgY29uc3Qgc2hhZG93c0VuYWJsZWQgPSBsaWdodGluZ1BhcmFtcy5zaGFkb3dzRW5hYmxlZDtcblxuICAgICAgICAvLyBnZXQgYWxsIGxpZ2h0cyB0aGF0IG5lZWQgc2hhZG93cyBvciBjb29raWVzLCBpZiB0aG9zZSBhcmUgZW5hYmxlZFxuICAgICAgICBsZXQgbmVlZHNTaGFkb3dBdGxhcyA9IGZhbHNlO1xuICAgICAgICBsZXQgbmVlZHNDb29raWVBdGxhcyA9IGZhbHNlO1xuICAgICAgICBjb25zdCBsaWdodHMgPSBfdGVtcEFycmF5O1xuICAgICAgICBsaWdodHMubGVuZ3RoID0gMDtcblxuICAgICAgICBjb25zdCBwcm9jZXNzTGlnaHRzID0gKGxpc3QpID0+IHtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGxpZ2h0ID0gbGlzdFtpXTtcbiAgICAgICAgICAgICAgICBpZiAobGlnaHQudmlzaWJsZVRoaXNGcmFtZSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBsaWdodFNoYWRvdyA9IHNoYWRvd3NFbmFibGVkICYmIGxpZ2h0LmNhc3RTaGFkb3dzO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBsaWdodENvb2tpZSA9IGNvb2tpZXNFbmFibGVkICYmICEhbGlnaHQuY29va2llO1xuXG4gICAgICAgICAgICAgICAgICAgIG5lZWRzU2hhZG93QXRsYXMgfHw9IGxpZ2h0U2hhZG93O1xuICAgICAgICAgICAgICAgICAgICBuZWVkc0Nvb2tpZUF0bGFzIHx8PSBsaWdodENvb2tpZTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAobGlnaHRTaGFkb3cgfHwgbGlnaHRDb29raWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpZ2h0cy5wdXNoKGxpZ2h0KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICBpZiAoY29va2llc0VuYWJsZWQgfHwgc2hhZG93c0VuYWJsZWQpIHtcbiAgICAgICAgICAgIHByb2Nlc3NMaWdodHMoc3BvdExpZ2h0cyk7XG4gICAgICAgICAgICBwcm9jZXNzTGlnaHRzKG9tbmlMaWdodHMpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gc29ydCBsaWdodHMgYnkgbWF4U2NyZWVuU2l6ZSAtIHRvIGhhdmUgdGhlbSBvcmRlcmVkIGJ5IGF0bGFzIHNsb3Qgc2l6ZVxuICAgICAgICBsaWdodHMuc29ydCgoYSwgYikgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGIubWF4U2NyZWVuU2l6ZSAtIGEubWF4U2NyZWVuU2l6ZTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKG5lZWRzU2hhZG93QXRsYXMpIHtcbiAgICAgICAgICAgIHRoaXMuYWxsb2NhdGVTaGFkb3dBdGxhcyh0aGlzLnNoYWRvd0F0bGFzUmVzb2x1dGlvbik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAobmVlZHNDb29raWVBdGxhcykge1xuICAgICAgICAgICAgdGhpcy5hbGxvY2F0ZUNvb2tpZUF0bGFzKHRoaXMuY29va2llQXRsYXNSZXNvbHV0aW9uKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChuZWVkc1NoYWRvd0F0bGFzIHx8IG5lZWRzQ29va2llQXRsYXMpIHtcbiAgICAgICAgICAgIHRoaXMuc3ViZGl2aWRlKGxpZ2h0cy5sZW5ndGgsIGxpZ2h0aW5nUGFyYW1zKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBsaWdodHM7XG4gICAgfVxuXG4gICAgLy8gY29uZmlndXJlIGxpZ2h0IHRvIHVzZSBhc3NpZ25lZCBzbG90XG4gICAgc2V0dXBTbG90KGxpZ2h0LCByZWN0KSB7XG5cbiAgICAgICAgbGlnaHQuYXRsYXNWaWV3cG9ydC5jb3B5KHJlY3QpO1xuXG4gICAgICAgIGNvbnN0IGZhY2VDb3VudCA9IGxpZ2h0Lm51bVNoYWRvd0ZhY2VzO1xuICAgICAgICBmb3IgKGxldCBmYWNlID0gMDsgZmFjZSA8IGZhY2VDb3VudDsgZmFjZSsrKSB7XG5cbiAgICAgICAgICAgIC8vIHNldHVwIHNsb3QgZm9yIHNoYWRvdyBhbmQgY29va2llXG4gICAgICAgICAgICBpZiAobGlnaHQuY2FzdFNoYWRvd3MgfHwgbGlnaHQuX2Nvb2tpZSkge1xuXG4gICAgICAgICAgICAgICAgX3ZpZXdwb3J0LmNvcHkocmVjdCk7XG4gICAgICAgICAgICAgICAgX3NjaXNzb3IuY29weShyZWN0KTtcblxuICAgICAgICAgICAgICAgIC8vIGZvciBzcG90IGxpZ2h0cyBpbiB0aGUgYXRsYXMsIG1ha2Ugdmlld3BvcnQgc2xpZ2h0bHkgc21hbGxlciB0byBhdm9pZCBzYW1wbGluZyBwYXN0IHRoZSBlZGdlc1xuICAgICAgICAgICAgICAgIGlmIChsaWdodC5fdHlwZSA9PT0gTElHSFRUWVBFX1NQT1QpIHtcbiAgICAgICAgICAgICAgICAgICAgX3ZpZXdwb3J0LmFkZCh0aGlzLnNjaXNzb3JWZWMpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIGZvciBjdWJlIG1hcCwgYWxsb2NhdGUgcGFydCBvZiB0aGUgc2xvdFxuICAgICAgICAgICAgICAgIGlmIChsaWdodC5fdHlwZSA9PT0gTElHSFRUWVBFX09NTkkpIHtcblxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzbWFsbFNpemUgPSBfdmlld3BvcnQueiAvIDM7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IHRoaXMuY3ViZVNsb3RzT2Zmc2V0c1tmYWNlXTtcbiAgICAgICAgICAgICAgICAgICAgX3ZpZXdwb3J0LnggKz0gc21hbGxTaXplICogb2Zmc2V0Lng7XG4gICAgICAgICAgICAgICAgICAgIF92aWV3cG9ydC55ICs9IHNtYWxsU2l6ZSAqIG9mZnNldC55O1xuICAgICAgICAgICAgICAgICAgICBfdmlld3BvcnQueiA9IHNtYWxsU2l6ZTtcbiAgICAgICAgICAgICAgICAgICAgX3ZpZXdwb3J0LncgPSBzbWFsbFNpemU7XG5cbiAgICAgICAgICAgICAgICAgICAgX3NjaXNzb3IuY29weShfdmlld3BvcnQpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChsaWdodC5jYXN0U2hhZG93cykge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBsaWdodFJlbmRlckRhdGEgPSBsaWdodC5nZXRSZW5kZXJEYXRhKG51bGwsIGZhY2UpO1xuICAgICAgICAgICAgICAgICAgICBsaWdodFJlbmRlckRhdGEuc2hhZG93Vmlld3BvcnQuY29weShfdmlld3BvcnQpO1xuICAgICAgICAgICAgICAgICAgICBsaWdodFJlbmRlckRhdGEuc2hhZG93U2Npc3Nvci5jb3B5KF9zY2lzc29yKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBhc3NpZ24gYSBzbG90IHRvIHRoZSBsaWdodFxuICAgIGFzc2lnblNsb3QobGlnaHQsIHNsb3RJbmRleCwgc2xvdFJlYXNzaWduZWQpIHtcblxuICAgICAgICBsaWdodC5hdGxhc1ZpZXdwb3J0QWxsb2NhdGVkID0gdHJ1ZTtcblxuICAgICAgICBjb25zdCBzbG90ID0gdGhpcy5zbG90c1tzbG90SW5kZXhdO1xuICAgICAgICBzbG90LmxpZ2h0SWQgPSBsaWdodC5pZDtcbiAgICAgICAgc2xvdC51c2VkID0gdHJ1ZTtcblxuICAgICAgICAvLyBzbG90IGlzIHJlYXNzaWduZWQgKGNvbnRlbnQgbmVlZHMgdG8gYmUgdXBkYXRlZClcbiAgICAgICAgaWYgKHNsb3RSZWFzc2lnbmVkKSB7XG4gICAgICAgICAgICBsaWdodC5hdGxhc1Nsb3RVcGRhdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIGxpZ2h0LmF0bGFzVmVyc2lvbiA9IHRoaXMudmVyc2lvbjtcbiAgICAgICAgICAgIGxpZ2h0LmF0bGFzU2xvdEluZGV4ID0gc2xvdEluZGV4O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gdXBkYXRlIHRleHR1cmUgYXRsYXMgZm9yIGEgbGlzdCBvZiBsaWdodHNcbiAgICB1cGRhdGUoc3BvdExpZ2h0cywgb21uaUxpZ2h0cywgbGlnaHRpbmdQYXJhbXMpIHtcblxuICAgICAgICAvLyB1cGRhdGUgdGV4dHVyZSByZXNvbHV0aW9uc1xuICAgICAgICB0aGlzLnNoYWRvd0F0bGFzUmVzb2x1dGlvbiA9IGxpZ2h0aW5nUGFyYW1zLnNoYWRvd0F0bGFzUmVzb2x1dGlvbjtcbiAgICAgICAgdGhpcy5jb29raWVBdGxhc1Jlc29sdXRpb24gPSBsaWdodGluZ1BhcmFtcy5jb29raWVBdGxhc1Jlc29sdXRpb247XG5cbiAgICAgICAgLy8gY29sbGVjdCBsaWdodHMgcmVxdWlyaW5nIGF0bGFzXG4gICAgICAgIGNvbnN0IGxpZ2h0cyA9IHRoaXMuY29sbGVjdExpZ2h0cyhzcG90TGlnaHRzLCBvbW5pTGlnaHRzLCBsaWdodGluZ1BhcmFtcyk7XG4gICAgICAgIGlmIChsaWdodHMubGVuZ3RoID4gMCkge1xuXG4gICAgICAgICAgICAvLyBtYXJrIGFsbCBzbG90cyBhcyB1bnVzZWRcbiAgICAgICAgICAgIGNvbnN0IHNsb3RzID0gdGhpcy5zbG90cztcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2xvdHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBzbG90c1tpXS51c2VkID0gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIGFzc2lnbiBzbG90cyB0byBsaWdodHNcbiAgICAgICAgICAgIC8vIFRoZSBzbG90IHRvIGxpZ2h0IGFzc2lnbm1lbnQgbG9naWM6XG4gICAgICAgICAgICAvLyAtIGludGVybmFsbHkgdGhlIGF0bGFzIHNsb3RzIGFyZSBzb3J0ZWQgaW4gdGhlIGRlc2NlbmRpbmcgb3JkZXIgKGRvbmUgd2hlbiBhdGxhcyBzcGxpdCBjaGFuZ2VzKVxuICAgICAgICAgICAgLy8gLSBldmVyeSBmcmFtZSBhbGwgdmlzaWJsZSBsaWdodHMgYXJlIHNvcnRlZCBieSB0aGVpciBzY3JlZW4gc3BhY2Ugc2l6ZSAodGhpcyBoYW5kbGVzIGFsbCBjYW1lcmFzIHdoZXJlIGxpZ2h0c1xuICAgICAgICAgICAgLy8gICBhcmUgdmlzaWJsZSB1c2luZyBtYXggdmFsdWUpXG4gICAgICAgICAgICAvLyAtIGFsbCBsaWdodHMgaW4gdGhpcyBvcmRlciBnZXQgYSBzbG90IHNpemUgZnJvbSB0aGUgc2xvdCBsaXN0IGluIHRoZSBzYW1lIG9yZGVyLiBDYXJlIGlzIHRha2VuIHRvIG5vdCByZWFzc2lnblxuICAgICAgICAgICAgLy8gICBzbG90IGlmIHRoZSBzaXplIG9mIGl0IGlzIHRoZSBzYW1lIGFuZCBvbmx5IGluZGV4IGNoYW5nZXMgLSB0aGlzIGlzIGRvbmUgdXNpbmcgdHdvIHBhc3MgYXNzaWdubWVudFxuICAgICAgICAgICAgY29uc3QgYXNzaWduQ291bnQgPSBNYXRoLm1pbihsaWdodHMubGVuZ3RoLCBzbG90cy5sZW5ndGgpO1xuXG4gICAgICAgICAgICAvLyBmaXJzdCBwYXNzIC0gcHJlc2VydmUgYWxsb2NhdGVkIHNsb3RzIGZvciBsaWdodHMgcmVxdWlyaW5nIHNsb3Qgb2YgdGhlIHNhbWUgc2l6ZVxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhc3NpZ25Db3VudDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbGlnaHQgPSBsaWdodHNbaV07XG5cbiAgICAgICAgICAgICAgICBpZiAobGlnaHQuY2FzdFNoYWRvd3MpXG4gICAgICAgICAgICAgICAgICAgIGxpZ2h0Ll9zaGFkb3dNYXAgPSB0aGlzLnNoYWRvd0F0bGFzO1xuXG4gICAgICAgICAgICAgICAgLy8gaWYgY3VycmVudGx5IGFzc2lnbmVkIHNsb3QgaXMgdGhlIHNhbWUgc2l6ZSBhcyB3aGF0IGlzIG5lZWRlZCwgYW5kIHdhcyBsYXN0IHVzZWQgYnkgdGhpcyBsaWdodCwgcmV1c2UgaXRcbiAgICAgICAgICAgICAgICBjb25zdCBwcmV2aW91c1Nsb3QgPSBzbG90c1tsaWdodC5hdGxhc1Nsb3RJbmRleF07XG4gICAgICAgICAgICAgICAgaWYgKGxpZ2h0LmF0bGFzVmVyc2lvbiA9PT0gdGhpcy52ZXJzaW9uICYmIGxpZ2h0LmlkID09PSBwcmV2aW91c1Nsb3Q/LmxpZ2h0SWQpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJldmlvdXNTbG90ID0gc2xvdHNbbGlnaHQuYXRsYXNTbG90SW5kZXhdO1xuICAgICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNTbG90LnNpemUgPT09IHNsb3RzW2ldLnNpemUgJiYgIXByZXZpb3VzU2xvdC51c2VkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFzc2lnblNsb3QobGlnaHQsIGxpZ2h0LmF0bGFzU2xvdEluZGV4LCBmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIHNlY29uZCBwYXNzIC0gYXNzaWduIHNsb3RzIHRvIHVuaGFuZGxlZCBsaWdodHNcbiAgICAgICAgICAgIGxldCB1c2VkQ291bnQgPSAwO1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhc3NpZ25Db3VudDsgaSsrKSB7XG5cbiAgICAgICAgICAgICAgICAvLyBza2lwIGFscmVhZHkgdXNlZCBzbG90c1xuICAgICAgICAgICAgICAgIHdoaWxlICh1c2VkQ291bnQgPCBzbG90cy5sZW5ndGggJiYgc2xvdHNbdXNlZENvdW50XS51c2VkKVxuICAgICAgICAgICAgICAgICAgICB1c2VkQ291bnQrKztcblxuICAgICAgICAgICAgICAgIGNvbnN0IGxpZ2h0ID0gbGlnaHRzW2ldO1xuICAgICAgICAgICAgICAgIGlmICghbGlnaHQuYXRsYXNWaWV3cG9ydEFsbG9jYXRlZCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFzc2lnblNsb3QobGlnaHQsIHVzZWRDb3VudCwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLy8gc2V0IHVwIGFsbCBzbG90c1xuICAgICAgICAgICAgICAgIGNvbnN0IHNsb3QgPSBzbG90c1tsaWdodC5hdGxhc1Nsb3RJbmRleF07XG4gICAgICAgICAgICAgICAgdGhpcy5zZXR1cFNsb3QobGlnaHQsIHNsb3QucmVjdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnVwZGF0ZVVuaWZvcm1zKCk7XG4gICAgfVxufVxuXG5leHBvcnQgeyBMaWdodFRleHR1cmVBdGxhcyB9O1xuIl0sIm5hbWVzIjpbIl90ZW1wQXJyYXkiLCJfdGVtcEFycmF5MiIsIl92aWV3cG9ydCIsIlZlYzQiLCJfc2Npc3NvciIsIlNsb3QiLCJjb25zdHJ1Y3RvciIsInJlY3QiLCJzaXplIiwiTWF0aCIsImZsb29yIiwidyIsInVzZWQiLCJsaWdodElkIiwiTGlnaHRUZXh0dXJlQXRsYXMiLCJkZXZpY2UiLCJ2ZXJzaW9uIiwic2hhZG93QXRsYXNSZXNvbHV0aW9uIiwic2hhZG93QXRsYXMiLCJzaGFkb3dFZGdlUGl4ZWxzIiwiY29va2llQXRsYXNSZXNvbHV0aW9uIiwiY29va2llQXRsYXMiLCJjb29raWVSZW5kZXJUYXJnZXQiLCJzbG90cyIsImF0bGFzU3BsaXQiLCJjdWJlU2xvdHNPZmZzZXRzIiwiVmVjMiIsInNjaXNzb3JWZWMiLCJhbGxvY2F0ZVNoYWRvd0F0bGFzIiwiYWxsb2NhdGVDb29raWVBdGxhcyIsImFsbG9jYXRlVW5pZm9ybXMiLCJkZXN0cm95IiwiZGVzdHJveVNoYWRvd0F0bGFzIiwiZGVzdHJveUNvb2tpZUF0bGFzIiwicmVzb2x1dGlvbiIsInRleHR1cmUiLCJ3aWR0aCIsIlNoYWRvd01hcCIsImNyZWF0ZUF0bGFzIiwiU0hBRE9XX1BDRjMiLCJjYWNoZWQiLCJzY2lzc29yT2Zmc2V0Iiwic2V0IiwiQ29va2llUmVuZGVyZXIiLCJjcmVhdGVUZXh0dXJlIiwiUmVuZGVyVGFyZ2V0IiwiY29sb3JCdWZmZXIiLCJkZXB0aCIsImZsaXBZIiwiX3NoYWRvd0F0bGFzVGV4dHVyZUlkIiwic2NvcGUiLCJyZXNvbHZlIiwiX3NoYWRvd0F0bGFzUGFyYW1zSWQiLCJfc2hhZG93QXRsYXNQYXJhbXMiLCJGbG9hdDMyQXJyYXkiLCJfY29va2llQXRsYXNUZXh0dXJlSWQiLCJ1cGRhdGVVbmlmb3JtcyIsImlzU2hhZG93RmlsdGVyUGNmIiwicnQiLCJyZW5kZXJUYXJnZXRzIiwic2hhZG93QnVmZmVyIiwid2ViZ2wyIiwiZGVwdGhCdWZmZXIiLCJzZXRWYWx1ZSIsInN1YmRpdmlkZSIsIm51bUxpZ2h0cyIsImxpZ2h0aW5nUGFyYW1zIiwiZ3JpZFNpemUiLCJjZWlsIiwic3FydCIsImxlbmd0aCIsImFycmF5c0VxdWFsIiwiYSIsImIiLCJldmVyeSIsInYiLCJpIiwicHVzaCIsInNwbGl0Q291bnQiLCJpbnZTaXplIiwiaiIsIm5leHRMZXZlbFNwbGl0IiwieCIsInkiLCJpbnZTaXplTmV4dCIsInJlY3ROZXh0Iiwic29ydCIsImNvbGxlY3RMaWdodHMiLCJzcG90TGlnaHRzIiwib21uaUxpZ2h0cyIsImNvb2tpZXNFbmFibGVkIiwic2hhZG93c0VuYWJsZWQiLCJuZWVkc1NoYWRvd0F0bGFzIiwibmVlZHNDb29raWVBdGxhcyIsImxpZ2h0cyIsInByb2Nlc3NMaWdodHMiLCJsaXN0IiwibGlnaHQiLCJ2aXNpYmxlVGhpc0ZyYW1lIiwibGlnaHRTaGFkb3ciLCJjYXN0U2hhZG93cyIsImxpZ2h0Q29va2llIiwiY29va2llIiwibWF4U2NyZWVuU2l6ZSIsInNldHVwU2xvdCIsImF0bGFzVmlld3BvcnQiLCJjb3B5IiwiZmFjZUNvdW50IiwibnVtU2hhZG93RmFjZXMiLCJmYWNlIiwiX2Nvb2tpZSIsIl90eXBlIiwiTElHSFRUWVBFX1NQT1QiLCJhZGQiLCJMSUdIVFRZUEVfT01OSSIsInNtYWxsU2l6ZSIsInoiLCJvZmZzZXQiLCJsaWdodFJlbmRlckRhdGEiLCJnZXRSZW5kZXJEYXRhIiwic2hhZG93Vmlld3BvcnQiLCJzaGFkb3dTY2lzc29yIiwiYXNzaWduU2xvdCIsInNsb3RJbmRleCIsInNsb3RSZWFzc2lnbmVkIiwiYXRsYXNWaWV3cG9ydEFsbG9jYXRlZCIsInNsb3QiLCJpZCIsImF0bGFzU2xvdFVwZGF0ZWQiLCJhdGxhc1ZlcnNpb24iLCJhdGxhc1Nsb3RJbmRleCIsInVwZGF0ZSIsImFzc2lnbkNvdW50IiwibWluIiwiX3NoYWRvd01hcCIsInByZXZpb3VzU2xvdCIsInVzZWRDb3VudCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBU0EsTUFBTUEsVUFBVSxHQUFHLEVBQW5CLENBQUE7QUFDQSxNQUFNQyxXQUFXLEdBQUcsRUFBcEIsQ0FBQTs7QUFDQSxNQUFNQyxTQUFTLEdBQUcsSUFBSUMsSUFBSixFQUFsQixDQUFBOztBQUNBLE1BQU1DLFFBQVEsR0FBRyxJQUFJRCxJQUFKLEVBQWpCLENBQUE7O0FBRUEsTUFBTUUsSUFBTixDQUFXO0VBQ1BDLFdBQVcsQ0FBQ0MsSUFBRCxFQUFPO0lBQ2QsSUFBS0MsQ0FBQUEsSUFBTCxHQUFZQyxJQUFJLENBQUNDLEtBQUwsQ0FBV0gsSUFBSSxDQUFDSSxDQUFMLEdBQVMsSUFBcEIsQ0FBWixDQUFBO0lBQ0EsSUFBS0MsQ0FBQUEsSUFBTCxHQUFZLEtBQVosQ0FBQTtJQUNBLElBQUtDLENBQUFBLE9BQUwsR0FBZSxDQUFDLENBQWhCLENBQUE7SUFDQSxJQUFLTixDQUFBQSxJQUFMLEdBQVlBLElBQVosQ0FBQTtBQUNILEdBQUE7O0FBTk0sQ0FBQTs7QUFVWCxNQUFNTyxpQkFBTixDQUF3QjtFQUNwQlIsV0FBVyxDQUFDUyxNQUFELEVBQVM7SUFFaEIsSUFBS0EsQ0FBQUEsTUFBTCxHQUFjQSxNQUFkLENBQUE7SUFDQSxJQUFLQyxDQUFBQSxPQUFMLEdBQWUsQ0FBZixDQUFBO0lBRUEsSUFBS0MsQ0FBQUEscUJBQUwsR0FBNkIsSUFBN0IsQ0FBQTtJQUNBLElBQUtDLENBQUFBLFdBQUwsR0FBbUIsSUFBbkIsQ0FBQTtJQUlBLElBQUtDLENBQUFBLGdCQUFMLEdBQXdCLENBQXhCLENBQUE7SUFFQSxJQUFLQyxDQUFBQSxxQkFBTCxHQUE2QixJQUE3QixDQUFBO0lBQ0EsSUFBS0MsQ0FBQUEsV0FBTCxHQUFtQixJQUFuQixDQUFBO0lBQ0EsSUFBS0MsQ0FBQUEsa0JBQUwsR0FBMEIsSUFBMUIsQ0FBQTtJQUdBLElBQUtDLENBQUFBLEtBQUwsR0FBYSxFQUFiLENBQUE7SUFHQSxJQUFLQyxDQUFBQSxVQUFMLEdBQWtCLEVBQWxCLENBQUE7SUFHQSxJQUFLQyxDQUFBQSxnQkFBTCxHQUF3QixDQUNwQixJQUFJQyxJQUFKLENBQVMsQ0FBVCxFQUFZLENBQVosQ0FEb0IsRUFFcEIsSUFBSUEsSUFBSixDQUFTLENBQVQsRUFBWSxDQUFaLENBRm9CLEVBR3BCLElBQUlBLElBQUosQ0FBUyxDQUFULEVBQVksQ0FBWixDQUhvQixFQUlwQixJQUFJQSxJQUFKLENBQVMsQ0FBVCxFQUFZLENBQVosQ0FKb0IsRUFLcEIsSUFBSUEsSUFBSixDQUFTLENBQVQsRUFBWSxDQUFaLENBTG9CLEVBTXBCLElBQUlBLElBQUosQ0FBUyxDQUFULEVBQVksQ0FBWixDQU5vQixDQUF4QixDQUFBO0FBVUEsSUFBQSxJQUFBLENBQUtDLFVBQUwsR0FBa0IsSUFBSXhCLElBQUosRUFBbEIsQ0FBQTtJQUVBLElBQUt5QixDQUFBQSxtQkFBTCxDQUF5QixDQUF6QixDQUFBLENBQUE7SUFDQSxJQUFLQyxDQUFBQSxtQkFBTCxDQUF5QixDQUF6QixDQUFBLENBQUE7QUFDQSxJQUFBLElBQUEsQ0FBS0MsZ0JBQUwsRUFBQSxDQUFBO0FBQ0gsR0FBQTs7QUFFREMsRUFBQUEsT0FBTyxHQUFHO0FBQ04sSUFBQSxJQUFBLENBQUtDLGtCQUFMLEVBQUEsQ0FBQTtBQUNBLElBQUEsSUFBQSxDQUFLQyxrQkFBTCxFQUFBLENBQUE7QUFDSCxHQUFBOztBQUVERCxFQUFBQSxrQkFBa0IsR0FBRztJQUNqQixJQUFJLElBQUEsQ0FBS2QsV0FBVCxFQUFzQjtNQUNsQixJQUFLQSxDQUFBQSxXQUFMLENBQWlCYSxPQUFqQixFQUFBLENBQUE7TUFDQSxJQUFLYixDQUFBQSxXQUFMLEdBQW1CLElBQW5CLENBQUE7QUFDSCxLQUFBO0FBQ0osR0FBQTs7QUFFRGUsRUFBQUEsa0JBQWtCLEdBQUc7SUFDakIsSUFBSSxJQUFBLENBQUtaLFdBQVQsRUFBc0I7TUFDbEIsSUFBS0EsQ0FBQUEsV0FBTCxDQUFpQlUsT0FBakIsRUFBQSxDQUFBO01BQ0EsSUFBS1YsQ0FBQUEsV0FBTCxHQUFtQixJQUFuQixDQUFBO0FBQ0gsS0FBQTs7SUFDRCxJQUFJLElBQUEsQ0FBS0Msa0JBQVQsRUFBNkI7TUFDekIsSUFBS0EsQ0FBQUEsa0JBQUwsQ0FBd0JTLE9BQXhCLEVBQUEsQ0FBQTtNQUNBLElBQUtULENBQUFBLGtCQUFMLEdBQTBCLElBQTFCLENBQUE7QUFDSCxLQUFBO0FBQ0osR0FBQTs7RUFFRE0sbUJBQW1CLENBQUNNLFVBQUQsRUFBYTtBQUM1QixJQUFBLElBQUksQ0FBQyxJQUFBLENBQUtoQixXQUFOLElBQXFCLElBQUtBLENBQUFBLFdBQUwsQ0FBaUJpQixPQUFqQixDQUF5QkMsS0FBekIsS0FBbUNGLFVBQTVELEVBQXdFO0FBR3BFLE1BQUEsSUFBQSxDQUFLbEIsT0FBTCxFQUFBLENBQUE7QUFFQSxNQUFBLElBQUEsQ0FBS2dCLGtCQUFMLEVBQUEsQ0FBQTtBQUNBLE1BQUEsSUFBQSxDQUFLZCxXQUFMLEdBQW1CbUIsU0FBUyxDQUFDQyxXQUFWLENBQXNCLElBQUt2QixDQUFBQSxNQUEzQixFQUFtQ21CLFVBQW5DLEVBQStDSyxXQUEvQyxDQUFuQixDQUFBO0FBR0EsTUFBQSxJQUFBLENBQUtyQixXQUFMLENBQWlCc0IsTUFBakIsR0FBMEIsSUFBMUIsQ0FBQTtBQUlBLE1BQUEsTUFBTUMsYUFBYSxHQUFHLENBQUksR0FBQSxJQUFBLENBQUt4QixxQkFBL0IsQ0FBQTtBQUNBLE1BQUEsSUFBQSxDQUFLVSxVQUFMLENBQWdCZSxHQUFoQixDQUFvQkQsYUFBcEIsRUFBbUNBLGFBQW5DLEVBQWtELENBQUMsQ0FBRCxHQUFLQSxhQUF2RCxFQUFzRSxDQUFDLENBQUQsR0FBS0EsYUFBM0UsQ0FBQSxDQUFBO0FBQ0gsS0FBQTtBQUNKLEdBQUE7O0VBRURaLG1CQUFtQixDQUFDSyxVQUFELEVBQWE7SUFDNUIsSUFBSSxDQUFDLElBQUtiLENBQUFBLFdBQU4sSUFBcUIsSUFBQSxDQUFLQSxXQUFMLENBQWlCZSxLQUFqQixLQUEyQkYsVUFBcEQsRUFBZ0U7QUFHNUQsTUFBQSxJQUFBLENBQUtsQixPQUFMLEVBQUEsQ0FBQTtBQUVBLE1BQUEsSUFBQSxDQUFLaUIsa0JBQUwsRUFBQSxDQUFBO01BQ0EsSUFBS1osQ0FBQUEsV0FBTCxHQUFtQnNCLGNBQWMsQ0FBQ0MsYUFBZixDQUE2QixJQUFLN0IsQ0FBQUEsTUFBbEMsRUFBMENtQixVQUExQyxDQUFuQixDQUFBO0FBRUEsTUFBQSxJQUFBLENBQUtaLGtCQUFMLEdBQTBCLElBQUl1QixZQUFKLENBQWlCO1FBQ3ZDQyxXQUFXLEVBQUUsS0FBS3pCLFdBRHFCO0FBRXZDMEIsUUFBQUEsS0FBSyxFQUFFLEtBRmdDO0FBR3ZDQyxRQUFBQSxLQUFLLEVBQUUsSUFBQTtBQUhnQyxPQUFqQixDQUExQixDQUFBO0FBS0gsS0FBQTtBQUNKLEdBQUE7O0FBRURsQixFQUFBQSxnQkFBZ0IsR0FBRztJQUNmLElBQUttQixDQUFBQSxxQkFBTCxHQUE2QixJQUFBLENBQUtsQyxNQUFMLENBQVltQyxLQUFaLENBQWtCQyxPQUFsQixDQUEwQixvQkFBMUIsQ0FBN0IsQ0FBQTtJQUNBLElBQUtDLENBQUFBLG9CQUFMLEdBQTRCLElBQUEsQ0FBS3JDLE1BQUwsQ0FBWW1DLEtBQVosQ0FBa0JDLE9BQWxCLENBQTBCLG1CQUExQixDQUE1QixDQUFBO0FBQ0EsSUFBQSxJQUFBLENBQUtFLGtCQUFMLEdBQTBCLElBQUlDLFlBQUosQ0FBaUIsQ0FBakIsQ0FBMUIsQ0FBQTtJQUVBLElBQUtDLENBQUFBLHFCQUFMLEdBQTZCLElBQUEsQ0FBS3hDLE1BQUwsQ0FBWW1DLEtBQVosQ0FBa0JDLE9BQWxCLENBQTBCLG9CQUExQixDQUE3QixDQUFBO0FBQ0gsR0FBQTs7QUFFREssRUFBQUEsY0FBYyxHQUFHO0lBR2IsTUFBTUMsaUJBQWlCLEdBQUcsSUFBMUIsQ0FBQTtJQUNBLE1BQU1DLEVBQUUsR0FBRyxJQUFLeEMsQ0FBQUEsV0FBTCxDQUFpQnlDLGFBQWpCLENBQStCLENBQS9CLENBQVgsQ0FBQTtBQUNBLElBQUEsTUFBTUMsWUFBWSxHQUFJLElBQUs3QyxDQUFBQSxNQUFMLENBQVk4QyxNQUFaLElBQXNCSixpQkFBdkIsR0FBNENDLEVBQUUsQ0FBQ0ksV0FBL0MsR0FBNkRKLEVBQUUsQ0FBQ1osV0FBckYsQ0FBQTs7QUFDQSxJQUFBLElBQUEsQ0FBS0cscUJBQUwsQ0FBMkJjLFFBQTNCLENBQW9DSCxZQUFwQyxDQUFBLENBQUE7O0FBR0EsSUFBQSxJQUFBLENBQUtQLGtCQUFMLENBQXdCLENBQXhCLENBQUEsR0FBNkIsS0FBS3BDLHFCQUFsQyxDQUFBO0FBQ0EsSUFBQSxJQUFBLENBQUtvQyxrQkFBTCxDQUF3QixDQUF4QixDQUFBLEdBQTZCLEtBQUtsQyxnQkFBbEMsQ0FBQTs7QUFDQSxJQUFBLElBQUEsQ0FBS2lDLG9CQUFMLENBQTBCVyxRQUExQixDQUFtQyxLQUFLVixrQkFBeEMsQ0FBQSxDQUFBOztBQUdBLElBQUEsSUFBQSxDQUFLRSxxQkFBTCxDQUEyQlEsUUFBM0IsQ0FBb0MsS0FBSzFDLFdBQXpDLENBQUEsQ0FBQTtBQUNILEdBQUE7O0FBRUQyQyxFQUFBQSxTQUFTLENBQUNDLFNBQUQsRUFBWUMsY0FBWixFQUE0QjtBQUVqQyxJQUFBLElBQUkxQyxVQUFVLEdBQUcwQyxjQUFjLENBQUMxQyxVQUFoQyxDQUFBOztJQUdBLElBQUksQ0FBQ0EsVUFBTCxFQUFpQjtBQUdiLE1BQUEsTUFBTTJDLFFBQVEsR0FBRzFELElBQUksQ0FBQzJELElBQUwsQ0FBVTNELElBQUksQ0FBQzRELElBQUwsQ0FBVUosU0FBVixDQUFWLENBQWpCLENBQUE7QUFDQXpDLE1BQUFBLFVBQVUsR0FBR3ZCLFdBQWIsQ0FBQTtBQUNBdUIsTUFBQUEsVUFBVSxDQUFDLENBQUQsQ0FBVixHQUFnQjJDLFFBQWhCLENBQUE7TUFDQTNDLFVBQVUsQ0FBQzhDLE1BQVgsR0FBb0IsQ0FBcEIsQ0FBQTtBQUNILEtBQUE7O0FBR0QsSUFBQSxNQUFNQyxXQUFXLEdBQUcsQ0FBQ0MsQ0FBRCxFQUFJQyxDQUFKLEtBQVVELENBQUMsQ0FBQ0YsTUFBRixLQUFhRyxDQUFDLENBQUNILE1BQWYsSUFBeUJFLENBQUMsQ0FBQ0UsS0FBRixDQUFRLENBQUNDLENBQUQsRUFBSUMsQ0FBSixLQUFVRCxDQUFDLEtBQUtGLENBQUMsQ0FBQ0csQ0FBRCxDQUF6QixDQUF2RCxDQUFBOztJQUdBLElBQUksQ0FBQ0wsV0FBVyxDQUFDL0MsVUFBRCxFQUFhLElBQUtBLENBQUFBLFVBQWxCLENBQWhCLEVBQStDO0FBRTNDLE1BQUEsSUFBQSxDQUFLUixPQUFMLEVBQUEsQ0FBQTtBQUNBLE1BQUEsSUFBQSxDQUFLTyxLQUFMLENBQVcrQyxNQUFYLEdBQW9CLENBQXBCLENBQUE7QUFHQSxNQUFBLElBQUEsQ0FBSzlDLFVBQUwsQ0FBZ0I4QyxNQUFoQixHQUF5QixDQUF6QixDQUFBO0FBQ0EsTUFBQSxJQUFBLENBQUs5QyxVQUFMLENBQWdCcUQsSUFBaEIsQ0FBcUIsR0FBR3JELFVBQXhCLENBQUEsQ0FBQTtBQUdBLE1BQUEsTUFBTXNELFVBQVUsR0FBRyxJQUFBLENBQUt0RCxVQUFMLENBQWdCLENBQWhCLENBQW5CLENBQUE7O01BQ0EsSUFBSXNELFVBQVUsR0FBRyxDQUFqQixFQUFvQjtRQUNoQixNQUFNQyxPQUFPLEdBQUcsQ0FBQSxHQUFJRCxVQUFwQixDQUFBOztRQUNBLEtBQUssSUFBSUYsQ0FBQyxHQUFHLENBQWIsRUFBZ0JBLENBQUMsR0FBR0UsVUFBcEIsRUFBZ0NGLENBQUMsRUFBakMsRUFBcUM7VUFDakMsS0FBSyxJQUFJSSxDQUFDLEdBQUcsQ0FBYixFQUFnQkEsQ0FBQyxHQUFHRixVQUFwQixFQUFnQ0UsQ0FBQyxFQUFqQyxFQUFxQztBQUNqQyxZQUFBLE1BQU16RSxJQUFJLEdBQUcsSUFBSUosSUFBSixDQUFTeUUsQ0FBQyxHQUFHRyxPQUFiLEVBQXNCQyxDQUFDLEdBQUdELE9BQTFCLEVBQW1DQSxPQUFuQyxFQUE0Q0EsT0FBNUMsQ0FBYixDQUFBO1lBQ0EsTUFBTUUsY0FBYyxHQUFHLElBQUEsQ0FBS3pELFVBQUwsQ0FBZ0IsQ0FBSW9ELEdBQUFBLENBQUMsR0FBR0UsVUFBUixHQUFxQkUsQ0FBckMsQ0FBdkIsQ0FBQTs7WUFHQSxJQUFJQyxjQUFjLEdBQUcsQ0FBckIsRUFBd0I7Y0FDcEIsS0FBSyxJQUFJQyxDQUFDLEdBQUcsQ0FBYixFQUFnQkEsQ0FBQyxHQUFHRCxjQUFwQixFQUFvQ0MsQ0FBQyxFQUFyQyxFQUF5QztnQkFDckMsS0FBSyxJQUFJQyxDQUFDLEdBQUcsQ0FBYixFQUFnQkEsQ0FBQyxHQUFHRixjQUFwQixFQUFvQ0UsQ0FBQyxFQUFyQyxFQUF5QztBQUNyQyxrQkFBQSxNQUFNQyxXQUFXLEdBQUdMLE9BQU8sR0FBR0UsY0FBOUIsQ0FBQTtrQkFDQSxNQUFNSSxRQUFRLEdBQUcsSUFBSWxGLElBQUosQ0FBU0ksSUFBSSxDQUFDMkUsQ0FBTCxHQUFTQSxDQUFDLEdBQUdFLFdBQXRCLEVBQW1DN0UsSUFBSSxDQUFDNEUsQ0FBTCxHQUFTQSxDQUFDLEdBQUdDLFdBQWhELEVBQTZEQSxXQUE3RCxFQUEwRUEsV0FBMUUsQ0FBakIsQ0FBQTtrQkFDQSxJQUFLN0QsQ0FBQUEsS0FBTCxDQUFXc0QsSUFBWCxDQUFnQixJQUFJeEUsSUFBSixDQUFTZ0YsUUFBVCxDQUFoQixDQUFBLENBQUE7QUFDSCxpQkFBQTtBQUNKLGVBQUE7QUFDSixhQVJELE1BUU87Y0FDSCxJQUFLOUQsQ0FBQUEsS0FBTCxDQUFXc0QsSUFBWCxDQUFnQixJQUFJeEUsSUFBSixDQUFTRSxJQUFULENBQWhCLENBQUEsQ0FBQTtBQUNILGFBQUE7QUFDSixXQUFBO0FBQ0osU0FBQTtBQUNKLE9BckJELE1BcUJPO0FBRUgsUUFBQSxJQUFBLENBQUtnQixLQUFMLENBQVdzRCxJQUFYLENBQWdCLElBQUl4RSxJQUFKLENBQVMsSUFBSUYsSUFBSixDQUFTLENBQVQsRUFBWSxDQUFaLEVBQWUsQ0FBZixFQUFrQixDQUFsQixDQUFULENBQWhCLENBQUEsQ0FBQTtBQUNILE9BQUE7O01BR0QsSUFBS29CLENBQUFBLEtBQUwsQ0FBVytELElBQVgsQ0FBZ0IsQ0FBQ2QsQ0FBRCxFQUFJQyxDQUFKLEtBQVU7QUFDdEIsUUFBQSxPQUFPQSxDQUFDLENBQUNqRSxJQUFGLEdBQVNnRSxDQUFDLENBQUNoRSxJQUFsQixDQUFBO09BREosQ0FBQSxDQUFBO0FBR0gsS0FBQTtBQUNKLEdBQUE7O0FBRUQrRSxFQUFBQSxhQUFhLENBQUNDLFVBQUQsRUFBYUMsVUFBYixFQUF5QnZCLGNBQXpCLEVBQXlDO0FBRWxELElBQUEsTUFBTXdCLGNBQWMsR0FBR3hCLGNBQWMsQ0FBQ3dCLGNBQXRDLENBQUE7QUFDQSxJQUFBLE1BQU1DLGNBQWMsR0FBR3pCLGNBQWMsQ0FBQ3lCLGNBQXRDLENBQUE7SUFHQSxJQUFJQyxnQkFBZ0IsR0FBRyxLQUF2QixDQUFBO0lBQ0EsSUFBSUMsZ0JBQWdCLEdBQUcsS0FBdkIsQ0FBQTtJQUNBLE1BQU1DLE1BQU0sR0FBRzlGLFVBQWYsQ0FBQTtJQUNBOEYsTUFBTSxDQUFDeEIsTUFBUCxHQUFnQixDQUFoQixDQUFBOztJQUVBLE1BQU15QixhQUFhLEdBQUlDLElBQUQsSUFBVTtBQUM1QixNQUFBLEtBQUssSUFBSXBCLENBQUMsR0FBRyxDQUFiLEVBQWdCQSxDQUFDLEdBQUdvQixJQUFJLENBQUMxQixNQUF6QixFQUFpQ00sQ0FBQyxFQUFsQyxFQUFzQztBQUNsQyxRQUFBLE1BQU1xQixLQUFLLEdBQUdELElBQUksQ0FBQ3BCLENBQUQsQ0FBbEIsQ0FBQTs7UUFDQSxJQUFJcUIsS0FBSyxDQUFDQyxnQkFBVixFQUE0QjtBQUN4QixVQUFBLE1BQU1DLFdBQVcsR0FBR1IsY0FBYyxJQUFJTSxLQUFLLENBQUNHLFdBQTVDLENBQUE7VUFDQSxNQUFNQyxXQUFXLEdBQUdYLGNBQWMsSUFBSSxDQUFDLENBQUNPLEtBQUssQ0FBQ0ssTUFBOUMsQ0FBQTtBQUVBVixVQUFBQSxnQkFBZ0IsS0FBaEJBLGdCQUFnQixHQUFLTyxXQUFMLENBQWhCLENBQUE7QUFDQU4sVUFBQUEsZ0JBQWdCLEtBQWhCQSxnQkFBZ0IsR0FBS1EsV0FBTCxDQUFoQixDQUFBOztVQUVBLElBQUlGLFdBQVcsSUFBSUUsV0FBbkIsRUFBZ0M7WUFDNUJQLE1BQU0sQ0FBQ2pCLElBQVAsQ0FBWW9CLEtBQVosQ0FBQSxDQUFBO0FBQ0gsV0FBQTtBQUNKLFNBQUE7QUFDSixPQUFBO0tBZEwsQ0FBQTs7SUFpQkEsSUFBSVAsY0FBYyxJQUFJQyxjQUF0QixFQUFzQztNQUNsQ0ksYUFBYSxDQUFDUCxVQUFELENBQWIsQ0FBQTtNQUNBTyxhQUFhLENBQUNOLFVBQUQsQ0FBYixDQUFBO0FBQ0gsS0FBQTs7QUFHREssSUFBQUEsTUFBTSxDQUFDUixJQUFQLENBQVksQ0FBQ2QsQ0FBRCxFQUFJQyxDQUFKLEtBQVU7QUFDbEIsTUFBQSxPQUFPQSxDQUFDLENBQUM4QixhQUFGLEdBQWtCL0IsQ0FBQyxDQUFDK0IsYUFBM0IsQ0FBQTtLQURKLENBQUEsQ0FBQTs7QUFJQSxJQUFBLElBQUlYLGdCQUFKLEVBQXNCO01BQ2xCLElBQUtoRSxDQUFBQSxtQkFBTCxDQUF5QixJQUFBLENBQUtYLHFCQUE5QixDQUFBLENBQUE7QUFDSCxLQUFBOztBQUVELElBQUEsSUFBSTRFLGdCQUFKLEVBQXNCO01BQ2xCLElBQUtoRSxDQUFBQSxtQkFBTCxDQUF5QixJQUFBLENBQUtULHFCQUE5QixDQUFBLENBQUE7QUFDSCxLQUFBOztJQUVELElBQUl3RSxnQkFBZ0IsSUFBSUMsZ0JBQXhCLEVBQTBDO0FBQ3RDLE1BQUEsSUFBQSxDQUFLN0IsU0FBTCxDQUFlOEIsTUFBTSxDQUFDeEIsTUFBdEIsRUFBOEJKLGNBQTlCLENBQUEsQ0FBQTtBQUNILEtBQUE7O0FBRUQsSUFBQSxPQUFPNEIsTUFBUCxDQUFBO0FBQ0gsR0FBQTs7QUFHRFUsRUFBQUEsU0FBUyxDQUFDUCxLQUFELEVBQVExRixJQUFSLEVBQWM7QUFFbkIwRixJQUFBQSxLQUFLLENBQUNRLGFBQU4sQ0FBb0JDLElBQXBCLENBQXlCbkcsSUFBekIsQ0FBQSxDQUFBO0FBRUEsSUFBQSxNQUFNb0csU0FBUyxHQUFHVixLQUFLLENBQUNXLGNBQXhCLENBQUE7O0lBQ0EsS0FBSyxJQUFJQyxJQUFJLEdBQUcsQ0FBaEIsRUFBbUJBLElBQUksR0FBR0YsU0FBMUIsRUFBcUNFLElBQUksRUFBekMsRUFBNkM7QUFHekMsTUFBQSxJQUFJWixLQUFLLENBQUNHLFdBQU4sSUFBcUJILEtBQUssQ0FBQ2EsT0FBL0IsRUFBd0M7UUFFcEM1RyxTQUFTLENBQUN3RyxJQUFWLENBQWVuRyxJQUFmLENBQUEsQ0FBQTs7UUFDQUgsUUFBUSxDQUFDc0csSUFBVCxDQUFjbkcsSUFBZCxDQUFBLENBQUE7O0FBR0EsUUFBQSxJQUFJMEYsS0FBSyxDQUFDYyxLQUFOLEtBQWdCQyxjQUFwQixFQUFvQztBQUNoQzlHLFVBQUFBLFNBQVMsQ0FBQytHLEdBQVYsQ0FBYyxJQUFBLENBQUt0RixVQUFuQixDQUFBLENBQUE7QUFDSCxTQUFBOztBQUdELFFBQUEsSUFBSXNFLEtBQUssQ0FBQ2MsS0FBTixLQUFnQkcsY0FBcEIsRUFBb0M7QUFFaEMsVUFBQSxNQUFNQyxTQUFTLEdBQUdqSCxTQUFTLENBQUNrSCxDQUFWLEdBQWMsQ0FBaEMsQ0FBQTtBQUNBLFVBQUEsTUFBTUMsTUFBTSxHQUFHLElBQUEsQ0FBSzVGLGdCQUFMLENBQXNCb0YsSUFBdEIsQ0FBZixDQUFBO0FBQ0EzRyxVQUFBQSxTQUFTLENBQUNnRixDQUFWLElBQWVpQyxTQUFTLEdBQUdFLE1BQU0sQ0FBQ25DLENBQWxDLENBQUE7QUFDQWhGLFVBQUFBLFNBQVMsQ0FBQ2lGLENBQVYsSUFBZWdDLFNBQVMsR0FBR0UsTUFBTSxDQUFDbEMsQ0FBbEMsQ0FBQTtVQUNBakYsU0FBUyxDQUFDa0gsQ0FBVixHQUFjRCxTQUFkLENBQUE7VUFDQWpILFNBQVMsQ0FBQ1MsQ0FBVixHQUFjd0csU0FBZCxDQUFBOztVQUVBL0csUUFBUSxDQUFDc0csSUFBVCxDQUFjeEcsU0FBZCxDQUFBLENBQUE7QUFDSCxTQUFBOztRQUVELElBQUkrRixLQUFLLENBQUNHLFdBQVYsRUFBdUI7VUFDbkIsTUFBTWtCLGVBQWUsR0FBR3JCLEtBQUssQ0FBQ3NCLGFBQU4sQ0FBb0IsSUFBcEIsRUFBMEJWLElBQTFCLENBQXhCLENBQUE7QUFDQVMsVUFBQUEsZUFBZSxDQUFDRSxjQUFoQixDQUErQmQsSUFBL0IsQ0FBb0N4RyxTQUFwQyxDQUFBLENBQUE7QUFDQW9ILFVBQUFBLGVBQWUsQ0FBQ0csYUFBaEIsQ0FBOEJmLElBQTlCLENBQW1DdEcsUUFBbkMsQ0FBQSxDQUFBO0FBQ0gsU0FBQTtBQUNKLE9BQUE7QUFDSixLQUFBO0FBQ0osR0FBQTs7QUFHRHNILEVBQUFBLFVBQVUsQ0FBQ3pCLEtBQUQsRUFBUTBCLFNBQVIsRUFBbUJDLGNBQW5CLEVBQW1DO0lBRXpDM0IsS0FBSyxDQUFDNEIsc0JBQU4sR0FBK0IsSUFBL0IsQ0FBQTtBQUVBLElBQUEsTUFBTUMsSUFBSSxHQUFHLElBQUEsQ0FBS3ZHLEtBQUwsQ0FBV29HLFNBQVgsQ0FBYixDQUFBO0FBQ0FHLElBQUFBLElBQUksQ0FBQ2pILE9BQUwsR0FBZW9GLEtBQUssQ0FBQzhCLEVBQXJCLENBQUE7SUFDQUQsSUFBSSxDQUFDbEgsSUFBTCxHQUFZLElBQVosQ0FBQTs7QUFHQSxJQUFBLElBQUlnSCxjQUFKLEVBQW9CO01BQ2hCM0IsS0FBSyxDQUFDK0IsZ0JBQU4sR0FBeUIsSUFBekIsQ0FBQTtBQUNBL0IsTUFBQUEsS0FBSyxDQUFDZ0MsWUFBTixHQUFxQixJQUFBLENBQUtqSCxPQUExQixDQUFBO01BQ0FpRixLQUFLLENBQUNpQyxjQUFOLEdBQXVCUCxTQUF2QixDQUFBO0FBQ0gsS0FBQTtBQUNKLEdBQUE7O0FBR0RRLEVBQUFBLE1BQU0sQ0FBQzNDLFVBQUQsRUFBYUMsVUFBYixFQUF5QnZCLGNBQXpCLEVBQXlDO0FBRzNDLElBQUEsSUFBQSxDQUFLakQscUJBQUwsR0FBNkJpRCxjQUFjLENBQUNqRCxxQkFBNUMsQ0FBQTtBQUNBLElBQUEsSUFBQSxDQUFLRyxxQkFBTCxHQUE2QjhDLGNBQWMsQ0FBQzlDLHFCQUE1QyxDQUFBO0lBR0EsTUFBTTBFLE1BQU0sR0FBRyxJQUFBLENBQUtQLGFBQUwsQ0FBbUJDLFVBQW5CLEVBQStCQyxVQUEvQixFQUEyQ3ZCLGNBQTNDLENBQWYsQ0FBQTs7QUFDQSxJQUFBLElBQUk0QixNQUFNLENBQUN4QixNQUFQLEdBQWdCLENBQXBCLEVBQXVCO01BR25CLE1BQU0vQyxLQUFLLEdBQUcsSUFBQSxDQUFLQSxLQUFuQixDQUFBOztBQUNBLE1BQUEsS0FBSyxJQUFJcUQsQ0FBQyxHQUFHLENBQWIsRUFBZ0JBLENBQUMsR0FBR3JELEtBQUssQ0FBQytDLE1BQTFCLEVBQWtDTSxDQUFDLEVBQW5DLEVBQXVDO0FBQ25DckQsUUFBQUEsS0FBSyxDQUFDcUQsQ0FBRCxDQUFMLENBQVNoRSxJQUFULEdBQWdCLEtBQWhCLENBQUE7QUFDSCxPQUFBOztBQVNELE1BQUEsTUFBTXdILFdBQVcsR0FBRzNILElBQUksQ0FBQzRILEdBQUwsQ0FBU3ZDLE1BQU0sQ0FBQ3hCLE1BQWhCLEVBQXdCL0MsS0FBSyxDQUFDK0MsTUFBOUIsQ0FBcEIsQ0FBQTs7TUFHQSxLQUFLLElBQUlNLENBQUMsR0FBRyxDQUFiLEVBQWdCQSxDQUFDLEdBQUd3RCxXQUFwQixFQUFpQ3hELENBQUMsRUFBbEMsRUFBc0M7QUFDbEMsUUFBQSxNQUFNcUIsS0FBSyxHQUFHSCxNQUFNLENBQUNsQixDQUFELENBQXBCLENBQUE7UUFFQSxJQUFJcUIsS0FBSyxDQUFDRyxXQUFWLEVBQ0lILEtBQUssQ0FBQ3FDLFVBQU4sR0FBbUIsSUFBQSxDQUFLcEgsV0FBeEIsQ0FBQTtBQUdKLFFBQUEsTUFBTXFILFlBQVksR0FBR2hILEtBQUssQ0FBQzBFLEtBQUssQ0FBQ2lDLGNBQVAsQ0FBMUIsQ0FBQTs7QUFDQSxRQUFBLElBQUlqQyxLQUFLLENBQUNnQyxZQUFOLEtBQXVCLElBQUEsQ0FBS2pILE9BQTVCLElBQXVDaUYsS0FBSyxDQUFDOEIsRUFBTixNQUFhUSxZQUFiLElBQUEsSUFBQSxHQUFBLEtBQUEsQ0FBQSxHQUFhQSxZQUFZLENBQUUxSCxPQUEzQixDQUEzQyxFQUErRTtBQUMzRSxVQUFBLE1BQU0wSCxhQUFZLEdBQUdoSCxLQUFLLENBQUMwRSxLQUFLLENBQUNpQyxjQUFQLENBQTFCLENBQUE7O0FBQ0EsVUFBQSxJQUFJSyxhQUFZLENBQUMvSCxJQUFiLEtBQXNCZSxLQUFLLENBQUNxRCxDQUFELENBQUwsQ0FBU3BFLElBQS9CLElBQXVDLENBQUMrSCxhQUFZLENBQUMzSCxJQUF6RCxFQUErRDtZQUMzRCxJQUFLOEcsQ0FBQUEsVUFBTCxDQUFnQnpCLEtBQWhCLEVBQXVCQSxLQUFLLENBQUNpQyxjQUE3QixFQUE2QyxLQUE3QyxDQUFBLENBQUE7QUFDSCxXQUFBO0FBQ0osU0FBQTtBQUNKLE9BQUE7O01BR0QsSUFBSU0sU0FBUyxHQUFHLENBQWhCLENBQUE7O01BQ0EsS0FBSyxJQUFJNUQsQ0FBQyxHQUFHLENBQWIsRUFBZ0JBLENBQUMsR0FBR3dELFdBQXBCLEVBQWlDeEQsQ0FBQyxFQUFsQyxFQUFzQztBQUdsQyxRQUFBLE9BQU80RCxTQUFTLEdBQUdqSCxLQUFLLENBQUMrQyxNQUFsQixJQUE0Qi9DLEtBQUssQ0FBQ2lILFNBQUQsQ0FBTCxDQUFpQjVILElBQXBELEVBQ0k0SCxTQUFTLEVBQUEsQ0FBQTs7QUFFYixRQUFBLE1BQU12QyxLQUFLLEdBQUdILE1BQU0sQ0FBQ2xCLENBQUQsQ0FBcEIsQ0FBQTs7QUFDQSxRQUFBLElBQUksQ0FBQ3FCLEtBQUssQ0FBQzRCLHNCQUFYLEVBQW1DO0FBQy9CLFVBQUEsSUFBQSxDQUFLSCxVQUFMLENBQWdCekIsS0FBaEIsRUFBdUJ1QyxTQUF2QixFQUFrQyxJQUFsQyxDQUFBLENBQUE7QUFDSCxTQUFBOztBQUdELFFBQUEsTUFBTVYsSUFBSSxHQUFHdkcsS0FBSyxDQUFDMEUsS0FBSyxDQUFDaUMsY0FBUCxDQUFsQixDQUFBO0FBQ0EsUUFBQSxJQUFBLENBQUsxQixTQUFMLENBQWVQLEtBQWYsRUFBc0I2QixJQUFJLENBQUN2SCxJQUEzQixDQUFBLENBQUE7QUFDSCxPQUFBO0FBQ0osS0FBQTs7QUFFRCxJQUFBLElBQUEsQ0FBS2lELGNBQUwsRUFBQSxDQUFBO0FBQ0gsR0FBQTs7QUF6V21COzs7OyJ9
