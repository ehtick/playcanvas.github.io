/**
 * @license
 * PlayCanvas Engine v1.62.0-dev revision 7d088032c (DEBUG PROFILER)
 * Copyright 2011-2023 PlayCanvas Ltd. All rights reserved.
 */
import { Debug } from '../../../core/debug.js';
import { ShaderProcessor } from '../shader-processor.js';

/**
 * A WebGPU implementation of the Shader.
 *
 * @ignore
 */
class WebgpuShader {
  /**
   * Transpiled vertex shader code.
   *
   * @type {Uint32Array}
   */

  /**
   * Transpiled fragment shader code.
   *
   * @type {Uint32Array}
   */

  /**
   * @param {import('../shader.js').Shader} shader - The shader.
   */
  constructor(shader) {
    this._vertexCode = void 0;
    this._fragmentCode = void 0;
    /** @type {import('../shader.js').Shader} */
    this.shader = shader;
    const definition = shader.definition;
    Debug.assert(definition);
    if (definition.processingOptions) {
      this.process();
    }
  }

  /**
   * Free the WebGPU resources associated with a shader.
   *
   * @param {import('../shader.js').Shader} shader - The shader to free.
   */
  destroy(shader) {
    this._vertexCode = null;
    this._fragmentCode = null;
  }
  process() {
    const shader = this.shader;

    // process the shader source to allow for uniforms
    const processed = ShaderProcessor.run(shader.device, shader.definition, shader);

    // keep reference to processed shaders in debug mode
    Debug.call(() => {
      this.processed = processed;
    });
    this._vertexCode = this.transpile(processed.vshader, 'vertex', shader.definition.vshader);
    this._fragmentCode = this.transpile(processed.fshader, 'fragment', shader.definition.fshader);
    if (!(this._vertexCode && this._fragmentCode)) {
      shader.failed = true;
    } else {
      shader.ready = true;
    }
    shader.meshUniformBufferFormat = processed.meshUniformBufferFormat;
    shader.meshBindGroupFormat = processed.meshBindGroupFormat;
  }
  transpile(src, shaderType, originalSrc) {
    try {
      const spirv = this.shader.device.glslang.compileGLSL(src, shaderType);
      return this.shader.device.twgsl.convertSpirV2WGSL(spirv);
    } catch (err) {
      console.error(`Failed to transpile webgl ${shaderType} shader [${this.shader.label}] to WebGPU: [${err.message}]`, {
        processed: src,
        original: originalSrc,
        shader: this.shader
      });
    }
  }
  get vertexCode() {
    Debug.assert(this._vertexCode);
    return this._vertexCode;
  }
  get fragmentCode() {
    Debug.assert(this._fragmentCode);
    return this._fragmentCode;
  }

  /**
   * Dispose the shader when the context has been lost.
   */
  loseContext() {}

  /**
   * Restore shader after the context has been obtained.
   *
   * @param {import('../graphics-device.js').GraphicsDevice} device - The graphics device.
   * @param {import('../shader.js').Shader} shader - The shader to restore.
   */
  restoreContext(device, shader) {}
}

export { WebgpuShader };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2ViZ3B1LXNoYWRlci5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL3BsYXRmb3JtL2dyYXBoaWNzL3dlYmdwdS93ZWJncHUtc2hhZGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERlYnVnIH0gZnJvbSAnLi4vLi4vLi4vY29yZS9kZWJ1Zy5qcyc7XG5cbmltcG9ydCB7IFNoYWRlclByb2Nlc3NvciB9IGZyb20gJy4uL3NoYWRlci1wcm9jZXNzb3IuanMnO1xuXG4vKipcbiAqIEEgV2ViR1BVIGltcGxlbWVudGF0aW9uIG9mIHRoZSBTaGFkZXIuXG4gKlxuICogQGlnbm9yZVxuICovXG5jbGFzcyBXZWJncHVTaGFkZXIge1xuICAgIC8qKlxuICAgICAqIFRyYW5zcGlsZWQgdmVydGV4IHNoYWRlciBjb2RlLlxuICAgICAqXG4gICAgICogQHR5cGUge1VpbnQzMkFycmF5fVxuICAgICAqL1xuICAgIF92ZXJ0ZXhDb2RlO1xuXG4gICAgLyoqXG4gICAgICogVHJhbnNwaWxlZCBmcmFnbWVudCBzaGFkZXIgY29kZS5cbiAgICAgKlxuICAgICAqIEB0eXBlIHtVaW50MzJBcnJheX1cbiAgICAgKi9cbiAgICBfZnJhZ21lbnRDb2RlO1xuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtpbXBvcnQoJy4uL3NoYWRlci5qcycpLlNoYWRlcn0gc2hhZGVyIC0gVGhlIHNoYWRlci5cbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihzaGFkZXIpIHtcbiAgICAgICAgLyoqIEB0eXBlIHtpbXBvcnQoJy4uL3NoYWRlci5qcycpLlNoYWRlcn0gKi9cbiAgICAgICAgdGhpcy5zaGFkZXIgPSBzaGFkZXI7XG5cbiAgICAgICAgY29uc3QgZGVmaW5pdGlvbiA9IHNoYWRlci5kZWZpbml0aW9uO1xuICAgICAgICBEZWJ1Zy5hc3NlcnQoZGVmaW5pdGlvbik7XG5cbiAgICAgICAgaWYgKGRlZmluaXRpb24ucHJvY2Vzc2luZ09wdGlvbnMpIHtcbiAgICAgICAgICAgIHRoaXMucHJvY2VzcygpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRnJlZSB0aGUgV2ViR1BVIHJlc291cmNlcyBhc3NvY2lhdGVkIHdpdGggYSBzaGFkZXIuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge2ltcG9ydCgnLi4vc2hhZGVyLmpzJykuU2hhZGVyfSBzaGFkZXIgLSBUaGUgc2hhZGVyIHRvIGZyZWUuXG4gICAgICovXG4gICAgZGVzdHJveShzaGFkZXIpIHtcbiAgICAgICAgdGhpcy5fdmVydGV4Q29kZSA9IG51bGw7XG4gICAgICAgIHRoaXMuX2ZyYWdtZW50Q29kZSA9IG51bGw7XG4gICAgfVxuXG4gICAgcHJvY2VzcygpIHtcbiAgICAgICAgY29uc3Qgc2hhZGVyID0gdGhpcy5zaGFkZXI7XG5cbiAgICAgICAgLy8gcHJvY2VzcyB0aGUgc2hhZGVyIHNvdXJjZSB0byBhbGxvdyBmb3IgdW5pZm9ybXNcbiAgICAgICAgY29uc3QgcHJvY2Vzc2VkID0gU2hhZGVyUHJvY2Vzc29yLnJ1bihzaGFkZXIuZGV2aWNlLCBzaGFkZXIuZGVmaW5pdGlvbiwgc2hhZGVyKTtcblxuICAgICAgICAvLyBrZWVwIHJlZmVyZW5jZSB0byBwcm9jZXNzZWQgc2hhZGVycyBpbiBkZWJ1ZyBtb2RlXG4gICAgICAgIERlYnVnLmNhbGwoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5wcm9jZXNzZWQgPSBwcm9jZXNzZWQ7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuX3ZlcnRleENvZGUgPSB0aGlzLnRyYW5zcGlsZShwcm9jZXNzZWQudnNoYWRlciwgJ3ZlcnRleCcsIHNoYWRlci5kZWZpbml0aW9uLnZzaGFkZXIpO1xuICAgICAgICB0aGlzLl9mcmFnbWVudENvZGUgPSB0aGlzLnRyYW5zcGlsZShwcm9jZXNzZWQuZnNoYWRlciwgJ2ZyYWdtZW50Jywgc2hhZGVyLmRlZmluaXRpb24uZnNoYWRlcik7XG5cbiAgICAgICAgaWYgKCEodGhpcy5fdmVydGV4Q29kZSAmJiB0aGlzLl9mcmFnbWVudENvZGUpKSB7XG4gICAgICAgICAgICBzaGFkZXIuZmFpbGVkID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHNoYWRlci5yZWFkeSA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICBzaGFkZXIubWVzaFVuaWZvcm1CdWZmZXJGb3JtYXQgPSBwcm9jZXNzZWQubWVzaFVuaWZvcm1CdWZmZXJGb3JtYXQ7XG4gICAgICAgIHNoYWRlci5tZXNoQmluZEdyb3VwRm9ybWF0ID0gcHJvY2Vzc2VkLm1lc2hCaW5kR3JvdXBGb3JtYXQ7XG4gICAgfVxuXG4gICAgdHJhbnNwaWxlKHNyYywgc2hhZGVyVHlwZSwgb3JpZ2luYWxTcmMpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHNwaXJ2ID0gdGhpcy5zaGFkZXIuZGV2aWNlLmdsc2xhbmcuY29tcGlsZUdMU0woc3JjLCBzaGFkZXJUeXBlKTtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNoYWRlci5kZXZpY2UudHdnc2wuY29udmVydFNwaXJWMldHU0woc3BpcnYpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byB0cmFuc3BpbGUgd2ViZ2wgJHtzaGFkZXJUeXBlfSBzaGFkZXIgWyR7dGhpcy5zaGFkZXIubGFiZWx9XSB0byBXZWJHUFU6IFske2Vyci5tZXNzYWdlfV1gLCB7XG4gICAgICAgICAgICAgICAgcHJvY2Vzc2VkOiBzcmMsXG4gICAgICAgICAgICAgICAgb3JpZ2luYWw6IG9yaWdpbmFsU3JjLFxuICAgICAgICAgICAgICAgIHNoYWRlcjogdGhpcy5zaGFkZXJcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZ2V0IHZlcnRleENvZGUoKSB7XG4gICAgICAgIERlYnVnLmFzc2VydCh0aGlzLl92ZXJ0ZXhDb2RlKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3ZlcnRleENvZGU7XG4gICAgfVxuXG4gICAgZ2V0IGZyYWdtZW50Q29kZSgpIHtcbiAgICAgICAgRGVidWcuYXNzZXJ0KHRoaXMuX2ZyYWdtZW50Q29kZSk7XG4gICAgICAgIHJldHVybiB0aGlzLl9mcmFnbWVudENvZGU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGlzcG9zZSB0aGUgc2hhZGVyIHdoZW4gdGhlIGNvbnRleHQgaGFzIGJlZW4gbG9zdC5cbiAgICAgKi9cbiAgICBsb3NlQ29udGV4dCgpIHtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXN0b3JlIHNoYWRlciBhZnRlciB0aGUgY29udGV4dCBoYXMgYmVlbiBvYnRhaW5lZC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7aW1wb3J0KCcuLi9ncmFwaGljcy1kZXZpY2UuanMnKS5HcmFwaGljc0RldmljZX0gZGV2aWNlIC0gVGhlIGdyYXBoaWNzIGRldmljZS5cbiAgICAgKiBAcGFyYW0ge2ltcG9ydCgnLi4vc2hhZGVyLmpzJykuU2hhZGVyfSBzaGFkZXIgLSBUaGUgc2hhZGVyIHRvIHJlc3RvcmUuXG4gICAgICovXG4gICAgcmVzdG9yZUNvbnRleHQoZGV2aWNlLCBzaGFkZXIpIHtcbiAgICB9XG59XG5cbmV4cG9ydCB7IFdlYmdwdVNoYWRlciB9O1xuIl0sIm5hbWVzIjpbIldlYmdwdVNoYWRlciIsImNvbnN0cnVjdG9yIiwic2hhZGVyIiwiX3ZlcnRleENvZGUiLCJfZnJhZ21lbnRDb2RlIiwiZGVmaW5pdGlvbiIsIkRlYnVnIiwiYXNzZXJ0IiwicHJvY2Vzc2luZ09wdGlvbnMiLCJwcm9jZXNzIiwiZGVzdHJveSIsInByb2Nlc3NlZCIsIlNoYWRlclByb2Nlc3NvciIsInJ1biIsImRldmljZSIsImNhbGwiLCJ0cmFuc3BpbGUiLCJ2c2hhZGVyIiwiZnNoYWRlciIsImZhaWxlZCIsInJlYWR5IiwibWVzaFVuaWZvcm1CdWZmZXJGb3JtYXQiLCJtZXNoQmluZEdyb3VwRm9ybWF0Iiwic3JjIiwic2hhZGVyVHlwZSIsIm9yaWdpbmFsU3JjIiwic3BpcnYiLCJnbHNsYW5nIiwiY29tcGlsZUdMU0wiLCJ0d2dzbCIsImNvbnZlcnRTcGlyVjJXR1NMIiwiZXJyIiwiY29uc29sZSIsImVycm9yIiwibGFiZWwiLCJtZXNzYWdlIiwib3JpZ2luYWwiLCJ2ZXJ0ZXhDb2RlIiwiZnJhZ21lbnRDb2RlIiwibG9zZUNvbnRleHQiLCJyZXN0b3JlQ29udGV4dCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFJQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsTUFBTUEsWUFBWSxDQUFDO0FBQ2Y7QUFDSjtBQUNBO0FBQ0E7QUFDQTs7QUFHSTtBQUNKO0FBQ0E7QUFDQTtBQUNBOztBQUdJO0FBQ0o7QUFDQTtFQUNJQyxXQUFXLENBQUNDLE1BQU0sRUFBRTtBQUFBLElBQUEsSUFBQSxDQVpwQkMsV0FBVyxHQUFBLEtBQUEsQ0FBQSxDQUFBO0FBQUEsSUFBQSxJQUFBLENBT1hDLGFBQWEsR0FBQSxLQUFBLENBQUEsQ0FBQTtBQU1UO0lBQ0EsSUFBSSxDQUFDRixNQUFNLEdBQUdBLE1BQU0sQ0FBQTtBQUVwQixJQUFBLE1BQU1HLFVBQVUsR0FBR0gsTUFBTSxDQUFDRyxVQUFVLENBQUE7QUFDcENDLElBQUFBLEtBQUssQ0FBQ0MsTUFBTSxDQUFDRixVQUFVLENBQUMsQ0FBQTtJQUV4QixJQUFJQSxVQUFVLENBQUNHLGlCQUFpQixFQUFFO01BQzlCLElBQUksQ0FBQ0MsT0FBTyxFQUFFLENBQUE7QUFDbEIsS0FBQTtBQUNKLEdBQUE7O0FBRUE7QUFDSjtBQUNBO0FBQ0E7QUFDQTtFQUNJQyxPQUFPLENBQUNSLE1BQU0sRUFBRTtJQUNaLElBQUksQ0FBQ0MsV0FBVyxHQUFHLElBQUksQ0FBQTtJQUN2QixJQUFJLENBQUNDLGFBQWEsR0FBRyxJQUFJLENBQUE7QUFDN0IsR0FBQTtBQUVBSyxFQUFBQSxPQUFPLEdBQUc7QUFDTixJQUFBLE1BQU1QLE1BQU0sR0FBRyxJQUFJLENBQUNBLE1BQU0sQ0FBQTs7QUFFMUI7QUFDQSxJQUFBLE1BQU1TLFNBQVMsR0FBR0MsZUFBZSxDQUFD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
