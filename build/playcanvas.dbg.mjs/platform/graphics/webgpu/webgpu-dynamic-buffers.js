import { DebugHelper } from '../../../core/debug.js';
import { DebugGraphics } from '../debug-graphics.js';
import { DynamicBuffers } from '../dynamic-buffers.js';
import { WebgpuDynamicBuffer } from './webgpu-dynamic-buffer.js';

class WebgpuDynamicBuffers extends DynamicBuffers {
  constructor(...args) {
    super(...args);
    /**
     * Staging buffers which are getting copied over to gpu buffers in the the command buffer waiting
     * to be submitted. When those command buffers are submitted, we can mapAsync these staging
     * buffers for reuse.
     *
     * @type {WebgpuDynamicBuffer[]}
     */
    this.pendingStagingBuffers = [];
  }
  createBuffer(device, size, isStaging) {
    return new WebgpuDynamicBuffer(device, size, isStaging);
  }

  /**
   * Submit all used buffers to the device.
   */
  submit() {
    super.submit();

    // submit all used buffers
    const count = this.usedBuffers.length;
    if (count) {
      const device = this.device;
      const gpuBuffers = this.gpuBuffers;

      // new command encoder, as buffer copies need to be submitted before the currently recorded
      // rendering encoder is submitted
      const commandEncoder = device.wgpu.createCommandEncoder();
      DebugHelper.setLabel(commandEncoder, 'DynamicBuffersSubmit');
      DebugGraphics.pushGpuMarker(device, 'DynamicBuffersSubmit');

      // run this loop backwards to preserve the order of buffers in gpuBuffers array
      for (let i = count - 1; i >= 0; i--) {
        const usedBuffer = this.usedBuffers[i];
        const {
          stagingBuffer,
          gpuBuffer,
          offset,
          size
        } = usedBuffer;

        // unmap staging buffer (we're done writing to it on CPU)
        const src = stagingBuffer.buffer;
        src.unmap();

        // schedule data copy from staging to gpu buffer
        commandEncoder.copyBufferToBuffer(src, offset, gpuBuffer.buffer, offset, size);

        // gpu buffer can be reused immediately
        gpuBuffers.push(gpuBuffer);
      }
      DebugGraphics.popGpuMarker(device);

      // schedule the command buffer to run before all currently scheduled command buffers
      const cb = commandEncoder.finish();
      DebugHelper.setLabel(cb, 'DynamicBuffers');
      device.addCommandBuffer(cb, true);

      // keep the used staging buffers in the pending list
      for (let i = 0; i < count; i++) {
        const stagingBuffer = this.usedBuffers[i].stagingBuffer;
        this.pendingStagingBuffers.push(stagingBuffer);
      }
      this.usedBuffers.length = 0;
    }
  }

  /**
   * Called when all scheduled command buffers are submitted to the device.
   */
  onCommandBuffersSubmitted() {
    // map the staging buffers for write to alow them to be reused - this resolves when the CBs
    // using them are done on the GPU
    const count = this.pendingStagingBuffers.length;
    if (count) {
      for (let i = 0; i < count; i++) {
        const stagingBuffer = this.pendingStagingBuffers[i];
        stagingBuffer.buffer.mapAsync(GPUMapMode.WRITE).then(() => {
          stagingBuffer.onAvailable();
          this.stagingBuffers.push(stagingBuffer);
        });
      }
      this.pendingStagingBuffers.length = 0;
    }
  }
}

export { WebgpuDynamicBuffers };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2ViZ3B1LWR5bmFtaWMtYnVmZmVycy5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL3BsYXRmb3JtL2dyYXBoaWNzL3dlYmdwdS93ZWJncHUtZHluYW1pYy1idWZmZXJzLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERlYnVnSGVscGVyIH0gZnJvbSBcIi4uLy4uLy4uL2NvcmUvZGVidWcuanNcIjtcbmltcG9ydCB7IERlYnVnR3JhcGhpY3MgfSBmcm9tIFwiLi4vZGVidWctZ3JhcGhpY3MuanNcIjtcbmltcG9ydCB7IER5bmFtaWNCdWZmZXJzIH0gZnJvbSBcIi4uL2R5bmFtaWMtYnVmZmVycy5qc1wiO1xuaW1wb3J0IHsgV2ViZ3B1RHluYW1pY0J1ZmZlciB9IGZyb20gXCIuL3dlYmdwdS1keW5hbWljLWJ1ZmZlci5qc1wiO1xuXG5jbGFzcyBXZWJncHVEeW5hbWljQnVmZmVycyBleHRlbmRzIER5bmFtaWNCdWZmZXJzIHtcbiAgICAvKipcbiAgICAgKiBTdGFnaW5nIGJ1ZmZlcnMgd2hpY2ggYXJlIGdldHRpbmcgY29waWVkIG92ZXIgdG8gZ3B1IGJ1ZmZlcnMgaW4gdGhlIHRoZSBjb21tYW5kIGJ1ZmZlciB3YWl0aW5nXG4gICAgICogdG8gYmUgc3VibWl0dGVkLiBXaGVuIHRob3NlIGNvbW1hbmQgYnVmZmVycyBhcmUgc3VibWl0dGVkLCB3ZSBjYW4gbWFwQXN5bmMgdGhlc2Ugc3RhZ2luZ1xuICAgICAqIGJ1ZmZlcnMgZm9yIHJldXNlLlxuICAgICAqXG4gICAgICogQHR5cGUge1dlYmdwdUR5bmFtaWNCdWZmZXJbXX1cbiAgICAgKi9cbiAgICBwZW5kaW5nU3RhZ2luZ0J1ZmZlcnMgPSBbXTtcblxuICAgIGNyZWF0ZUJ1ZmZlcihkZXZpY2UsIHNpemUsIGlzU3RhZ2luZykge1xuICAgICAgICByZXR1cm4gbmV3IFdlYmdwdUR5bmFtaWNCdWZmZXIoZGV2aWNlLCBzaXplLCBpc1N0YWdpbmcpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN1Ym1pdCBhbGwgdXNlZCBidWZmZXJzIHRvIHRoZSBkZXZpY2UuXG4gICAgICovXG4gICAgc3VibWl0KCkge1xuXG4gICAgICAgIHN1cGVyLnN1Ym1pdCgpO1xuXG4gICAgICAgIC8vIHN1Ym1pdCBhbGwgdXNlZCBidWZmZXJzXG4gICAgICAgIGNvbnN0IGNvdW50ID0gdGhpcy51c2VkQnVmZmVycy5sZW5ndGg7XG4gICAgICAgIGlmIChjb3VudCkge1xuXG4gICAgICAgICAgICBjb25zdCBkZXZpY2UgPSB0aGlzLmRldmljZTtcbiAgICAgICAgICAgIGNvbnN0IGdwdUJ1ZmZlcnMgPSB0aGlzLmdwdUJ1ZmZlcnM7XG5cbiAgICAgICAgICAgIC8vIG5ldyBjb21tYW5kIGVuY29kZXIsIGFzIGJ1ZmZlciBjb3BpZXMgbmVlZCB0byBiZSBzdWJtaXR0ZWQgYmVmb3JlIHRoZSBjdXJyZW50bHkgcmVjb3JkZWRcbiAgICAgICAgICAgIC8vIHJlbmRlcmluZyBlbmNvZGVyIGlzIHN1Ym1pdHRlZFxuICAgICAgICAgICAgY29uc3QgY29tbWFuZEVuY29kZXIgPSBkZXZpY2Uud2dwdS5jcmVhdGVDb21tYW5kRW5jb2RlcigpO1xuICAgICAgICAgICAgRGVidWdIZWxwZXIuc2V0TGFiZWwoY29tbWFuZEVuY29kZXIsICdEeW5hbWljQnVmZmVyc1N1Ym1pdCcpO1xuXG4gICAgICAgICAgICBEZWJ1Z0dyYXBoaWNzLnB1c2hHcHVNYXJrZXIoZGV2aWNlLCAnRHluYW1pY0J1ZmZlcnNTdWJtaXQnKTtcblxuICAgICAgICAgICAgLy8gcnVuIHRoaXMgbG9vcCBiYWNrd2FyZHMgdG8gcHJlc2VydmUgdGhlIG9yZGVyIG9mIGJ1ZmZlcnMgaW4gZ3B1QnVmZmVycyBhcnJheVxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IGNvdW50IC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgICAgICAgICBjb25zdCB1c2VkQnVmZmVyID0gdGhpcy51c2VkQnVmZmVyc1tpXTtcbiAgICAgICAgICAgICAgICBjb25zdCB7IHN0YWdpbmdCdWZmZXIsIGdwdUJ1ZmZlciwgb2Zmc2V0LCBzaXplIH0gPSB1c2VkQnVmZmVyO1xuXG4gICAgICAgICAgICAgICAgLy8gdW5tYXAgc3RhZ2luZyBidWZmZXIgKHdlJ3JlIGRvbmUgd3JpdGluZyB0byBpdCBvbiBDUFUpXG4gICAgICAgICAgICAgICAgY29uc3Qgc3JjID0gc3RhZ2luZ0J1ZmZlci5idWZmZXI7XG4gICAgICAgICAgICAgICAgc3JjLnVubWFwKCk7XG5cbiAgICAgICAgICAgICAgICAvLyBzY2hlZHVsZSBkYXRhIGNvcHkgZnJvbSBzdGFnaW5nIHRvIGdwdSBidWZmZXJcbiAgICAgICAgICAgICAgICBjb21tYW5kRW5jb2Rlci5jb3B5QnVmZmVyVG9CdWZmZXIoc3JjLCBvZmZzZXQsIGdwdUJ1ZmZlci5idWZmZXIsIG9mZnNldCwgc2l6ZSk7XG5cbiAgICAgICAgICAgICAgICAvLyBncHUgYnVmZmVyIGNhbiBiZSByZXVzZWQgaW1tZWRpYXRlbHlcbiAgICAgICAgICAgICAgICBncHVCdWZmZXJzLnB1c2goZ3B1QnVmZmVyKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgRGVidWdHcmFwaGljcy5wb3BHcHVNYXJrZXIoZGV2aWNlKTtcblxuICAgICAgICAgICAgLy8gc2NoZWR1bGUgdGhlIGNvbW1hbmQgYnVmZmVyIHRvIHJ1biBiZWZvcmUgYWxsIGN1cnJlbnRseSBzY2hlZHVsZWQgY29tbWFuZCBidWZmZXJzXG4gICAgICAgICAgICBjb25zdCBjYiA9IGNvbW1hbmRFbmNvZGVyLmZpbmlzaCgpO1xuICAgICAgICAgICAgRGVidWdIZWxwZXIuc2V0TGFiZWwoY2IsICdEeW5hbWljQnVmZmVycycpO1xuICAgICAgICAgICAgZGV2aWNlLmFkZENvbW1hbmRCdWZmZXIoY2IsIHRydWUpO1xuXG4gICAgICAgICAgICAvLyBrZWVwIHRoZSB1c2VkIHN0YWdpbmcgYnVmZmVycyBpbiB0aGUgcGVuZGluZyBsaXN0XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHtcbiAgICAgICAgICAgICAgICBjb25zdCBzdGFnaW5nQnVmZmVyID0gdGhpcy51c2VkQnVmZmVyc1tpXS5zdGFnaW5nQnVmZmVyO1xuICAgICAgICAgICAgICAgIHRoaXMucGVuZGluZ1N0YWdpbmdCdWZmZXJzLnB1c2goc3RhZ2luZ0J1ZmZlcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnVzZWRCdWZmZXJzLmxlbmd0aCA9IDA7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxsZWQgd2hlbiBhbGwgc2NoZWR1bGVkIGNvbW1hbmQgYnVmZmVycyBhcmUgc3VibWl0dGVkIHRvIHRoZSBkZXZpY2UuXG4gICAgICovXG4gICAgb25Db21tYW5kQnVmZmVyc1N1Ym1pdHRlZCgpIHtcbiAgICAgICAgLy8gbWFwIHRoZSBzdGFnaW5nIGJ1ZmZlcnMgZm9yIHdyaXRlIHRvIGFsb3cgdGhlbSB0byBiZSByZXVzZWQgLSB0aGlzIHJlc29sdmVzIHdoZW4gdGhlIENCc1xuICAgICAgICAvLyB1c2luZyB0aGVtIGFyZSBkb25lIG9uIHRoZSBHUFVcbiAgICAgICAgY29uc3QgY291bnQgPSB0aGlzLnBlbmRpbmdTdGFnaW5nQnVmZmVycy5sZW5ndGg7XG4gICAgICAgIGlmIChjb3VudCkge1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc3RhZ2luZ0J1ZmZlciA9IHRoaXMucGVuZGluZ1N0YWdpbmdCdWZmZXJzW2ldO1xuICAgICAgICAgICAgICAgIHN0YWdpbmdCdWZmZXIuYnVmZmVyLm1hcEFzeW5jKEdQVU1hcE1vZGUuV1JJVEUpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBzdGFnaW5nQnVmZmVyLm9uQXZhaWxhYmxlKCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhZ2luZ0J1ZmZlcnMucHVzaChzdGFnaW5nQnVmZmVyKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMucGVuZGluZ1N0YWdpbmdCdWZmZXJzLmxlbmd0aCA9IDA7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmV4cG9ydCB7IFdlYmdwdUR5bmFtaWNCdWZmZXJzIH07XG4iXSwibmFtZXMiOlsiV2ViZ3B1RHluYW1pY0J1ZmZlcnMiLCJEeW5hbWljQnVmZmVycyIsImNvbnN0cnVjdG9yIiwiYXJncyIsInBlbmRpbmdTdGFnaW5nQnVmZmVycyIsImNyZWF0ZUJ1ZmZlciIsImRldmljZSIsInNpemUiLCJpc1N0YWdpbmciLCJXZWJncHVEeW5hbWljQnVmZmVyIiwic3VibWl0IiwiY291bnQiLCJ1c2VkQnVmZmVycyIsImxlbmd0aCIsImdwdUJ1ZmZlcnMiLCJjb21tYW5kRW5jb2RlciIsIndncHUiLCJjcmVhdGVDb21tYW5kRW5jb2RlciIsIkRlYnVnSGVscGVyIiwic2V0TGFiZWwiLCJEZWJ1Z0dyYXBoaWNzIiwicHVzaEdwdU1hcmtlciIsImkiLCJ1c2VkQnVmZmVyIiwic3RhZ2luZ0J1ZmZlciIsImdwdUJ1ZmZlciIsIm9mZnNldCIsInNyYyIsImJ1ZmZlciIsInVubWFwIiwiY29weUJ1ZmZlclRvQnVmZmVyIiwicHVzaCIsInBvcEdwdU1hcmtlciIsImNiIiwiZmluaXNoIiwiYWRkQ29tbWFuZEJ1ZmZlciIsIm9uQ29tbWFuZEJ1ZmZlcnNTdWJtaXR0ZWQiLCJtYXBBc3luYyIsIkdQVU1hcE1vZGUiLCJXUklURSIsInRoZW4iLCJvbkF2YWlsYWJsZSIsInN0YWdpbmdCdWZmZXJzIl0sIm1hcHBpbmdzIjoiOzs7OztBQUtBLE1BQU1BLG9CQUFvQixTQUFTQyxjQUFjLENBQUM7QUFBQUMsRUFBQUEsV0FBQUEsQ0FBQSxHQUFBQyxJQUFBLEVBQUE7QUFBQSxJQUFBLEtBQUEsQ0FBQSxHQUFBQSxJQUFBLENBQUEsQ0FBQTtBQUM5QztBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtJQU5JLElBT0FDLENB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
