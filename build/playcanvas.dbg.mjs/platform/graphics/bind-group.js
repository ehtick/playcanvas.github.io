/**
 * @license
 * PlayCanvas Engine v1.59.0-preview revision 797466563 (DEBUG PROFILER)
 * Copyright 2011-2022 PlayCanvas Ltd. All rights reserved.
 */
import { Debug } from '../../core/debug.js';
import { TRACEID_BINDGROUP_ALLOC } from '../../core/constants.js';
import { UNIFORM_BUFFER_DEFAULT_SLOT_NAME } from './constants.js';

let id = 0;

class BindGroup {
  constructor(graphicsDevice, format, defaultUniformBuffer) {
    this.id = id++;
    this.device = graphicsDevice;
    this.format = format;
    this.dirty = true;
    this.impl = graphicsDevice.createBindGroupImpl(this);
    this.textures = [];
    this.uniformBuffers = [];

    this.defaultUniformBuffer = defaultUniformBuffer;
    if (defaultUniformBuffer) {
      this.setUniformBuffer(UNIFORM_BUFFER_DEFAULT_SLOT_NAME, defaultUniformBuffer);
    }
    Debug.trace(TRACEID_BINDGROUP_ALLOC, `Alloc: Id ${this.id}`, this, format);
  }

  destroy() {
    this.impl.destroy();
    this.impl = null;
    this.format = null;
    this.defaultUniformBuffer = null;
  }

  setUniformBuffer(name, uniformBuffer) {
    const index = this.format.bufferFormatsMap.get(name);
    Debug.assert(index !== undefined, `Setting a uniform [${name}] on a bind group with id ${this.id} which does not contain in.`);
    if (this.uniformBuffers[index] !== uniformBuffer) {
      this.uniformBuffers[index] = uniformBuffer;
      this.dirty = true;
    }
  }

  setTexture(name, texture) {
    const index = this.format.textureFormatsMap.get(name);
    Debug.assert(index !== undefined, `Setting a texture [${name}] on a bind group with id: ${this.id} which does not contain in.`);
    if (this.textures[index] !== texture) {
      this.textures[index] = texture;
      this.dirty = true;
    }
  }

  update() {
    const textureFormats = this.format.textureFormats;
    for (let i = 0; i < textureFormats.length; i++) {
      const textureFormat = textureFormats[i];
      const value = textureFormat.scopeId.value;
      Debug.assert(value, `Value was not set when assigning texture slot [${textureFormat.name}] to a bind group.`);
      this.setTexture(textureFormat.name, value);
    }
    if (this.dirty) {
      this.dirty = false;
      this.impl.update(this);
    }
  }
}

export { BindGroup };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZC1ncm91cC5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3BsYXRmb3JtL2dyYXBoaWNzL2JpbmQtZ3JvdXAuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGVidWcgfSBmcm9tICcuLi8uLi9jb3JlL2RlYnVnLmpzJztcbmltcG9ydCB7IFRSQUNFSURfQklOREdST1VQX0FMTE9DIH0gZnJvbSAnLi4vLi4vY29yZS9jb25zdGFudHMuanMnO1xuaW1wb3J0IHsgVU5JRk9STV9CVUZGRVJfREVGQVVMVF9TTE9UX05BTUUgfSBmcm9tICcuL2NvbnN0YW50cy5qcyc7XG5cbmxldCBpZCA9IDA7XG5cbi8qKlxuICogQSBiaW5kIGdyb3VwIHJlcHJlc2VudHMgYW4gY29sbGVjdGlvbiBvZiB7QGxpbmsgVW5pZm9ybUJ1ZmZlcn0gYW5kIHtAbGluayBUZXh0dXJlfSBpbnN0YW5jZSxcbiAqIHdoaWNoIGNhbiBiZSBiaW5kIG9uIGEgR1BVIGZvciByZW5kZXJpbmcuXG4gKlxuICogQGlnbm9yZVxuICovXG5jbGFzcyBCaW5kR3JvdXAge1xuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIG5ldyBCaW5kIEdyb3VwLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtpbXBvcnQoJy4vZ3JhcGhpY3MtZGV2aWNlLmpzJykuR3JhcGhpY3NEZXZpY2V9IGdyYXBoaWNzRGV2aWNlIC0gVGhlIGdyYXBoaWNzIGRldmljZVxuICAgICAqIHVzZWQgdG8gbWFuYWdlIHRoaXMgdW5pZm9ybSBidWZmZXIuXG4gICAgICogQHBhcmFtIHtpbXBvcnQoJy4vYmluZC1ncm91cC1mb3JtYXQuanMnKS5CaW5kR3JvdXBGb3JtYXR9IGZvcm1hdCAtIEZvcm1hdCBvZiB0aGUgYmluZCBncm91cC5cbiAgICAgKiBAcGFyYW0ge2ltcG9ydCgnLi91bmlmb3JtLWJ1ZmZlci5qcycpLlVuaWZvcm1CdWZmZXJ9IFtkZWZhdWx0VW5pZm9ybUJ1ZmZlcl0gLSBUaGUgZGVmYXVsdFxuICAgICAqIHVuaWZvcm0gYnVmZmVyLiBUeXBpY2FsbHkgYSBiaW5kIGdyb3VwIG9ubHkgaGFzIGEgc2luZ2xlIHVuaWZvcm0gYnVmZmVyLCBhbmQgdGhpcyBhbGxvd3NcbiAgICAgKiBlYXNpZXIgYWNjZXNzLlxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGdyYXBoaWNzRGV2aWNlLCBmb3JtYXQsIGRlZmF1bHRVbmlmb3JtQnVmZmVyKSB7XG4gICAgICAgIHRoaXMuaWQgPSBpZCsrO1xuICAgICAgICB0aGlzLmRldmljZSA9IGdyYXBoaWNzRGV2aWNlO1xuICAgICAgICB0aGlzLmZvcm1hdCA9IGZvcm1hdDtcbiAgICAgICAgdGhpcy5kaXJ0eSA9IHRydWU7XG4gICAgICAgIHRoaXMuaW1wbCA9IGdyYXBoaWNzRGV2aWNlLmNyZWF0ZUJpbmRHcm91cEltcGwodGhpcyk7XG5cbiAgICAgICAgdGhpcy50ZXh0dXJlcyA9IFtdO1xuICAgICAgICB0aGlzLnVuaWZvcm1CdWZmZXJzID0gW107XG5cbiAgICAgICAgLyoqIEB0eXBlIHtpbXBvcnQoJy4vdW5pZm9ybS1idWZmZXIuanMnKS5Vbmlmb3JtQnVmZmVyfSAqL1xuICAgICAgICB0aGlzLmRlZmF1bHRVbmlmb3JtQnVmZmVyID0gZGVmYXVsdFVuaWZvcm1CdWZmZXI7XG4gICAgICAgIGlmIChkZWZhdWx0VW5pZm9ybUJ1ZmZlcikge1xuICAgICAgICAgICAgdGhpcy5zZXRVbmlmb3JtQnVmZmVyKFVOSUZPUk1fQlVGRkVSX0RFRkFVTFRfU0xPVF9OQU1FLCBkZWZhdWx0VW5pZm9ybUJ1ZmZlcik7XG4gICAgICAgIH1cblxuICAgICAgICBEZWJ1Zy50cmFjZShUUkFDRUlEX0JJTkRHUk9VUF9BTExPQywgYEFsbG9jOiBJZCAke3RoaXMuaWR9YCwgdGhpcywgZm9ybWF0KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGcmVlcyByZXNvdXJjZXMgYXNzb2NpYXRlZCB3aXRoIHRoaXMgYmluZCBncm91cC5cbiAgICAgKi9cbiAgICBkZXN0cm95KCkge1xuICAgICAgICB0aGlzLmltcGwuZGVzdHJveSgpO1xuICAgICAgICB0aGlzLmltcGwgPSBudWxsO1xuICAgICAgICB0aGlzLmZvcm1hdCA9IG51bGw7XG4gICAgICAgIHRoaXMuZGVmYXVsdFVuaWZvcm1CdWZmZXIgPSBudWxsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFzc2lnbiBhIHVuaWZvcm0gYnVmZmVyIHRvIGEgc2xvdC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIHVuaWZvcm0gYnVmZmVyIHNsb3RcbiAgICAgKiBAcGFyYW0ge2ltcG9ydCgnLi91bmlmb3JtLWJ1ZmZlci5qcycpLlVuaWZvcm1CdWZmZXJ9IHVuaWZvcm1CdWZmZXIgLSBUaGUgVW5pZm9ybSBidWZmZXIgdG9cbiAgICAgKiBhc3NpZ24gdG8gdGhlIHNsb3QuXG4gICAgICovXG4gICAgc2V0VW5pZm9ybUJ1ZmZlcihuYW1lLCB1bmlmb3JtQnVmZmVyKSB7XG4gICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5mb3JtYXQuYnVmZmVyRm9ybWF0c01hcC5nZXQobmFtZSk7XG4gICAgICAgIERlYnVnLmFzc2VydChpbmRleCAhPT0gdW5kZWZpbmVkLCBgU2V0dGluZyBhIHVuaWZvcm0gWyR7bmFtZX1dIG9uIGEgYmluZCBncm91cCB3aXRoIGlkICR7dGhpcy5pZH0gd2hpY2ggZG9lcyBub3QgY29udGFpbiBpbi5gKTtcbiAgICAgICAgaWYgKHRoaXMudW5pZm9ybUJ1ZmZlcnNbaW5kZXhdICE9PSB1bmlmb3JtQnVmZmVyKSB7XG4gICAgICAgICAgICB0aGlzLnVuaWZvcm1CdWZmZXJzW2luZGV4XSA9IHVuaWZvcm1CdWZmZXI7XG4gICAgICAgICAgICB0aGlzLmRpcnR5ID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFzc2lnbiBhIHRleHR1cmUgdG8gYSBuYW1lZCBzbG90LlxuICAgICAqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgdGV4dHVyZSBzbG90LlxuICAgICAqIEBwYXJhbSB7aW1wb3J0KCcuL3RleHR1cmUuanMnKS5UZXh0dXJlfSB0ZXh0dXJlIC0gVGV4dHVyZSB0byBhc3NpZ24gdG8gdGhlIHNsb3QuXG4gICAgICovXG4gICAgc2V0VGV4dHVyZShuYW1lLCB0ZXh0dXJlKSB7XG4gICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5mb3JtYXQudGV4dHVyZUZvcm1hdHNNYXAuZ2V0KG5hbWUpO1xuICAgICAgICBEZWJ1Zy5hc3NlcnQoaW5kZXggIT09IHVuZGVmaW5lZCwgYFNldHRpbmcgYSB0ZXh0dXJlIFske25hbWV9XSBvbiBhIGJpbmQgZ3JvdXAgd2l0aCBpZDogJHt0aGlzLmlkfSB3aGljaCBkb2VzIG5vdCBjb250YWluIGluLmApO1xuICAgICAgICBpZiAodGhpcy50ZXh0dXJlc1tpbmRleF0gIT09IHRleHR1cmUpIHtcbiAgICAgICAgICAgIHRoaXMudGV4dHVyZXNbaW5kZXhdID0gdGV4dHVyZTtcbiAgICAgICAgICAgIHRoaXMuZGlydHkgPSB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQXBwbGllcyBhbnkgY2hhbmdlcyBtYWRlIHRvIHRoZSBiaW5kIGdyb3VwJ3MgcHJvcGVydGllcy5cbiAgICAgKi9cbiAgICB1cGRhdGUoKSB7XG5cbiAgICAgICAgY29uc3QgdGV4dHVyZUZvcm1hdHMgPSB0aGlzLmZvcm1hdC50ZXh0dXJlRm9ybWF0cztcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0ZXh0dXJlRm9ybWF0cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgY29uc3QgdGV4dHVyZUZvcm1hdCA9IHRleHR1cmVGb3JtYXRzW2ldO1xuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSB0ZXh0dXJlRm9ybWF0LnNjb3BlSWQudmFsdWU7XG4gICAgICAgICAgICBEZWJ1Zy5hc3NlcnQodmFsdWUsIGBWYWx1ZSB3YXMgbm90IHNldCB3aGVuIGFzc2lnbmluZyB0ZXh0dXJlIHNsb3QgWyR7dGV4dHVyZUZvcm1hdC5uYW1lfV0gdG8gYSBiaW5kIGdyb3VwLmApO1xuICAgICAgICAgICAgdGhpcy5zZXRUZXh0dXJlKHRleHR1cmVGb3JtYXQubmFtZSwgdmFsdWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHtcbiAgICAgICAgICAgIHRoaXMuZGlydHkgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMuaW1wbC51cGRhdGUodGhpcyk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmV4cG9ydCB7IEJpbmRHcm91cCB9O1xuIl0sIm5hbWVzIjpbImlkIiwiQmluZEdyb3VwIiwiY29uc3RydWN0b3IiLCJncmFwaGljc0RldmljZSIsImZvcm1hdCIsImRlZmF1bHRVbmlmb3JtQnVmZmVyIiwiZGV2aWNlIiwiZGlydHkiLCJpbXBsIiwiY3JlYXRlQmluZEdyb3VwSW1wbCIsInRleHR1cmVzIiwidW5pZm9ybUJ1ZmZlcnMiLCJzZXRVbmlmb3JtQnVmZmVyIiwiVU5JRk9STV9CVUZGRVJfREVGQVVMVF9TTE9UX05BTUUiLCJEZWJ1ZyIsInRyYWNlIiwiVFJBQ0VJRF9CSU5ER1JPVVBfQUxMT0MiLCJkZXN0cm95IiwibmFtZSIsInVuaWZvcm1CdWZmZXIiLCJpbmRleCIsImJ1ZmZlckZvcm1hdHNNYXAiLCJnZXQiLCJhc3NlcnQiLCJ1bmRlZmluZWQiLCJzZXRUZXh0dXJlIiwidGV4dHVyZSIsInRleHR1cmVGb3JtYXRzTWFwIiwidXBkYXRlIiwidGV4dHVyZUZvcm1hdHMiLCJpIiwibGVuZ3RoIiwidGV4dHVyZUZvcm1hdCIsInZhbHVlIiwic2NvcGVJZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBSUEsSUFBSUEsRUFBRSxHQUFHLENBQUMsQ0FBQTs7QUFRVixNQUFNQyxTQUFTLENBQUM7QUFXWkMsRUFBQUEsV0FBVyxDQUFDQyxjQUFjLEVBQUVDLE1BQU0sRUFBRUMsb0JBQW9CLEVBQUU7QUFDdEQsSUFBQSxJQUFJLENBQUNM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
