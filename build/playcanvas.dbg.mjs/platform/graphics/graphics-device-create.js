import { Debug } from '../../core/debug.js';
import { platform } from '../../core/platform.js';
import { WebgpuGraphicsDevice } from './webgpu/webgpu-graphics-device.js';
import { DEVICETYPE_WEBGL2, DEVICETYPE_WEBGL1, DEVICETYPE_WEBGPU } from './constants.js';
import { WebglGraphicsDevice } from './webgl/webgl-graphics-device.js';

/**
 * Creates a graphics device.
 *
 * @param {HTMLCanvasElement} canvas - The canvas element.
 * @param {object} options - Graphics device options.
 * @param {string[]} [options.deviceTypes] - An array of DEVICETYPE_*** constants, defining the
 * order in which the devices are attempted to get created. Defaults to an empty array. If the
 * specified array does not contain [{@link DEVICETYPE_WEBGL2} or {@link DEVICETYPE_WEBGL1}], those
 * are internally added to its end in this order. Typically, you'd only specify
 * {@link DEVICETYPE_WEBGPU}, or leave it empty.
 * @param {boolean} [options.antialias] - Boolean that indicates whether or not to perform
 * anti-aliasing if possible. Defaults to true.
 * @param {boolean} [options.depth=true] - Boolean that indicates that the drawing buffer is
 * requested to have a depth buffer of at least 16 bits.
 * @param {boolean} [options.stencil=true] - Boolean that indicates that the drawing buffer is
 * requested to have a stencil buffer of at least 8 bits.
 * @param {string} [options.glslangUrl] - The URL to the glslang script. Required if the
 * {@link DEVICETYPE_WEBGPU} type is added to deviceTypes array. Not used for
 * {@link DEVICETYPE_WEBGL1} or {@link DEVICETYPE_WEBGL2} device type creation.
 * @param {string} [options.twgslUrl] - An url to twgsl script, required if glslangUrl was specified.
 * @param {boolean} [options.xrCompatible] - Boolean that hints to the user agent to use a
 * compatible graphics adapter for an immersive XR device.
 * @param {'default'|'high-performance'|'low-power'} [options.powerPreference='default'] - A
 * hint indicating what configuration of GPU would be selected. Possible values are:
 *
 * - 'default': Let the user agent decide which GPU configuration is most suitable. This is the
 * default value.
 * - 'high-performance': Prioritizes rendering performance over power consumption.
 * - 'low-power': Prioritizes power saving over rendering performance.
 *
 * @returns {Promise} - Promise object representing the created graphics device.
 */
function createGraphicsDevice(canvas, options = {}) {
  var _options$deviceTypes;
  const deviceTypes = (_options$deviceTypes = options.deviceTypes) != null ? _options$deviceTypes : [];

  // automatically added fallbacks
  if (!deviceTypes.includes(DEVICETYPE_WEBGL2)) {
    deviceTypes.push(DEVICETYPE_WEBGL2);
  }
  if (!deviceTypes.includes(DEVICETYPE_WEBGL1)) {
    deviceTypes.push(DEVICETYPE_WEBGL1);
  }

  // XR compatibility if not specified
  if (platform.browser && !!navigator.xr) {
    var _options$xrCompatible;
    (_options$xrCompatible = options.xrCompatible) != null ? _options$xrCompatible : options.xrCompatible = true;
  }
  let device;
  for (let i = 0; i < deviceTypes.length; i++) {
    var _window, _window$navigator;
    const deviceType = deviceTypes[i];
    if (deviceType === DEVICETYPE_WEBGPU && (_window = window) != null && (_window$navigator = _window.navigator) != null && _window$navigator.gpu) {
      device = new WebgpuGraphicsDevice(canvas, options);
      return device.initWebGpu(options.glslangUrl, options.twgslUrl);
    }
    if (deviceType !== DEVICETYPE_WEBGPU) {
      options.preferWebGl2 = deviceType === DEVICETYPE_WEBGL2;
      device = new WebglGraphicsDevice(canvas, options);
      return Promise.resolve(device);
    }
  }
  Debug.assert(device, 'Failed to allocate graphics device based on requested device types: ', options.deviceTypes);
  return Promise.reject(new Error("Failed to allocate graphics device"));
}

export { createGraphicsDevice };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhcGhpY3MtZGV2aWNlLWNyZWF0ZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3BsYXRmb3JtL2dyYXBoaWNzL2dyYXBoaWNzLWRldmljZS1jcmVhdGUuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGVidWcgfSBmcm9tICcuLi8uLi9jb3JlL2RlYnVnLmpzJztcbmltcG9ydCB7IHBsYXRmb3JtIH0gZnJvbSAnLi4vLi4vY29yZS9wbGF0Zm9ybS5qcyc7XG5cbmltcG9ydCB7IFdlYmdwdUdyYXBoaWNzRGV2aWNlIH0gZnJvbSAnLi93ZWJncHUvd2ViZ3B1LWdyYXBoaWNzLWRldmljZS5qcyc7XG5pbXBvcnQgeyBERVZJQ0VUWVBFX1dFQkdMMiwgREVWSUNFVFlQRV9XRUJHTDEsIERFVklDRVRZUEVfV0VCR1BVIH0gZnJvbSAnLi9jb25zdGFudHMuanMnO1xuaW1wb3J0IHsgV2ViZ2xHcmFwaGljc0RldmljZSB9IGZyb20gJy4vd2ViZ2wvd2ViZ2wtZ3JhcGhpY3MtZGV2aWNlLmpzJztcblxuLyoqXG4gKiBDcmVhdGVzIGEgZ3JhcGhpY3MgZGV2aWNlLlxuICpcbiAqIEBwYXJhbSB7SFRNTENhbnZhc0VsZW1lbnR9IGNhbnZhcyAtIFRoZSBjYW52YXMgZWxlbWVudC5cbiAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIC0gR3JhcGhpY3MgZGV2aWNlIG9wdGlvbnMuXG4gKiBAcGFyYW0ge3N0cmluZ1tdfSBbb3B0aW9ucy5kZXZpY2VUeXBlc10gLSBBbiBhcnJheSBvZiBERVZJQ0VUWVBFXyoqKiBjb25zdGFudHMsIGRlZmluaW5nIHRoZVxuICogb3JkZXIgaW4gd2hpY2ggdGhlIGRldmljZXMgYXJlIGF0dGVtcHRlZCB0byBnZXQgY3JlYXRlZC4gRGVmYXVsdHMgdG8gYW4gZW1wdHkgYXJyYXkuIElmIHRoZVxuICogc3BlY2lmaWVkIGFycmF5IGRvZXMgbm90IGNvbnRhaW4gW3tAbGluayBERVZJQ0VUWVBFX1dFQkdMMn0gb3Ige0BsaW5rIERFVklDRVRZUEVfV0VCR0wxfV0sIHRob3NlXG4gKiBhcmUgaW50ZXJuYWxseSBhZGRlZCB0byBpdHMgZW5kIGluIHRoaXMgb3JkZXIuIFR5cGljYWxseSwgeW91J2Qgb25seSBzcGVjaWZ5XG4gKiB7QGxpbmsgREVWSUNFVFlQRV9XRUJHUFV9LCBvciBsZWF2ZSBpdCBlbXB0eS5cbiAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMuYW50aWFsaWFzXSAtIEJvb2xlYW4gdGhhdCBpbmRpY2F0ZXMgd2hldGhlciBvciBub3QgdG8gcGVyZm9ybVxuICogYW50aS1hbGlhc2luZyBpZiBwb3NzaWJsZS4gRGVmYXVsdHMgdG8gdHJ1ZS5cbiAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMuZGVwdGg9dHJ1ZV0gLSBCb29sZWFuIHRoYXQgaW5kaWNhdGVzIHRoYXQgdGhlIGRyYXdpbmcgYnVmZmVyIGlzXG4gKiByZXF1ZXN0ZWQgdG8gaGF2ZSBhIGRlcHRoIGJ1ZmZlciBvZiBhdCBsZWFzdCAxNiBiaXRzLlxuICogQHBhcmFtIHtib29sZWFufSBbb3B0aW9ucy5zdGVuY2lsPXRydWVdIC0gQm9vbGVhbiB0aGF0IGluZGljYXRlcyB0aGF0IHRoZSBkcmF3aW5nIGJ1ZmZlciBpc1xuICogcmVxdWVzdGVkIHRvIGhhdmUgYSBzdGVuY2lsIGJ1ZmZlciBvZiBhdCBsZWFzdCA4IGJpdHMuXG4gKiBAcGFyYW0ge3N0cmluZ30gW29wdGlvbnMuZ2xzbGFuZ1VybF0gLSBUaGUgVVJMIHRvIHRoZSBnbHNsYW5nIHNjcmlwdC4gUmVxdWlyZWQgaWYgdGhlXG4gKiB7QGxpbmsgREVWSUNFVFlQRV9XRUJHUFV9IHR5cGUgaXMgYWRkZWQgdG8gZGV2aWNlVHlwZXMgYXJyYXkuIE5vdCB1c2VkIGZvclxuICoge0BsaW5rIERFVklDRVRZUEVfV0VCR0wxfSBvciB7QGxpbmsgREVWSUNFVFlQRV9XRUJHTDJ9IGRldmljZSB0eXBlIGNyZWF0aW9uLlxuICogQHBhcmFtIHtzdHJpbmd9IFtvcHRpb25zLnR3Z3NsVXJsXSAtIEFuIHVybCB0byB0d2dzbCBzY3JpcHQsIHJlcXVpcmVkIGlmIGdsc2xhbmdVcmwgd2FzIHNwZWNpZmllZC5cbiAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMueHJDb21wYXRpYmxlXSAtIEJvb2xlYW4gdGhhdCBoaW50cyB0byB0aGUgdXNlciBhZ2VudCB0byB1c2UgYVxuICogY29tcGF0aWJsZSBncmFwaGljcyBhZGFwdGVyIGZvciBhbiBpbW1lcnNpdmUgWFIgZGV2aWNlLlxuICogQHBhcmFtIHsnZGVmYXVsdCd8J2hpZ2gtcGVyZm9ybWFuY2UnfCdsb3ctcG93ZXInfSBbb3B0aW9ucy5wb3dlclByZWZlcmVuY2U9J2RlZmF1bHQnXSAtIEFcbiAqIGhpbnQgaW5kaWNhdGluZyB3aGF0IGNvbmZpZ3VyYXRpb24gb2YgR1BVIHdvdWxkIGJlIHNlbGVjdGVkLiBQb3NzaWJsZSB2YWx1ZXMgYXJlOlxuICpcbiAqIC0gJ2RlZmF1bHQnOiBMZXQgdGhlIHVzZXIgYWdlbnQgZGVjaWRlIHdoaWNoIEdQVSBjb25maWd1cmF0aW9uIGlzIG1vc3Qgc3VpdGFibGUuIFRoaXMgaXMgdGhlXG4gKiBkZWZhdWx0IHZhbHVlLlxuICogLSAnaGlnaC1wZXJmb3JtYW5jZSc6IFByaW9yaXRpemVzIHJlbmRlcmluZyBwZXJmb3JtYW5jZSBvdmVyIHBvd2VyIGNvbnN1bXB0aW9uLlxuICogLSAnbG93LXBvd2VyJzogUHJpb3JpdGl6ZXMgcG93ZXIgc2F2aW5nIG92ZXIgcmVuZGVyaW5nIHBlcmZvcm1hbmNlLlxuICpcbiAqIEByZXR1cm5zIHtQcm9taXNlfSAtIFByb21pc2Ugb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgY3JlYXRlZCBncmFwaGljcyBkZXZpY2UuXG4gKi9cbmZ1bmN0aW9uIGNyZWF0ZUdyYXBoaWNzRGV2aWNlKGNhbnZhcywgb3B0aW9ucyA9IHt9KSB7XG5cbiAgICBjb25zdCBkZXZpY2VUeXBlcyA9IG9wdGlvbnMuZGV2aWNlVHlwZXMgPz8gW107XG5cbiAgICAvLyBhdXRvbWF0aWNhbGx5IGFkZGVkIGZhbGxiYWNrc1xuICAgIGlmICghZGV2aWNlVHlwZXMuaW5jbHVkZXMoREVWSUNFVFlQRV9XRUJHTDIpKSB7XG4gICAgICAgIGRldmljZVR5cGVzLnB1c2goREVWSUNFVFlQRV9XRUJHTDIpO1xuICAgIH1cbiAgICBpZiAoIWRldmljZVR5cGVzLmluY2x1ZGVzKERFVklDRVRZUEVfV0VCR0wxKSkge1xuICAgICAgICBkZXZpY2VUeXBlcy5wdXNoKERFVklDRVRZUEVfV0VCR0wxKTtcbiAgICB9XG5cbiAgICAvLyBYUiBjb21wYXRpYmlsaXR5IGlmIG5vdCBzcGVjaWZpZWRcbiAgICBpZiAocGxhdGZvcm0uYnJvd3NlciAmJiAhIW5hdmlnYXRvci54cikge1xuICAgICAgICBvcHRpb25zLnhyQ29tcGF0aWJsZSA/Pz0gdHJ1ZTtcbiAgICB9XG5cbiAgICBsZXQgZGV2aWNlO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGV2aWNlVHlwZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3QgZGV2aWNlVHlwZSA9IGRldmljZVR5cGVzW2ldO1xuXG4gICAgICAgIGlmIChkZXZpY2VUeXBlID09PSBERVZJQ0VUWVBFX1dFQkdQVSAmJiB3aW5kb3c/Lm5hdmlnYXRvcj8uZ3B1KSB7XG4gICAgICAgICAgICBkZXZpY2UgPSBuZXcgV2ViZ3B1R3JhcGhpY3NEZXZpY2UoY2FudmFzLCBvcHRpb25zKTtcbiAgICAgICAgICAgIHJldHVybiBkZXZpY2UuaW5pdFdlYkdwdShvcHRpb25zLmdsc2xhbmdVcmwsIG9wdGlvbnMudHdnc2xVcmwpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGRldmljZVR5cGUgIT09IERFVklDRVRZUEVfV0VCR1BVKSB7XG4gICAgICAgICAgICBvcHRpb25zLnByZWZlcldlYkdsMiA9IGRldmljZVR5cGUgPT09IERFVklDRVRZUEVfV0VCR0wyO1xuICAgICAgICAgICAgZGV2aWNlID0gbmV3IFdlYmdsR3JhcGhpY3NEZXZpY2UoY2FudmFzLCBvcHRpb25zKTtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZGV2aWNlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIERlYnVnLmFzc2VydChkZXZpY2UsICdGYWlsZWQgdG8gYWxsb2NhdGUgZ3JhcGhpY3MgZGV2aWNlIGJhc2VkIG9uIHJlcXVlc3RlZCBkZXZpY2UgdHlwZXM6ICcsIG9wdGlvbnMuZGV2aWNlVHlwZXMpO1xuICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoXCJGYWlsZWQgdG8gYWxsb2NhdGUgZ3JhcGhpY3MgZGV2aWNlXCIpKTtcbn1cblxuZXhwb3J0IHsgY3JlYXRlR3JhcGhpY3NEZXZpY2UgfTtcbiJdLCJuYW1lcyI6WyJjcmVhdGVHcmFwaGljc0RldmljZSIsImNhbnZhcyIsIm9wdGlvbnMiLCJfb3B0aW9ucyRkZXZpY2VUeXBlcyIsImRldmljZVR5cGVzIiwiaW5jbHVkZXMiLCJERVZJQ0VUWVBFX1dFQkdMMiIsInB1c2giLCJERVZJQ0VUWVBFX1dFQkdMMSIsInBsYXRmb3JtIiwiYnJvd3NlciIsIm5hdmlnYXRvciIsInhyIiwiX29wdGlvbnMkeHJDb21wYXRpYmxlIiwieHJDb21wYXRpYmxlIiwiZGV2aWNlIiwiaSIsImxlbmd0aCIsIl93aW5kb3ciLCJfd2luZG93JG5hdmlnYXRvciIsImRldmljZVR5cGUiLCJERVZJQ0VUWVBFX1dFQkdQVSIsIndpbmRvdyIsImdwdSIsIldlYmdwdUdyYXBoaWNzRGV2aWNlIiwiaW5pdFdlYkdwdSIsImdsc2xhbmdVcmwiLCJ0d2dzbFVybCIsInByZWZlcldlYkdsMiIsIldlYmdsR3JhcGhpY3NEZXZpY2UiLCJQcm9taXNlIiwicmVzb2x2ZSIsIkRlYnVnIiwiYXNzZXJ0IiwicmVqZWN0IiwiRXJyb3IiXSwibWFwcGluZ3MiOiI7Ozs7OztBQU9BO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNB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
