import { Debug } from '../../core/debug.js';
import { uniformTypeToName, UNIFORMTYPE_FLOAT, UNIFORMTYPE_VEC2, UNIFORMTYPE_VEC3, UNIFORMTYPE_VEC4, UNIFORMTYPE_INT, UNIFORMTYPE_IVEC2, UNIFORMTYPE_IVEC3, UNIFORMTYPE_IVEC4, UNIFORMTYPE_MAT2, UNIFORMTYPE_MAT3, UNIFORMTYPE_FLOATARRAY, UNIFORMTYPE_VEC2ARRAY, UNIFORMTYPE_VEC3ARRAY } from './constants.js';
import { DynamicBufferAllocation } from './dynamic-buffers.js';

// Uniform buffer set functions - only implemented for types for which the default
// array to buffer copy does not work, or could be slower.
const _updateFunctions = [];
_updateFunctions[UNIFORMTYPE_FLOAT] = function (uniformBuffer, value, offset) {
  const dst = uniformBuffer.storageFloat32;
  dst[offset] = value;
};
_updateFunctions[UNIFORMTYPE_VEC2] = (uniformBuffer, value, offset) => {
  const dst = uniformBuffer.storageFloat32;
  dst[offset] = value[0];
  dst[offset + 1] = value[1];
};
_updateFunctions[UNIFORMTYPE_VEC3] = (uniformBuffer, value, offset) => {
  const dst = uniformBuffer.storageFloat32;
  dst[offset] = value[0];
  dst[offset + 1] = value[1];
  dst[offset + 2] = value[2];
};
_updateFunctions[UNIFORMTYPE_VEC4] = (uniformBuffer, value, offset) => {
  const dst = uniformBuffer.storageFloat32;
  dst[offset] = value[0];
  dst[offset + 1] = value[1];
  dst[offset + 2] = value[2];
  dst[offset + 3] = value[3];
};
_updateFunctions[UNIFORMTYPE_INT] = function (uniformBuffer, value, offset) {
  const dst = uniformBuffer.storageInt32;
  dst[offset] = value;
};
_updateFunctions[UNIFORMTYPE_IVEC2] = function (uniformBuffer, value, offset) {
  const dst = uniformBuffer.storageInt32;
  dst[offset] = value[0];
  dst[offset + 1] = value[1];
};
_updateFunctions[UNIFORMTYPE_IVEC3] = function (uniformBuffer, value, offset) {
  const dst = uniformBuffer.storageInt32;
  dst[offset] = value[0];
  dst[offset + 1] = value[1];
  dst[offset + 2] = value[2];
};
_updateFunctions[UNIFORMTYPE_IVEC4] = function (uniformBuffer, value, offset) {
  const dst = uniformBuffer.storageInt32;
  dst[offset] = value[0];
  dst[offset + 1] = value[1];
  dst[offset + 2] = value[2];
  dst[offset + 3] = value[3];
};

// convert from continuous array to vec2[3] with padding to vec4[2]
_updateFunctions[UNIFORMTYPE_MAT2] = (uniformBuffer, value, offset) => {
  const dst = uniformBuffer.storageFloat32;
  dst[offset] = value[0];
  dst[offset + 1] = value[1];
  dst[offset + 4] = value[2];
  dst[offset + 5] = value[3];
  dst[offset + 8] = value[4];
  dst[offset + 9] = value[5];
};

// convert from continuous array to vec3[3] with padding to vec4[3]
_updateFunctions[UNIFORMTYPE_MAT3] = (uniformBuffer, value, offset) => {
  const dst = uniformBuffer.storageFloat32;
  dst[offset] = value[0];
  dst[offset + 1] = value[1];
  dst[offset + 2] = value[2];
  dst[offset + 4] = value[3];
  dst[offset + 5] = value[4];
  dst[offset + 6] = value[5];
  dst[offset + 8] = value[6];
  dst[offset + 9] = value[7];
  dst[offset + 10] = value[8];
};
_updateFunctions[UNIFORMTYPE_FLOATARRAY] = function (uniformBuffer, value, offset, count) {
  const dst = uniformBuffer.storageFloat32;
  for (let i = 0; i < count; i++) {
    dst[offset + i * 4] = value[i];
  }
};
_updateFunctions[UNIFORMTYPE_VEC2ARRAY] = (uniformBuffer, value, offset, count) => {
  const dst = uniformBuffer.storageFloat32;
  for (let i = 0; i < count; i++) {
    dst[offset + i * 4] = value[i * 2];
    dst[offset + i * 4 + 1] = value[i * 2 + 1];
  }
};
_updateFunctions[UNIFORMTYPE_VEC3ARRAY] = (uniformBuffer, value, offset, count) => {
  const dst = uniformBuffer.storageFloat32;
  for (let i = 0; i < count; i++) {
    dst[offset + i * 4] = value[i * 3];
    dst[offset + i * 4 + 1] = value[i * 3 + 1];
    dst[offset + i * 4 + 2] = value[i * 3 + 2];
  }
};

/**
 * A uniform buffer represents a GPU memory buffer storing the uniforms.
 *
 * @ignore
 */
class UniformBuffer {
  /**
   * Create a new UniformBuffer instance.
   *
   * @param {import('./graphics-device.js').GraphicsDevice} graphicsDevice - The graphics device
   * used to manage this uniform buffer.
   * @param {import('./uniform-buffer-format.js').UniformBufferFormat} format - Format of the
   * uniform buffer.
   * @param {boolean} [persistent] - Whether the buffer is persistent. Defaults to true.
   */
  constructor(graphicsDevice, format, persistent = true) {
    this.device = void 0;
    /** @type {boolean} */
    this.persistent = void 0;
    /** @type {DynamicBufferAllocation} */
    this.allocation = void 0;
    /** @type {Float32Array} */
    this.storageFloat32 = void 0;
    /** @type {Int32Array} */
    this.storageInt32 = void 0;
    /**
     * A render version used to track the last time the properties requiring bind group to be
     * updated were changed.
     *
     * @type {number}
     */
    this.renderVersionDirty = 0;
    this.device = graphicsDevice;
    this.format = format;
    this.persistent = persistent;
    Debug.assert(format);
    if (persistent) {
      this.impl = graphicsDevice.createUniformBufferImpl(this);
      const storage = new ArrayBuffer(format.byteSize);
      this.assignStorage(new Int32Array(storage));
      graphicsDevice._vram.ub += this.format.byteSize;

      // TODO: register with the device and handle lost context
      // this.device.buffers.push(this);
    } else {
      this.allocation = new DynamicBufferAllocation();
    }
  }

  /**
   * Frees resources associated with this uniform buffer.
   */
  destroy() {
    if (this.persistent) {
      // stop tracking the vertex buffer
      // TODO: remove the buffer from the list on the device (lost context handling)
      const device = this.device;
      this.impl.destroy(device);
      device._vram.ub -= this.format.byteSize;
    }
  }
  get offset() {
    return this.persistent ? 0 : this.allocation.offset;
  }

  /**
   * Assign a storage to this uniform buffer.
   *
   * @param {Int32Array} storage - The storage to assign to this uniform buffer.
   */
  assignStorage(storage) {
    this.storageInt32 = storage;
    this.storageFloat32 = new Float32Array(storage.buffer, storage.byteOffset, storage.byteLength / 4);
  }

  /**
   * Called when the rendering context was lost. It releases all context related resources.
   *
   * @ignore
   */
  loseContext() {
    var _this$impl;
    (_this$impl = this.impl) == null ? void 0 : _this$impl.loseContext();
  }

  /**
   * Assign a value to the uniform specified by its format. This is the fast version of assigning
   * a value to a uniform, avoiding any lookups.
   *
   * @param {import('./uniform-buffer-format.js').UniformFormat} uniformFormat - The format of
   * the uniform.
   */
  setUniform(uniformFormat) {
    Debug.assert(uniformFormat);
    const offset = uniformFormat.offset;
    const value = uniformFormat.scopeId.value;
    if (value !== null && value !== undefined) {
      const updateFunction = _updateFunctions[uniformFormat.updateType];
      if (updateFunction) {
        updateFunction(this, value, offset, uniformFormat.count);
      } else {
        this.storageFloat32.set(value, offset);
      }
    } else {
      Debug.warnOnce(`Value was not set when assigning to uniform [${uniformFormat.name}]` + `, expected type ${uniformTypeToName[uniformFormat.type]}`);
    }
  }

  /**
   * Assign a value to the uniform specified by name.
   *
   * @param {string} name - The name of the uniform.
   */
  set(name) {
    const uniformFormat = this.format.map.get(name);
    Debug.assert(uniformFormat, `Uniform name [${name}] is not part of the Uniform buffer.`);
    if (uniformFormat) {
      this.setUniform(uniformFormat);
    }
  }
  update() {
    const persistent = this.persistent;
    if (!persistent) {
      // allocate memory from dynamic buffer for this frame
      const allocation = this.allocation;
      const oldGpuBuffer = allocation.gpuBuffer;
      this.device.dynamicBuffers.alloc(allocation, this.format.byteSize);
      this.assignStorage(allocation.storage);

      // buffer has changed, update the render version to force bind group to be updated
      if (oldGpuBuffer !== allocation.gpuBuffer) {
        this.renderVersionDirty = this.device.renderVersion;
      }
    }

    // set new values
    const uniforms = this.format.uniforms;
    for (let i = 0; i < uniforms.length; i++) {
      this.setUniform(uniforms[i]);
    }
    if (persistent) {
      // Upload the new data
      this.impl.unlock(this);
    } else {
      this.storageFloat32 = null;
      this.storageInt32 = null;
    }
  }
}

export { UniformBuffer };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidW5pZm9ybS1idWZmZXIuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9wbGF0Zm9ybS9ncmFwaGljcy91bmlmb3JtLWJ1ZmZlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEZWJ1ZyB9IGZyb20gJy4uLy4uL2NvcmUvZGVidWcuanMnO1xuaW1wb3J0IHtcbiAgICB1bmlmb3JtVHlwZVRvTmFtZSxcbiAgICBVTklGT1JNVFlQRV9JTlQsIFVOSUZPUk1UWVBFX0ZMT0FULCBVTklGT1JNVFlQRV9WRUMyLCBVTklGT1JNVFlQRV9WRUMzLFxuICAgIFVOSUZPUk1UWVBFX1ZFQzQsIFVOSUZPUk1UWVBFX0lWRUMyLCBVTklGT1JNVFlQRV9JVkVDMywgVU5JRk9STVRZUEVfSVZFQzQsXG4gICAgVU5JRk9STVRZUEVfRkxPQVRBUlJBWSwgVU5JRk9STVRZUEVfVkVDMkFSUkFZLCBVTklGT1JNVFlQRV9WRUMzQVJSQVksXG4gICAgVU5JRk9STVRZUEVfTUFUMiwgVU5JRk9STVRZUEVfTUFUM1xufSBmcm9tICcuL2NvbnN0YW50cy5qcyc7XG5pbXBvcnQgeyBEeW5hbWljQnVmZmVyQWxsb2NhdGlvbiB9IGZyb20gJy4vZHluYW1pYy1idWZmZXJzLmpzJztcblxuLy8gVW5pZm9ybSBidWZmZXIgc2V0IGZ1bmN0aW9ucyAtIG9ubHkgaW1wbGVtZW50ZWQgZm9yIHR5cGVzIGZvciB3aGljaCB0aGUgZGVmYXVsdFxuLy8gYXJyYXkgdG8gYnVmZmVyIGNvcHkgZG9lcyBub3Qgd29yaywgb3IgY291bGQgYmUgc2xvd2VyLlxuY29uc3QgX3VwZGF0ZUZ1bmN0aW9ucyA9IFtdO1xuXG5fdXBkYXRlRnVuY3Rpb25zW1VOSUZPUk1UWVBFX0ZMT0FUXSA9IGZ1bmN0aW9uICh1bmlmb3JtQnVmZmVyLCB2YWx1ZSwgb2Zmc2V0KSB7XG4gICAgY29uc3QgZHN0ID0gdW5pZm9ybUJ1ZmZlci5zdG9yYWdlRmxvYXQzMjtcbiAgICBkc3Rbb2Zmc2V0XSA9IHZhbHVlO1xufTtcblxuX3VwZGF0ZUZ1bmN0aW9uc1tVTklGT1JNVFlQRV9WRUMyXSA9ICh1bmlmb3JtQnVmZmVyLCB2YWx1ZSwgb2Zmc2V0KSA9PiB7XG4gICAgY29uc3QgZHN0ID0gdW5pZm9ybUJ1ZmZlci5zdG9yYWdlRmxvYXQzMjtcbiAgICBkc3Rbb2Zmc2V0XSA9IHZhbHVlWzBdO1xuICAgIGRzdFtvZmZzZXQgKyAxXSA9IHZhbHVlWzFdO1xufTtcblxuX3VwZGF0ZUZ1bmN0aW9uc1tVTklGT1JNVFlQRV9WRUMzXSA9ICh1bmlmb3JtQnVmZmVyLCB2YWx1ZSwgb2Zmc2V0KSA9PiB7XG4gICAgY29uc3QgZHN0ID0gdW5pZm9ybUJ1ZmZlci5zdG9yYWdlRmxvYXQzMjtcbiAgICBkc3Rbb2Zmc2V0XSA9IHZhbHVlWzBdO1xuICAgIGRzdFtvZmZzZXQgKyAxXSA9IHZhbHVlWzFdO1xuICAgIGRzdFtvZmZzZXQgKyAyXSA9IHZhbHVlWzJdO1xufTtcblxuX3VwZGF0ZUZ1bmN0aW9uc1tVTklGT1JNVFlQRV9WRUM0XSA9ICh1bmlmb3JtQnVmZmVyLCB2YWx1ZSwgb2Zmc2V0KSA9PiB7XG4gICAgY29uc3QgZHN0ID0gdW5pZm9ybUJ1ZmZlci5zdG9yYWdlRmxvYXQzMjtcbiAgICBkc3Rbb2Zmc2V0XSA9IHZhbHVlWzBdO1xuICAgIGRzdFtvZmZzZXQgKyAxXSA9IHZhbHVlWzFdO1xuICAgIGRzdFtvZmZzZXQgKyAyXSA9IHZhbHVlWzJdO1xuICAgIGRzdFtvZmZzZXQgKyAzXSA9IHZhbHVlWzNdO1xufTtcblxuX3VwZGF0ZUZ1bmN0aW9uc1tVTklGT1JNVFlQRV9JTlRdID0gZnVuY3Rpb24gKHVuaWZvcm1CdWZmZXIsIHZhbHVlLCBvZmZzZXQpIHtcbiAgICBjb25zdCBkc3QgPSB1bmlmb3JtQnVmZmVyLnN0b3JhZ2VJbnQzMjtcbiAgICBkc3Rbb2Zmc2V0XSA9IHZhbHVlO1xufTtcblxuX3VwZGF0ZUZ1bmN0aW9uc1tVTklGT1JNVFlQRV9JVkVDMl0gPSBmdW5jdGlvbiAodW5pZm9ybUJ1ZmZlciwgdmFsdWUsIG9mZnNldCkge1xuICAgIGNvbnN0IGRzdCA9IHVuaWZvcm1CdWZmZXIuc3RvcmFnZUludDMyO1xuICAgIGRzdFtvZmZzZXRdID0gdmFsdWVbMF07XG4gICAgZHN0W29mZnNldCArIDFdID0gdmFsdWVbMV07XG59O1xuXG5fdXBkYXRlRnVuY3Rpb25zW1VOSUZPUk1UWVBFX0lWRUMzXSA9IGZ1bmN0aW9uICh1bmlmb3JtQnVmZmVyLCB2YWx1ZSwgb2Zmc2V0KSB7XG4gICAgY29uc3QgZHN0ID0gdW5pZm9ybUJ1ZmZlci5zdG9yYWdlSW50MzI7XG4gICAgZHN0W29mZnNldF0gPSB2YWx1ZVswXTtcbiAgICBkc3Rbb2Zmc2V0ICsgMV0gPSB2YWx1ZVsxXTtcbiAgICBkc3Rbb2Zmc2V0ICsgMl0gPSB2YWx1ZVsyXTtcbn07XG5cbl91cGRhdGVGdW5jdGlvbnNbVU5JRk9STVRZUEVfSVZFQzRdID0gZnVuY3Rpb24gKHVuaWZvcm1CdWZmZXIsIHZhbHVlLCBvZmZzZXQpIHtcbiAgICBjb25zdCBkc3QgPSB1bmlmb3JtQnVmZmVyLnN0b3JhZ2VJbnQzMjtcbiAgICBkc3Rbb2Zmc2V0XSA9IHZhbHVlWzBdO1xuICAgIGRzdFtvZmZzZXQgKyAxXSA9IHZhbHVlWzFdO1xuICAgIGRzdFtvZmZzZXQgKyAyXSA9IHZhbHVlWzJdO1xuICAgIGRzdFtvZmZzZXQgKyAzXSA9IHZhbHVlWzNdO1xufTtcblxuLy8gY29udmVydCBmcm9tIGNvbnRpbnVvdXMgYXJyYXkgdG8gdmVjMlszXSB3aXRoIHBhZGRpbmcgdG8gdmVjNFsyXVxuX3VwZGF0ZUZ1bmN0aW9uc1tVTklGT1JNVFlQRV9NQVQyXSA9ICh1bmlmb3JtQnVmZmVyLCB2YWx1ZSwgb2Zmc2V0KSA9PiB7XG4gICAgY29uc3QgZHN0ID0gdW5pZm9ybUJ1ZmZlci5zdG9yYWdlRmxvYXQzMjtcbiAgICBkc3Rbb2Zmc2V0XSA9IHZhbHVlWzBdO1xuICAgIGRzdFtvZmZzZXQgKyAxXSA9IHZhbHVlWzFdO1xuXG4gICAgZHN0W29mZnNldCArIDRdID0gdmFsdWVbMl07XG4gICAgZHN0W29mZnNldCArIDVdID0gdmFsdWVbM107XG5cbiAgICBkc3Rbb2Zmc2V0ICsgOF0gPSB2YWx1ZVs0XTtcbiAgICBkc3Rbb2Zmc2V0ICsgOV0gPSB2YWx1ZVs1XTtcbn07XG5cbi8vIGNvbnZlcnQgZnJvbSBjb250aW51b3VzIGFycmF5IHRvIHZlYzNbM10gd2l0aCBwYWRkaW5nIHRvIHZlYzRbM11cbl91cGRhdGVGdW5jdGlvbnNbVU5JRk9STVRZUEVfTUFUM10gPSAodW5pZm9ybUJ1ZmZlciwgdmFsdWUsIG9mZnNldCkgPT4ge1xuICAgIGNvbnN0IGRzdCA9IHVuaWZvcm1CdWZmZXIuc3RvcmFnZUZsb2F0MzI7XG4gICAgZHN0W29mZnNldF0gPSB2YWx1ZVswXTtcbiAgICBkc3Rbb2Zmc2V0ICsgMV0gPSB2YWx1ZVsxXTtcbiAgICBkc3Rbb2Zmc2V0ICsgMl0gPSB2YWx1ZVsyXTtcblxuICAgIGRzdFtvZmZzZXQgKyA0XSA9IHZhbHVlWzNdO1xuICAgIGRzdFtvZmZzZXQgKyA1XSA9IHZhbHVlWzRdO1xuICAgIGRzdFtvZmZzZXQgKyA2XSA9IHZhbHVlWzVdO1xuXG4gICAgZHN0W29mZnNldCArIDhdID0gdmFsdWVbNl07XG4gICAgZHN0W29mZnNldCArIDldID0gdmFsdWVbN107XG4gICAgZHN0W29mZnNldCArIDEwXSA9IHZhbHVlWzhdO1xufTtcblxuX3VwZGF0ZUZ1bmN0aW9uc1tVTklGT1JNVFlQRV9GTE9BVEFSUkFZXSA9IGZ1bmN0aW9uICh1bmlmb3JtQnVmZmVyLCB2YWx1ZSwgb2Zmc2V0LCBjb3VudCkge1xuICAgIGNvbnN0IGRzdCA9IHVuaWZvcm1CdWZmZXIuc3RvcmFnZUZsb2F0MzI7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7XG4gICAgICAgIGRzdFtvZmZzZXQgKyBpICogNF0gPSB2YWx1ZVtpXTtcbiAgICB9XG59O1xuXG5fdXBkYXRlRnVuY3Rpb25zW1VOSUZPUk1UWVBFX1ZFQzJBUlJBWV0gPSAodW5pZm9ybUJ1ZmZlciwgdmFsdWUsIG9mZnNldCwgY291bnQpID0+IHtcbiAgICBjb25zdCBkc3QgPSB1bmlmb3JtQnVmZmVyLnN0b3JhZ2VGbG9hdDMyO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnQ7IGkrKykge1xuICAgICAgICBkc3Rbb2Zmc2V0ICsgaSAqIDRdID0gdmFsdWVbaSAqIDJdO1xuICAgICAgICBkc3Rbb2Zmc2V0ICsgaSAqIDQgKyAxXSA9IHZhbHVlW2kgKiAyICsgMV07XG4gICAgfVxufTtcblxuX3VwZGF0ZUZ1bmN0aW9uc1tVTklGT1JNVFlQRV9WRUMzQVJSQVldID0gKHVuaWZvcm1CdWZmZXIsIHZhbHVlLCBvZmZzZXQsIGNvdW50KSA9PiB7XG4gICAgY29uc3QgZHN0ID0gdW5pZm9ybUJ1ZmZlci5zdG9yYWdlRmxvYXQzMjtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHtcbiAgICAgICAgZHN0W29mZnNldCArIGkgKiA0XSA9IHZhbHVlW2kgKiAzXTtcbiAgICAgICAgZHN0W29mZnNldCArIGkgKiA0ICsgMV0gPSB2YWx1ZVtpICogMyArIDFdO1xuICAgICAgICBkc3Rbb2Zmc2V0ICsgaSAqIDQgKyAyXSA9IHZhbHVlW2kgKiAzICsgMl07XG4gICAgfVxufTtcblxuLyoqXG4gKiBBIHVuaWZvcm0gYnVmZmVyIHJlcHJlc2VudHMgYSBHUFUgbWVtb3J5IGJ1ZmZlciBzdG9yaW5nIHRoZSB1bmlmb3Jtcy5cbiAqXG4gKiBAaWdub3JlXG4gKi9cbmNsYXNzIFVuaWZvcm1CdWZmZXIge1xuICAgIGRldmljZTtcblxuICAgIC8qKiBAdHlwZSB7Ym9vbGVhbn0gKi9cbiAgICBwZXJzaXN0ZW50O1xuXG4gICAgLyoqIEB0eXBlIHtEeW5hbWljQnVmZmVyQWxsb2NhdGlvbn0gKi9cbiAgICBhbGxvY2F0aW9uO1xuXG4gICAgLyoqIEB0eXBlIHtGbG9hdDMyQXJyYXl9ICovXG4gICAgc3RvcmFnZUZsb2F0MzI7XG5cbiAgICAvKiogQHR5cGUge0ludDMyQXJyYXl9ICovXG4gICAgc3RvcmFnZUludDMyO1xuXG4gICAgLyoqXG4gICAgICogQSByZW5kZXIgdmVyc2lvbiB1c2VkIHRvIHRyYWNrIHRoZSBsYXN0IHRpbWUgdGhlIHByb3BlcnRpZXMgcmVxdWlyaW5nIGJpbmQgZ3JvdXAgdG8gYmVcbiAgICAgKiB1cGRhdGVkIHdlcmUgY2hhbmdlZC5cbiAgICAgKlxuICAgICAqIEB0eXBlIHtudW1iZXJ9XG4gICAgICovXG4gICAgcmVuZGVyVmVyc2lvbkRpcnR5ID0gMDtcblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIG5ldyBVbmlmb3JtQnVmZmVyIGluc3RhbmNlLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtpbXBvcnQoJy4vZ3JhcGhpY3MtZGV2aWNlLmpzJykuR3JhcGhpY3NEZXZpY2V9IGdyYXBoaWNzRGV2aWNlIC0gVGhlIGdyYXBoaWNzIGRldmljZVxuICAgICAqIHVzZWQgdG8gbWFuYWdlIHRoaXMgdW5pZm9ybSBidWZmZXIuXG4gICAgICogQHBhcmFtIHtpbXBvcnQoJy4vdW5pZm9ybS1idWZmZXItZm9ybWF0LmpzJykuVW5pZm9ybUJ1ZmZlckZvcm1hdH0gZm9ybWF0IC0gRm9ybWF0IG9mIHRoZVxuICAgICAqIHVuaWZvcm0gYnVmZmVyLlxuICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3BlcnNpc3RlbnRdIC0gV2hldGhlciB0aGUgYnVmZmVyIGlzIHBlcnNpc3RlbnQuIERlZmF1bHRzIHRvIHRydWUuXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoZ3JhcGhpY3NEZXZpY2UsIGZvcm1hdCwgcGVyc2lzdGVudCA9IHRydWUpIHtcbiAgICAgICAgdGhpcy5kZXZpY2UgPSBncmFwaGljc0RldmljZTtcbiAgICAgICAgdGhpcy5mb3JtYXQgPSBmb3JtYXQ7XG4gICAgICAgIHRoaXMucGVyc2lzdGVudCA9IHBlcnNpc3RlbnQ7XG4gICAgICAgIERlYnVnLmFzc2VydChmb3JtYXQpO1xuXG4gICAgICAgIGlmIChwZXJzaXN0ZW50KSB7XG5cbiAgICAgICAgICAgIHRoaXMuaW1wbCA9IGdyYXBoaWNzRGV2aWNlLmNyZWF0ZVVuaWZvcm1CdWZmZXJJbXBsKHRoaXMpO1xuXG4gICAgICAgICAgICBjb25zdCBzdG9yYWdlID0gbmV3IEFycmF5QnVmZmVyKGZvcm1hdC5ieXRlU2l6ZSk7XG4gICAgICAgICAgICB0aGlzLmFzc2lnblN0b3JhZ2UobmV3IEludDMyQXJyYXkoc3RvcmFnZSkpO1xuXG4gICAgICAgICAgICBncmFwaGljc0RldmljZS5fdnJhbS51YiArPSB0aGlzLmZvcm1hdC5ieXRlU2l6ZTtcblxuICAgICAgICAgICAgLy8gVE9ETzogcmVnaXN0ZXIgd2l0aCB0aGUgZGV2aWNlIGFuZCBoYW5kbGUgbG9zdCBjb250ZXh0XG4gICAgICAgICAgICAvLyB0aGlzLmRldmljZS5idWZmZXJzLnB1c2godGhpcyk7XG4gICAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgICAgIHRoaXMuYWxsb2NhdGlvbiA9IG5ldyBEeW5hbWljQnVmZmVyQWxsb2NhdGlvbigpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRnJlZXMgcmVzb3VyY2VzIGFzc29jaWF0ZWQgd2l0aCB0aGlzIHVuaWZvcm0gYnVmZmVyLlxuICAgICAqL1xuICAgIGRlc3Ryb3koKSB7XG5cbiAgICAgICAgaWYgKHRoaXMucGVyc2lzdGVudCkge1xuICAgICAgICAgICAgLy8gc3RvcCB0cmFja2luZyB0aGUgdmVydGV4IGJ1ZmZlclxuICAgICAgICAgICAgLy8gVE9ETzogcmVtb3ZlIHRoZSBidWZmZXIgZnJvbSB0aGUgbGlzdCBvbiB0aGUgZGV2aWNlIChsb3N0IGNvbnRleHQgaGFuZGxpbmcpXG4gICAgICAgICAgICBjb25zdCBkZXZpY2UgPSB0aGlzLmRldmljZTtcblxuICAgICAgICAgICAgdGhpcy5pbXBsLmRlc3Ryb3koZGV2aWNlKTtcblxuICAgICAgICAgICAgZGV2aWNlLl92cmFtLnViIC09IHRoaXMuZm9ybWF0LmJ5dGVTaXplO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZ2V0IG9mZnNldCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucGVyc2lzdGVudCA/IDAgOiB0aGlzLmFsbG9jYXRpb24ub2Zmc2V0O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFzc2lnbiBhIHN0b3JhZ2UgdG8gdGhpcyB1bmlmb3JtIGJ1ZmZlci5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7SW50MzJBcnJheX0gc3RvcmFnZSAtIFRoZSBzdG9yYWdlIHRvIGFzc2lnbiB0byB0aGlzIHVuaWZvcm0gYnVmZmVyLlxuICAgICAqL1xuICAgIGFzc2lnblN0b3JhZ2Uoc3RvcmFnZSkge1xuICAgICAgICB0aGlzLnN0b3JhZ2VJbnQzMiA9IHN0b3JhZ2U7XG4gICAgICAgIHRoaXMuc3RvcmFnZUZsb2F0MzIgPSBuZXcgRmxvYXQzMkFycmF5KHN0b3JhZ2UuYnVmZmVyLCBzdG9yYWdlLmJ5dGVPZmZzZXQsIHN0b3JhZ2UuYnl0ZUxlbmd0aCAvIDQpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENhbGxlZCB3aGVuIHRoZSByZW5kZXJpbmcgY29udGV4dCB3YXMgbG9zdC4gSXQgcmVsZWFzZXMgYWxsIGNvbnRleHQgcmVsYXRlZCByZXNvdXJjZXMuXG4gICAgICpcbiAgICAgKiBAaWdub3JlXG4gICAgICovXG4gICAgbG9zZUNvbnRleHQoKSB7XG4gICAgICAgIHRoaXMuaW1wbD8ubG9zZUNvbnRleHQoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBc3NpZ24gYSB2YWx1ZSB0byB0aGUgdW5pZm9ybSBzcGVjaWZpZWQgYnkgaXRzIGZvcm1hdC4gVGhpcyBpcyB0aGUgZmFzdCB2ZXJzaW9uIG9mIGFzc2lnbmluZ1xuICAgICAqIGEgdmFsdWUgdG8gYSB1bmlmb3JtLCBhdm9pZGluZyBhbnkgbG9va3Vwcy5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7aW1wb3J0KCcuL3VuaWZvcm0tYnVmZmVyLWZvcm1hdC5qcycpLlVuaWZvcm1Gb3JtYXR9IHVuaWZvcm1Gb3JtYXQgLSBUaGUgZm9ybWF0IG9mXG4gICAgICogdGhlIHVuaWZvcm0uXG4gICAgICovXG4gICAgc2V0VW5pZm9ybSh1bmlmb3JtRm9ybWF0KSB7XG4gICAgICAgIERlYnVnLmFzc2VydCh1bmlmb3JtRm9ybWF0KTtcbiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gdW5pZm9ybUZvcm1hdC5vZmZzZXQ7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gdW5pZm9ybUZvcm1hdC5zY29wZUlkLnZhbHVlO1xuXG4gICAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7XG5cbiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZUZ1bmN0aW9uID0gX3VwZGF0ZUZ1bmN0aW9uc1t1bmlmb3JtRm9ybWF0LnVwZGF0ZVR5cGVdO1xuICAgICAgICAgICAgaWYgKHVwZGF0ZUZ1bmN0aW9uKSB7XG4gICAgICAgICAgICAgICAgdXBkYXRlRnVuY3Rpb24odGhpcywgdmFsdWUsIG9mZnNldCwgdW5pZm9ybUZvcm1hdC5jb3VudCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RvcmFnZUZsb2F0MzIuc2V0KHZhbHVlLCBvZmZzZXQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgRGVidWcud2Fybk9uY2UoYFZhbHVlIHdhcyBub3Qgc2V0IHdoZW4gYXNzaWduaW5nIHRvIHVuaWZvcm0gWyR7dW5pZm9ybUZvcm1hdC5uYW1lfV1gICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBgLCBleHBlY3RlZCB0eXBlICR7dW5pZm9ybVR5cGVUb05hbWVbdW5pZm9ybUZvcm1hdC50eXBlXX1gKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFzc2lnbiBhIHZhbHVlIHRvIHRoZSB1bmlmb3JtIHNwZWNpZmllZCBieSBuYW1lLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgdW5pZm9ybS5cbiAgICAgKi9cbiAgICBzZXQobmFtZSkge1xuICAgICAgICBjb25zdCB1bmlmb3JtRm9ybWF0ID0gdGhpcy5mb3JtYXQubWFwLmdldChuYW1lKTtcbiAgICAgICAgRGVidWcuYXNzZXJ0KHVuaWZvcm1Gb3JtYXQsIGBVbmlmb3JtIG5hbWUgWyR7bmFtZX1dIGlzIG5vdCBwYXJ0IG9mIHRoZSBVbmlmb3JtIGJ1ZmZlci5gKTtcbiAgICAgICAgaWYgKHVuaWZvcm1Gb3JtYXQpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0VW5pZm9ybSh1bmlmb3JtRm9ybWF0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHVwZGF0ZSgpIHtcblxuICAgICAgICBjb25zdCBwZXJzaXN0ZW50ID0gdGhpcy5wZXJzaXN0ZW50O1xuICAgICAgICBpZiAoIXBlcnNpc3RlbnQpIHtcblxuICAgICAgICAgICAgLy8gYWxsb2NhdGUgbWVtb3J5IGZyb20gZHluYW1pYyBidWZmZXIgZm9yIHRoaXMgZnJhbWVcbiAgICAgICAgICAgIGNvbnN0IGFsbG9jYXRpb24gPSB0aGlzLmFsbG9jYXRpb247XG4gICAgICAgICAgICBjb25zdCBvbGRHcHVCdWZmZXIgPSBhbGxvY2F0aW9uLmdwdUJ1ZmZlcjtcbiAgICAgICAgICAgIHRoaXMuZGV2aWNlLmR5bmFtaWNCdWZmZXJzLmFsbG9jKGFsbG9jYXRpb24sIHRoaXMuZm9ybWF0LmJ5dGVTaXplKTtcbiAgICAgICAgICAgIHRoaXMuYXNzaWduU3RvcmFnZShhbGxvY2F0aW9uLnN0b3JhZ2UpO1xuXG4gICAgICAgICAgICAvLyBidWZmZXIgaGFzIGNoYW5nZWQsIHVwZGF0ZSB0aGUgcmVuZGVyIHZlcnNpb24gdG8gZm9yY2UgYmluZCBncm91cCB0byBiZSB1cGRhdGVkXG4gICAgICAgICAgICBpZiAob2xkR3B1QnVmZmVyICE9PSBhbGxvY2F0aW9uLmdwdUJ1ZmZlcikge1xuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyVmVyc2lvbkRpcnR5ID0gdGhpcy5kZXZpY2UucmVuZGVyVmVyc2lvbjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHNldCBuZXcgdmFsdWVzXG4gICAgICAgIGNvbnN0IHVuaWZvcm1zID0gdGhpcy5mb3JtYXQudW5pZm9ybXM7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdW5pZm9ybXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHRoaXMuc2V0VW5pZm9ybSh1bmlmb3Jtc1tpXSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocGVyc2lzdGVudCkge1xuICAgICAgICAgICAgLy8gVXBsb2FkIHRoZSBuZXcgZGF0YVxuICAgICAgICAgICAgdGhpcy5pbXBsLnVubG9jayh0aGlzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuc3RvcmFnZUZsb2F0MzIgPSBudWxsO1xuICAgICAgICAgICAgdGhpcy5zdG9yYWdlSW50MzIgPSBudWxsO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5leHBvcnQgeyBVbmlmb3JtQnVmZmVyIH07XG4iXSwibmFtZXMiOlsiX3VwZGF0ZUZ1bmN0aW9ucyIsIlVOSUZPUk1UWVBFX0ZMT0FUIiwidW5pZm9ybUJ1ZmZlciIsInZhbHVlIiwib2Zmc2V0IiwiZHN0Iiwic3RvcmFnZUZsb2F0MzIiLCJVTklGT1JNVFlQRV9WRUMyIiwiVU5JRk9STVRZUEVfVkVDMyIsIlVOSUZPUk1UWVBFX1ZFQzQiLCJVTklGT1JNVFlQRV9JTlQiLCJzdG9yYWdlSW50MzIiLCJVTklGT1JNVFlQRV9JVkVDMiIsIlVOSUZPUk1UWVBFX0lWRUMzIiwiVU5JRk9STVRZUEVfSVZFQzQiLCJVTklGT1JNVFlQRV9NQVQyIiwiVU5JRk9STVRZUEVfTUFUMyIsIlVOSUZPUk1UWVBFX0ZMT0FUQVJSQVkiLCJjb3VudCIsImkiLCJVTklGT1JNVFlQRV9WRUMyQVJSQVkiLCJVTklGT1JNVFlQRV9WRUMzQVJSQVkiLCJVbmlmb3JtQnVmZmVyIiwiY29uc3RydWN0b3IiLCJncmFwaGljc0RldmljZSIsImZvcm1hdCIsInBlcnNpc3RlbnQiLCJkZXZpY2UiLCJhbGxvY2F0aW9uIiwicmVuZGVyVmVyc2lvbkRpcnR5IiwiRGVidWciLCJhc3NlcnQiLCJpbXBsIiwiY3JlYXRlVW5pZm9ybUJ1ZmZlckltcGwiLCJzdG9yYWdlIiwiQXJyYXlCdWZmZXIiLCJieXRlU2l6ZSIsImFzc2lnblN0b3JhZ2UiLCJJbnQzMkFycmF5IiwiX3ZyYW0iLCJ1YiIsIkR5bmFtaWNCdWZmZXJBbGxvY2F0aW9uIiwiZGVzdHJveSIsIkZsb2F0MzJBcnJheSIsImJ1ZmZlciIsImJ5dGVPZmZzZXQiLCJieXRlTGVuZ3RoIiwibG9zZUNvbnRleHQiLCJfdGhpcyRpbXBsIiwic2V0VW5pZm9ybSIsInVuaWZvcm1Gb3JtYXQiLCJzY29wZUlkIiwidW5kZWZpbmVkIiwidXBkYXRlRnVuY3Rpb24iLCJ1cGRhdGVUeXBlIiwic2V0Iiwid2Fybk9uY2UiLCJuYW1lIiwidW5pZm9ybVR5cGVUb05hbWUiLCJ0eXBlIiwibWFwIiwiZ2V0IiwidXBkYXRlIiwib2xkR3B1QnVmZmVyIiwiZ3B1QnVmZmVyIiwiZHluYW1pY0J1ZmZlcnMiLCJhbGxvYyIsInJlbmRlclZlcnNpb24iLCJ1bmlmb3JtcyIsImxlbmd0aCIsInVubG9jayJdLCJtYXBwaW5ncyI6Ijs7OztBQVVBO0FBQ0E7QUFDQSxNQUFNQSxnQkFBZ0IsR0FBRyxFQUFFLENBQUE7QUFFM0JBLGdCQUFnQixDQUFDQyxpQkFBaUIsQ0FBQyxHQUFHLFVBQVVDLGFBQWEsRUFBRUMsS0FBSyxFQUFFQyxNQUFNLEVBQUU7QUFDMUUsRUFBQSxNQUFNQyxHQUFHLEdBQUdILGFBQWEsQ0FBQ0ksY0FBYyxDQUFBO0FBQ3hDRCxFQUFBQSxHQUFHLENBQUNELE1BQU0sQ0FBQyxHQUFHRCxLQUFLLENBQUE7QUFDdkIsQ0FBQyxDQUFBO0FBRURILGdCQUFnQixDQUFDTyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUNMLGFBQWEsRUFBRUMsS0FBSyxFQUFFQyxNQUFNLEtBQUs7QUFDbkUsRUFBQSxNQUFNQyxHQUFHLEdBQUdILGFBQWEsQ0FBQ0ksY0FBYyxDQUFBO0FBQ3hDRCxFQUFBQSxHQUFHLENBQUNELE1BQU0sQ0FBQyxHQUFHRCxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7RUFDdEJFLEdBQUcsQ0FBQ0QsTUFBTSxHQUFHLENBQUMsQ0FBQyxHQUFHRCxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7QUFDOUIsQ0FBQyxDQUFBO0FBRURILGdCQUFnQixDQUFDUSxnQkFBZ0IsQ0FBQyxHQUFHLENBQUNOLGFBQWEsRUFBRUMsS0FBSyxFQUFFQyxNQUFNLEtBQUs7QUFDbkUsRUFBQSxNQUFNQyxHQUFHLEdBQUdILGFBQWEsQ0FBQ0ksY0FBYyxDQUFBO0FBQ3hDRCxFQUFBQSxHQUFHLENBQUNELE1BQU0sQ0FBQyxHQUFHRCxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7RUFDdEJFLEdBQUcsQ0FBQ0QsTUFBTSxHQUFHLENBQUMsQ0FBQyxHQUFHRCxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7RUFDMUJFLEdBQUcsQ0FBQ0QsTUFBTSxHQUFHLENBQUMsQ0FBQyxHQUFHRCxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7QUFDOUIsQ0FBQyxDQUFBO0FBRURILGdCQUFnQixDQUFDUyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUNQLGFBQWEsRUFBRUMsS0FBSyxFQUFFQyxNQUFNLEtBQUs7QUFDbkUsRUFBQSxNQUFNQyxHQUFHLEdBQUdILGFBQWEsQ0FBQ0ksY0FBYyxDQUFBO0FBQ3hDRCxFQUFBQSxHQUFHLENBQUNELE1BQU0sQ0FBQyxHQUFHRCxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7RUFDdEJFLEdBQUcsQ0FBQ0QsTUFBTSxHQUFHLENBQUMsQ0FBQyxHQUFHRCxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7RUFDMUJFLEdBQUcsQ0FBQ0QsTUFBTSxHQUFHLENBQUMsQ0FBQyxHQUFHRCxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7RUFDMUJFLEdBQUcsQ0FBQ0QsTUFBTSxHQUFHLENBQUMsQ0FBQyxHQUFHRCxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7QUFDOUIsQ0FBQyxDQUFBO0FBRURILGdCQUFnQixDQUFDVSxlQUFlLENBQUMsR0FBRyxVQUFVUixhQUFhLEVBQUVDLEtBQUssRUFBRUMsTUFBTSxFQUFFO0FBQ3hFLEVBQUEsTUFBTUMsR0FBRyxHQUFHSCxhQUFhLENBQUNTLFlBQVksQ0FBQTtBQUN0Q04sRUFBQUEsR0FBRyxDQUFDRCxNQUFNLENBQUMsR0FBR0QsS0FBSyxDQUFBO0FBQ3ZCLENBQUMsQ0FBQTtBQUVESCxnQkFBZ0IsQ0FBQ1ksaUJBQWlCLENBQUMsR0FBRyxVQUFVVixhQUFhLEVBQUVDLEtBQUssRUFBRUMsTUFBTSxFQUFFO0FBQzFFLEVBQUEsTUFBTUMsR0FBRyxHQUFHSCxhQUFhLENBQUNTLFlBQVksQ0FBQTtBQUN0Q04sRUFBQUEsR0FBRyxDQUFDRCxNQUFNLENBQUMsR0FBR0QsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO0VBQ3RCRSxHQUFHLENBQUNELE1BQU0sR0FBRyxDQUFDLENBQUMsR0FBR0QsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO0FBQzlCLENBQUMsQ0FBQTtBQUVESCxnQkFBZ0IsQ0FBQ2EsaUJBQWlCLENBQUMsR0FBRyxVQUFVWCxhQUFhLEVBQUVDLEtBQUssRUFBRUMsTUFBTSxFQUFFO0FBQzFFLEVBQUEsTUFBTUMsR0FBRyxHQUFHSCxhQUFhLENBQUNTLFlBQVksQ0FBQTtBQUN0Q04sRUFBQUEsR0FBRyxDQUFDRCxNQUFNLENBQUMsR0FBR0QsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO0VBQ3RCRSxHQUFHLENBQUNELE1BQU0sR0FBRyxDQUFDLENBQUMsR0FBR0QsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO0VBQzFCRSxHQUFHLENBQUNELE1BQU0sR0FBRyxDQUFDLENBQUMsR0FBR0QsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO0FBQzlCLENBQUMsQ0FBQTtBQUVESCxnQkFBZ0IsQ0FBQ2MsaUJBQWlCLENBQUMsR0FBRyxVQUFVWixhQUFhLEVBQUVDLEtBQUssRUFBRUMsTUFBTSxFQUFFO0FBQzFFLEVBQUEsTUFBTUMs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
