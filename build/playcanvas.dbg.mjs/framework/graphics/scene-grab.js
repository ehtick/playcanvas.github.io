/**
 * @license
 * PlayCanvas Engine v1.59.0-dev revision 84ad26f31 (DEBUG PROFILER)
 * Copyright 2011-2022 PlayCanvas Ltd. All rights reserved.
 */
import { PIXELFORMAT_RGBA8, PIXELFORMAT_RGB8, FILTER_NEAREST, FILTER_LINEAR_MIPMAP_LINEAR, FILTER_LINEAR, ADDRESS_CLAMP_TO_EDGE, PIXELFORMAT_DEPTHSTENCIL } from '../../platform/graphics/constants.js';
import { RenderTarget } from '../../platform/graphics/render-target.js';
import { Texture } from '../../platform/graphics/texture.js';
import { DebugGraphics } from '../../platform/graphics/debug-graphics.js';
import { LAYERID_DEPTH, SHADER_DEPTH, LAYERID_WORLD } from '../../scene/constants.js';
import { Layer } from '../../scene/layer.js';

const _depthUniformNames = ['uSceneDepthMap', 'uDepthMap'];
const _colorUniformNames = ['uSceneColorMap', 'texture_grabPass'];

class SceneGrab {
  constructor(application) {
    this.application = application;

    this.device = application.graphicsDevice;

    this.layer = null;

    this.colorFormat = this.device.defaultFramebufferAlpha ? PIXELFORMAT_RGBA8 : PIXELFORMAT_RGB8;

    if (this.device.webgl2) {
      this.initWebGl2();
    } else {
      this.initWebGl1();
    }
  }
  setupUniform(device, depth, buffer) {
    const names = depth ? _depthUniformNames : _colorUniformNames;
    names.forEach(name => device.scope.resolve(name).setValue(buffer));
  }
  allocateTexture(device, source, name, format, isDepth, mipmaps) {
    return new Texture(device, {
      name,
      format,
      width: source ? source.colorBuffer.width : device.width,
      height: source ? source.colorBuffer.height : device.height,
      mipmaps,
      minFilter: isDepth ? FILTER_NEAREST : mipmaps ? FILTER_LINEAR_MIPMAP_LINEAR : FILTER_LINEAR,
      magFilter: isDepth ? FILTER_NEAREST : FILTER_LINEAR,
      addressU: ADDRESS_CLAMP_TO_EDGE,
      addressV: ADDRESS_CLAMP_TO_EDGE
    });
  }
  resizeCondition(target, source, device) {
    const width = (source == null ? void 0 : source.width) || device.width;
    const height = (source == null ? void 0 : source.height) || device.height;
    return !target || width !== target.width || height !== target.height;
  }
  allocateRenderTarget(renderTarget, sourceRenderTarget, device, format, isDepth, mipmaps, isDepthUniforms) {
    const names = isDepthUniforms ? _depthUniformNames : _colorUniformNames;

    const buffer = this.allocateTexture(device, sourceRenderTarget, names[0], format, isDepth, mipmaps);
    if (renderTarget) {
      renderTarget.destroyFrameBuffers();

      if (isDepth) {
        renderTarget._depthBuffer = buffer;
      } else {
        renderTarget._colorBuffer = buffer;
      }
    } else {
      renderTarget = new RenderTarget({
        name: 'renderTargetSceneGrab',
        colorBuffer: isDepth ? null : buffer,
        depthBuffer: isDepth ? buffer : null,
        depth: !isDepth,
        stencil: device.supportsStencil,
        autoResolve: false
      });
    }
    return renderTarget;
  }
  releaseRenderTarget(rt) {
    if (rt) {
      rt.destroyTextureBuffers();
      rt.destroy();
    }
  }
  initWebGl2() {
    const app = this.application;
    const self = this;

    this.layer = new Layer({
      enabled: false,
      name: "Depth",
      id: LAYERID_DEPTH,
      onDisable: function () {
        self.releaseRenderTarget(this.depthRenderTarget);
        this.depthRenderTarget = null;
        self.releaseRenderTarget(this.colorRenderTarget);
        this.colorRenderTarget = null;
      },
      onPreRenderOpaque: function (cameraPass) {

        const device = app.graphicsDevice;

        const camera = this.cameras[cameraPass];
        if (camera.renderSceneColorMap) {
          var _camera$renderTarget;
          if (self.resizeCondition(this.colorRenderTarget, (_camera$renderTarget = camera.renderTarget) == null ? void 0 : _camera$renderTarget.colorBuffer, device)) {
            self.releaseRenderTarget(this.colorRenderTarget);
            this.colorRenderTarget = self.allocateRenderTarget(this.colorRenderTarget, camera.renderTarget, device, this.colorFormat, false, true, false);
          }

          DebugGraphics.pushGpuMarker(device, 'GRAB-COLOR');
          device.copyRenderTarget(device.renderTarget, this.colorRenderTarget, true, false);

          device.activeTexture(device.maxCombinedTextures - 1);
          const colorBuffer = this.colorRenderTarget.colorBuffer;
          device.bindTexture(colorBuffer);
          device.gl.generateMipmap(colorBuffer.impl._glTarget);
          DebugGraphics.popGpuMarker(device);

          self.setupUniform(device, false, colorBuffer);
        }
        if (camera.renderSceneDepthMap) {
          var _camera$renderTarget2;
          if (self.resizeCondition(this.depthRenderTarget, (_camera$renderTarget2 = camera.renderTarget) == null ? void 0 : _camera$renderTarget2.depthBuffer, device)) {
            self.releaseRenderTarget(this.depthRenderTarget);
            this.depthRenderTarget = self.allocateRenderTarget(this.depthRenderTarget, camera.renderTarget, device, PIXELFORMAT_DEPTHSTENCIL, true, false, true);
          }

          DebugGraphics.pushGpuMarker(device, 'GRAB-DEPTH');
          device.copyRenderTarget(device.renderTarget, this.depthRenderTarget, false, true);
          DebugGraphics.popGpuMarker(device);

          self.setupUniform(device, true, this.depthRenderTarget.depthBuffer);
        }
      },
      onPostRenderOpaque: function (cameraPass) {}
    });
  }
  initWebGl1() {
    const app = this.application;
    const self = this;

    this.layer = new Layer({
      enabled: false,
      name: "Depth",
      id: LAYERID_DEPTH,
      shaderPass: SHADER_DEPTH,
      onEnable: function () {
        this.depthRenderTarget = new RenderTarget({
          name: 'depthRenderTarget-webgl1',
          depth: true,
          stencil: app.graphicsDevice.supportsStencil,
          autoResolve: false,
          graphicsDevice: app.graphicsDevice
        });

        this.renderTarget = this.depthRenderTarget;
      },
      onDisable: function () {
        this.depthRenderTarget.destroyTextureBuffers();
        this.renderTarget = null;
        self.releaseRenderTarget(this.colorRenderTarget);
        this.colorRenderTarget = null;
      },
      onPostCull: function (cameraPass) {
        const device = app.graphicsDevice;

        const camera = this.cameras[cameraPass];
        if (camera.renderSceneDepthMap) {
          var _camera$renderTarget3;
          if (self.resizeCondition(this.depthRenderTarget, (_camera$renderTarget3 = camera.renderTarget) == null ? void 0 : _camera$renderTarget3.depthBuffer, device)) {
            this.depthRenderTarget.destroyTextureBuffers();
            this.depthRenderTarget = self.allocateRenderTarget(this.depthRenderTarget, camera.renderTarget, device, PIXELFORMAT_RGBA8, false, false, true);
          }

          const visibleObjects = this.instances.visibleOpaque[cameraPass];
          const visibleList = visibleObjects.list;
          const layerComposition = app.scene.layers;
          const subLayerEnabled = layerComposition.subLayerEnabled;
          const isTransparent = layerComposition.subLayerList;

          const rt = app.scene.layers.getLayerById(LAYERID_WORLD).renderTarget;
          const cam = this.cameras[cameraPass];
          let visibleLength = 0;
          const layers = layerComposition.layerList;
          for (let i = 0; i < layers.length; i++) {
            const layer = layers[i];
            if (layer === this) break;
            if (layer.renderTarget !== rt || !layer.enabled || !subLayerEnabled[i]) continue;
            const layerCamId = layer.cameras.indexOf(cam);
            if (layerCamId < 0) continue;
            const transparent = isTransparent[i];
            let layerVisibleList = transparent ? layer.instances.visibleTransparent[layerCamId] : layer.instances.visibleOpaque[layerCamId];
            const layerVisibleListLength = layerVisibleList.length;
            layerVisibleList = layerVisibleList.list;
            for (let j = 0; j < layerVisibleListLength; j++) {
              const drawCall = layerVisibleList[j];
              if (drawCall.material && drawCall.material.depthWrite && !drawCall._noDepthDrawGl1) {
                visibleList[visibleLength] = drawCall;
                visibleLength++;
              }
            }
          }
          visibleObjects.length = visibleLength;
        }
      },
      onPreRenderOpaque: function (cameraPass) {
        const device = app.graphicsDevice;

        const camera = this.cameras[cameraPass];
        if (camera.renderSceneColorMap) {
          var _camera$renderTarget4;
          if (self.resizeCondition(this.colorRenderTarget, (_camera$renderTarget4 = camera.renderTarget) == null ? void 0 : _camera$renderTarget4.colorBuffer, device)) {
            self.releaseRenderTarget(this.colorRenderTarget);
            this.colorRenderTarget = self.allocateRenderTarget(this.colorRenderTarget, camera.renderTarget, device, this.colorFormat, false, false, false);
          }

          DebugGraphics.pushGpuMarker(device, 'GRAB-COLOR');

          const colorBuffer = this.colorRenderTarget._colorBuffer;
          if (!colorBuffer.impl._glTexture) {
            colorBuffer.impl.initialize(device, colorBuffer);
          }

          device.bindTexture(colorBuffer);
          const gl = device.gl;
          gl.copyTexImage2D(gl.TEXTURE_2D, 0, colorBuffer.impl._glFormat, 0, 0, colorBuffer.width, colorBuffer.height, 0);

          colorBuffer._needsUpload = false;
          colorBuffer._needsMipmapsUpload = false;
          DebugGraphics.popGpuMarker(device);

          self.setupUniform(device, false, colorBuffer);
        }
        if (camera.renderSceneDepthMap) {
          self.setupUniform(device, true, this.depthRenderTarget.colorBuffer);
        }
      },
      onDrawCall: function () {
        app.graphicsDevice.setColorWrite(true, true, true, true);
      },
      onPostRenderOpaque: function (cameraPass) {
        const camera = this.cameras[cameraPass];
        if (camera.renderSceneDepthMap) {
          const visibleObjects = this.instances.visibleOpaque[cameraPass];
          visibleObjects.length = 0;
        }
      }
    });
  }

  patch(layer) {
    layer.onEnable = this.layer.onEnable;
    layer.onDisable = this.layer.onDisable;
    layer.onPreRenderOpaque = this.layer.onPreRenderOpaque;
    layer.onPostRenderOpaque = this.layer.onPostRenderOpaque;
    layer.shaderPass = this.layer.shaderPass;
    layer.onPostCull = this.layer.onPostCull;
    layer.onDrawCall = this.layer.onDrawCall;
  }
}

export { SceneGrab };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NlbmUtZ3JhYi5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2ZyYW1ld29yay9ncmFwaGljcy9zY2VuZS1ncmFiLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gICAgQUREUkVTU19DTEFNUF9UT19FREdFLFxuICAgIEZJTFRFUl9ORUFSRVNULCBGSUxURVJfTElORUFSLCBGSUxURVJfTElORUFSX01JUE1BUF9MSU5FQVIsXG4gICAgUElYRUxGT1JNQVRfREVQVEhTVEVOQ0lMLCBQSVhFTEZPUk1BVF9SR0JBOCwgUElYRUxGT1JNQVRfUkdCOFxufSBmcm9tICcuLi8uLi9wbGF0Zm9ybS9ncmFwaGljcy9jb25zdGFudHMuanMnO1xuXG5pbXBvcnQgeyBSZW5kZXJUYXJnZXQgfSBmcm9tICcuLi8uLi9wbGF0Zm9ybS9ncmFwaGljcy9yZW5kZXItdGFyZ2V0LmpzJztcbmltcG9ydCB7IFRleHR1cmUgfSBmcm9tICcuLi8uLi9wbGF0Zm9ybS9ncmFwaGljcy90ZXh0dXJlLmpzJztcbmltcG9ydCB7IERlYnVnR3JhcGhpY3MgfSBmcm9tICcuLi8uLi9wbGF0Zm9ybS9ncmFwaGljcy9kZWJ1Zy1ncmFwaGljcy5qcyc7XG5cbmltcG9ydCB7XG4gICAgTEFZRVJJRF9ERVBUSCwgTEFZRVJJRF9XT1JMRCxcbiAgICBTSEFERVJfREVQVEhcbn0gZnJvbSAnLi4vLi4vc2NlbmUvY29uc3RhbnRzLmpzJztcblxuaW1wb3J0IHsgTGF5ZXIgfSBmcm9tICcuLi8uLi9zY2VuZS9sYXllci5qcyc7XG5cbi8vIHVuaWZvcm0gbmFtZXMgKGZpcnN0IGlzIGN1cnJlbnQgbmFtZSwgc2Vjb25kIG9uZSBpcyBkZXByZWNhdGVkIG5hbWUgZm9yIGNvbXBhdGliaWxpdHkpXG5jb25zdCBfZGVwdGhVbmlmb3JtTmFtZXMgPSBbJ3VTY2VuZURlcHRoTWFwJywgJ3VEZXB0aE1hcCddO1xuY29uc3QgX2NvbG9yVW5pZm9ybU5hbWVzID0gWyd1U2NlbmVDb2xvck1hcCcsICd0ZXh0dXJlX2dyYWJQYXNzJ107XG5cbi8qKlxuICogSW50ZXJuYWwgY2xhc3MgYWJzdHJhY3RpbmcgdGhlIGFjY2VzcyB0byB0aGUgZGVwdGggYW5kIGNvbG9yIHRleHR1cmUgb2YgdGhlIHNjZW5lLlxuICogY29sb3IgZnJhbWUgYnVmZmVyIGlzIGNvcGllZCB0byBhIHRleHR1cmVcbiAqIEZvciB3ZWJnbCAyIGRldmljZXMsIHRoZSBkZXB0aCBidWZmZXIgaXMgY29waWVkIHRvIGEgdGV4dHVyZVxuICogZm9yIHdlYmdsIDEgZGV2aWNlcywgdGhlIHNjZW5lJ3MgZGVwdGggaXMgcmVuZGVyZWQgdG8gYSBzZXBhcmF0ZSBSR0JBIHRleHR1cmVcbiAqXG4gKiBUT0RPOiBpbXBsZW1lbnQgbWlwbWFwcGVkIGNvbG9yIGJ1ZmZlciBzdXBwb3J0IGZvciBXZWJHTCAxIGFzIHdlbGwsIHdoaWNoIHJlcXVpcmVzXG4gKiB0aGUgdGV4dHVyZSB0byBiZSBhIHBvd2VyIG9mIHR3bywgYnkgZmlyc3QgZG93bnNjYWxpbmcgdGhlIGNhcHR1cmVkIGZyYW1lYnVmZmVyXG4gKiB0ZXh0dXJlIHRvIHNtYWxsZXIgcG93ZXIgb2YgMiB0ZXh0dXJlLCBhbmQgdGhlbiBnZW5lcmF0ZSBtaXBtYXBzIGFuZCB1c2UgaXQgZm9yIHJlbmRlcmluZ1xuICogVE9ETzogb3IgZXZlbiBiZXR0ZXIsIGltcGxlbWVudCBibHVyIGZpbHRlciB0byBoYXZlIHNtb290aGVyIGxvd2VyIGxldmVsc1xuICpcbiAqIEBpZ25vcmVcbiAqL1xuY2xhc3MgU2NlbmVHcmFiIHtcbiAgICBjb25zdHJ1Y3RvcihhcHBsaWNhdGlvbikge1xuICAgICAgICB0aGlzLmFwcGxpY2F0aW9uID0gYXBwbGljYXRpb247XG5cbiAgICAgICAgLyoqIEB0eXBlIHtpbXBvcnQoJy4uLy4uL3BsYXRmb3JtL2dyYXBoaWNzL2dyYXBoaWNzLWRldmljZS5qcycpLkdyYXBoaWNzRGV2aWNlfSAqL1xuICAgICAgICB0aGlzLmRldmljZSA9IGFwcGxpY2F0aW9uLmdyYXBoaWNzRGV2aWNlO1xuXG4gICAgICAgIC8vIGNyZWF0ZSBkZXB0aCBsYXllclxuICAgICAgICB0aGlzLmxheWVyID0gbnVsbDtcblxuICAgICAgICAvLyBjb2xvciBidWZmZXIgZm9ybWF0XG4gICAgICAgIHRoaXMuY29sb3JGb3JtYXQgPSB0aGlzLmRldmljZS5kZWZhdWx0RnJhbWVidWZmZXJBbHBoYSA/IFBJWEVMRk9STUFUX1JHQkE4IDogUElYRUxGT1JNQVRfUkdCODtcblxuICAgICAgICAvLyBjcmVhdGUgYSBkZXB0aCBsYXllciwgd2hpY2ggaXMgYSBkZWZhdWx0IGRlcHRoIGxheWVyLCBidXQgYWxzbyBhIHRlbXBsYXRlIHVzZWRcbiAgICAgICAgLy8gdG8gcGF0Y2ggYXBwbGljYXRpb24gY3JlYXRlZCBkZXB0aCBsYXllcnMgdG8gYmVoYXZlIGFzIG9uZVxuICAgICAgICBpZiAodGhpcy5kZXZpY2Uud2ViZ2wyKSB7XG4gICAgICAgICAgICB0aGlzLmluaXRXZWJHbDIoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuaW5pdFdlYkdsMSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc2V0dXBVbmlmb3JtKGRldmljZSwgZGVwdGgsIGJ1ZmZlcikge1xuXG4gICAgICAgIC8vIGFzc2lnbiBpdCB0byBzY29wZXMgdG8gZXhwb3NlIGl0IHRvIHNoYWRlcnNcbiAgICAgICAgY29uc3QgbmFtZXMgPSBkZXB0aCA/IF9kZXB0aFVuaWZvcm1OYW1lcyA6IF9jb2xvclVuaWZvcm1OYW1lcztcbiAgICAgICAgbmFtZXMuZm9yRWFjaChuYW1lID0+IGRldmljZS5zY29wZS5yZXNvbHZlKG5hbWUpLnNldFZhbHVlKGJ1ZmZlcikpO1xuICAgIH1cblxuICAgIGFsbG9jYXRlVGV4dHVyZShkZXZpY2UsIHNvdXJjZSwgbmFtZSwgZm9ybWF0LCBpc0RlcHRoLCBtaXBtYXBzKSB7XG5cbiAgICAgICAgLy8gYWxsb2NhdGUgdGV4dHVyZSB0aGF0IHdpbGwgc3RvcmUgdGhlIGRlcHRoXG4gICAgICAgIHJldHVybiBuZXcgVGV4dHVyZShkZXZpY2UsIHtcbiAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICBmb3JtYXQsXG4gICAgICAgICAgICB3aWR0aDogc291cmNlID8gc291cmNlLmNvbG9yQnVmZmVyLndpZHRoIDogZGV2aWNlLndpZHRoLFxuICAgICAgICAgICAgaGVpZ2h0OiBzb3VyY2UgPyBzb3VyY2UuY29sb3JCdWZmZXIuaGVpZ2h0IDogZGV2aWNlLmhlaWdodCxcbiAgICAgICAgICAgIG1pcG1hcHMsXG4gICAgICAgICAgICBtaW5GaWx0ZXI6IGlzRGVwdGggPyBGSUxURVJfTkVBUkVTVCA6IChtaXBtYXBzID8gRklMVEVSX0xJTkVBUl9NSVBNQVBfTElORUFSIDogRklMVEVSX0xJTkVBUiksXG4gICAgICAgICAgICBtYWdGaWx0ZXI6IGlzRGVwdGggPyBGSUxURVJfTkVBUkVTVCA6IEZJTFRFUl9MSU5FQVIsXG4gICAgICAgICAgICBhZGRyZXNzVTogQUREUkVTU19DTEFNUF9UT19FREdFLFxuICAgICAgICAgICAgYWRkcmVzc1Y6IEFERFJFU1NfQ0xBTVBfVE9fRURHRVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICByZXNpemVDb25kaXRpb24odGFyZ2V0LCBzb3VyY2UsIGRldmljZSkge1xuICAgICAgICBjb25zdCB3aWR0aCA9IHNvdXJjZT8ud2lkdGggfHwgZGV2aWNlLndpZHRoO1xuICAgICAgICBjb25zdCBoZWlnaHQgPSBzb3VyY2U/LmhlaWdodCB8fCBkZXZpY2UuaGVpZ2h0O1xuICAgICAgICByZXR1cm4gIXRhcmdldCB8fCB3aWR0aCAhPT0gdGFyZ2V0LndpZHRoIHx8IGhlaWdodCAhPT0gdGFyZ2V0LmhlaWdodDtcbiAgICB9XG5cbiAgICBhbGxvY2F0ZVJlbmRlclRhcmdldChyZW5kZXJUYXJnZXQsIHNvdXJjZVJlbmRlclRhcmdldCwgZGV2aWNlLCBmb3JtYXQsIGlzRGVwdGgsIG1pcG1hcHMsIGlzRGVwdGhVbmlmb3Jtcykge1xuXG4gICAgICAgIC8vIHRleHR1cmUgLyB1bmlmb3JtIG5hbWVzOiBuZXcgb25lIChmaXJzdCksIGFzIHdlbGwgYXMgb2xkIG9uZSAgKHNlY29uZCkgZm9yIGNvbXBhdGliaWxpdHlcbiAgICAgICAgY29uc3QgbmFtZXMgPSBpc0RlcHRoVW5pZm9ybXMgPyBfZGVwdGhVbmlmb3JtTmFtZXMgOiBfY29sb3JVbmlmb3JtTmFtZXM7XG5cbiAgICAgICAgLy8gYWxsb2NhdGUgdGV4dHVyZSBidWZmZXJcbiAgICAgICAgY29uc3QgYnVmZmVyID0gdGhpcy5hbGxvY2F0ZVRleHR1cmUoZGV2aWNlLCBzb3VyY2VSZW5kZXJUYXJnZXQsIG5hbWVzWzBdLCBmb3JtYXQsIGlzRGVwdGgsIG1pcG1hcHMpO1xuXG4gICAgICAgIGlmIChyZW5kZXJUYXJnZXQpIHtcblxuICAgICAgICAgICAgLy8gaWYgcmVhbGxvY2F0aW5nIFJUIHNpemUsIHJlbGVhc2UgcHJldmlvdXMgZnJhbWVidWZmZXJcbiAgICAgICAgICAgIHJlbmRlclRhcmdldC5kZXN0cm95RnJhbWVCdWZmZXJzKCk7XG5cbiAgICAgICAgICAgIC8vIGFzc2lnbiBuZXcgdGV4dHVyZVxuICAgICAgICAgICAgaWYgKGlzRGVwdGgpIHtcbiAgICAgICAgICAgICAgICByZW5kZXJUYXJnZXQuX2RlcHRoQnVmZmVyID0gYnVmZmVyO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZW5kZXJUYXJnZXQuX2NvbG9yQnVmZmVyID0gYnVmZmVyO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICAvLyBjcmVhdGUgbmV3IHJlbmRlciB0YXJnZXQgd2l0aCB0aGUgdGV4dHVyZVxuICAgICAgICAgICAgcmVuZGVyVGFyZ2V0ID0gbmV3IFJlbmRlclRhcmdldCh7XG4gICAgICAgICAgICAgICAgbmFtZTogJ3JlbmRlclRhcmdldFNjZW5lR3JhYicsXG4gICAgICAgICAgICAgICAgY29sb3JCdWZmZXI6IGlzRGVwdGggPyBudWxsIDogYnVmZmVyLFxuICAgICAgICAgICAgICAgIGRlcHRoQnVmZmVyOiBpc0RlcHRoID8gYnVmZmVyIDogbnVsbCxcbiAgICAgICAgICAgICAgICBkZXB0aDogIWlzRGVwdGgsXG4gICAgICAgICAgICAgICAgc3RlbmNpbDogZGV2aWNlLnN1cHBvcnRzU3RlbmNpbCxcbiAgICAgICAgICAgICAgICBhdXRvUmVzb2x2ZTogZmFsc2VcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlbmRlclRhcmdldDtcbiAgICB9XG5cbiAgICByZWxlYXNlUmVuZGVyVGFyZ2V0KHJ0KSB7XG5cbiAgICAgICAgaWYgKHJ0KSB7XG4gICAgICAgICAgICBydC5kZXN0cm95VGV4dHVyZUJ1ZmZlcnMoKTtcbiAgICAgICAgICAgIHJ0LmRlc3Ryb3koKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGluaXRXZWJHbDIoKSB7XG5cbiAgICAgICAgY29uc3QgYXBwID0gdGhpcy5hcHBsaWNhdGlvbjtcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG5cbiAgICAgICAgLy8gV2ViR0wgMiBkZXB0aCBsYXllciBqdXN0IGNvcGllcyBleGlzdGluZyBjb2xvciBvciBkZXB0aFxuICAgICAgICB0aGlzLmxheWVyID0gbmV3IExheWVyKHtcbiAgICAgICAgICAgIGVuYWJsZWQ6IGZhbHNlLFxuICAgICAgICAgICAgbmFtZTogXCJEZXB0aFwiLFxuICAgICAgICAgICAgaWQ6IExBWUVSSURfREVQVEgsXG5cbiAgICAgICAgICAgIG9uRGlzYWJsZTogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHNlbGYucmVsZWFzZVJlbmRlclRhcmdldCh0aGlzLmRlcHRoUmVuZGVyVGFyZ2V0KTtcbiAgICAgICAgICAgICAgICB0aGlzLmRlcHRoUmVuZGVyVGFyZ2V0ID0gbnVsbDtcblxuICAgICAgICAgICAgICAgIHNlbGYucmVsZWFzZVJlbmRlclRhcmdldCh0aGlzLmNvbG9yUmVuZGVyVGFyZ2V0KTtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbG9yUmVuZGVyVGFyZ2V0ID0gbnVsbDtcbiAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgIG9uUHJlUmVuZGVyT3BhcXVlOiBmdW5jdGlvbiAoY2FtZXJhUGFzcykgeyAvLyByZXNpemUgZGVwdGggbWFwIGlmIG5lZWRlZFxuXG4gICAgICAgICAgICAgICAgLyoqIEB0eXBlIHtpbXBvcnQoJy4uLy4uL3BsYXRmb3JtL2dyYXBoaWNzL2dyYXBoaWNzLWRldmljZS5qcycpLkdyYXBoaWNzRGV2aWNlfSAqL1xuICAgICAgICAgICAgICAgIGNvbnN0IGRldmljZSA9IGFwcC5ncmFwaGljc0RldmljZTtcblxuICAgICAgICAgICAgICAgIC8qKiBAdHlwZSB7aW1wb3J0KCcuLi9jb21wb25lbnRzL2NhbWVyYS9jb21wb25lbnQuanMnKS5DYW1lcmFDb21wb25lbnR9ICovXG4gICAgICAgICAgICAgICAgY29uc3QgY2FtZXJhID0gdGhpcy5jYW1lcmFzW2NhbWVyYVBhc3NdO1xuXG4gICAgICAgICAgICAgICAgaWYgKGNhbWVyYS5yZW5kZXJTY2VuZUNvbG9yTWFwKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gYWxsb2NhdGUgLyByZXNpemUgZXhpc3RpbmcgUlQgYXMgbmVlZGVkXG4gICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLnJlc2l6ZUNvbmRpdGlvbih0aGlzLmNvbG9yUmVuZGVyVGFyZ2V0LCBjYW1lcmEucmVuZGVyVGFyZ2V0Py5jb2xvckJ1ZmZlciwgZGV2aWNlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5yZWxlYXNlUmVuZGVyVGFyZ2V0KHRoaXMuY29sb3JSZW5kZXJUYXJnZXQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xvclJlbmRlclRhcmdldCA9IHNlbGYuYWxsb2NhdGVSZW5kZXJUYXJnZXQodGhpcy5jb2xvclJlbmRlclRhcmdldCwgY2FtZXJhLnJlbmRlclRhcmdldCwgZGV2aWNlLCB0aGlzLmNvbG9yRm9ybWF0LCBmYWxzZSwgdHJ1ZSwgZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gY29weSBjb2xvciBmcm9tIHRoZSBjdXJyZW50IHJlbmRlciB0YXJnZXRcbiAgICAgICAgICAgICAgICAgICAgRGVidWdHcmFwaGljcy5wdXNoR3B1TWFya2VyKGRldmljZSwgJ0dSQUItQ09MT1InKTtcblxuICAgICAgICAgICAgICAgICAgICBkZXZpY2UuY29weVJlbmRlclRhcmdldChkZXZpY2UucmVuZGVyVGFyZ2V0LCB0aGlzLmNvbG9yUmVuZGVyVGFyZ2V0LCB0cnVlLCBmYWxzZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gZ2VuZXJhdGUgbWlwbWFwc1xuICAgICAgICAgICAgICAgICAgICBkZXZpY2UuYWN0aXZlVGV4dHVyZShkZXZpY2UubWF4Q29tYmluZWRUZXh0dXJlcyAtIDEpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjb2xvckJ1ZmZlciA9IHRoaXMuY29sb3JSZW5kZXJUYXJnZXQuY29sb3JCdWZmZXI7XG4gICAgICAgICAgICAgICAgICAgIGRldmljZS5iaW5kVGV4dHVyZShjb2xvckJ1ZmZlcik7XG4gICAgICAgICAgICAgICAgICAgIGRldmljZS5nbC5nZW5lcmF0ZU1pcG1hcChjb2xvckJ1ZmZlci5pbXBsLl9nbFRhcmdldCk7XG5cbiAgICAgICAgICAgICAgICAgICAgRGVidWdHcmFwaGljcy5wb3BHcHVNYXJrZXIoZGV2aWNlKTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBhc3NpZ24gdW5pZnJvbVxuICAgICAgICAgICAgICAgICAgICBzZWxmLnNldHVwVW5pZm9ybShkZXZpY2UsIGZhbHNlLCBjb2xvckJ1ZmZlcik7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGNhbWVyYS5yZW5kZXJTY2VuZURlcHRoTWFwKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gcmVhbGxvY2F0ZSBSVCBpZiBuZWVkZWRcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYucmVzaXplQ29uZGl0aW9uKHRoaXMuZGVwdGhSZW5kZXJUYXJnZXQsIGNhbWVyYS5yZW5kZXJUYXJnZXQ/LmRlcHRoQnVmZmVyLCBkZXZpY2UpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbGVhc2VSZW5kZXJUYXJnZXQodGhpcy5kZXB0aFJlbmRlclRhcmdldCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlcHRoUmVuZGVyVGFyZ2V0ID0gc2VsZi5hbGxvY2F0ZVJlbmRlclRhcmdldCh0aGlzLmRlcHRoUmVuZGVyVGFyZ2V0LCBjYW1lcmEucmVuZGVyVGFyZ2V0LCBkZXZpY2UsIFBJWEVMRk9STUFUX0RFUFRIU1RFTkNJTCwgdHJ1ZSwgZmFsc2UsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gY29weSBkZXB0aFxuICAgICAgICAgICAgICAgICAgICBEZWJ1Z0dyYXBoaWNzLnB1c2hHcHVNYXJrZXIoZGV2aWNlLCAnR1JBQi1ERVBUSCcpO1xuICAgICAgICAgICAgICAgICAgICBkZXZpY2UuY29weVJlbmRlclRhcmdldChkZXZpY2UucmVuZGVyVGFyZ2V0LCB0aGlzLmRlcHRoUmVuZGVyVGFyZ2V0LCBmYWxzZSwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIERlYnVnR3JhcGhpY3MucG9wR3B1TWFya2VyKGRldmljZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gYXNzaWduIHVuaWZyb21cbiAgICAgICAgICAgICAgICAgICAgc2VsZi5zZXR1cFVuaWZvcm0oZGV2aWNlLCB0cnVlLCB0aGlzLmRlcHRoUmVuZGVyVGFyZ2V0LmRlcHRoQnVmZmVyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICBvblBvc3RSZW5kZXJPcGFxdWU6IGZ1bmN0aW9uIChjYW1lcmFQYXNzKSB7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGluaXRXZWJHbDEoKSB7XG5cbiAgICAgICAgY29uc3QgYXBwID0gdGhpcy5hcHBsaWNhdGlvbjtcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG5cbiAgICAgICAgLy8gV2ViR0wgMSBkZXB0aCBsYXllciByZW5kZXJzIHRoZSBzYW1lIG9iamVjdHMgYXMgaW4gV29ybGQsIGJ1dCB3aXRoIFJHQkEtZW5jb2RlZCBkZXB0aCBzaGFkZXIgdG8gZ2V0IGRlcHRoXG4gICAgICAgIHRoaXMubGF5ZXIgPSBuZXcgTGF5ZXIoe1xuICAgICAgICAgICAgZW5hYmxlZDogZmFsc2UsXG4gICAgICAgICAgICBuYW1lOiBcIkRlcHRoXCIsXG4gICAgICAgICAgICBpZDogTEFZRVJJRF9ERVBUSCxcbiAgICAgICAgICAgIHNoYWRlclBhc3M6IFNIQURFUl9ERVBUSCxcblxuICAgICAgICAgICAgb25FbmFibGU6IGZ1bmN0aW9uICgpIHtcblxuICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSBSVCB3aXRob3V0IHRleHR1cmVzLCB0aG9zZSB3aWxsIGJlIGNyZWF0ZWQgYXMgbmVlZGVkIGxhdGVyXG4gICAgICAgICAgICAgICAgdGhpcy5kZXB0aFJlbmRlclRhcmdldCA9IG5ldyBSZW5kZXJUYXJnZXQoe1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiAnZGVwdGhSZW5kZXJUYXJnZXQtd2ViZ2wxJyxcbiAgICAgICAgICAgICAgICAgICAgZGVwdGg6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIHN0ZW5jaWw6IGFwcC5ncmFwaGljc0RldmljZS5zdXBwb3J0c1N0ZW5jaWwsXG4gICAgICAgICAgICAgICAgICAgIGF1dG9SZXNvbHZlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgZ3JhcGhpY3NEZXZpY2U6IGFwcC5ncmFwaGljc0RldmljZVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgLy8gYXNzaWduIGl0IHNvIHRoZSByZW5kZXIgYWN0aW9ucyBrbm93cyB0byByZW5kZXIgdG8gaXRcbiAgICAgICAgICAgICAgICAvLyBUT0RPOiBhdm9pZCB0aGlzIGFzIHRoaXMgQVBJIGlzIGRlcHJlY2F0ZWRcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclRhcmdldCA9IHRoaXMuZGVwdGhSZW5kZXJUYXJnZXQ7XG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICBvbkRpc2FibGU6IGZ1bmN0aW9uICgpIHtcblxuICAgICAgICAgICAgICAgIC8vIG9ubHkgcmVsZWFzZSBkZXB0aCB0ZXh0dXJlLCBidXQgbm90IHRoZSByZW5kZXIgdGFyZ2V0IGl0c2VsZlxuICAgICAgICAgICAgICAgIHRoaXMuZGVwdGhSZW5kZXJUYXJnZXQuZGVzdHJveVRleHR1cmVCdWZmZXJzKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJUYXJnZXQgPSBudWxsO1xuXG4gICAgICAgICAgICAgICAgc2VsZi5yZWxlYXNlUmVuZGVyVGFyZ2V0KHRoaXMuY29sb3JSZW5kZXJUYXJnZXQpO1xuICAgICAgICAgICAgICAgIHRoaXMuY29sb3JSZW5kZXJUYXJnZXQgPSBudWxsO1xuICAgICAgICAgICAgfSxcblxuICAgICAgICAgICAgb25Qb3N0Q3VsbDogZnVuY3Rpb24gKGNhbWVyYVBhc3MpIHtcblxuICAgICAgICAgICAgICAgIC8qKiBAdHlwZSB7aW1wb3J0KCcuLi8uLi9wbGF0Zm9ybS9ncmFwaGljcy9ncmFwaGljcy1kZXZpY2UuanMnKS5HcmFwaGljc0RldmljZX0gKi9cbiAgICAgICAgICAgICAgICBjb25zdCBkZXZpY2UgPSBhcHAuZ3JhcGhpY3NEZXZpY2U7XG5cbiAgICAgICAgICAgICAgICAvKiogQHR5cGUge2ltcG9ydCgnLi4vY29tcG9uZW50cy9jYW1lcmEvY29tcG9uZW50LmpzJykuQ2FtZXJhQ29tcG9uZW50fSAqL1xuICAgICAgICAgICAgICAgIGNvbnN0IGNhbWVyYSA9IHRoaXMuY2FtZXJhc1tjYW1lcmFQYXNzXTtcblxuICAgICAgICAgICAgICAgIGlmIChjYW1lcmEucmVuZGVyU2NlbmVEZXB0aE1hcCkge1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIHJlYWxsb2NhdGUgUlQgaWYgbmVlZGVkXG4gICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLnJlc2l6ZUNvbmRpdGlvbih0aGlzLmRlcHRoUmVuZGVyVGFyZ2V0LCBjYW1lcmEucmVuZGVyVGFyZ2V0Py5kZXB0aEJ1ZmZlciwgZGV2aWNlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZXB0aFJlbmRlclRhcmdldC5kZXN0cm95VGV4dHVyZUJ1ZmZlcnMoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGVwdGhSZW5kZXJUYXJnZXQgPSBzZWxmLmFsbG9jYXRlUmVuZGVyVGFyZ2V0KHRoaXMuZGVwdGhSZW5kZXJUYXJnZXQsIGNhbWVyYS5yZW5kZXJUYXJnZXQsIGRldmljZSwgUElYRUxGT1JNQVRfUkdCQTgsIGZhbHNlLCBmYWxzZSwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvLyBDb2xsZWN0IGFsbCByZW5kZXJlZCBtZXNoIGluc3RhbmNlcyB3aXRoIHRoZSBzYW1lIHJlbmRlciB0YXJnZXQgYXMgV29ybGQgaGFzLCBkZXB0aFdyaXRlID09IHRydWUgYW5kIHByaW9yIHRvIHRoaXMgbGF5ZXIgdG8gcmVwbGljYXRlIGJsaXRGcmFtZWJ1ZmZlciBvbiBXZWJHTDJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmlzaWJsZU9iamVjdHMgPSB0aGlzLmluc3RhbmNlcy52aXNpYmxlT3BhcXVlW2NhbWVyYVBhc3NdO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB2aXNpYmxlTGlzdCA9IHZpc2libGVPYmplY3RzLmxpc3Q7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGxheWVyQ29tcG9zaXRpb24gPSBhcHAuc2NlbmUubGF5ZXJzO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBzdWJMYXllckVuYWJsZWQgPSBsYXllckNvbXBvc2l0aW9uLnN1YkxheWVyRW5hYmxlZDtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNUcmFuc3BhcmVudCA9IGxheWVyQ29tcG9zaXRpb24uc3ViTGF5ZXJMaXN0O1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIGNhbid0IHVzZSBzZWxmLmRlZmF1bHRMYXllcldvcmxkLnJlbmRlclRhcmdldCBiZWNhdXNlIHByb2plY3RzIHRoYXQgdXNlIHRoZSBlZGl0b3Igb3ZlcnJpZGUgZGVmYXVsdCBsYXllcnNcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcnQgPSBhcHAuc2NlbmUubGF5ZXJzLmdldExheWVyQnlJZChMQVlFUklEX1dPUkxEKS5yZW5kZXJUYXJnZXQ7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbSA9IHRoaXMuY2FtZXJhc1tjYW1lcmFQYXNzXTtcblxuICAgICAgICAgICAgICAgICAgICBsZXQgdmlzaWJsZUxlbmd0aCA9IDA7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGxheWVycyA9IGxheWVyQ29tcG9zaXRpb24ubGF5ZXJMaXN0O1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxheWVycy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGF5ZXIgPSBsYXllcnNbaV07XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobGF5ZXIgPT09IHRoaXMpIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxheWVyLnJlbmRlclRhcmdldCAhPT0gcnQgfHwgIWxheWVyLmVuYWJsZWQgfHwgIXN1YkxheWVyRW5hYmxlZFtpXSkgY29udGludWU7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxheWVyQ2FtSWQgPSBsYXllci5jYW1lcmFzLmluZGV4T2YoY2FtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXllckNhbUlkIDwgMCkgY29udGludWU7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRyYW5zcGFyZW50ID0gaXNUcmFuc3BhcmVudFtpXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBsYXllclZpc2libGVMaXN0ID0gdHJhbnNwYXJlbnQgPyBsYXllci5pbnN0YW5jZXMudmlzaWJsZVRyYW5zcGFyZW50W2xheWVyQ2FtSWRdIDogbGF5ZXIuaW5zdGFuY2VzLnZpc2libGVPcGFxdWVbbGF5ZXJDYW1JZF07XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXllclZpc2libGVMaXN0TGVuZ3RoID0gbGF5ZXJWaXNpYmxlTGlzdC5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgICAgICBsYXllclZpc2libGVMaXN0ID0gbGF5ZXJWaXNpYmxlTGlzdC5saXN0O1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGxheWVyVmlzaWJsZUxpc3RMZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRyYXdDYWxsID0gbGF5ZXJWaXNpYmxlTGlzdFtqXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZHJhd0NhbGwubWF0ZXJpYWwgJiYgZHJhd0NhbGwubWF0ZXJpYWwuZGVwdGhXcml0ZSAmJiAhZHJhd0NhbGwuX25vRGVwdGhEcmF3R2wxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpc2libGVMaXN0W3Zpc2libGVMZW5ndGhdID0gZHJhd0NhbGw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpc2libGVMZW5ndGgrKztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZU9iamVjdHMubGVuZ3RoID0gdmlzaWJsZUxlbmd0aDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICBvblByZVJlbmRlck9wYXF1ZTogZnVuY3Rpb24gKGNhbWVyYVBhc3MpIHtcblxuICAgICAgICAgICAgICAgIC8qKiBAdHlwZSB7aW1wb3J0KCcuLi8uLi9wbGF0Zm9ybS9ncmFwaGljcy9ncmFwaGljcy1kZXZpY2UuanMnKS5HcmFwaGljc0RldmljZX0gKi9cbiAgICAgICAgICAgICAgICBjb25zdCBkZXZpY2UgPSBhcHAuZ3JhcGhpY3NEZXZpY2U7XG5cbiAgICAgICAgICAgICAgICAvKiogQHR5cGUge2ltcG9ydCgnLi4vY29tcG9uZW50cy9jYW1lcmEvY29tcG9uZW50LmpzJykuQ2FtZXJhQ29tcG9uZW50fSAqL1xuICAgICAgICAgICAgICAgIGNvbnN0IGNhbWVyYSA9IHRoaXMuY2FtZXJhc1tjYW1lcmFQYXNzXTtcblxuICAgICAgICAgICAgICAgIGlmIChjYW1lcmEucmVuZGVyU2NlbmVDb2xvck1hcCkge1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIHJlYWxsb2NhdGUgUlQgaWYgbmVlZGVkXG4gICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLnJlc2l6ZUNvbmRpdGlvbih0aGlzLmNvbG9yUmVuZGVyVGFyZ2V0LCBjYW1lcmEucmVuZGVyVGFyZ2V0Py5jb2xvckJ1ZmZlciwgZGV2aWNlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5yZWxlYXNlUmVuZGVyVGFyZ2V0KHRoaXMuY29sb3JSZW5kZXJUYXJnZXQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xvclJlbmRlclRhcmdldCA9IHNlbGYuYWxsb2NhdGVSZW5kZXJUYXJnZXQodGhpcy5jb2xvclJlbmRlclRhcmdldCwgY2FtZXJhLnJlbmRlclRhcmdldCwgZGV2aWNlLCB0aGlzLmNvbG9yRm9ybWF0LCBmYWxzZSwgZmFsc2UsIGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIC8vIGNvcHkgb3V0IHRoZSBjb2xvciBidWZmZXJcbiAgICAgICAgICAgICAgICAgICAgRGVidWdHcmFwaGljcy5wdXNoR3B1TWFya2VyKGRldmljZSwgJ0dSQUItQ09MT1InKTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBpbml0aWFsaXplIHRoZSB0ZXh0dXJlXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbG9yQnVmZmVyID0gdGhpcy5jb2xvclJlbmRlclRhcmdldC5fY29sb3JCdWZmZXI7XG4gICAgICAgICAgICAgICAgICAgIGlmICghY29sb3JCdWZmZXIuaW1wbC5fZ2xUZXh0dXJlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xvckJ1ZmZlci5pbXBsLmluaXRpYWxpemUoZGV2aWNlLCBjb2xvckJ1ZmZlcik7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvLyBjb3B5IGZyYW1lYnVmZmVyIHRvIGl0XG4gICAgICAgICAgICAgICAgICAgIGRldmljZS5iaW5kVGV4dHVyZShjb2xvckJ1ZmZlcik7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGdsID0gZGV2aWNlLmdsO1xuICAgICAgICAgICAgICAgICAgICBnbC5jb3B5VGV4SW1hZ2UyRChnbC5URVhUVVJFXzJELCAwLCBjb2xvckJ1ZmZlci5pbXBsLl9nbEZvcm1hdCwgMCwgMCwgY29sb3JCdWZmZXIud2lkdGgsIGNvbG9yQnVmZmVyLmhlaWdodCwgMCk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gc3RvcCB0aGUgZGV2aWNlIGZyb20gdXBkYXRpbmcgdGhpcyB0ZXh0dXJlIGZ1cnRoZXJcbiAgICAgICAgICAgICAgICAgICAgY29sb3JCdWZmZXIuX25lZWRzVXBsb2FkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGNvbG9yQnVmZmVyLl9uZWVkc01pcG1hcHNVcGxvYWQgPSBmYWxzZTtcblxuICAgICAgICAgICAgICAgICAgICBEZWJ1Z0dyYXBoaWNzLnBvcEdwdU1hcmtlcihkZXZpY2UpO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIGFzc2lnbiB1bmlmcm9tXG4gICAgICAgICAgICAgICAgICAgIHNlbGYuc2V0dXBVbmlmb3JtKGRldmljZSwgZmFsc2UsIGNvbG9yQnVmZmVyKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoY2FtZXJhLnJlbmRlclNjZW5lRGVwdGhNYXApIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gYXNzaWduIHVuaWZyb21cbiAgICAgICAgICAgICAgICAgICAgc2VsZi5zZXR1cFVuaWZvcm0oZGV2aWNlLCB0cnVlLCB0aGlzLmRlcHRoUmVuZGVyVGFyZ2V0LmNvbG9yQnVmZmVyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICBvbkRyYXdDYWxsOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgYXBwLmdyYXBoaWNzRGV2aWNlLnNldENvbG9yV3JpdGUodHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSk7XG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICBvblBvc3RSZW5kZXJPcGFxdWU6IGZ1bmN0aW9uIChjYW1lcmFQYXNzKSB7XG5cbiAgICAgICAgICAgICAgICAvKiogQHR5cGUge2ltcG9ydCgnLi4vY29tcG9uZW50cy9jYW1lcmEvY29tcG9uZW50LmpzJykuQ2FtZXJhQ29tcG9uZW50fSAqL1xuICAgICAgICAgICAgICAgIGNvbnN0IGNhbWVyYSA9IHRoaXMuY2FtZXJhc1tjYW1lcmFQYXNzXTtcblxuICAgICAgICAgICAgICAgIGlmIChjYW1lcmEucmVuZGVyU2NlbmVEZXB0aE1hcCkge1xuICAgICAgICAgICAgICAgICAgICAvLyBqdXN0IGNsZWFyIHRoZSBsaXN0IG9mIHZpc2libGUgb2JqZWN0cyB0byBhdm9pZCBrZWVwaW5nIHJlZmVyZW5jZXNcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmlzaWJsZU9iamVjdHMgPSB0aGlzLmluc3RhbmNlcy52aXNpYmxlT3BhcXVlW2NhbWVyYVBhc3NdO1xuICAgICAgICAgICAgICAgICAgICB2aXNpYmxlT2JqZWN0cy5sZW5ndGggPSAwO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gZnVuY3Rpb24gd2hpY2ggcGF0Y2hlcyBhIGxheWVyIHRvIHVzZSBkZXB0aCBsYXllciBzZXQgdXAgaW4gdGhpcyBjbGFzc1xuICAgIHBhdGNoKGxheWVyKSB7XG5cbiAgICAgICAgbGF5ZXIub25FbmFibGUgPSB0aGlzLmxheWVyLm9uRW5hYmxlO1xuICAgICAgICBsYXllci5vbkRpc2FibGUgPSB0aGlzLmxheWVyLm9uRGlzYWJsZTtcbiAgICAgICAgbGF5ZXIub25QcmVSZW5kZXJPcGFxdWUgPSB0aGlzLmxheWVyLm9uUHJlUmVuZGVyT3BhcXVlO1xuICAgICAgICBsYXllci5vblBvc3RSZW5kZXJPcGFxdWUgPSB0aGlzLmxheWVyLm9uUG9zdFJlbmRlck9wYXF1ZTtcbiAgICAgICAgbGF5ZXIuc2hhZGVyUGFzcyA9IHRoaXMubGF5ZXIuc2hhZGVyUGFzcztcbiAgICAgICAgbGF5ZXIub25Qb3N0Q3VsbCA9IHRoaXMubGF5ZXIub25Qb3N0Q3VsbDtcbiAgICAgICAgbGF5ZXIub25EcmF3Q2FsbCA9IHRoaXMubGF5ZXIub25EcmF3Q2FsbDtcbiAgICB9XG59XG5cbmV4cG9ydCB7IFNjZW5lR3JhYiB9O1xuIl0sIm5hbWVzIjpbIl9kZXB0aFVuaWZvcm1OYW1lcyIsIl9jb2xvclVuaWZvcm1OYW1lcyIsIlNjZW5lR3JhYiIsImNvbnN0cnVjdG9yIiwiYXBwbGljYXRpb24iLCJkZXZpY2UiLCJncmFwaGljc0RldmljZSIsImxheWVyIiwiY29sb3JGb3JtYXQiLCJkZWZhdWx0RnJhbWVidWZmZXJBbHBoYSIsIlBJWEVMRk9STUFUX1JHQkE4IiwiUElYRUxGT1JNQVRfUkdCOCIsIndlYmdsMiIsImluaXRXZWJHbDIiLCJpbml0V2ViR2wxIiwic2V0dXBVbmlmb3JtIiwiZGVwdGgiLCJidWZmZXIiLCJuYW1lcyIsImZvckVhY2giLCJuYW1lIiwic2NvcGUiLCJyZXNvbHZlIiwic2V0VmFsdWUiLCJhbGxvY2F0ZVRleHR1cmUiLCJzb3VyY2UiLCJmb3JtYXQiLCJpc0RlcHRoIiwibWlwbWFwcyIsIlRleHR1cmUiLCJ3aWR0aCIsImNvbG9yQnVmZmVyIiwiaGVpZ2h0IiwibWluRmlsdGVyIiwiRklMVEVSX05FQVJFU1QiLCJGSUxURVJfTElORUFSX01JUE1BUF9MSU5FQVIiLCJGSUxURVJfTElORUFSIiwibWFnRmlsdGVyIiwiYWRkcmVzc1UiLCJBRERSRVNTX0NMQU1QX1RPX0VER0UiLCJhZGRyZXNzViIsInJlc2l6ZUNvbmRpdGlvbiIsInRhcmdldCIsImFsbG9jYXRlUmVuZGVyVGFyZ2V0IiwicmVuZGVyVGFyZ2V0Iiwic291cmNlUmVuZGVyVGFyZ2V0IiwiaXNEZXB0aFVuaWZvcm1zIiwiZGVzdHJveUZyYW1lQnVmZmVycyIsIl9kZXB0aEJ1ZmZlciIsIl9jb2xvckJ1ZmZlciIsIlJlbmRlclRhcmdldCIsImRlcHRoQnVmZmVyIiwic3RlbmNpbCIsInN1cHBvcnRzU3RlbmNpbCIsImF1dG9SZXNvbHZlIiwicmVsZWFzZVJlbmRlclRhcmdldCIsInJ0IiwiZGVzdHJveVRleHR1cmVCdWZmZXJzIiwiZGVzdHJveSIsImFwcCIsInNlbGYiLCJMYXllciIsImVuYWJsZWQiLCJpZCIsIkxBWUVSSURfREVQVEgiLCJvbkRpc2FibGUiLCJkZXB0aFJlbmRlclRhcmdldCIsImNvbG9yUmVuZGVyVGFyZ2V0Iiwib25QcmVSZW5kZXJPcGFxdWUiLCJjYW1lcmFQYXNzIiwiY2FtZXJhIiwiY2FtZXJhcyIsInJlbmRlclNjZW5lQ29sb3JNYXAiLCJEZWJ1Z0dyYXBoaWNzIiwicHVzaEdwdU1hcmtlciIsImNvcHlSZW5kZXJUYXJnZXQiLCJhY3RpdmVUZXh0dXJlIiwibWF4Q29tYmluZWRUZXh0dXJlcyIsImJpbmRUZXh0dXJlIiwiZ2wiLCJnZW5lcmF0ZU1pcG1hcCIsImltcGwiLCJfZ2xUYXJnZXQiLCJwb3BHcHVNYXJrZXIiLCJyZW5kZXJTY2VuZURlcHRoTWFwIiwiUElYRUxGT1JNQVRfREVQVEhTVEVOQ0lMIiwib25Qb3N0UmVuZGVyT3BhcXVlIiwic2hhZGVyUGFzcyIsIlNIQURFUl9ERVBUSCIsIm9uRW5hYmxlIiwib25Qb3N0Q3VsbCIsInZpc2libGVPYmplY3RzIiwiaW5zdGFuY2VzIiwidmlzaWJsZU9wYXF1ZSIsInZpc2libGVMaXN0IiwibGlzdCIsImxheWVyQ29tcG9zaXRpb24iLCJzY2VuZSIsImxheWVycyIsInN1YkxheWVyRW5hYmxlZCIsImlzVHJhbnNwYXJlbnQiLCJzdWJMYXllckxpc3QiLCJnZXRMYXllckJ5SWQiLCJMQVlFUklEX1dPUkxEIiwiY2FtIiwidmlzaWJsZUxlbmd0aCIsImxheWVyTGlzdCIsImkiLCJsZW5ndGgiLCJsYXllckNhbUlkIiwiaW5kZXhPZiIsInRyYW5zcGFyZW50IiwibGF5ZXJWaXNpYmxlTGlzdCIsInZpc2libGVUcmFuc3BhcmVudCIsImxheWVyVmlzaWJsZUxpc3RMZW5ndGgiLCJqIiwiZHJhd0NhbGwiLCJtYXRlcmlhbCIsImRlcHRoV3JpdGUiLCJfbm9EZXB0aERyYXdHbDEiLCJfZ2xUZXh0dXJlIiwiaW5pdGlhbGl6ZSIsImNvcHlUZXhJbWFnZTJEIiwiVEVYVFVSRV8yRCIsIl9nbEZvcm1hdCIsIl9uZWVkc1VwbG9hZCIsIl9uZWVkc01pcG1hcHNVcGxvYWQiLCJvbkRyYXdDYWxsIiwic2V0Q29sb3JXcml0ZSIsInBhdGNoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFrQkEsTUFBTUEsa0JBQWtCLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxXQUFXLENBQUMsQ0FBQTtBQUMxRCxNQUFNQyxrQkFBa0IsR0FBRyxDQUFDLGdCQUFnQixFQUFFLGtCQUFrQixDQUFDLENBQUE7O0FBZWpFLE1BQU1DLFNBQVMsQ0FBQztFQUNaQyxXQUFX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
