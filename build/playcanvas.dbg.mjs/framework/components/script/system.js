/**
 * @license
 * PlayCanvas Engine v1.57.0 revision f1998a31e (DEBUG PROFILER)
 * Copyright 2011-2022 PlayCanvas Ltd. All rights reserved.
 */
import { SortedLoopArray } from '../../../core/sorted-loop-array.js';
import { ComponentSystem } from '../system.js';
import { ScriptComponent } from './component.js';
import { ScriptComponentData } from './data.js';

const METHOD_INITIALIZE_ATTRIBUTES = '_onInitializeAttributes';
const METHOD_INITIALIZE = '_onInitialize';
const METHOD_POST_INITIALIZE = '_onPostInitialize';
const METHOD_UPDATE = '_onUpdate';
const METHOD_POST_UPDATE = '_onPostUpdate';
let executionOrderCounter = 0;

class ScriptComponentSystem extends ComponentSystem {
  constructor(app) {
    super(app);
    this.id = 'script';
    this.ComponentType = ScriptComponent;
    this.DataType = ScriptComponentData;
    this._components = new SortedLoopArray({
      sortBy: '_executionOrder'
    });
    this._enabledComponents = new SortedLoopArray({
      sortBy: '_executionOrder'
    });
    this.preloading = true;
    this.on('beforeremove', this._onBeforeRemove, this);
    this.app.systems.on('initialize', this._onInitialize, this);
    this.app.systems.on('postInitialize', this._onPostInitialize, this);
    this.app.systems.on('update', this._onUpdate, this);
    this.app.systems.on('postUpdate', this._onPostUpdate, this);
  }

  initializeComponentData(component, data) {
    component._executionOrder = executionOrderCounter++;

    this._components.append(component);

    if (executionOrderCounter > Number.MAX_SAFE_INTEGER) {
      this._resetExecutionOrder();
    }

    component.enabled = data.hasOwnProperty('enabled') ? !!data.enabled : true;

    if (component.enabled && component.entity.enabled) {
      this._enabledComponents.append(component);
    }

    if (data.hasOwnProperty('order') && data.hasOwnProperty('scripts')) {
      component._scriptsData = data.scripts;

      for (let i = 0; i < data.order.length; i++) {
        component.create(data.order[i], {
          enabled: data.scripts[data.order[i]].enabled,
          attributes: data.scripts[data.order[i]].attributes,
          preloading: this.preloading
        });
      }
    }
  }

  cloneComponent(entity, clone) {
    const order = [];
    const scripts = {};

    for (let i = 0; i < entity.script._scripts.length; i++) {
      const scriptInstance = entity.script._scripts[i];
      const scriptName = scriptInstance.__scriptType.__name;
      order.push(scriptName);
      const attributes = {};

      for (const key in scriptInstance.__attributes) attributes[key] = scriptInstance.__attributes[key];

      scripts[scriptName] = {
        enabled: scriptInstance._enabled,
        attributes: attributes
      };
    }

    for (const key in entity.script._scriptsIndex) {
      if (key.awaiting) {
        order.splice(key.ind, 0, key);
      }
    }

    const data = {
      enabled: entity.script.enabled,
      order: order,
      scripts: scripts
    };
    return this.addComponent(clone, data);
  }

  _resetExecutionOrder() {
    executionOrderCounter = 0;

    for (let i = 0, len = this._components.length; i < len; i++) {
      this._components.items[i]._executionOrder = executionOrderCounter++;
    }
  }

  _callComponentMethod(components, name, dt) {
    for (components.loopIndex = 0; components.loopIndex < components.length; components.loopIndex++) {
      components.items[components.loopIndex][name](dt);
    }
  }

  _onInitialize() {
    this.preloading = false;

    this._callComponentMethod(this._components, METHOD_INITIALIZE_ATTRIBUTES);

    this._callComponentMethod(this._enabledComponents, METHOD_INITIALIZE);
  }

  _onPostInitialize() {
    this._callComponentMethod(this._enabledComponents, METHOD_POST_INITIALIZE);
  }

  _onUpdate(dt) {
    this._callComponentMethod(this._enabledComponents, METHOD_UPDATE, dt);
  }

  _onPostUpdate(dt) {
    this._callComponentMethod(this._enabledComponents, METHOD_POST_UPDATE, dt);
  }

  _addComponentToEnabled(component) {
    this._enabledComponents.insert(component);
  }

  _removeComponentFromEnabled(component) {
    this._enabledComponents.remove(component);
  }

  _onBeforeRemove(entity, component) {
    const ind = this._components.items.indexOf(component);

    if (ind >= 0) {
      component._onBeforeRemove();
    }

    this._removeComponentFromEnabled(component);

    this._components.remove(component);
  }

  destroy() {
    super.destroy();
    this.app.systems.off('initialize', this._onInitialize, this);
    this.app.systems.off('postInitialize', this._onPostInitialize, this);
    this.app.systems.off('update', this._onUpdate, this);
    this.app.systems.off('postUpdate', this._onPostUpdate, this);
  }

}

export { ScriptComponentSystem };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3lzdGVtLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvZnJhbWV3b3JrL2NvbXBvbmVudHMvc2NyaXB0L3N5c3RlbS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTb3J0ZWRMb29wQXJyYXkgfSBmcm9tICcuLi8uLi8uLi9jb3JlL3NvcnRlZC1sb29wLWFycmF5LmpzJztcblxuaW1wb3J0IHsgQ29tcG9uZW50U3lzdGVtIH0gZnJvbSAnLi4vc3lzdGVtLmpzJztcblxuaW1wb3J0IHsgU2NyaXB0Q29tcG9uZW50IH0gZnJvbSAnLi9jb21wb25lbnQuanMnO1xuaW1wb3J0IHsgU2NyaXB0Q29tcG9uZW50RGF0YSB9IGZyb20gJy4vZGF0YS5qcyc7XG5cbi8qKiBAdHlwZWRlZiB7aW1wb3J0KCcuLi8uLi9hcHAtYmFzZS5qcycpLkFwcEJhc2V9IEFwcEJhc2UgKi9cblxuY29uc3QgTUVUSE9EX0lOSVRJQUxJWkVfQVRUUklCVVRFUyA9ICdfb25Jbml0aWFsaXplQXR0cmlidXRlcyc7XG5jb25zdCBNRVRIT0RfSU5JVElBTElaRSA9ICdfb25Jbml0aWFsaXplJztcbmNvbnN0IE1FVEhPRF9QT1NUX0lOSVRJQUxJWkUgPSAnX29uUG9zdEluaXRpYWxpemUnO1xuY29uc3QgTUVUSE9EX1VQREFURSA9ICdfb25VcGRhdGUnO1xuY29uc3QgTUVUSE9EX1BPU1RfVVBEQVRFID0gJ19vblBvc3RVcGRhdGUnO1xuXG4vLyBFdmVyLWluY3JlYXNpbmcgaW50ZWdlciB1c2VkIGFzIHRoZSBleGVjdXRpb24gb3JkZXIgb2YgbmV3IHNjcmlwdCBjb21wb25lbnRzLiBXZSBhcmUgdXNpbmcgYW5cbi8vIGV2ZXItaW5jcmVhc2luZyBudW1iZXIgYW5kIG5vdCB0aGUgb3JkZXIgb2YgdGhlIHNjcmlwdCBjb21wb25lbnQgaW4gdGhlIGNvbXBvbmVudHMgYXJyYXkgYmVjYXVzZVxuLy8gaWYgd2UgZXZlciByZW1vdmUgY29tcG9uZW50cyBmcm9tIHRoZSBhcnJheSwgd2Ugd291bGQgaGF2ZSB0byByZS1jYWxjdWxhdGUgdGhlIGV4ZWN1dGlvbiBvcmRlclxuLy8gZm9yIGFsbCBzdWJzZXF1ZW50IHNjcmlwdCBjb21wb25lbnRzIGluIHRoZSBhcnJheSBldmVyeSB0aW1lLCB3aGljaCB3b3VsZCBiZSBzbG93LlxubGV0IGV4ZWN1dGlvbk9yZGVyQ291bnRlciA9IDA7XG5cbi8qKlxuICogQWxsb3dzIHNjcmlwdHMgdG8gYmUgYXR0YWNoZWQgdG8gYW4gRW50aXR5IGFuZCBleGVjdXRlZC5cbiAqXG4gKiBAYXVnbWVudHMgQ29tcG9uZW50U3lzdGVtXG4gKi9cbmNsYXNzIFNjcmlwdENvbXBvbmVudFN5c3RlbSBleHRlbmRzIENvbXBvbmVudFN5c3RlbSB7XG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgbmV3IFNjcmlwdENvbXBvbmVudFN5c3RlbS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7QXBwQmFzZX0gYXBwIC0gVGhlIGFwcGxpY2F0aW9uLlxuICAgICAqIEBoaWRlY29uc3RydWN0b3JcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihhcHApIHtcbiAgICAgICAgc3VwZXIoYXBwKTtcblxuICAgICAgICB0aGlzLmlkID0gJ3NjcmlwdCc7XG5cbiAgICAgICAgdGhpcy5Db21wb25lbnRUeXBlID0gU2NyaXB0Q29tcG9uZW50O1xuICAgICAgICB0aGlzLkRhdGFUeXBlID0gU2NyaXB0Q29tcG9uZW50RGF0YTtcblxuICAgICAgICAvLyBsaXN0IG9mIGFsbCBlbnRpdGllcyBzY3JpcHQgY29tcG9uZW50c1xuICAgICAgICAvLyB3ZSBhcmUgdXNpbmcgcGMuU29ydGVkTG9vcEFycmF5IGJlY2F1c2UgaXQgaXNcbiAgICAgICAgLy8gc2FmZSB0byBtb2RpZnkgd2hpbGUgbG9vcGluZyB0aHJvdWdoIGl0XG4gICAgICAgIHRoaXMuX2NvbXBvbmVudHMgPSBuZXcgU29ydGVkTG9vcEFycmF5KHtcbiAgICAgICAgICAgIHNvcnRCeTogJ19leGVjdXRpb25PcmRlcidcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gaG9sZHMgYWxsIHRoZSBlbmFibGVkIHNjcmlwdCBjb21wb25lbnRzXG4gICAgICAgIC8vICh3aG9zZSBlbnRpdGllcyBhcmUgYWxzbyBlbmFibGVkKS4gV2UgYXJlIHVzaW5nIHBjLlNvcnRlZExvb3BBcnJheVxuICAgICAgICAvLyBiZWNhdXNlIGl0IGlzIHNhZmUgdG8gbW9kaWZ5IHdoaWxlIGxvb3BpbmcgdGhyb3VnaCBpdC4gVGhpcyBhcnJheSBvZnRlblxuICAgICAgICAvLyBjaGFuZ2UgZHVyaW5nIHVwZGF0ZSBhbmQgcG9zdFVwZGF0ZSBsb29wcyBhcyBlbnRpdGllcyBhbmQgY29tcG9uZW50cyBnZXRcbiAgICAgICAgLy8gZW5hYmxlZCBvciBkaXNhYmxlZFxuICAgICAgICB0aGlzLl9lbmFibGVkQ29tcG9uZW50cyA9IG5ldyBTb3J0ZWRMb29wQXJyYXkoe1xuICAgICAgICAgICAgc29ydEJ5OiAnX2V4ZWN1dGlvbk9yZGVyJ1xuICAgICAgICB9KTtcblxuXG4gICAgICAgIC8vIGlmIHRydWUgdGhlbiB3ZSBhcmUgY3VycmVudGx5IHByZWxvYWRpbmcgc2NyaXB0c1xuICAgICAgICB0aGlzLnByZWxvYWRpbmcgPSB0cnVlO1xuXG4gICAgICAgIHRoaXMub24oJ2JlZm9yZXJlbW92ZScsIHRoaXMuX29uQmVmb3JlUmVtb3ZlLCB0aGlzKTtcbiAgICAgICAgdGhpcy5hcHAuc3lzdGVtcy5vbignaW5pdGlhbGl6ZScsIHRoaXMuX29uSW5pdGlhbGl6ZSwgdGhpcyk7XG4gICAgICAgIHRoaXMuYXBwLnN5c3RlbXMub24oJ3Bvc3RJbml0aWFsaXplJywgdGhpcy5fb25Qb3N0SW5pdGlhbGl6ZSwgdGhpcyk7XG4gICAgICAgIHRoaXMuYXBwLnN5c3RlbXMub24oJ3VwZGF0ZScsIHRoaXMuX29uVXBkYXRlLCB0aGlzKTtcbiAgICAgICAgdGhpcy5hcHAuc3lzdGVtcy5vbigncG9zdFVwZGF0ZScsIHRoaXMuX29uUG9zdFVwZGF0ZSwgdGhpcyk7XG4gICAgfVxuXG4gICAgaW5pdGlhbGl6ZUNvbXBvbmVudERhdGEoY29tcG9uZW50LCBkYXRhKSB7XG4gICAgICAgIC8vIFNldCBleGVjdXRpb24gb3JkZXIgdG8gYW4gZXZlci1pbmNyZWFzaW5nIG51bWJlclxuICAgICAgICAvLyBhbmQgYWRkIHRvIHRoZSBlbmQgb2YgdGhlIGNvbXBvbmVudHMgYXJyYXkuXG4gICAgICAgIGNvbXBvbmVudC5fZXhlY3V0aW9uT3JkZXIgPSBleGVjdXRpb25PcmRlckNvdW50ZXIrKztcbiAgICAgICAgdGhpcy5fY29tcG9uZW50cy5hcHBlbmQoY29tcG9uZW50KTtcblxuICAgICAgICAvLyBjaGVjayB3ZSBkb24ndCBvdmVyZmxvdyBleGVjdXRpb25PcmRlckNvdW50ZXJcbiAgICAgICAgaWYgKGV4ZWN1dGlvbk9yZGVyQ291bnRlciA+IE51bWJlci5NQVhfU0FGRV9JTlRFR0VSKSB7XG4gICAgICAgICAgICB0aGlzLl9yZXNldEV4ZWN1dGlvbk9yZGVyKCk7XG4gICAgICAgIH1cblxuICAgICAgICBjb21wb25lbnQuZW5hYmxlZCA9IGRhdGEuaGFzT3duUHJvcGVydHkoJ2VuYWJsZWQnKSA/ICEhZGF0YS5lbmFibGVkIDogdHJ1ZTtcbiAgICAgICAgLy8gaWYgZW5hYmxlZCB0aGVuIGFkZCB0aGlzIGNvbXBvbmVudCB0byB0aGUgZW5kIG9mIHRoZSBlbmFibGVkQ29tcG9uZW50cyBhcnJheVxuICAgICAgICAvLyBOb3RlLCB3ZSBzaG91bGQgYmUgT0sgdG8ganVzdCBhcHBlbmQgdGhpcyB0byB0aGUgZW5kIGluc3RlYWQgb2YgdXNpbmcgaW5zZXJ0KClcbiAgICAgICAgLy8gd2hpY2ggd2lsbCBzZWFyY2ggZm9yIHRoZSByaWdodCBzbG90IHRvIGluc2VydCB0aGUgY29tcG9uZW50IGJhc2VkIG9uIGV4ZWN1dGlvbiBvcmRlcixcbiAgICAgICAgLy8gYmVjYXVzZSB0aGUgZXhlY3V0aW9uIG9yZGVyIG9mIHRoaXMgc2NyaXB0IHNob3VsZCBiZSBsYXJnZXIgdGhhbiBhbGwgdGhlIG90aGVycyBpbiB0aGVcbiAgICAgICAgLy8gZW5hYmxlZENvbXBvbmVudHMgYXJyYXkgc2luY2UgaXQgd2FzIGp1c3QgYWRkZWQuXG4gICAgICAgIGlmIChjb21wb25lbnQuZW5hYmxlZCAmJiBjb21wb25lbnQuZW50aXR5LmVuYWJsZWQpIHtcbiAgICAgICAgICAgIHRoaXMuX2VuYWJsZWRDb21wb25lbnRzLmFwcGVuZChjb21wb25lbnQpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGRhdGEuaGFzT3duUHJvcGVydHkoJ29yZGVyJykgJiYgZGF0YS5oYXNPd25Qcm9wZXJ0eSgnc2NyaXB0cycpKSB7XG4gICAgICAgICAgICBjb21wb25lbnQuX3NjcmlwdHNEYXRhID0gZGF0YS5zY3JpcHRzO1xuXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGEub3JkZXIubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBjb21wb25lbnQuY3JlYXRlKGRhdGEub3JkZXJbaV0sIHtcbiAgICAgICAgICAgICAgICAgICAgZW5hYmxlZDogZGF0YS5zY3JpcHRzW2RhdGEub3JkZXJbaV1dLmVuYWJsZWQsXG4gICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZXM6IGRhdGEuc2NyaXB0c1tkYXRhLm9yZGVyW2ldXS5hdHRyaWJ1dGVzLFxuICAgICAgICAgICAgICAgICAgICBwcmVsb2FkaW5nOiB0aGlzLnByZWxvYWRpbmdcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNsb25lQ29tcG9uZW50KGVudGl0eSwgY2xvbmUpIHtcbiAgICAgICAgY29uc3Qgb3JkZXIgPSBbXTtcbiAgICAgICAgY29uc3Qgc2NyaXB0cyA9IHsgfTtcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVudGl0eS5zY3JpcHQuX3NjcmlwdHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IHNjcmlwdEluc3RhbmNlID0gZW50aXR5LnNjcmlwdC5fc2NyaXB0c1tpXTtcbiAgICAgICAgICAgIGNvbnN0IHNjcmlwdE5hbWUgPSBzY3JpcHRJbnN0YW5jZS5fX3NjcmlwdFR5cGUuX19uYW1lO1xuICAgICAgICAgICAgb3JkZXIucHVzaChzY3JpcHROYW1lKTtcblxuICAgICAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IHsgfTtcbiAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIHNjcmlwdEluc3RhbmNlLl9fYXR0cmlidXRlcylcbiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzW2tleV0gPSBzY3JpcHRJbnN0YW5jZS5fX2F0dHJpYnV0ZXNba2V5XTtcblxuICAgICAgICAgICAgc2NyaXB0c1tzY3JpcHROYW1lXSA9IHtcbiAgICAgICAgICAgICAgICBlbmFibGVkOiBzY3JpcHRJbnN0YW5jZS5fZW5hYmxlZCxcbiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzOiBhdHRyaWJ1dGVzXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gZW50aXR5LnNjcmlwdC5fc2NyaXB0c0luZGV4KSB7XG4gICAgICAgICAgICBpZiAoa2V5LmF3YWl0aW5nKSB7XG4gICAgICAgICAgICAgICAgb3JkZXIuc3BsaWNlKGtleS5pbmQsIDAsIGtleSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBkYXRhID0ge1xuICAgICAgICAgICAgZW5hYmxlZDogZW50aXR5LnNjcmlwdC5lbmFibGVkLFxuICAgICAgICAgICAgb3JkZXI6IG9yZGVyLFxuICAgICAgICAgICAgc2NyaXB0czogc2NyaXB0c1xuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiB0aGlzLmFkZENvbXBvbmVudChjbG9uZSwgZGF0YSk7XG4gICAgfVxuXG4gICAgX3Jlc2V0RXhlY3V0aW9uT3JkZXIoKSB7XG4gICAgICAgIGV4ZWN1dGlvbk9yZGVyQ291bnRlciA9IDA7XG4gICAgICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSB0aGlzLl9jb21wb25lbnRzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICAgICAgICB0aGlzLl9jb21wb25lbnRzLml0ZW1zW2ldLl9leGVjdXRpb25PcmRlciA9IGV4ZWN1dGlvbk9yZGVyQ291bnRlcisrO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgX2NhbGxDb21wb25lbnRNZXRob2QoY29tcG9uZW50cywgbmFtZSwgZHQpIHtcbiAgICAgICAgZm9yIChjb21wb25lbnRzLmxvb3BJbmRleCA9IDA7IGNvbXBvbmVudHMubG9vcEluZGV4IDwgY29tcG9uZW50cy5sZW5ndGg7IGNvbXBvbmVudHMubG9vcEluZGV4KyspIHtcbiAgICAgICAgICAgIGNvbXBvbmVudHMuaXRlbXNbY29tcG9uZW50cy5sb29wSW5kZXhdW25hbWVdKGR0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9vbkluaXRpYWxpemUoKSB7XG4gICAgICAgIHRoaXMucHJlbG9hZGluZyA9IGZhbHNlO1xuXG4gICAgICAgIC8vIGluaXRpYWxpemUgYXR0cmlidXRlcyBvbiBhbGwgY29tcG9uZW50c1xuICAgICAgICB0aGlzLl9jYWxsQ29tcG9uZW50TWV0aG9kKHRoaXMuX2NvbXBvbmVudHMsIE1FVEhPRF9JTklUSUFMSVpFX0FUVFJJQlVURVMpO1xuXG4gICAgICAgIC8vIGNhbGwgb25Jbml0aWFsaXplIG9uIGVuYWJsZWQgY29tcG9uZW50c1xuICAgICAgICB0aGlzLl9jYWxsQ29tcG9uZW50TWV0aG9kKHRoaXMuX2VuYWJsZWRDb21wb25lbnRzLCBNRVRIT0RfSU5JVElBTElaRSk7XG4gICAgfVxuXG4gICAgX29uUG9zdEluaXRpYWxpemUoKSB7XG4gICAgICAgIC8vIGNhbGwgb25Qb3N0SW5pdGlhbGl6ZSBvbiBlbmFibGVkIGNvbXBvbmVudHNcbiAgICAgICAgdGhpcy5fY2FsbENvbXBvbmVudE1ldGhvZCh0aGlzLl9lbmFibGVkQ29tcG9uZW50cywgTUVUSE9EX1BPU1RfSU5JVElBTElaRSk7XG4gICAgfVxuXG4gICAgX29uVXBkYXRlKGR0KSB7XG4gICAgICAgIC8vIGNhbGwgb25VcGRhdGUgb24gZW5hYmxlZCBjb21wb25lbnRzXG4gICAgICAgIHRoaXMuX2NhbGxDb21wb25lbnRNZXRob2QodGhpcy5fZW5hYmxlZENvbXBvbmVudHMsIE1FVEhPRF9VUERBVEUsIGR0KTtcbiAgICB9XG5cbiAgICBfb25Qb3N0VXBkYXRlKGR0KSB7XG4gICAgICAgIC8vIGNhbGwgb25Qb3N0VXBkYXRlIG9uIGVuYWJsZWQgY29tcG9uZW50c1xuICAgICAgICB0aGlzLl9jYWxsQ29tcG9uZW50TWV0aG9kKHRoaXMuX2VuYWJsZWRDb21wb25lbnRzLCBNRVRIT0RfUE9TVF9VUERBVEUsIGR0KTtcbiAgICB9XG5cbiAgICAvLyBpbnNlcnRzIHRoZSBjb21wb25lbnQgaW50byB0aGUgZW5hYmxlZENvbXBvbmVudHMgYXJyYXlcbiAgICAvLyB3aGljaCBmaW5kcyB0aGUgcmlnaHQgc2xvdCBiYXNlZCBvbiBjb21wb25lbnQuX2V4ZWN1dGlvbk9yZGVyXG4gICAgX2FkZENvbXBvbmVudFRvRW5hYmxlZChjb21wb25lbnQpIHtcbiAgICAgICAgdGhpcy5fZW5hYmxlZENvbXBvbmVudHMuaW5zZXJ0KGNvbXBvbmVudCk7XG4gICAgfVxuXG4gICAgLy8gcmVtb3ZlcyB0aGUgY29tcG9uZW50IGZyb20gdGhlIGVuYWJsZWRDb21wb25lbnRzIGFycmF5XG4gICAgX3JlbW92ZUNvbXBvbmVudEZyb21FbmFibGVkKGNvbXBvbmVudCkge1xuICAgICAgICB0aGlzLl9lbmFibGVkQ29tcG9uZW50cy5yZW1vdmUoY29tcG9uZW50KTtcbiAgICB9XG5cbiAgICBfb25CZWZvcmVSZW1vdmUoZW50aXR5LCBjb21wb25lbnQpIHtcbiAgICAgICAgY29uc3QgaW5kID0gdGhpcy5fY29tcG9uZW50cy5pdGVtcy5pbmRleE9mKGNvbXBvbmVudCk7XG4gICAgICAgIGlmIChpbmQgPj0gMCkge1xuICAgICAgICAgICAgY29tcG9uZW50Ll9vbkJlZm9yZVJlbW92ZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fcmVtb3ZlQ29tcG9uZW50RnJvbUVuYWJsZWQoY29tcG9uZW50KTtcblxuICAgICAgICAvLyByZW1vdmUgZnJvbSBjb21wb25lbnRzIGFycmF5XG4gICAgICAgIHRoaXMuX2NvbXBvbmVudHMucmVtb3ZlKGNvbXBvbmVudCk7XG4gICAgfVxuXG4gICAgZGVzdHJveSgpIHtcbiAgICAgICAgc3VwZXIuZGVzdHJveSgpO1xuXG4gICAgICAgIHRoaXMuYXBwLnN5c3RlbXMub2ZmKCdpbml0aWFsaXplJywgdGhpcy5fb25Jbml0aWFsaXplLCB0aGlzKTtcbiAgICAgICAgdGhpcy5hcHAuc3lzdGVtcy5vZmYoJ3Bvc3RJbml0aWFsaXplJywgdGhpcy5fb25Qb3N0SW5pdGlhbGl6ZSwgdGhpcyk7XG4gICAgICAgIHRoaXMuYXBwLnN5c3RlbXMub2ZmKCd1cGRhdGUnLCB0aGlzLl9vblVwZGF0ZSwgdGhpcyk7XG4gICAgICAgIHRoaXMuYXBwLnN5c3RlbXMub2ZmKCdwb3N0VXBkYXRlJywgdGhpcy5fb25Qb3N0VXBkYXRlLCB0aGlzKTtcbiAgICB9XG59XG5cbmV4cG9ydCB7IFNjcmlwdENvbXBvbmVudFN5c3RlbSB9O1xuIl0sIm5hbWVzIjpbIk1FVEhPRF9JTklUSUFMSVpFX0FUVFJJQlVURVMiLCJNRVRIT0RfSU5JVElBTElaRSIsIk1FVEhPRF9QT1NUX0lOSVRJQUxJWkUiLCJNRVRIT0RfVVBEQVRFIiwiTUVUSE9EX1BPU1RfVVBEQVRFIiwiZXhlY3V0aW9uT3JkZXJDb3VudGVyIiwiU2NyaXB0Q29tcG9uZW50U3lzdGVtIiwiQ29tcG9uZW50U3lzdGVtIiwiY29uc3RydWN0b3IiLCJhcHAiLCJpZCIsIkNvbXBvbmVudFR5cGUiLCJTY3JpcHRDb21wb25lbnQiLCJEYXRhVHlwZSIsIlNjcmlwdENvbXBvbmVudERhdGEiLCJfY29tcG9uZW50cyIsIlNvcnRlZExvb3BBcnJheSIsInNvcnRCeSIsIl9lbmFibGVkQ29tcG9uZW50cyIsInByZWxvYWRpbmciLCJvbiIsIl9vbkJlZm9yZVJlbW92ZSIsInN5c3RlbXMiLCJfb25Jbml0aWFsaXplIiwiX29uUG9zdEluaXRpYWxpemUiLCJfb25VcGRhdGUiLCJfb25Qb3N0VXBkYXRlIiwiaW5pdGlhbGl6ZUNvbXBvbmVudERhdGEiLCJjb21wb25lbnQiLCJkYXRhIiwiX2V4ZWN1dGlvbk9yZGVyIiwiYXBwZW5kIiwiTnVtYmVyIiwiTUFYX1NBRkVfSU5URUdFUiIsIl9yZXNldEV4ZWN1dGlvbk9yZGVyIiwiZW5hYmxlZCIsImhhc093blByb3BlcnR5IiwiZW50aXR5IiwiX3NjcmlwdHNEYXRhIiwic2NyaXB0cyIsImkiLCJvcmRlciIsImxlbmd0aCIsImNyZWF0ZSIsImF0dHJpYnV0ZXMiLCJjbG9uZUNvbXBvbmVudCIsImNsb25lIiwic2NyaXB0IiwiX3NjcmlwdHMiLCJzY3JpcHRJbnN0YW5jZSIsInNjcmlwdE5hbWUiLCJfX3NjcmlwdFR5cGUiLCJfX25hbWUiLCJwdXNoIiwia2V5IiwiX19hdHRyaWJ1dGVzIiwiX2VuYWJsZWQiLCJfc2NyaXB0c0luZGV4IiwiYXdhaXRpbmciLCJzcGxpY2UiLCJpbmQiLCJhZGRDb21wb25lbnQiLCJsZW4iLCJpdGVtcyIsIl9jYWxsQ29tcG9uZW50TWV0aG9kIiwiY29tcG9uZW50cyIsIm5hbWUiLCJkdCIsImxvb3BJbmRleCIsIl9hZGRDb21wb25lbnRUb0VuYWJsZWQiLCJpbnNlcnQiLCJfcmVtb3ZlQ29tcG9uZW50RnJvbUVuYWJsZWQiLCJyZW1vdmUiLCJpbmRleE9mIiwiZGVzdHJveSIsIm9mZiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQVNBLE1BQU1BLDRCQUE0QixHQUFHLHlCQUFyQyxDQUFBO0FBQ0EsTUFBTUMsaUJBQWlCLEdBQUcsZUFBMUIsQ0FBQTtBQUNBLE1BQU1DLHNCQUFzQixHQUFHLG1CQUEvQixDQUFBO0FBQ0EsTUFBTUMsYUFBYSxHQUFHLFdBQXRCLENBQUE7QUFDQSxNQUFNQyxrQkFBa0IsR0FB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
