import"../core/tracing.js";import{Vec3 as e}from"../math/vec3.js";import{PIXELFORMAT_R8_G8_B8_A8 as t,TEXTURETYPE_DEFAULT as r,TEXTURETYPE_RGBM as l}from"./constants.js";import{createShaderFromCode as o}from"./program-lib/utils.js";import{drawQuadWithShader as n}from"./simple-post-effect.js";import{shaderChunks as s}from"./program-lib/chunks/chunks.js";import{RenderTarget as f}from"./render-target.js";import{Texture as m}from"./texture.js";function i(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}function a(e,t,r){let l=2*(e+.5)/r-1,o=2*(t+.5)/r-1;l*=1-1/r,o*=1-1/r;const n=1/r,s=l-n,f=o-n,m=l+n,a=o+n;let c=i(s,f)-i(s,a)-i(m,f)+i(m,a);return 0===e&&0===t||e===r-1&&0===t||0===e&&t===r-1||e===r-1&&t===r-1?c/=3:0!==e&&0!==t&&e!==r-1&&t!==r-1||(c*=.5),c}function c(i,c,u){if(c.format!==t)return null;if(!c._levels[0]||!c._levels[0][0])return null;const p=c.width;if(!c._levels[0][0].length){if(!(c._levels[0][0]instanceof HTMLImageElement))return null;{const e=o(i,s.fullscreenQuadVS,s.fullscreenQuadPS,"fsQuadSimple"),t=i.scope.resolve("source");for(let l=0;l<6;l++){const o=c._levels[0][l],s=new m(i,{name:"prefiltered-cube",cubemap:!1,type:r,format:c.format,width:p,height:p,mipmaps:!1});s._levels[0]=o,s.upload();const a=new m(i,{name:"prefiltered-cube",cubemap:!1,type:r,format:c.format,width:p,height:p,mipmaps:!1}),u=new f({colorBuffer:a,depth:!1});t.setValue(s),n(i,u,e);const h=i.gl;h.bindFramebuffer(h.FRAMEBUFFER,u.impl._glFrameBuffer);const d=new Uint8Array(p*p*4);h.readPixels(0,0,s.width,s.height,h.RGBA,h.UNSIGNED_BYTE,d),c._levels[0][l]=d}}}const h=[];for(let t=0;t<p;t++)for(let r=0;r<p;r++){const l=r/(p-1)*2-1,o=t/(p-1)*2-1;h[t*p+r]=new e(l,o,1).normalize()}const d=new Float32Array(27);let g=0;for(let e=0;e<6;e++)for(let t=0;t<p;t++)for(let r=0;r<p;r++){const o=t*p+r,n=a(r,t,p),s=4*n/17,f=8*n/17,m=15*n/17,i=5*n/68,v=15*n/68,w=h[o];let y,_,x;0===e?(y=w.z,_=-w.y,x=-w.x):1===e?(y=-w.z,_=-w.y,x=w.x):2===e?(y=w.x,_=w.z,x=w.y):3===e?(y=w.x,_=-w.z,x=-w.y):4===e?(y=w.x,_=-w.y,x=w.z):5===e&&(y=-w.x,_=-w.y,x=-w.z),u||(y=-y);const b=c._levels[0][e][4*o+3]/255;for(let t=0;t<3;t++){let r=c._levels[0][e][4*o+t]/255;c.type===l?(r*=8*b,r*=r):r=Math.pow(r,2.2),d[0+t]+=r*s,d[3+t]+=r*f*y,d[6+t]+=r*f*_,d[9+t]+=r*f*x,d[12+t]+=r*m*y*x,d[15+t]+=r*m*x*_,d[18+t]+=r*m*_*y,d[21+t]+=r*i*(3*x*x-1),d[24+t]+=r*v*(y*y-_*_),g+=n}}for(let e=0;e<d.length;e++)d[e]*=4*Math.PI/g;return d}export{c as shFromCubemap};
