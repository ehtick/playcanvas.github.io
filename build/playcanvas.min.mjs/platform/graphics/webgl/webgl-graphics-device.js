import{setupVertexArrayObject as t}from"../../../polyfill/OESVertexArrayObject.js";import"../../../core/tracing.js";import{platform as e}from"../../../core/platform.js";import{Color as i}from"../../../core/math/color.js";import{DEVICETYPE_WEBGL as s,PIXELFORMAT_RGBA8 as r,PIXELFORMAT_RGB8 as n,CLEARFLAG_COLOR as a,CLEARFLAG_DEPTH as l,UNIFORMTYPE_BOOL as o,UNIFORMTYPE_INT as h,UNIFORMTYPE_FLOAT as c,UNIFORMTYPE_VEC2 as u,UNIFORMTYPE_VEC3 as d,UNIFORMTYPE_VEC4 as f,UNIFORMTYPE_IVEC2 as _,UNIFORMTYPE_IVEC3 as E,UNIFORMTYPE_IVEC4 as p,UNIFORMTYPE_BVEC2 as T,UNIFORMTYPE_BVEC3 as m,UNIFORMTYPE_BVEC4 as g,UNIFORMTYPE_MAT2 as x,UNIFORMTYPE_MAT3 as F,UNIFORMTYPE_MAT4 as A,UNIFORMTYPE_TEXTURE2D as R,UNIFORMTYPE_TEXTURECUBE as b,UNIFORMTYPE_TEXTURE2D_SHADOW as S,UNIFORMTYPE_TEXTURECUBE_SHADOW as B,UNIFORMTYPE_TEXTURE3D as C,UNIFORMTYPE_FLOATARRAY as U,UNIFORMTYPE_VEC2ARRAY as O,UNIFORMTYPE_VEC3ARRAY as v,UNIFORMTYPE_VEC4ARRAY as L,PIXELFORMAT_RGBA16F as M,PIXELFORMAT_RGBA32F as I,BLENDMODE_ONE as P,BLENDMODE_ZERO as D,BLENDEQUATION_ADD as N,CULLFACE_BACK as w,FUNC_LESSEQUAL as y,FUNC_ALWAYS as k,STENCILOP_KEEP as H,ADDRESS_CLAMP_TO_EDGE as V,semanticToLocation as X,CLEARFLAG_STENCIL as G,CULLFACE_NONE as W,FILTER_NEAREST_MIPMAP_NEAREST as Z,FILTER_NEAREST_MIPMAP_LINEAR as j,FILTER_NEAREST as K,FILTER_LINEAR_MIPMAP_NEAREST as q,FILTER_LINEAR_MIPMAP_LINEAR as z,FILTER_LINEAR as Y}from"../constants.js";import{GraphicsDevice as Q}from"../graphics-device.js";import{drawQuadWithShader as J}from"../simple-post-effect.js";import{RenderTarget as $}from"../render-target.js";import{Texture as tt}from"../texture.js";import{WebglVertexBuffer as et}from"./webgl-vertex-buffer.js";import{WebglIndexBuffer as it}from"./webgl-index-buffer.js";import{WebglShader as st}from"./webgl-shader.js";import{WebglTexture as rt}from"./webgl-texture.js";import{WebglRenderTarget as nt}from"./webgl-render-target.js";import{ShaderUtils as at}from"../shader-utils.js";import{Shader as lt}from"../shader.js";const ot=[],ht="\nattribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n    gl_Position = vec4(vertex_position, 0.5, 1.0);\n    vUv0 = vertex_position.xy*0.5+0.5;\n}\n";function ct(t,e){let i=!0;const s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,2,2,0,t.RGBA,e,null);const r=t.createFramebuffer();return t.bindFramebuffer(t.FRAMEBUFFER,r),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,s,0),t.checkFramebufferStatus(t.FRAMEBUFFER)!==t.FRAMEBUFFER_COMPLETE&&(i=!1),t.bindTexture(t.TEXTURE_2D,null),t.deleteTexture(s),t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteFramebuffer(r),i}class ut extends Q{constructor(i,P={}){super(i),this.gl=void 0,this.webgl2=void 0,this.deviceType=s,this.defaultFramebuffer=null,this.updateClientRect(),this.contextLost=!1,this._contextLostHandler=t=>{t.preventDefault(),this.contextLost=!0,this.loseContext(),this.fire("devicelost")},this._contextRestoredHandler=()=>{this.restoreContext(),this.contextLost=!1,this.fire("devicerestored")},P.stencil=!0,P.powerPreference||(P.powerPreference="high-performance");const D="undefined"!=typeof navigator&&navigator.userAgent;this.forceDisableMultisampling=D&&D.includes("AppleWebKit")&&(D.includes("15.4")||D.includes("15_4")),this.forceDisableMultisampling&&(P.antialias=!1);const N=void 0===P.preferWebGl2||P.preferWebGl2?["webgl2","webgl","experimental-webgl"]:["webgl","experimental-webgl"];let w=null;for(let t=0;t<N.length;t++)if(w=i.getContext(N[t],P),w){this.webgl2="webgl2"===N[t];break}if(this.gl=w,!w)throw new Error("WebGL not supported");const y=w.getParameter(w.ALPHA_BITS);this.framebufferFormat=y?r:n;const k=e.browser&&!!window.chrome,H=e.browser&&-1!==navigator.appVersion.indexOf("Mac");let V,X,G,W,Z;this._tempEnableSafariTextureUnitWorkaround=e.browser&&!!window.safari,this._tempMacChromeBlitFramebufferWorkaround=H&&k&&!P.alpha,this.webgl2||t(w),i.addEventListener("webglcontextlost",this._contextLostHandler,!1),i.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches(),this.supportsImageBitmap=null,"undefined"!=typeof ImageBitmap&&function(t){const e=new Uint8Array([137,80,78,71,13,10,26,10,0,0,0,13,73,72,68,82,0,0,0,1,0,0,0,1,8,6,0,0,0,31,21,196,137,0,0,0,13,73,68,65,84,120,218,99,100,100,98,182,7,0,0,89,0,71,67,133,148,237,0,0,0,0,73,69,78,68,174,66,96,130]);return createImageBitmap(new Blob([e],{type:"image/png"}),{premultiplyAlpha:"none"}).then((e=>{const i=new tt(t,{width:1,height:1,format:r,mipmaps:!1,levels:[e]}),s=new $({colorBuffer:i,depth:!1});t.setFramebuffer(s.impl._glFrameBuffer),t.initRenderTarget(s);const n=new Uint8ClampedArray(4);return t.gl.readPixels(0,0,1,1,t.gl.RGBA,t.gl.UNSIGNED_BYTE,n),s.destroy(),i.destroy(),1===n[0]&&2===n[1]&&3===n[2]&&63===n[3]})).catch((t=>!1))}(this).then((t=>{this.supportsImageBitmap=t})),this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:a|l},this.glAddress=[w.REPEAT,w.CLAMP_TO_EDGE,w.MIRRORED_REPEAT],this.glBlendEquation=[w.FUNC_ADD,w.FUNC_SUBTRACT,w.FUNC_REVERSE_SUBTRACT,this.webgl2?w.MIN:this.extBlendMinmax?this.extBlendMinmax.MIN_EXT:w.FUNC_ADD,this.webgl2?w.MAX:this.extBlendMinmax?this.extBlendMinmax.MAX_EXT:w.FUNC_ADD],this.glBlendFunction=[w.ZERO,w.ONE,w.SRC_COLOR,w.ONE_MINUS_SRC_COLOR,w.DST_COLOR,w.ONE_MINUS_DST_COLOR,w.SRC_ALPHA,w.SRC_ALPHA_SATURATE,w.ONE_MINUS_SRC_ALPHA,w.DST_ALPHA,w.ONE_MINUS_DST_ALPHA,w.CONSTANT_COLOR,w.ONE_MINUS_CONSTANT_COLOR,w.CONSTANT_ALPHA,w.ONE_MINUS_CONSTANT_ALPHA],this.glComparison=[w.NEVER,w.LESS,w.EQUAL,w.LEQUAL,w.GREATER,w.NOTEQUAL,w.GEQUAL,w.ALWAYS],this.glStencilOp=[w.KEEP,w.ZERO,w.REPLACE,w.INCR,w.INCR_WRAP,w.DECR,w.DECR_WRAP,w.INVERT],this.glClearFlag=[0,w.COLOR_BUFFER_BIT,w.DEPTH_BUFFER_BIT,w.COLOR_BUFFER_BIT|w.DEPTH_BUFFER_BIT,w.STENCIL_BUFFER_BIT,w.STENCIL_BUFFER_BIT|w.COLOR_BUFFER_BIT,w.STENCIL_BUFFER_BIT|w.DEPTH_BUFFER_BIT,w.STENCIL_BUFFER_BIT|w.COLOR_BUFFER_BIT|w.DEPTH_BUFFER_BIT],this.glCull=[0,w.BACK,w.FRONT,w.FRONT_AND_BACK],this.glFilter=[w.NEAREST,w.LINEAR,w.NEAREST_MIPMAP_NEAREST,w.NEAREST_MIPMAP_LINEAR,w.LINEAR_MIPMAP_NEAREST,w.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[w.POINTS,w.LINES,w.LINE_LOOP,w.LINE_STRIP,w.TRIANGLES,w.TRIANGLE_STRIP,w.TRIANGLE_FAN],this.glType=[w.BYTE,w.UNSIGNED_BYTE,w.SHORT,w.UNSIGNED_SHORT,w.INT,w.UNSIGNED_INT,w.FLOAT],this.pcUniformType={},this.pcUniformType[w.BOOL]=o,this.pcUniformType[w.INT]=h,this.pcUniformType[w.FLOAT]=c,this.pcUniformType[w.FLOAT_VEC2]=u,this.pcUniformType[w.FLOAT_VEC3]=d,this.pcUniformType[w.FLOAT_VEC4]=f,this.pcUniformType[w.INT_VEC2]=_,this.pcUniformType[w.INT_VEC3]=E,this.pcUniformType[w.INT_VEC4]=p,this.pcUniformType[w.BOOL_VEC2]=T,this.pcUniformType[w.BOOL_VEC3]=m,this.pcUniformType[w.BOOL_VEC4]=g,this.pcUniformType[w.FLOAT_MAT2]=x,this.pcUniformType[w.FLOAT_MAT3]=F,this.pcUniformType[w.FLOAT_MAT4]=A,this.pcUniformType[w.SAMPLER_2D]=R,this.pcUniformType[w.SAMPLER_CUBE]=b,this.webgl2&&(this.pcUniformType[w.SAMPLER_2D_SHADOW]=S,this.pcUniformType[w.SAMPLER_CUBE_SHADOW]=B,this.pcUniformType[w.SAMPLER_3D]=C),this.targetToSlot={},this.targetToSlot[w.TEXTURE_2D]=0,this.targetToSlot[w.TEXTURE_CUBE_MAP]=1,this.targetToSlot[w.TEXTURE_3D]=2,this.commitFunction=[],this.commitFunction[o]=function(t,e){t.value!==e&&(w.uniform1i(t.locationId,e),t.value=e)},this.commitFunction[h]=this.commitFunction[o],this.commitFunction[c]=function(t,e){t.value!==e&&(w.uniform1f(t.locationId,e),t.value=e)},this.commitFunction[u]=function(t,e){Z=t.value,V=e[0],X=e[1],Z[0]===V&&Z[1]===X||(w.uniform2fv(t.locationId,e),Z[0]=V,Z[1]=X)},this.commitFunction[d]=function(t,e){Z=t.value,V=e[0],X=e[1],G=e[2],Z[0]===V&&Z[1]===X&&Z[2]===G||(w.uniform3fv(t.locationId,e),Z[0]=V,Z[1]=X,Z[2]=G)},this.commitFunction[f]=function(t,e){Z=t.value,V=e[0],X=e[1],G=e[2],W=e[3],Z[0]===V&&Z[1]===X&&Z[2]===G&&Z[3]===W||(w.uniform4fv(t.locationId,e),Z[0]=V,Z[1]=X,Z[2]=G,Z[3]=W)},this.commitFunction[_]=function(t,e){Z=t.value,V=e[0],X=e[1],Z[0]===V&&Z[1]===X||(w.uniform2iv(t.locationId,e),Z[0]=V,Z[1]=X)},this.commitFunction[T]=this.commitFunction[_],this.commitFunction[E]=function(t,e){Z=t.value,V=e[0],X=e[1],G=e[2],Z[0]===V&&Z[1]===X&&Z[2]===G||(w.uniform3iv(t.locationId,e),Z[0]=V,Z[1]=X,Z[2]=G)},this.commitFunction[m]=this.commitFunction[E],this.commitFunction[p]=function(t,e){Z=t.value,V=e[0],X=e[1],G=e[2],W=e[3],Z[0]===V&&Z[1]===X&&Z[2]===G&&Z[3]===W||(w.uniform4iv(t.locationId,e),Z[0]=V,Z[1]=X,Z[2]=G,Z[3]=W)},this.commitFunction[g]=this.commitFunction[p],this.commitFunction[x]=function(t,e){w.uniformMatrix2fv(t.locationId,!1,e)},this.commitFunction[F]=function(t,e){w.uniformMatrix3fv(t.locationId,!1,e)},this.commitFunction[A]=function(t,e){w.uniformMatrix4fv(t.locationId,!1,e)},this.commitFunction[U]=function(t,e){w.uniform1fv(t.locationId,e)},this.commitFunction[O]=function(t,e){w.uniform2fv(t.locationId,e)},this.commitFunction[v]=function(t,e){w.uniform3fv(t.locationId,e)},this.commitFunction[L]=function(t,e){w.uniform4fv(t.locationId,e)},this.supportsBoneTextures=this.extTextureFloat&&this.maxVertexTextures>0;let j=this.vertexUniformsCount;j-=16,j-=8,j-=1,j-=16,this.boneLimit=Math.floor(j/3),this.boneLimit=Math.min(this.boneLimit,128),"Mali-450 MP"===this.unmaskedRenderer&&(this.boneLimit=34),this.constantTexSource=this.scope.resolve("source"),this.extTextureFloat?this.webgl2?this.textureFloatRenderable=!!this.extColorBufferFloat:this.textureFloatRenderable=ct(w,w.FLOAT):this.textureFloatRenderable=!1,this.extColorBufferHalfFloat?this.textureHalfFloatRenderable=!!this.extColorBufferHalfFloat:this.extTextureHalfFloat?this.webgl2?this.textureHalfFloatRenderable=!!this.extColorBufferFloat:this.textureHalfFloatRenderable=ct(w,this.extTextureHalfFloat.HALF_FLOAT_OES):this.textureHalfFloatRenderable=!1,this.supportsMorphTargetTexturesCore="highp"===this.maxPrecision&&this.maxVertexTextures>=2,this._textureFloatHighPrecision=void 0,this._textureHalfFloatUpdatable=void 0,this.areaLightLutFormat=r,this.extTextureHalfFloat&&this.textureHalfFloatUpdatable&&this.extTextureHalfFloatLinear?this.areaLightLutFormat=M:this.extTextureFloat&&this.extTextureFloatLinear&&(this.areaLightLutFormat=I)}destroy(){super.destroy();const t=this.gl;this.webgl2&&this.feedback&&t.deleteTransformFeedback(this.feedback),this.clearShaderCache(),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._contextLostHandler=null,this._contextRestoredHandler=null,this.gl=null,super.postDestroy()}createVertexBufferImpl(t,e){return new et}createIndexBufferImpl(t){return new it(t)}createShaderImpl(t){return new st(t)}createTextureImpl(t){return new rt}createRenderTargetImpl(t){return new nt}getPrecision(){const t=this.gl;let e="highp";if(t.getShaderPrecisionFormat){const i=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT),s=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT),r=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT),n=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT),a=i.precision>0&&r.precision>0,l=s.precision>0&&n.precision>0;a||(e=l?"mediump":"lowp")}return e}initializeExtensions(){const t=this.gl,e=t.getSupportedExtensions(),i=function(){for(let i=0;i<arguments.length;i++)if(-1!==e.indexOf(arguments[i]))return t.getExtension(arguments[i]);return null};if(this.webgl2)this.extBlendMinmax=!0,this.extDrawBuffers=!0,this.extInstancing=!0,this.extStandardDerivatives=!0,this.extTextureFloat=!0,this.extTextureHalfFloat=!0,this.extTextureLod=!0,this.extUintElement=!0,this.extVertexArrayObject=!0,this.extColorBufferFloat=i("EXT_color_buffer_float"),this.extDisjointTimerQuery=i("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query"),this.extDepthTexture=!0;else{if(this.extBlendMinmax=i("EXT_blend_minmax"),this.extDrawBuffers=i("EXT_draw_buffers"),this.extInstancing=i("ANGLE_instanced_arrays"),this.extInstancing){const e=this.extInstancing;t.drawArraysInstanced=e.drawArraysInstancedANGLE.bind(e),t.drawElementsInstanced=e.drawElementsInstancedANGLE.bind(e),t.vertexAttribDivisor=e.vertexAttribDivisorANGLE.bind(e)}if(this.extStandardDerivatives=i("OES_standard_derivatives"),this.extTextureFloat=i("OES_texture_float"),this.extTextureHalfFloat=i("OES_texture_half_float"),this.extTextureLod=i("EXT_shader_texture_lod"),this.extUintElement=i("OES_element_index_uint"),this.extVertexArrayObject=i("OES_vertex_array_object"),this.extVertexArrayObject){const e=this.extVertexArrayObject;t.createVertexArray=e.createVertexArrayOES.bind(e),t.deleteVertexArray=e.deleteVertexArrayOES.bind(e),t.isVertexArray=e.isVertexArrayOES.bind(e),t.bindVertexArray=e.bindVertexArrayOES.bind(e)}this.extColorBufferFloat=null,this.extDisjointTimerQuery=null,this.extDepthTexture=t.getExtension("WEBGL_depth_texture")}this.extDebugRendererInfo=i("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=i("OES_texture_float_linear"),this.extTextureHalfFloatLinear=i("OES_texture_half_float_linear"),this.extFloatBlend=i("EXT_float_blend"),this.extTextureFilterAnisotropic=i("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extCompressedTextureETC1=i("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=i("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=i("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=i("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureATC=i("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=i("WEBGL_compressed_texture_astc"),this.extParallelShaderCompile=i("KHR_parallel_shader_compile"),this.extColorBufferHalfFloat=i("EXT_color_buffer_half_float")}initializeCapabilities(){const t=this.gl;let i;const s="undefined"!=typeof navigator?navigator.userAgent:"";this.maxPrecision=this.precision=this.getPrecision();const r=t.getContextAttributes();this.supportsMsaa=r.antialias,this.supportsStencil=r.stencil,this.supportsInstancing=!!this.extInstancing,this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubeMapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=t.getParameter(t.MAX_RENDERBUFFER_SIZE),this.maxTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this.webgl2?(this.maxDrawBuffers=t.getParameter(t.MAX_DRAW_BUFFERS),this.maxColorAttachments=t.getParameter(t.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE)):(i=this.extDrawBuffers,this.maxDrawBuffers=i?t.getParameter(i.MAX_DRAW_BUFFERS_EXT):1,this.maxColorAttachments=i?t.getParameter(i.MAX_COLOR_ATTACHMENTS_EXT):1,this.maxVolumeSize=1),i=this.extDebugRendererInfo,this.unmaskedRenderer=i?t.getParameter(i.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=i?t.getParameter(i.UNMASKED_VENDOR_WEBGL):"";this.supportsGpuParticles=!("ARM"===this.unmaskedVendor&&s.match(/SM-[a-zA-Z0-9]+/)),i=this.extTextureFilterAnisotropic,this.maxAnisotropy=i?t.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1,this.samples=t.getParameter(t.SAMPLES),this.maxSamples=this.webgl2&&!this.forceDisableMultisampling?t.getParameter(t.MAX_SAMPLES):1,this.supportsAreaLights=this.webgl2||!e.android,this.supportsTextureFetch=this.webgl2,this.maxTextures<=8&&(this.supportsAreaLights=!1)}initializeRenderState(){const t=this.gl;this.blending=!1,t.disable(t.BLEND),this.blendSrc=P,this.blendDst=D,this.blendSrcAlpha=P,this.blendDstAlpha=D,this.separateAlphaBlend=!1,this.blendEquation=N,this.blendAlphaEquation=N,this.separateAlphaEquation=!1,t.blendFunc(t.ONE,t.ZERO),t.blendEquation(t.FUNC_ADD),this.blendColor=new i(0,0,0,0),t.blendColor(0,0,0,0),this.writeRed=!0,this.writeGreen=!0,this.writeBlue=!0,this.writeAlpha=!0,t.colorMask(!0,!0,!0,!0),this.cullMode=w,t.enable(t.CULL_FACE),t.cullFace(t.BACK),this.depthTest=!0,t.enable(t.DEPTH_TEST),this.depthFunc=y,t.depthFunc(t.LEQUAL),this.depthWrite=!0,t.depthMask(!0),this.stencil=!1,t.disable(t.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=k,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,t.stencilFunc(t.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=H,this.stencilZfailFront=this.stencilZfailBack=H,this.stencilZpassFront=this.stencilZpassBack=H,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,this.webgl2&&(t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.RASTERIZER_DISCARD)),this.depthBiasEnabled=!1,t.disable(t.POLYGON_OFFSET_FILL),this.clearDepth=1,t.clearDepth(1),this.clearColor=new i(0,0,0,0),t.clearColor(0,0,0,0),this.clearStencil=0,t.clearStencil(0),this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.webgl2?t.hint(t.FRAGMENT_SHADER_DERIVATIVE_HINT,t.NICEST):this.extStandardDerivatives&&t.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,t.NICEST),t.enable(t.SCISSOR_TEST),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.NONE),this.unpackFlipY=!1,t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.pixelStorei(t.UNPACK_ALIGNMENT,1)}initializeContextCaches(){super.initializeContextCaches(),this.vertexShaderCache={},this.fragmentShaderCache={},this._vaoMap=new Map,this.boundVao=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.textureUnits=[];for(let t=0;t<this.maxCombinedTextures;t++)this.textureUnits.push([null,null,null])}loseContext(){for(const t of this.shaders)t.loseContext();for(const t of this.textures)t.loseContext();for(const t of this.buffers)t.loseContext();for(const t of this.targets)t.loseContext()}restoreContext(){this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches();for(const t of this.shaders)t.restoreContext();for(const t of this.buffers)t.unlock()}setViewport(t,e,i,s){this.vx===t&&this.vy===e&&this.vw===i&&this.vh===s||(this.gl.viewport(t,e,i,s),this.vx=t,this.vy=e,this.vw=i,this.vh=s)}setScissor(t,e,i,s){this.sx===t&&this.sy===e&&this.sw===i&&this.sh===s||(this.gl.scissor(t,e,i,s),this.sx=t,this.sy=e,this.sw=i,this.sh=s)}setFramebuffer(t){if(this.activeFramebuffer!==t){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,t),this.activeFramebuffer=t}}copyRenderTarget(t,e,i,s){const r=this.gl;if(!this.webgl2&&s)return!1;if(i)if(e){if(t){if(!t._colorBuffer||!e._colorBuffer)return!1;if(t._colorBuffer._format!==e._colorBuffer._format)return!1}}else if(!t._colorBuffer)return!1;if(s&&t&&!t._depth){if(!t._depthBuffer||!e._depthBuffer)return!1;if(t._depthBuffer._format!==e._depthBuffer._format)return!1}if(this.webgl2&&e){const n=this.renderTarget;this.renderTarget=e,this.updateBegin(),r.bindFramebuffer(r.READ_FRAMEBUFFER,t?t.impl._glFrameBuffer:null),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,e.impl._glFrameBuffer);const a=t?t.width:e.width,l=t?t.height:e.height;r.blitFramebuffer(0,0,a,l,0,0,a,l,(i?r.COLOR_BUFFER_BIT:0)|(s?r.DEPTH_BUFFER_BIT:0),r.NEAREST),this.renderTarget=n,r.bindFramebuffer(r.FRAMEBUFFER,n?n.impl._glFrameBuffer:null)}else{const i=this.getCopyShader();this.constantTexSource.setValue(t._colorBuffer),J(this,e,i)}return!0}getCopyShader(){return this._copyShader||(this._copyShader=new lt(this,at.createDefinition(this,{name:"outputTex2D",vertexCode:ht,fragmentCode:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n    gl_FragColor = texture2D(source, vUv0);\n}\n"}))),this._copyShader}startPass(t){this.setRenderTarget(t.renderTarget),this.updateBegin();const e=t.colorOps,i=t.depthStencilOps;if(e.clear||i.clearDepth||i.clearStencil){const s=t.renderTarget,r=s?s.width:this.width,n=s?s.height:this.height;this.setViewport(0,0,r,n),this.setScissor(0,0,r,n);let o=0;const h={};e.clear&&(o|=a,h.color=[e.clearValue.r,e.clearValue.g,e.clearValue.b,e.clearValue.a]),i.clearDepth&&(o|=l,h.depth=i.clearDepthValue),i.clearStencil&&(o|=G,h.stencil=i.clearStencilValue),h.flags=o,this.clear(h)}this.insideRenderPass=!0}endPass(t){this.unbindVertexArray();const e=this.renderTarget;if(e){if(this.webgl2){ot.length=0;const e=this.gl;t.colorOps.store||t.colorOps.resolve||ot.push(e.COLOR_ATTACHMENT0),t.depthStencilOps.storeDepth||ot.push(e.DEPTH_ATTACHMENT),t.depthStencilOps.storeStencil||ot.push(e.STENCIL_ATTACHMENT),ot.length>0&&t.fullSizeClearRect&&e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,ot)}if(t.colorOps.resolve&&this.webgl2&&t.samples>1&&e.autoResolve&&e.resolve(!0,!1),t.colorOps.mipmaps){const t=e._colorBuffer;t&&t.impl._glTexture&&t.mipmaps&&(t.pot||this.webgl2)&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(t),this.gl.generateMipmap(t.impl._glTarget))}}this.insideRenderPass=!1}updateBegin(){if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(let t=0;t<this.textureUnits.length;++t)for(let e=0;e<3;++e)this.textureUnits[t][e]=null;const t=this.renderTarget;t?t.impl.initialized?this.setFramebuffer(t.impl._glFrameBuffer):this.initRenderTarget(t):this.setFramebuffer(this.defaultFramebuffer)}updateEnd(){this.unbindVertexArray();const t=this.renderTarget;if(t){this.webgl2&&t._samples>1&&t.autoResolve&&t.resolve();const e=t._colorBuffer;e&&e.impl._glTexture&&e.mipmaps&&(e.pot||this.webgl2)&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(e),this.gl.generateMipmap(e.impl._glTarget))}}setUnpackFlipY(t){if(this.unpackFlipY!==t){this.unpackFlipY=t;const e=this.gl;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t)}}setUnpackPremultiplyAlpha(t){if(this.unpackPremultiplyAlpha!==t){this.unpackPremultiplyAlpha=t;const e=this.gl;e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t)}}activeTexture(t){this.textureUnit!==t&&(this.gl.activeTexture(this.gl.TEXTURE0+t),this.textureUnit=t)}bindTexture(t){const e=t.impl,i=e._glTarget,s=e._glTexture,r=this.textureUnit,n=this.targetToSlot[i];this.textureUnits[r][n]!==s&&(this.gl.bindTexture(i,s),this.textureUnits[r][n]=s)}bindTextureOnUnit(t,e){const i=t.impl,s=i._glTarget,r=i._glTexture,n=this.targetToSlot[s];this.textureUnits[e][n]!==r&&(this.activeTexture(e),this.gl.bindTexture(s,r),this.textureUnits[e][n]=r)}setTextureParameters(t){const e=this.gl,i=t._parameterFlags,s=t.impl._glTarget;if(1&i){let i=t._minFilter;(!t.pot&&!this.webgl2||!t._mipmaps||t._compressed&&1===t._levels.length)&&(i===Z||i===j?i=K:i!==q&&i!==z||(i=Y)),e.texParameteri(s,e.TEXTURE_MIN_FILTER,this.glFilter[i])}if(2&i&&e.texParameteri(s,e.TEXTURE_MAG_FILTER,this.glFilter[t._magFilter]),4&i&&(this.webgl2?e.texParameteri(s,e.TEXTURE_WRAP_S,this.glAddress[t._addressU]):e.texParameteri(s,e.TEXTURE_WRAP_S,this.glAddress[t.pot?t._addressU:V])),8&i&&(this.webgl2?e.texParameteri(s,e.TEXTURE_WRAP_T,this.glAddress[t._addressV]):e.texParameteri(s,e.TEXTURE_WRAP_T,this.glAddress[t.pot?t._addressV:V])),16&i&&this.webgl2&&e.texParameteri(s,e.TEXTURE_WRAP_R,this.glAddress[t._addressW]),32&i&&this.webgl2&&e.texParameteri(s,e.TEXTURE_COMPARE_MODE,t._compareOnRead?e.COMPARE_REF_TO_TEXTURE:e.NONE),64&i&&this.webgl2&&e.texParameteri(s,e.TEXTURE_COMPARE_FUNC,this.glComparison[t._compareFunc]),128&i){const i=this.extTextureFilterAnisotropic;i&&e.texParameterf(s,i.TEXTURE_MAX_ANISOTROPY_EXT,Math.max(1,Math.min(Math.round(t._anisotropy),this.maxAnisotropy)))}}setTexture(t,e){t.impl._glTexture||t.impl.initialize(this,t),t._parameterFlags>0||t._needsUpload||t._needsMipmapsUpload?(this.activeTexture(e),this.bindTexture(t),t._parameterFlags&&(this.setTextureParameters(t),t._parameterFlags=0),(t._needsUpload||t._needsMipmapsUpload)&&(t.impl.upload(this,t),t._needsUpload=!1,t._needsMipmapsUpload=!1)):this.bindTextureOnUnit(t,e)}createVertexArray(t){let e,i;const s=t.length>1;if(s){e="";for(let i=0;i<t.length;i++){const s=t[i];e+=s.id+s.format.renderingingHash}i=this._vaoMap.get(e)}if(!i){const r=this.gl;i=r.createVertexArray(),r.bindVertexArray(i),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null);for(let e=0;e<t.length;e++){const i=t[e];r.bindBuffer(r.ARRAY_BUFFER,i.impl.bufferId);const s=i.format.elements;for(let t=0;t<s.length;t++){const e=s[t],n=X[e.name];r.vertexAttribPointer(n,e.numComponents,this.glType[e.dataType],e.normalize,e.stride,e.offset),r.enableVertexAttribArray(n),i.format.instancing&&r.vertexAttribDivisor(n,1)}}r.bindVertexArray(null),r.bindBuffer(r.ARRAY_BUFFER,null),s&&this._vaoMap.set(e,i)}return i}unbindVertexArray(){this.boundVao&&(this.boundVao=null,this.gl.bindVertexArray(null))}setBuffers(){const t=this.gl;let e;if(1===this.vertexBuffers.length){const t=this.vertexBuffers[0];t.impl.vao||(t.impl.vao=this.createVertexArray(this.vertexBuffers)),e=t.impl.vao}else e=this.createVertexArray(this.vertexBuffers);this.boundVao!==e&&(this.boundVao=e,t.bindVertexArray(e)),this.vertexBuffers.length=0;const i=this.indexBuffer?this.indexBuffer.impl.bufferId:null;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i)}draw(t,e,i){const s=this.gl;let r,n,a,l,o,h,c,u;const d=this.shader;if(!d)return;const f=d.impl.samplers,_=d.impl.uniforms;i||this.setBuffers();let E=0;for(let t=0,e=f.length;t<e;t++)if(r=f[t],n=r.scopeId.value,n)if(n instanceof tt)a=n,this.setTexture(a,E),r.slot!==E&&(s.uniform1i(r.locationId,E),r.slot=E),E++;else{r.array.length=0,l=n.length;for(let t=0;t<l;t++)a=n[t],this.setTexture(a,E),r.array[t]=E,E++;s.uniform1iv(r.locationId,r.array)}for(let t=0,e=_.length;t<e;t++)o=_[t],h=o.scopeId,c=o.version,u=h.versionObject.version,c.globalId===u.globalId&&c.revision===u.revision||(c.globalId=u.globalId,c.revision=u.revision,null!==h.value&&this.commitFunction[o.dataType](o,h.value));this.webgl2&&this.transformFeedbackBuffer&&(s.bindBufferBase(s.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.impl.bufferId),s.beginTransformFeedback(s.POINTS));const p=this.glPrimitive[t.type],T=t.count;if(t.indexed){const i=this.indexBuffer,r=i.impl.glFormat,n=t.base*i.bytesPerIndex;e>0?s.drawElementsInstanced(p,T,r,n,e):s.drawElements(p,T,r,n)}else{const i=t.base;e>0?s.drawArraysInstanced(p,i,T,e):s.drawArrays(p,i,T)}this.webgl2&&this.transformFeedbackBuffer&&(s.endTransformFeedback(),s.bindBufferBase(s.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++}clear(t){const e=this.defaultClearOptions,i=void 0===(t=t||e).flags?e.flags:t.flags;if(0!==i){const s=this.gl;if(i&a){const i=void 0===t.color?e.color:t.color;this.setClearColor(i[0],i[1],i[2],i[3]),this.setColorWrite(!0,!0,!0,!0)}if(i&l){const i=void 0===t.depth?e.depth:t.depth;this.setClearDepth(i),this.setDepthWrite(!0)}if(i&G){const i=void 0===t.stencil?e.stencil:t.stencil;this.setClearStencil(i)}s.clear(this.glClearFlag[i])}}readPixels(t,e,i,s,r){const n=this.gl;n.readPixels(t,e,i,s,n.RGBA,n.UNSIGNED_BYTE,r)}setClearDepth(t){t!==this.clearDepth&&(this.gl.clearDepth(t),this.clearDepth=t)}setClearColor(t,e,i,s){const r=this.clearColor;t===r.r&&e===r.g&&i===r.b&&s===r.a||(this.gl.clearColor(t,e,i,s),this.clearColor.set(t,e,i,s))}setClearStencil(t){t!==this.clearStencil&&(this.gl.clearStencil(t),this.clearStencil=t)}getDepthTest(){return this.depthTest}setDepthTest(t){if(this.depthTest!==t){const e=this.gl;t?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this.depthTest=t}}setDepthFunc(t){this.depthFunc!==t&&(this.gl.depthFunc(this.glComparison[t]),this.depthFunc=t)}getDepthWrite(){return this.depthWrite}setDepthWrite(t){this.depthWrite!==t&&(this.gl.depthMask(t),this.depthWrite=t)}setColorWrite(t,e,i,s){this.writeRed===t&&this.writeGreen===e&&this.writeBlue===i&&this.writeAlpha===s||(this.gl.colorMask(t,e,i,s),this.writeRed=t,this.writeGreen=e,this.writeBlue=i,this.writeAlpha=s)}setAlphaToCoverage(t){this.webgl2&&this.alphaToCoverage!==t&&(this.alphaToCoverage=t,t?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))}setTransformFeedbackBuffer(t){if(this.transformFeedbackBuffer!==t&&(this.transformFeedbackBuffer=t,this.webgl2)){const e=this.gl;t?(this.feedback||(this.feedback=e.createTransformFeedback()),e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,this.feedback)):e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null)}}setRaster(t){this.raster!==t&&(this.raster=t,this.webgl2&&(t?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD)))}setDepthBias(t){this.depthBiasEnabled!==t&&(this.depthBiasEnabled=t,t?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL))}setDepthBiasValues(t,e){this.gl.polygonOffset(e,t)}getBlending(){return this.blending}setBlending(t){if(this.blending!==t){const e=this.gl;t?e.enable(e.BLEND):e.disable(e.BLEND),this.blending=t}}setStencilTest(t){if(this.stencil!==t){const e=this.gl;t?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this.stencil=t}}setStencilFunc(t,e,i){if(this.stencilFuncFront!==t||this.stencilRefFront!==e||this.stencilMaskFront!==i||this.stencilFuncBack!==t||this.stencilRefBack!==e||this.stencilMaskBack!==i){this.gl.stencilFunc(this.glComparison[t],e,i),this.stencilFuncFront=this.stencilFuncBack=t,this.stencilRefFront=this.stencilRefBack=e,this.stencilMaskFront=this.stencilMaskBack=i}}setStencilFuncFront(t,e,i){if(this.stencilFuncFront!==t||this.stencilRefFront!==e||this.stencilMaskFront!==i){const s=this.gl;s.stencilFuncSeparate(s.FRONT,this.glComparison[t],e,i),this.stencilFuncFront=t,this.stencilRefFront=e,this.stencilMaskFront=i}}setStencilFuncBack(t,e,i){if(this.stencilFuncBack!==t||this.stencilRefBack!==e||this.stencilMaskBack!==i){const s=this.gl;s.stencilFuncSeparate(s.BACK,this.glComparison[t],e,i),this.stencilFuncBack=t,this.stencilRefBack=e,this.stencilMaskBack=i}}setStencilOperation(t,e,i,s){this.stencilFailFront===t&&this.stencilZfailFront===e&&this.stencilZpassFront===i&&this.stencilFailBack===t&&this.stencilZfailBack===e&&this.stencilZpassBack===i||(this.gl.stencilOp(this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[i]),this.stencilFailFront=this.stencilFailBack=t,this.stencilZfailFront=this.stencilZfailBack=e,this.stencilZpassFront=this.stencilZpassBack=i),this.stencilWriteMaskFront===s&&this.stencilWriteMaskBack===s||(this.gl.stencilMask(s),this.stencilWriteMaskFront=s,this.stencilWriteMaskBack=s)}setStencilOperationFront(t,e,i,s){this.stencilFailFront===t&&this.stencilZfailFront===e&&this.stencilZpassFront===i||(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[i]),this.stencilFailFront=t,this.stencilZfailFront=e,this.stencilZpassFront=i),this.stencilWriteMaskFront!==s&&(this.gl.stencilMaskSeparate(this.gl.FRONT,s),this.stencilWriteMaskFront=s)}setStencilOperationBack(t,e,i,s){this.stencilFailBack===t&&this.stencilZfailBack===e&&this.stencilZpassBack===i||(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[i]),this.stencilFailBack=t,this.stencilZfailBack=e,this.stencilZpassBack=i),this.stencilWriteMaskBack!==s&&(this.gl.stencilMaskSeparate(this.gl.BACK,s),this.stencilWriteMaskBack=s)}setBlendFunction(t,e){(this.blendSrc!==t||this.blendDst!==e||this.separateAlphaBlend)&&(this.gl.blendFunc(this.glBlendFunction[t],this.glBlendFunction[e]),this.blendSrc=t,this.blendDst=e,this.separateAlphaBlend=!1)}setBlendFunctionSeparate(t,e,i,s){this.blendSrc===t&&this.blendDst===e&&this.blendSrcAlpha===i&&this.blendDstAlpha===s&&this.separateAlphaBlend||(this.gl.blendFuncSeparate(this.glBlendFunction[t],this.glBlendFunction[e],this.glBlendFunction[i],this.glBlendFunction[s]),this.blendSrc=t,this.blendDst=e,this.blendSrcAlpha=i,this.blendDstAlpha=s,this.separateAlphaBlend=!0)}setBlendEquation(t){(this.blendEquation!==t||this.separateAlphaEquation)&&(this.gl.blendEquation(this.glBlendEquation[t]),this.blendEquation=t,this.separateAlphaEquation=!1)}setBlendEquationSeparate(t,e){this.blendEquation===t&&this.blendAlphaEquation===e&&this.separateAlphaEquation||(this.gl.blendEquationSeparate(this.glBlendEquation[t],this.glBlendEquation[e]),this.blendEquation=t,this.blendAlphaEquation=e,this.separateAlphaEquation=!0)}setBlendColor(t,e,i,s){const r=this.blendColor;t===r.r&&e===r.g&&i===r.b&&s===r.a||(this.gl.blendColor(t,e,i,s),r.set(t,e,i,s))}setCullMode(t){if(this.cullMode!==t){if(t===W)this.gl.disable(this.gl.CULL_FACE);else{this.cullMode===W&&this.gl.enable(this.gl.CULL_FACE);const e=this.glCull[t];this.cullFace!==e&&(this.gl.cullFace(e),this.cullFace=e)}this.cullMode=t}}getCullMode(){return this.cullMode}setShader(t){if(t!==this.shader){if(t.failed)return!1;if(!t.ready&&!t.impl.postLink(this,t))return t.failed=!0,!1;this.shader=t,this.gl.useProgram(t.impl.glProgram),this.attributesInvalidated=!0}return!0}getHdrFormat(t,e,i,s){const r=this.extTextureHalfFloat&&(!e||this.textureHalfFloatRenderable)&&(!i||this.textureHalfFloatUpdatable)&&(!s||this.extTextureHalfFloatLinear),n=this.extTextureFloat&&(!e||this.textureFloatRenderable)&&(!s||this.extTextureFloatLinear);return r&&n?t?I:M:r?M:n?I:null}clearShaderCache(){const t=this.gl;for(const e in this.fragmentShaderCache)t.deleteShader(this.fragmentShaderCache[e]),delete this.fragmentShaderCache[e];for(const e in this.vertexShaderCache)t.deleteShader(this.vertexShaderCache[e]),delete this.vertexShaderCache[e]}clearVertexArrayObjectCache(){const t=this.gl;this._vaoMap.forEach(((e,i,s)=>{t.deleteVertexArray(e)})),this._vaoMap.clear()}get width(){return this.gl.drawingBufferWidth||this.canvas.width}get height(){return this.gl.drawingBufferHeight||this.canvas.height}set fullscreen(t){if(t){this.gl.canvas.requestFullscreen()}else document.exitFullscreen()}get fullscreen(){return!!document.fullscreenElement}get textureFloatHighPrecision(){return void 0===this._textureFloatHighPrecision&&(this._textureFloatHighPrecision=function(t){if(!t.textureFloatRenderable)return!1;const e=new lt(t,at.createDefinition(t,{name:"ptest1",vertexCode:ht,fragmentCode:"\nvoid main(void) { \n    gl_FragColor = vec4(2147483648.0);\n}\n"})),i=new lt(t,at.createDefinition(t,{name:"ptest2",vertexCode:ht,fragmentCode:"\nuniform sampler2D source;\nvec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res -= res.xxyz * bit_mask;\n    return res;\n}\nvoid main(void) {\n    float c = texture2D(source, vec2(0.0)).r;\n    float diff = abs(c - 2147483648.0) / 2147483648.0;\n    gl_FragColor = packFloat(diff);\n}\n"})),s={format:I,width:1,height:1,mipmaps:!1,minFilter:K,magFilter:K,name:"testFHP"},n=new tt(t,s),a=new $({colorBuffer:n,depth:!1});J(t,a,e),s.format=r;const l=new tt(t,s),o=new $({colorBuffer:l,depth:!1});t.constantTexSource.setValue(n),J(t,o,i);const h=t.activeFramebuffer;t.setFramebuffer(o.impl._glFrameBuffer);const c=new Uint8Array(4);t.readPixels(0,0,1,1,c),t.setFramebuffer(h);const u=c[0]/255/16777216+c[1]/255/65536+c[2]/255/256+c[3]/255;return n.destroy(),a.destroy(),l.destroy(),o.destroy(),e.destroy(),i.destroy(),0===u}(this)),this._textureFloatHighPrecision}get textureHalfFloatUpdatable(){return void 0===this._textureHalfFloatUpdatable&&(this.webgl2?this._textureHalfFloatUpdatable=!0:this._textureHalfFloatUpdatable=function(t,e){let i=!0;const s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const r=new Uint16Array(16);return t.texImage2D(t.TEXTURE_2D,0,t.RGBA,2,2,0,t.RGBA,e,r),t.getError()!==t.NO_ERROR&&(i=!1,console.log("Above error related to HALF_FLOAT_OES can be ignored, it was triggered by testing half float texture support")),t.bindTexture(t.TEXTURE_2D,null),t.deleteTexture(s),i}(this.gl,this.extTextureHalfFloat.HALF_FLOAT_OES)),this._textureHalfFloatUpdatable}}export{ut as WebglGraphicsDevice};
