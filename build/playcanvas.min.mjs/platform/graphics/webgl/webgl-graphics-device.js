import{setupVertexArrayObject as t}from"../../../polyfill/OESVertexArrayObject.js";import{math as e}from"../../../core/math/math.js";import"../../../core/debug.js";import{platform as i}from"../../../core/platform.js";import{Color as s}from"../../../core/math/color.js";import{DEVICETYPE_WEBGL2 as r,DEVICETYPE_WEBGL1 as n,PIXELFORMAT_RGBA8 as a,PIXELFORMAT_RGB8 as l,UNIFORMTYPE_BOOL as o,UNIFORMTYPE_INT as h,UNIFORMTYPE_FLOAT as c,UNIFORMTYPE_VEC2 as u,UNIFORMTYPE_VEC3 as f,UNIFORMTYPE_VEC4 as E,UNIFORMTYPE_IVEC2 as _,UNIFORMTYPE_IVEC3 as d,UNIFORMTYPE_IVEC4 as T,UNIFORMTYPE_BVEC2 as m,UNIFORMTYPE_BVEC3 as p,UNIFORMTYPE_BVEC4 as x,UNIFORMTYPE_MAT2 as g,UNIFORMTYPE_MAT3 as F,UNIFORMTYPE_MAT4 as A,UNIFORMTYPE_TEXTURE2D as R,UNIFORMTYPE_TEXTURECUBE as b,UNIFORMTYPE_TEXTURE2D_SHADOW as S,UNIFORMTYPE_TEXTURECUBE_SHADOW as B,UNIFORMTYPE_TEXTURE3D as C,UNIFORMTYPE_FLOATARRAY as O,UNIFORMTYPE_VEC2ARRAY as L,UNIFORMTYPE_VEC3ARRAY as U,UNIFORMTYPE_VEC4ARRAY as P,PIXELFORMAT_RGBA16F as M,PIXELFORMAT_RGBA32F as v,FUNC_ALWAYS as I,STENCILOP_KEEP as N,ADDRESS_CLAMP_TO_EDGE as D,semanticToLocation as w,CLEARFLAG_COLOR as y,CLEARFLAG_DEPTH as k,CLEARFLAG_STENCIL as H,CULLFACE_NONE as V,PRIMITIVE_TRISTRIP as X,FILTER_NEAREST_MIPMAP_NEAREST as G,FILTER_NEAREST_MIPMAP_LINEAR as W,FILTER_NEAREST as j,FILTER_LINEAR_MIPMAP_NEAREST as z,FILTER_LINEAR_MIPMAP_LINEAR as K,FILTER_LINEAR as Z}from"../constants.js";import{GraphicsDevice as Y}from"../graphics-device.js";import{RenderTarget as q}from"../render-target.js";import{Texture as Q}from"../texture.js";import{WebglVertexBuffer as J}from"./webgl-vertex-buffer.js";import{WebglIndexBuffer as $}from"./webgl-index-buffer.js";import{WebglShader as tt}from"./webgl-shader.js";import{WebglTexture as et}from"./webgl-texture.js";import{WebglRenderTarget as it}from"./webgl-render-target.js";import{ShaderUtils as st}from"../shader-utils.js";import{Shader as rt}from"../shader.js";import{BlendState as nt}from"../blend-state.js";import{DepthState as at}from"../depth-state.js";import{StencilParameters as lt}from"../stencil-parameters.js";const ot=[],ht="\nattribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tvUv0 = vertex_position.xy*0.5+0.5;\n}\n";function ct(t,e,i){const s=t.renderTarget;t.setRenderTarget(e),t.updateBegin(),t.setCullMode(V),t.setBlendState(nt.NOBLEND),t.setDepthState(at.NODEPTH),t.setStencilState(null,null),t.setVertexBuffer(t.quadVertexBuffer,0),t.setShader(i),t.draw({type:X,base:0,count:4,indexed:!1}),t.updateEnd(),t.setRenderTarget(s),t.updateBegin()}function ut(t,e){let i=!0;const s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,2,2,0,t.RGBA,e,null);const r=t.createFramebuffer();return t.bindFramebuffer(t.FRAMEBUFFER,r),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,s,0),t.checkFramebufferStatus(t.FRAMEBUFFER)!==t.FRAMEBUFFER_COMPLETE&&(i=!1),t.bindTexture(t.TEXTURE_2D,null),t.deleteTexture(s),t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteFramebuffer(r),i}class ft extends Y{constructor(e,s={}){super(e,s),this.gl=void 0,this.webgl2=void 0,s=this.initOptions,this.defaultFramebuffer=null,this.updateClientRect(),this.contextLost=!1,this._contextLostHandler=t=>{t.preventDefault(),this.contextLost=!0,this.loseContext(),this.fire("devicelost")},this._contextRestoredHandler=()=>{this.restoreContext(),this.contextLost=!1,this.fire("devicerestored")};const I="undefined"!=typeof navigator&&navigator.userAgent;this.forceDisableMultisampling=I&&I.includes("AppleWebKit")&&(I.includes("15.4")||I.includes("15_4")),this.forceDisableMultisampling&&(s.antialias=!1);let N=null;if(s.gl)N=s.gl;else{const t=void 0===s.preferWebGl2||s.preferWebGl2?["webgl2","webgl","experimental-webgl"]:["webgl","experimental-webgl"];for(let i=0;i<t.length&&(N=e.getContext(t[i],s),!N);i++);}if(!N)throw new Error("WebGL not supported");this.gl=N,this.webgl2="undefined"!=typeof WebGL2RenderingContext&&N instanceof WebGL2RenderingContext,this._deviceType=this.webgl2?r:n;const D=N.getParameter(N.ALPHA_BITS);this.framebufferFormat=D?a:l;const w="chrome"===i.browserName,y="safari"===i.browserName,k=i.browser&&-1!==navigator.appVersion.indexOf("Mac");let H,V,X,G,W;this._tempEnableSafariTextureUnitWorkaround=y,this._tempMacChromeBlitFramebufferWorkaround=k&&w&&!s.alpha,this.webgl2||t(N),e.addEventListener("webglcontextlost",this._contextLostHandler,!1),e.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches(),this.supportsImageBitmap=!y&&"undefined"!=typeof ImageBitmap,this.glAddress=[N.REPEAT,N.CLAMP_TO_EDGE,N.MIRRORED_REPEAT],this.glBlendEquation=[N.FUNC_ADD,N.FUNC_SUBTRACT,N.FUNC_REVERSE_SUBTRACT,this.webgl2?N.MIN:this.extBlendMinmax?this.extBlendMinmax.MIN_EXT:N.FUNC_ADD,this.webgl2?N.MAX:this.extBlendMinmax?this.extBlendMinmax.MAX_EXT:N.FUNC_ADD],this.glBlendFunctionColor=[N.ZERO,N.ONE,N.SRC_COLOR,N.ONE_MINUS_SRC_COLOR,N.DST_COLOR,N.ONE_MINUS_DST_COLOR,N.SRC_ALPHA,N.SRC_ALPHA_SATURATE,N.ONE_MINUS_SRC_ALPHA,N.DST_ALPHA,N.ONE_MINUS_DST_ALPHA,N.CONSTANT_COLOR,N.ONE_MINUS_CONSTANT_COLOR],this.glBlendFunctionAlpha=[N.ZERO,N.ONE,N.SRC_COLOR,N.ONE_MINUS_SRC_COLOR,N.DST_COLOR,N.ONE_MINUS_DST_COLOR,N.SRC_ALPHA,N.SRC_ALPHA_SATURATE,N.ONE_MINUS_SRC_ALPHA,N.DST_ALPHA,N.ONE_MINUS_DST_ALPHA,N.CONSTANT_ALPHA,N.ONE_MINUS_CONSTANT_ALPHA],this.glComparison=[N.NEVER,N.LESS,N.EQUAL,N.LEQUAL,N.GREATER,N.NOTEQUAL,N.GEQUAL,N.ALWAYS],this.glStencilOp=[N.KEEP,N.ZERO,N.REPLACE,N.INCR,N.INCR_WRAP,N.DECR,N.DECR_WRAP,N.INVERT],this.glClearFlag=[0,N.COLOR_BUFFER_BIT,N.DEPTH_BUFFER_BIT,N.COLOR_BUFFER_BIT|N.DEPTH_BUFFER_BIT,N.STENCIL_BUFFER_BIT,N.STENCIL_BUFFER_BIT|N.COLOR_BUFFER_BIT,N.STENCIL_BUFFER_BIT|N.DEPTH_BUFFER_BIT,N.STENCIL_BUFFER_BIT|N.COLOR_BUFFER_BIT|N.DEPTH_BUFFER_BIT],this.glCull=[0,N.BACK,N.FRONT,N.FRONT_AND_BACK],this.glFilter=[N.NEAREST,N.LINEAR,N.NEAREST_MIPMAP_NEAREST,N.NEAREST_MIPMAP_LINEAR,N.LINEAR_MIPMAP_NEAREST,N.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[N.POINTS,N.LINES,N.LINE_LOOP,N.LINE_STRIP,N.TRIANGLES,N.TRIANGLE_STRIP,N.TRIANGLE_FAN],this.glType=[N.BYTE,N.UNSIGNED_BYTE,N.SHORT,N.UNSIGNED_SHORT,N.INT,N.UNSIGNED_INT,N.FLOAT],this.pcUniformType={},this.pcUniformType[N.BOOL]=o,this.pcUniformType[N.INT]=h,this.pcUniformType[N.FLOAT]=c,this.pcUniformType[N.FLOAT_VEC2]=u,this.pcUniformType[N.FLOAT_VEC3]=f,this.pcUniformType[N.FLOAT_VEC4]=E,this.pcUniformType[N.INT_VEC2]=_,this.pcUniformType[N.INT_VEC3]=d,this.pcUniformType[N.INT_VEC4]=T,this.pcUniformType[N.BOOL_VEC2]=m,this.pcUniformType[N.BOOL_VEC3]=p,this.pcUniformType[N.BOOL_VEC4]=x,this.pcUniformType[N.FLOAT_MAT2]=g,this.pcUniformType[N.FLOAT_MAT3]=F,this.pcUniformType[N.FLOAT_MAT4]=A,this.pcUniformType[N.SAMPLER_2D]=R,this.pcUniformType[N.SAMPLER_CUBE]=b,this.webgl2&&(this.pcUniformType[N.SAMPLER_2D_SHADOW]=S,this.pcUniformType[N.SAMPLER_CUBE_SHADOW]=B,this.pcUniformType[N.SAMPLER_3D]=C),this.targetToSlot={},this.targetToSlot[N.TEXTURE_2D]=0,this.targetToSlot[N.TEXTURE_CUBE_MAP]=1,this.targetToSlot[N.TEXTURE_3D]=2,this.commitFunction=[],this.commitFunction[o]=function(t,e){t.value!==e&&(N.uniform1i(t.locationId,e),t.value=e)},this.commitFunction[h]=this.commitFunction[o],this.commitFunction[c]=function(t,e){t.value!==e&&(N.uniform1f(t.locationId,e),t.value=e)},this.commitFunction[u]=function(t,e){W=t.value,H=e[0],V=e[1],W[0]===H&&W[1]===V||(N.uniform2fv(t.locationId,e),W[0]=H,W[1]=V)},this.commitFunction[f]=function(t,e){W=t.value,H=e[0],V=e[1],X=e[2],W[0]===H&&W[1]===V&&W[2]===X||(N.uniform3fv(t.locationId,e),W[0]=H,W[1]=V,W[2]=X)},this.commitFunction[E]=function(t,e){W=t.value,H=e[0],V=e[1],X=e[2],G=e[3],W[0]===H&&W[1]===V&&W[2]===X&&W[3]===G||(N.uniform4fv(t.locationId,e),W[0]=H,W[1]=V,W[2]=X,W[3]=G)},this.commitFunction[_]=function(t,e){W=t.value,H=e[0],V=e[1],W[0]===H&&W[1]===V||(N.uniform2iv(t.locationId,e),W[0]=H,W[1]=V)},this.commitFunction[m]=this.commitFunction[_],this.commitFunction[d]=function(t,e){W=t.value,H=e[0],V=e[1],X=e[2],W[0]===H&&W[1]===V&&W[2]===X||(N.uniform3iv(t.locationId,e),W[0]=H,W[1]=V,W[2]=X)},this.commitFunction[p]=this.commitFunction[d],this.commitFunction[T]=function(t,e){W=t.value,H=e[0],V=e[1],X=e[2],G=e[3],W[0]===H&&W[1]===V&&W[2]===X&&W[3]===G||(N.uniform4iv(t.locationId,e),W[0]=H,W[1]=V,W[2]=X,W[3]=G)},this.commitFunction[x]=this.commitFunction[T],this.commitFunction[g]=function(t,e){N.uniformMatrix2fv(t.locationId,!1,e)},this.commitFunction[F]=function(t,e){N.uniformMatrix3fv(t.locationId,!1,e)},this.commitFunction[A]=function(t,e){N.uniformMatrix4fv(t.locationId,!1,e)},this.commitFunction[O]=function(t,e){N.uniform1fv(t.locationId,e)},this.commitFunction[L]=function(t,e){N.uniform2fv(t.locationId,e)},this.commitFunction[U]=function(t,e){N.uniform3fv(t.locationId,e)},this.commitFunction[P]=function(t,e){N.uniform4fv(t.locationId,e)},this.supportsBoneTextures=this.extTextureFloat&&this.maxVertexTextures>0;let j=this.vertexUniformsCount;j-=16,j-=8,j-=1,j-=16,this.boneLimit=Math.floor(j/3),this.boneLimit=Math.min(this.boneLimit,128),"Mali-450 MP"===this.unmaskedRenderer&&(this.boneLimit=34),this.constantTexSource=this.scope.resolve("source"),this.extTextureFloat?this.webgl2?this.textureFloatRenderable=!!this.extColorBufferFloat:this.textureFloatRenderable=ut(N,N.FLOAT):this.textureFloatRenderable=!1,this.extColorBufferHalfFloat?this.textureHalfFloatRenderable=!!this.extColorBufferHalfFloat:this.extTextureHalfFloat?this.webgl2?this.textureHalfFloatRenderable=!!this.extColorBufferFloat:this.textureHalfFloatRenderable=ut(N,this.extTextureHalfFloat.HALF_FLOAT_OES):this.textureHalfFloatRenderable=!1,this.supportsMorphTargetTexturesCore="highp"===this.maxPrecision&&this.maxVertexTextures>=2,this.supportsDepthShadow=this.webgl2,this._textureFloatHighPrecision=void 0,this._textureHalfFloatUpdatable=void 0,this.areaLightLutFormat=a,this.extTextureHalfFloat&&this.textureHalfFloatUpdatable&&this.extTextureHalfFloatLinear?this.areaLightLutFormat=M:this.extTextureFloat&&this.extTextureFloatLinear&&(this.areaLightLutFormat=v),this.postInit()}destroy(){super.destroy();const t=this.gl;this.webgl2&&this.feedback&&t.deleteTransformFeedback(this.feedback),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._contextLostHandler=null,this._contextRestoredHandler=null,this.gl=null,super.postDestroy()}createVertexBufferImpl(t,e){return new J}createIndexBufferImpl(t){return new $(t)}createShaderImpl(t){return new tt(t)}createTextureImpl(t){return new et}createRenderTargetImpl(t){return new it}getPrecision(){const t=this.gl;let e="highp";if(t.getShaderPrecisionFormat){const i=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT),s=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT),r=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT),n=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT),a=i.precision>0&&r.precision>0,l=s.precision>0&&n.precision>0;a||(e=l?"mediump":"lowp")}return e}getExtension(){for(let t=0;t<arguments.length;t++)if(-1!==this.supportedExtensions.indexOf(arguments[t]))return this.gl.getExtension(arguments[t]);return null}get extDisjointTimerQuery(){return this._extDisjointTimerQuery||this.webgl2&&(this._extDisjointTimerQuery=this.getExtension("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query")),this._extDisjointTimerQuery}initializeExtensions(){const t=this.gl,e=t.getSupportedExtensions();if(this.supportedExtensions=e,this.webgl2)this.extBlendMinmax=!0,this.extDrawBuffers=!0,this.drawBuffers=t.drawBuffers.bind(t),this.extInstancing=!0,this.extStandardDerivatives=!0,this.extTextureFloat=!0,this.extTextureHalfFloat=!0,this.extTextureLod=!0,this.extUintElement=!0,this.extVertexArrayObject=!0,this.extColorBufferFloat=this.getExtension("EXT_color_buffer_float"),this.extDepthTexture=!0;else{var i;if(this.extBlendMinmax=this.getExtension("EXT_blend_minmax"),this.extDrawBuffers=this.getExtension("WEBGL_draw_buffers"),this.extInstancing=this.getExtension("ANGLE_instanced_arrays"),this.drawBuffers=null==(i=this.extDrawBuffers)?void 0:i.drawBuffersWEBGL.bind(this.extDrawBuffers),this.extInstancing){const e=this.extInstancing;t.drawArraysInstanced=e.drawArraysInstancedANGLE.bind(e),t.drawElementsInstanced=e.drawElementsInstancedANGLE.bind(e),t.vertexAttribDivisor=e.vertexAttribDivisorANGLE.bind(e)}if(this.extStandardDerivatives=this.getExtension("OES_standard_derivatives"),this.extTextureFloat=this.getExtension("OES_texture_float"),this.extTextureHalfFloat=this.getExtension("OES_texture_half_float"),this.extTextureLod=this.getExtension("EXT_shader_texture_lod"),this.extUintElement=this.getExtension("OES_element_index_uint"),this.extVertexArrayObject=this.getExtension("OES_vertex_array_object"),this.extVertexArrayObject){const e=this.extVertexArrayObject;t.createVertexArray=e.createVertexArrayOES.bind(e),t.deleteVertexArray=e.deleteVertexArrayOES.bind(e),t.isVertexArray=e.isVertexArrayOES.bind(e),t.bindVertexArray=e.bindVertexArrayOES.bind(e)}this.extColorBufferFloat=null,this.extDepthTexture=t.getExtension("WEBGL_depth_texture")}this.extDebugRendererInfo=this.getExtension("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=this.getExtension("OES_texture_float_linear"),this.extTextureHalfFloatLinear=this.getExtension("OES_texture_half_float_linear"),this.extFloatBlend=this.getExtension("EXT_float_blend"),this.extTextureFilterAnisotropic=this.getExtension("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extCompressedTextureETC1=this.getExtension("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=this.getExtension("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=this.getExtension("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=this.getExtension("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureATC=this.getExtension("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=this.getExtension("WEBGL_compressed_texture_astc"),this.extParallelShaderCompile=this.getExtension("KHR_parallel_shader_compile"),this.extColorBufferHalfFloat=this.getExtension("EXT_color_buffer_half_float")}initializeCapabilities(){const t=this.gl;let e;const s="undefined"!=typeof navigator?navigator.userAgent:"";this.maxPrecision=this.precision=this.getPrecision();const r=t.getContextAttributes();this.supportsMsaa=r.antialias,this.supportsStencil=r.stencil,this.supportsInstancing=!!this.extInstancing,this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubeMapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=t.getParameter(t.MAX_RENDERBUFFER_SIZE),this.maxTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this.webgl2?(this.maxDrawBuffers=t.getParameter(t.MAX_DRAW_BUFFERS),this.maxColorAttachments=t.getParameter(t.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE),this.supportsMrt=!0,this.supportsVolumeTextures=!0):(e=this.extDrawBuffers,this.supportsMrt=!!e,this.maxDrawBuffers=e?t.getParameter(e.MAX_DRAW_BUFFERS_WEBGL):1,this.maxColorAttachments=e?t.getParameter(e.MAX_COLOR_ATTACHMENTS_WEBGL):1,this.maxVolumeSize=1),e=this.extDebugRendererInfo,this.unmaskedRenderer=e?t.getParameter(e.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=e?t.getParameter(e.UNMASKED_VENDOR_WEBGL):"";this.supportsGpuParticles=!("ARM"===this.unmaskedVendor&&s.match(/SM-[a-zA-Z0-9]+/)||this.unmaskedRenderer.match(/\bMali-G52+/)),e=this.extTextureFilterAnisotropic,this.maxAnisotropy=e?t.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1,this.samples=t.getParameter(t.SAMPLES),this.maxSamples=this.webgl2&&!this.forceDisableMultisampling?t.getParameter(t.MAX_SAMPLES):1,this.supportsAreaLights=this.webgl2||!i.android,this.supportsTextureFetch=this.webgl2,this.maxTextures<=8&&(this.supportsAreaLights=!1)}initializeRenderState(){super.initializeRenderState();const t=this.gl;t.disable(t.BLEND),t.blendFunc(t.ONE,t.ZERO),t.blendEquation(t.FUNC_ADD),t.colorMask(!0,!0,!0,!0),this.blendColor=new s(0,0,0,0),t.blendColor(0,0,0,0),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.depthMask(!0),this.stencil=!1,t.disable(t.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=I,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,t.stencilFunc(t.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=N,this.stencilZfailFront=this.stencilZfailBack=N,this.stencilZpassFront=this.stencilZpassBack=N,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,this.webgl2&&(t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.RASTERIZER_DISCARD)),this.depthBiasEnabled=!1,t.disable(t.POLYGON_OFFSET_FILL),this.clearDepth=1,t.clearDepth(1),this.clearColor=new s(0,0,0,0),t.clearColor(0,0,0,0),this.clearStencil=0,t.clearStencil(0),this.webgl2?t.hint(t.FRAGMENT_SHADER_DERIVATIVE_HINT,t.NICEST):this.extStandardDerivatives&&t.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,t.NICEST),t.enable(t.SCISSOR_TEST),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.NONE),this.unpackFlipY=!1,t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.pixelStorei(t.UNPACK_ALIGNMENT,1)}initializeContextCaches(){super.initializeContextCaches(),this._vaoMap=new Map,this.boundVao=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.textureUnits=[];for(let t=0;t<this.maxCombinedTextures;t++)this.textureUnits.push([null,null,null])}loseContext(){for(const t of this.shaders)t.loseContext();for(const t of this.textures)t.loseContext();for(const t of this.buffers)t.loseContext();for(const t of this.targets)t.loseContext()}restoreContext(){this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches();for(const t of this.shaders)t.restoreContext();for(const t of this.buffers)t.unlock()}endShaderBatch(){tt.endShaderBatch(this)}setViewport(t,e,i,s){this.vx===t&&this.vy===e&&this.vw===i&&this.vh===s||(this.gl.viewport(t,e,i,s),this.vx=t,this.vy=e,this.vw=i,this.vh=s)}setScissor(t,e,i,s){this.sx===t&&this.sy===e&&this.sw===i&&this.sh===s||(this.gl.scissor(t,e,i,s),this.sx=t,this.sy=e,this.sw=i,this.sh=s)}setFramebuffer(t){if(this.activeFramebuffer!==t){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,t),this.activeFramebuffer=t}}copyRenderTarget(t,e,i,s){const r=this.gl;if(!this.webgl2&&s)return!1;if(i)if(e){if(t){if(!t._colorBuffer||!e._colorBuffer)return!1;if(t._colorBuffer._format!==e._colorBuffer._format)return!1}}else if(!t._colorBuffer)return!1;if(s&&t&&!t._depth){if(!t._depthBuffer||!e._depthBuffer)return!1;if(t._depthBuffer._format!==e._depthBuffer._format)return!1}if(this.webgl2&&e){const n=this.renderTarget;this.renderTarget=e,this.updateBegin(),r.bindFramebuffer(r.READ_FRAMEBUFFER,t?t.impl._glFrameBuffer:null),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,e.impl._glFrameBuffer);const a=t?t.width:e.width,l=t?t.height:e.height;r.blitFramebuffer(0,0,a,l,0,0,a,l,(i?r.COLOR_BUFFER_BIT:0)|(s?r.DEPTH_BUFFER_BIT:0),r.NEAREST),this.renderTarget=n,r.bindFramebuffer(r.FRAMEBUFFER,n?n.impl._glFrameBuffer:null)}else{const i=this.getCopyShader();this.constantTexSource.setValue(t._colorBuffer),ct(this,e,i)}return!0}getCopyShader(){return this._copyShader||(this._copyShader=new rt(this,st.createDefinition(this,{name:"outputTex2D",vertexCode:ht,fragmentCode:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\t\tgl_FragColor = texture2D(source, vUv0);\n}\n"}))),this._copyShader}startPass(t){this.setRenderTarget(t.renderTarget),this.updateBegin();const e=t.colorOps,i=t.depthStencilOps;if(null!=e&&e.clear||i.clearDepth||i.clearStencil){const s=t.renderTarget,r=s?s.width:this.width,n=s?s.height:this.height;this.setViewport(0,0,r,n),this.setScissor(0,0,r,n);let a=0;const l={};null!=e&&e.clear&&(a|=y,l.color=[e.clearValue.r,e.clearValue.g,e.clearValue.b,e.clearValue.a]),i.clearDepth&&(a|=k,l.depth=i.clearDepthValue),i.clearStencil&&(a|=H,l.stencil=i.clearStencilValue),l.flags=a,this.clear(l)}this.insideRenderPass=!0}endPass(t){this.unbindVertexArray();const e=this.renderTarget,i=t.colorArrayOps.length;if(e){var s;if(this.webgl2){ot.length=0;const e=this.gl;for(let s=0;s<i;s++){const i=t.colorArrayOps[s];i.store||i.resolve||ot.push(e.COLOR_ATTACHMENT0+s)}t.depthStencilOps.storeDepth||ot.push(e.DEPTH_ATTACHMENT),t.depthStencilOps.storeStencil||ot.push(e.STENCIL_ATTACHMENT),ot.length>0&&t.fullSizeClearRect&&e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,ot)}null!=(s=t.colorOps)&&s.resolve&&this.webgl2&&t.samples>1&&e.autoResolve&&e.resolve(!0,!1);for(let s=0;s<i;s++){if(t.colorArrayOps[s].mipmaps){const t=e._colorBuffers[s];t&&t.impl._glTexture&&t.mipmaps&&(t.pot||this.webgl2)&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(t),this.gl.generateMipmap(t.impl._glTarget))}}}this.insideRenderPass=!1}updateBegin(){if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(let t=0;t<this.textureUnits.length;++t)for(let e=0;e<3;++e)this.textureUnits[t][e]=null;const t=this.renderTarget;t?t.impl.initialized?this.setFramebuffer(t.impl._glFrameBuffer):this.initRenderTarget(t):this.setFramebuffer(this.defaultFramebuffer)}updateEnd(){this.unbindVertexArray();const t=this.renderTarget;if(t){this.webgl2&&t._samples>1&&t.autoResolve&&t.resolve();const e=t._colorBuffer;e&&e.impl._glTexture&&e.mipmaps&&(e.pot||this.webgl2)&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(e),this.gl.generateMipmap(e.impl._glTarget))}}setUnpackFlipY(t){if(this.unpackFlipY!==t){this.unpackFlipY=t;const e=this.gl;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t)}}setUnpackPremultiplyAlpha(t){if(this.unpackPremultiplyAlpha!==t){this.unpackPremultiplyAlpha=t;const e=this.gl;e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t)}}activeTexture(t){this.textureUnit!==t&&(this.gl.activeTexture(this.gl.TEXTURE0+t),this.textureUnit=t)}bindTexture(t){const e=t.impl,i=e._glTarget,s=e._glTexture,r=this.textureUnit,n=this.targetToSlot[i];this.textureUnits[r][n]!==s&&(this.gl.bindTexture(i,s),this.textureUnits[r][n]=s)}bindTextureOnUnit(t,e){const i=t.impl,s=i._glTarget,r=i._glTexture,n=this.targetToSlot[s];this.textureUnits[e][n]!==r&&(this.activeTexture(e),this.gl.bindTexture(s,r),this.textureUnits[e][n]=r)}setTextureParameters(t){const i=this.gl,s=t.impl.dirtyParameterFlags,r=t.impl._glTarget;if(1&s){let e=t._minFilter;(!t.pot&&!this.webgl2||!t._mipmaps||t._compressed&&1===t._levels.length)&&(e===G||e===W?e=j:e!==z&&e!==K||(e=Z)),i.texParameteri(r,i.TEXTURE_MIN_FILTER,this.glFilter[e])}if(2&s&&i.texParameteri(r,i.TEXTURE_MAG_FILTER,this.glFilter[t._magFilter]),4&s&&(this.webgl2?i.texParameteri(r,i.TEXTURE_WRAP_S,this.glAddress[t._addressU]):i.texParameteri(r,i.TEXTURE_WRAP_S,this.glAddress[t.pot?t._addressU:D])),8&s&&(this.webgl2?i.texParameteri(r,i.TEXTURE_WRAP_T,this.glAddress[t._addressV]):i.texParameteri(r,i.TEXTURE_WRAP_T,this.glAddress[t.pot?t._addressV:D])),16&s&&this.webgl2&&i.texParameteri(r,i.TEXTURE_WRAP_R,this.glAddress[t._addressW]),32&s&&this.webgl2&&i.texParameteri(r,i.TEXTURE_COMPARE_MODE,t._compareOnRead?i.COMPARE_REF_TO_TEXTURE:i.NONE),64&s&&this.webgl2&&i.texParameteri(r,i.TEXTURE_COMPARE_FUNC,this.glComparison[t._compareFunc]),128&s){const s=this.extTextureFilterAnisotropic;s&&i.texParameterf(r,s.TEXTURE_MAX_ANISOTROPY_EXT,e.clamp(Math.round(t._anisotropy),1,this.maxAnisotropy))}}setTexture(t,e){const i=t.impl;i._glTexture||i.initialize(this,t),i.dirtyParameterFlags>0||t._needsUpload||t._needsMipmapsUpload?(this.activeTexture(e),this.bindTexture(t),i.dirtyParameterFlags&&(this.setTextureParameters(t),i.dirtyParameterFlags=0),(t._needsUpload||t._needsMipmapsUpload)&&(i.upload(this,t),t._needsUpload=!1,t._needsMipmapsUpload=!1)):this.bindTextureOnUnit(t,e)}createVertexArray(t){let e,i;const s=t.length>1;if(s){e="";for(let i=0;i<t.length;i++){const s=t[i];e+=s.id+s.format.renderingHash}i=this._vaoMap.get(e)}if(!i){const r=this.gl;i=r.createVertexArray(),r.bindVertexArray(i),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null);for(let e=0;e<t.length;e++){const i=t[e];r.bindBuffer(r.ARRAY_BUFFER,i.impl.bufferId);const s=i.format.elements;for(let t=0;t<s.length;t++){const e=s[t],n=w[e.name];r.vertexAttribPointer(n,e.numComponents,this.glType[e.dataType],e.normalize,e.stride,e.offset),r.enableVertexAttribArray(n),i.format.instancing&&r.vertexAttribDivisor(n,1)}}r.bindVertexArray(null),r.bindBuffer(r.ARRAY_BUFFER,null),s&&this._vaoMap.set(e,i)}return i}unbindVertexArray(){this.boundVao&&(this.boundVao=null,this.gl.bindVertexArray(null))}setBuffers(){const t=this.gl;let e;if(1===this.vertexBuffers.length){const t=this.vertexBuffers[0];t.impl.vao||(t.impl.vao=this.createVertexArray(this.vertexBuffers)),e=t.impl.vao}else e=this.createVertexArray(this.vertexBuffers);this.boundVao!==e&&(this.boundVao=e,t.bindVertexArray(e)),this.vertexBuffers.length=0;const i=this.indexBuffer?this.indexBuffer.impl.bufferId:null;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i)}draw(t,e,i){const s=this.gl;let r,n,a,l,o,h,c,u;const f=this.shader;if(!f)return;const E=f.impl.samplers,_=f.impl.uniforms;i||this.setBuffers();let d=0;for(let t=0,e=E.length;t<e;t++){if(r=E[t],n=r.scopeId.value,!n)return;if(n instanceof Q)a=n,this.setTexture(a,d),r.slot!==d&&(s.uniform1i(r.locationId,d),r.slot=d),d++;else{r.array.length=0,l=n.length;for(let t=0;t<l;t++)a=n[t],this.setTexture(a,d),r.array[t]=d,d++;s.uniform1iv(r.locationId,r.array)}}for(let t=0,e=_.length;t<e;t++)o=_[t],h=o.scopeId,c=o.version,u=h.versionObject.version,c.globalId===u.globalId&&c.revision===u.revision||(c.globalId=u.globalId,c.revision=u.revision,null!==h.value&&this.commitFunction[o.dataType](o,h.value));this.webgl2&&this.transformFeedbackBuffer&&(s.bindBufferBase(s.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.impl.bufferId),s.beginTransformFeedback(s.POINTS));const T=this.glPrimitive[t.type],m=t.count;if(t.indexed){const i=this.indexBuffer,r=i.impl.glFormat,n=t.base*i.bytesPerIndex;e>0?s.drawElementsInstanced(T,m,r,n,e):s.drawElements(T,m,r,n)}else{const i=t.base;e>0?s.drawArraysInstanced(T,i,m,e):s.drawArrays(T,i,m)}this.webgl2&&this.transformFeedbackBuffer&&(s.endTransformFeedback(),s.bindBufferBase(s.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++}clear(t){var e;const i=this.defaultClearOptions,s=null!=(e=(t=t||i).flags)?e:i.flags;if(0!==s){const e=this.gl;if(s&y){var r;const e=null!=(r=t.color)?r:i.color,s=e[0],n=e[1],a=e[2],l=e[3],o=this.clearColor;s===o.r&&n===o.g&&a===o.b&&l===o.a||(this.gl.clearColor(s,n,a,l),this.clearColor.set(s,n,a,l)),this.setBlendState(nt.NOBLEND)}if(s&k){var n;const e=null!=(n=t.depth)?n:i.depth;e!==this.clearDepth&&(this.gl.clearDepth(e),this.clearDepth=e),this.setDepthState(at.WRITEDEPTH)}if(s&H){var a;const e=null!=(a=t.stencil)?a:i.stencil;e!==this.clearStencil&&(this.gl.clearStencil(e),this.clearStencil=e)}e.clear(this.glClearFlag[s])}}submit(){this.gl.flush()}readPixels(t,e,i,s,r){const n=this.gl;n.readPixels(t,e,i,s,n.RGBA,n.UNSIGNED_BYTE,r)}async readPixelsAsync(t,e,i,s,r){var n,a,l;const o=this.gl;if(!this.webgl2)return this.readPixels(t,e,i,s,r);const h=null==(n=this.renderTarget.colorBuffer)?void 0:n.impl,c=null!=(a=null==h?void 0:h._glFormat)?a:o.RGBA,u=null!=(l=null==h?void 0:h._glPixelType)?l:o.UNSIGNED_BYTE,f=o.createBuffer();o.bindBuffer(o.PIXEL_PACK_BUFFER,f),o.bufferData(o.PIXEL_PACK_BUFFER,r.byteLength,o.STREAM_READ),o.readPixels(t,e,i,s,c,u,0),o.bindBuffer(o.PIXEL_PACK_BUFFER,null),await((t,e)=>{const i=o.fenceSync(o.SYNC_GPU_COMMANDS_COMPLETE,0);return this.submit(),new Promise(((s,r)=>{!function n(){const a=o.clientWaitSync(i,t,0);a===o.WAIT_FAILED?(o.deleteSync(i),r(new Error("webgl clientWaitSync sync failed"))):a===o.TIMEOUT_EXPIRED?setTimeout(n,e):(o.deleteSync(i),s())}()}))})(0,20),o.bindBuffer(o.PIXEL_PACK_BUFFER,f),o.getBufferSubData(o.PIXEL_PACK_BUFFER,0,r),o.bindBuffer(o.PIXEL_PACK_BUFFER,null),o.deleteBuffer(f)}setAlphaToCoverage(t){this.webgl2&&this.alphaToCoverage!==t&&(this.alphaToCoverage=t,t?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))}setTransformFeedbackBuffer(t){if(this.transformFeedbackBuffer!==t&&(this.transformFeedbackBuffer=t,this.webgl2)){const e=this.gl;t?(this.feedback||(this.feedback=e.createTransformFeedback()),e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,this.feedback)):e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null)}}setRaster(t){this.raster!==t&&(this.raster=t,this.webgl2&&(t?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD)))}setDepthBias(t){this.depthBiasEnabled!==t&&(this.depthBiasEnabled=t,t?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL))}setDepthBiasValues(t,e){this.gl.polygonOffset(e,t)}setStencilTest(t){if(this.stencil!==t){const e=this.gl;t?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this.stencil=t}}setStencilFunc(t,e,i){this.stencilFuncFront===t&&this.stencilRefFront===e&&this.stencilMaskFront===i&&this.stencilFuncBack===t&&this.stencilRefBack===e&&this.stencilMaskBack===i||(this.gl.stencilFunc(this.glComparison[t],e,i),this.stencilFuncFront=this.stencilFuncBack=t,this.stencilRefFront=this.stencilRefBack=e,this.stencilMaskFront=this.stencilMaskBack=i)}setStencilFuncFront(t,e,i){if(this.stencilFuncFront!==t||this.stencilRefFront!==e||this.stencilMaskFront!==i){const s=this.gl;s.stencilFuncSeparate(s.FRONT,this.glComparison[t],e,i),this.stencilFuncFront=t,this.stencilRefFront=e,this.stencilMaskFront=i}}setStencilFuncBack(t,e,i){if(this.stencilFuncBack!==t||this.stencilRefBack!==e||this.stencilMaskBack!==i){const s=this.gl;s.stencilFuncSeparate(s.BACK,this.glComparison[t],e,i),this.stencilFuncBack=t,this.stencilRefBack=e,this.stencilMaskBack=i}}setStencilOperation(t,e,i,s){this.stencilFailFront===t&&this.stencilZfailFront===e&&this.stencilZpassFront===i&&this.stencilFailBack===t&&this.stencilZfailBack===e&&this.stencilZpassBack===i||(this.gl.stencilOp(this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[i]),this.stencilFailFront=this.stencilFailBack=t,this.stencilZfailFront=this.stencilZfailBack=e,this.stencilZpassFront=this.stencilZpassBack=i),this.stencilWriteMaskFront===s&&this.stencilWriteMaskBack===s||(this.gl.stencilMask(s),this.stencilWriteMaskFront=s,this.stencilWriteMaskBack=s)}setStencilOperationFront(t,e,i,s){this.stencilFailFront===t&&this.stencilZfailFront===e&&this.stencilZpassFront===i||(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[i]),this.stencilFailFront=t,this.stencilZfailFront=e,this.stencilZpassFront=i),this.stencilWriteMaskFront!==s&&(this.gl.stencilMaskSeparate(this.gl.FRONT,s),this.stencilWriteMaskFront=s)}setStencilOperationBack(t,e,i,s){this.stencilFailBack===t&&this.stencilZfailBack===e&&this.stencilZpassBack===i||(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[i]),this.stencilFailBack=t,this.stencilZfailBack=e,this.stencilZpassBack=i),this.stencilWriteMaskBack!==s&&(this.gl.stencilMaskSeparate(this.gl.BACK,s),this.stencilWriteMaskBack=s)}setBlendState(t){const e=this.blendState;if(!e.equals(t)){const i=this.gl,{blend:s,colorOp:r,alphaOp:n,colorSrcFactor:a,colorDstFactor:l,alphaSrcFactor:o,alphaDstFactor:h}=t;if(e.blend!==s&&(s?i.enable(i.BLEND):i.disable(i.BLEND)),e.colorOp!==r||e.alphaOp!==n){const t=this.glBlendEquation;i.blendEquationSeparate(t[r],t[n])}e.colorSrcFactor===a&&e.colorDstFactor===l&&e.alphaSrcFactor===o&&e.alphaDstFactor===h||i.blendFuncSeparate(this.glBlendFunctionColor[a],this.glBlendFunctionColor[l],this.glBlendFunctionAlpha[o],this.glBlendFunctionAlpha[h]),e.allWrite!==t.allWrite&&this.gl.colorMask(t.redWrite,t.greenWrite,t.blueWrite,t.alphaWrite),e.copy(t)}}setBlendColor(t,e,i,s){const r=this.blendColor;t===r.r&&e===r.g&&i===r.b&&s===r.a||(this.gl.blendColor(t,e,i,s),r.set(t,e,i,s))}setStencilState(t,e){t||e?(this.setStencilTest(!0),t===e?(this.setStencilFunc(t.func,t.ref,t.readMask),this.setStencilOperation(t.fail,t.zfail,t.zpass,t.writeMask)):(null!=t||(t=lt.DEFAULT),this.setStencilFuncFront(t.func,t.ref,t.readMask),this.setStencilOperationFront(t.fail,t.zfail,t.zpass,t.writeMask),null!=e||(e=lt.DEFAULT),this.setStencilFuncBack(e.func,e.ref,e.readMask),this.setStencilOperationBack(e.fail,e.zfail,e.zpass,e.writeMask))):this.setStencilTest(!1)}setDepthState(t){const e=this.depthState;if(!e.equals(t)){const i=this.gl,s=t.write;e.write!==s&&i.depthMask(s);let{func:r,test:n}=t;!n&&s&&(n=!0,r=I),e.func!==r&&i.depthFunc(this.glComparison[r]),e.test!==n&&(n?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST)),e.copy(t)}}setCullMode(t){if(this.cullMode!==t){if(t===V)this.gl.disable(this.gl.CULL_FACE);else{this.cullMode===V&&this.gl.enable(this.gl.CULL_FACE);const e=this.glCull[t];this.cullFace!==e&&(this.gl.cullFace(e),this.cullFace=e)}this.cullMode=t}}setShader(t){if(t!==this.shader){if(t.failed)return!1;if(!t.ready&&!t.impl.finalize(this,t))return t.failed=!0,!1;this.shader=t,this.gl.useProgram(t.impl.glProgram),this.attributesInvalidated=!0}return!0}getHdrFormat(t,e,i,s){const r=this.extTextureHalfFloat&&(!e||this.textureHalfFloatRenderable)&&(!i||this.textureHalfFloatUpdatable)&&(!s||this.extTextureHalfFloatLinear),n=this.extTextureFloat&&(!e||this.textureFloatRenderable)&&(!s||this.extTextureFloatLinear);return r&&n?t?v:M:r?M:n?v:null}clearVertexArrayObjectCache(){const t=this.gl;this._vaoMap.forEach(((e,i,s)=>{t.deleteVertexArray(e)})),this._vaoMap.clear()}resizeCanvas(t,e){this._width=t,this._height=e;const s=Math.min(this._maxPixelRatio,i.browser?window.devicePixelRatio:1);t=Math.floor(t*s),e=Math.floor(e*s),this.canvas.width===t&&this.canvas.height===e||(this.canvas.width=t,this.canvas.height=e,this.fire(Y.EVENT_RESIZE,t,e))}get width(){return this.gl.drawingBufferWidth||this.canvas.width}get height(){return this.gl.drawingBufferHeight||this.canvas.height}set fullscreen(t){if(t){this.gl.canvas.requestFullscreen()}else document.exitFullscreen()}get fullscreen(){return!!document.fullscreenElement}get textureFloatHighPrecision(){return void 0===this._textureFloatHighPrecision&&(this._textureFloatHighPrecision=function(t){if(!t.textureFloatRenderable)return!1;const e=new rt(t,st.createDefinition(t,{name:"ptest1",vertexCode:ht,fragmentCode:"\nvoid main(void) { \n\t\tgl_FragColor = vec4(2147483648.0);\n}\n"})),i=new rt(t,st.createDefinition(t,{name:"ptest2",vertexCode:ht,fragmentCode:"\nuniform sampler2D source;\nvec4 packFloat(float depth) {\n\t\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\t\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\t\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\t\tres -= res.xxyz * bit_mask;\n\t\treturn res;\n}\nvoid main(void) {\n\t\tfloat c = texture2D(source, vec2(0.0)).r;\n\t\tfloat diff = abs(c - 2147483648.0) / 2147483648.0;\n\t\tgl_FragColor = packFloat(diff);\n}\n"})),s={format:v,width:1,height:1,mipmaps:!1,minFilter:j,magFilter:j,name:"testFHP"},r=new Q(t,s),n=new q({colorBuffer:r,depth:!1});ct(t,n,e),s.format=a;const l=new Q(t,s),o=new q({colorBuffer:l,depth:!1});t.constantTexSource.setValue(r),ct(t,o,i);const h=t.activeFramebuffer;t.setFramebuffer(o.impl._glFrameBuffer);const c=new Uint8Array(4);t.readPixels(0,0,1,1,c),t.setFramebuffer(h);const u=c[0]/255/16777216+c[1]/255/65536+c[2]/255/256+c[3]/255;return r.destroy(),n.destroy(),l.destroy(),o.destroy(),e.destroy(),i.destroy(),0===u}(this)),this._textureFloatHighPrecision}get textureHalfFloatUpdatable(){return void 0===this._textureHalfFloatUpdatable&&(this.webgl2?this._textureHalfFloatUpdatable=!0:this._textureHalfFloatUpdatable=function(t,e){let i=!0;const s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const r=new Uint16Array(16);return t.texImage2D(t.TEXTURE_2D,0,t.RGBA,2,2,0,t.RGBA,e,r),t.getError()!==t.NO_ERROR&&(i=!1,console.log("Above error related to HALF_FLOAT_OES can be ignored, it was triggered by testing half float texture support")),t.bindTexture(t.TEXTURE_2D,null),t.deleteTexture(s),i}(this.gl,this.extTextureHalfFloat.HALF_FLOAT_OES)),this._textureHalfFloatUpdatable}}export{ft as WebglGraphicsDevice};
