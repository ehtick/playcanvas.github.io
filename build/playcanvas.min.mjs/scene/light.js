import{math as t}from"../core/math/math.js";import{Color as e}from"../core/math/color.js";import{Mat4 as s}from"../core/math/mat4.js";import{Vec2 as i}from"../core/math/vec2.js";import{Vec3 as a}from"../core/math/vec3.js";import{Vec4 as o}from"../core/math/vec4.js";import{LIGHTTYPE_DIRECTIONAL as h,MASK_AFFECT_DYNAMIC as n,LIGHTFALLOFF_LINEAR as r,SHADOW_PCF3 as l,BLUR_GAUSSIAN as d,LIGHTSHAPE_PUNCTUAL as _,SHADOWUPDATE_REALTIME as c,LIGHTTYPE_OMNI as u,SHADOW_PCSS as f,SHADOW_PCF5 as p,SHADOW_VSM32 as w,SHADOW_VSM16 as m,SHADOW_VSM8 as y,SHADOW_PCF1 as g,MASK_BAKE as C,SHADOWUPDATE_NONE as S,SHADOWUPDATE_THISFRAME as k,LIGHTTYPE_SPOT as M}from"./constants.js";import{ShadowRenderer as v}from"./renderer/shadow-renderer.js";const B=new a,b={bias:0,normalBias:0},A={r:0,g:1,b:2,a:3},O={directional:h,omni:u,point:u,spot:M},T=[[new o(0,0,1,1)],[new o(0,0,.5,.5),new o(0,.5,.5,.5)],[new o(0,0,.5,.5),new o(0,.5,.5,.5),new o(.5,0,.5,.5)],[new o(0,0,.5,.5),new o(0,.5,.5,.5),new o(.5,0,.5,.5),new o(.5,.5,.5,.5)]];let D=0;class U{constructor(t,e,i,a){this.light=a,this.camera=e,this.shadowCamera=v.createShadowCamera(t,a._shadowType,a._type,i),this.shadowMatrix=new s,this.shadowViewport=new o(0,0,1,1),this.shadowScissor=new o(0,0,1,1),this.face=i,this.visibleCasters=[],this.viewBindGroups=[]}destroy(){this.viewBindGroups.forEach((t=>{t.defaultUniformBuffer.destroy(),t.destroy()})),this.viewBindGroups.length=0}get shadowBuffer(){const t=this.shadowCamera.renderTarget;if(t){const e=this.light;return e._type===u?t.colorBuffer:e._isPcf&&e.device.supportsDepthShadow?t.depthBuffer:t.colorBuffer}return null}}class F{constructor(t){this.device=t,this.id=D++,this._type=h,this._color=new e(.8,.8,.8),this._intensity=1,this._affectSpecularity=!0,this._luminance=0,this._castShadows=!1,this._enabled=!1,this.mask=n,this.isStatic=!1,this.key=0,this.bakeDir=!0,this.bakeNumSamples=1,this.bakeArea=0,this.attenuationStart=10,this.attenuationEnd=10,this._falloffMode=r,this._shadowType=l,this._vsmBlurSize=11,this.vsmBlurMode=d,this.vsmBias=.0025,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=!1,this._cookieOffsetSet=!1,this._innerConeAngle=40,this._outerConeAngle=45,this.cascades=null,this._shadowMatrixPalette=null,this._shadowCascadeDistances=null,this.numCascades=1,this.cascadeDistribution=.5,this._shape=_,this._finalColor=new Float32Array([.8,.8,.8]);const s=Math.pow(this._finalColor[0],2.2);this._linearFinalColor=new Float32Array([s,s,s]),this._position=new a(0,0,0),this._direction=new a(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._updateOuterAngle(this._outerConeAngle),this._usePhysicalUnits=void 0,this._shadowMap=null,this._shadowRenderParams=[],this._shadowCameraParams=[],this.shadowDistance=40,this._shadowResolution=1024,this.shadowBias=-5e-4,this.shadowIntensity=1,this._normalOffsetBias=0,this.shadowUpdateMode=c,this.shadowUpdateOverrides=null,this._penumbraSize=1,this._isVsm=!1,this._isPcf=!0,this._cookieMatrix=null,this._atlasViewport=null,this.atlasViewportAllocated=!1,this.atlasVersion=0,this.atlasSlotIndex=0,this.atlasSlotUpdated=!1,this._scene=null,this._node=null,this._renderData=[],this.visibleThisFrame=!1,this.maxScreenSize=0}destroy(){this._destroyShadowMap(),this.releaseRenderData(),this._renderData=null}releaseRenderData(){if(this._renderData){for(let t=0;t<this._renderData.length;t++)this._renderData[t].destroy();this._renderData.length=0}}set numCascades(t){this.cascades&&this.numCascades===t||(this.cascades=T[t-1],this._shadowMatrixPalette=new Float32Array(64),this._shadowCascadeDistances=new Float32Array(4),this._destroyShadowMap(),this.updateKey())}get numCascades(){return this.cascades.length}set shadowMap(t){this._shadowMap!==t&&(this._destroyShadowMap(),this._shadowMap=t)}get shadowMap(){return this._shadowMap}get numShadowFaces(){const t=this._type;return t===h?this.numCascades:t===u?6:1}set type(t){if(this._type===t)return;this._type=t,this._destroyShadowMap(),this.updateKey();const e=this._shadowType;this._shadowType=null,this.shadowUpdateOverrides=null,this.shadowType=e}get type(){return this._type}set shape(t){if(this._shape===t)return;this._shape=t,this._destroyShadowMap(),this.updateKey();const e=this._shadowType;this._shadowType=null,this.shadowType=e}get shape(){return this._shape}set usePhysicalUnits(t){this._usePhysicalUnits!==t&&(this._usePhysicalUnits=t,this._updateFinalColor())}get usePhysicalUnits(){return this._usePhysicalUnits}set shadowType(t){if(this._shadowType===t)return;const e=this.device;this._type===u&&t!==l&&t!==f&&(t=l);const s=e.supportsDepthShadow;t!==p||s||(t=l),t!==w||e.textureFloatRenderable||(t=m),t!==m||e.textureHalfFloatRenderable||(t=y),this._isVsm=t>=y&&t<=w,this._isPcf=t===g||t===l||t===p,this._shadowType=t,this._destroyShadowMap(),this.updateKey()}get shadowType(){return this._shadowType}set enabled(t){this._enabled!==t&&(this._enabled=t,this.layersDirty())}get enabled(){return this._enabled}set castShadows(t){this._castShadows!==t&&(this._castShadows=t,this._destroyShadowMap(),this.layersDirty(),this.updateKey())}get castShadows(){return this._castShadows&&this.mask!==C&&0!==this.mask}set shadowResolution(t){this._shadowResolution!==t&&(t=this._type===u?Math.min(t,this.device.maxCubeMapSize):Math.min(t,this.device.maxTextureSize),this._shadowResolution=t,this._destroyShadowMap())}get shadowResolution(){return this._shadowResolution}set vsmBlurSize(t){this._vsmBlurSize!==t&&(t%2==0&&t++,this._vsmBlurSize=t)}get vsmBlurSize(){return this._vsmBlurSize}set normalOffsetBias(t){this._normalOffsetBias!==t&&((!this._normalOffsetBias&&t||this._normalOffsetBias&&!t)&&this.updateKey(),this._normalOffsetBias=t)}get normalOffsetBias(){return this._normalOffsetBias}set falloffMode(t){this._falloffMode!==t&&(this._falloffMode=t,this.updateKey())}get falloffMode(){return this._falloffMode}set innerConeAngle(t){this._innerConeAngle!==t&&(this._innerConeAngle=t,this._innerConeAngleCos=Math.cos(t*Math.PI/180),this._usePhysicalUnits&&this._updateFinalColor())}get innerConeAngle(){return this._innerConeAngle}set outerConeAngle(t){this._outerConeAngle!==t&&(this._outerConeAngle=t,this._updateOuterAngle(t),this._usePhysicalUnits&&this._updateFinalColor())}get outerConeAngle(){return this._outerConeAngle}set penumbraSize(t){this._penumbraSize=t}get penumbraSize(){return this._penumbraSize}_updateOuterAngle(t){const e=t*Math.PI/180;this._outerConeAngleCos=Math.cos(e),this._outerConeAngleSin=Math.sin(e)}set intensity(t){this._intensity!==t&&(this._intensity=t,this._updateFinalColor())}get intensity(){return this._intensity}set affectSpecularity(t){this._type===h&&(this._affectSpecularity=t,this.updateKey())}get affectSpecularity(){return this._affectSpecularity}set luminance(t){this._luminance!==t&&(this._luminance=t,this._updateFinalColor())}get luminance(){return this._luminance}get cookieMatrix(){return this._cookieMatrix||(this._cookieMatrix=new s),this._cookieMatrix}get atlasViewport(){return this._atlasViewport||(this._atlasViewport=new o(0,0,1,1)),this._atlasViewport}set cookie(t){this._cookie!==t&&(this._cookie=t,this.updateKey())}get cookie(){return this._cookie}set cookieFalloff(t){this._cookieFalloff!==t&&(this._cookieFalloff=t,this.updateKey())}get cookieFalloff(){return this._cookieFalloff}set cookieChannel(t){if(this._cookieChannel!==t){if(t.length<3){const e=t.charAt(t.length-1),s=3-t.length;for(let i=0;i<s;i++)t+=e}this._cookieChannel=t,this.updateKey()}}get cookieChannel(){return this._cookieChannel}set cookieTransform(t){this._cookieTransform!==t&&(this._cookieTransform=t,this._cookieTransformSet=!!t,t&&!this._cookieOffset&&(this.cookieOffset=new i,this._cookieOffsetSet=!1),this.updateKey())}get cookieTransform(){return this._cookieTransform}set cookieOffset(t){if(this._cookieOffset===t)return;!(!this._cookieTransformSet&&!t)&&!t&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=t,this._cookieOffsetSet=!!t,t&&!this._cookieTransform&&(this.cookieTransform=new o(1,1,0,0),this._cookieTransformSet=!1),this.updateKey()}get cookieOffset(){return this._cookieOffset}beginFrame(){this.visibleThisFrame=this._type===h&&this._enabled,this.maxScreenSize=0,this.atlasViewportAllocated=!1,this.atlasSlotUpdated=!1}_destroyShadowMap(){if(this.releaseRenderData(),this._shadowMap&&(this._shadowMap.cached||this._shadowMap.destroy(),this._shadowMap=null),this.shadowUpdateMode===S&&(this.shadowUpdateMode=k),this.shadowUpdateOverrides)for(let t=0;t<this.shadowUpdateOverrides.length;t++)this.shadowUpdateOverrides[t]===S&&(this.shadowUpdateOverrides[t]=k)}getRenderData(t,e){for(let s=0;s<this._renderData.length;s++){const i=this._renderData[s];if(i.camera===t&&i.face===e)return i}const s=new U(this.device,t,e,this);return this._renderData.push(s),s}clone(){const t=new F(this.device);return t.type=this._type,t.setColor(this._color),t.intensity=this._intensity,t.affectSpecularity=this._affectSpecularity,t.luminance=this._luminance,t.castShadows=this.castShadows,t._enabled=this._enabled,t.attenuationStart=this.attenuationStart,t.attenuationEnd=this.attenuationEnd,t.falloffMode=this._falloffMode,t.shadowType=this._shadowType,t.vsmBlurSize=this._vsmBlurSize,t.vsmBlurMode=this.vsmBlurMode,t.vsmBias=this.vsmBias,t.penumbraSize=this.penumbraSize,t.shadowUpdateMode=this.shadowUpdateMode,t.mask=this.mask,this.shadowUpdateOverrides&&(t.shadowUpdateOverrides=this.shadowUpdateOverrides.slice()),t.innerConeAngle=this._innerConeAngle,t.outerConeAngle=this._outerConeAngle,t.numCascades=this.numCascades,t.cascadeDistribution=this.cascadeDistribution,t.shape=this._shape,t.shadowBias=this.shadowBias,t.normalOffsetBias=this._normalOffsetBias,t.shadowResolution=this._shadowResolution,t.shadowDistance=this.shadowDistance,t.shadowIntensity=this.shadowIntensity,t}static getLightUnitConversion(t,e=Math.PI/4,s=0){switch(t){case M:{const t=Math.cos(e),i=Math.cos(s);return 2*Math.PI*(1-i+(i-t)/2)}case u:return 4*Math.PI;case h:return 1}}_getUniformBiasValues(t){const e=t.shadowCamera._farClip;switch(this._type){case u:b.bias=this.shadowBias,b.normalBias=this._normalOffsetBias;break;case M:this._isVsm?b.bias=-2e-4:(b.bias=20*this.shadowBias,!this.device.webgl2&&this.device.extStandardDerivatives&&(b.bias*=-100)),b.normalBias=this._isVsm?this.vsmBias/(this.attenuationEnd/7):this._normalOffsetBias;break;case h:this._isVsm?b.bias=-2e-4:(b.bias=this.shadowBias/e*100,!this.device.webgl2&&this.device.extStandardDerivatives&&(b.bias*=-100)),b.normalBias=this._isVsm?this.vsmBias/(e/7):this._normalOffsetBias}return b}getColor(){return this._color}getBoundingSphere(t){if(this._type===M){const e=this.attenuationEnd,s=this._outerConeAngle,i=this._outerConeAngleCos,a=this._node;B.copy(a.up),s>45?(t.radius=e*this._outerConeAngleSin,B.mulScalar(-e*i)):(t.radius=e/(2*i),B.mulScalar(-t.radius)),t.center.add2(a.getPosition(),B)}else this._type===u&&(t.center=this._node.getPosition(),t.radius=this.attenuationEnd)}getBoundingBox(e){if(this._type===M){const s=this.attenuationEnd,i=this._outerConeAngle,a=this._node,o=Math.abs(Math.sin(i*t.DEG_TO_RAD)*s);e.center.set(0,.5*-s,0),e.halfExtents.set(o,.5*s,o),e.setFromTransformedAabb(e,a.getWorldTransform(),!0)}else this._type===u&&(e.center.copy(this._node.getPosition()),e.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))}_updateFinalColor(){const e=this._color,s=e.r,i=e.g,a=e.b;let o=this._intensity;this._usePhysicalUnits&&(o=this._luminance/F.getLightUnitConversion(this._type,this._outerConeAngle*t.DEG_TO_RAD,this._innerConeAngle*t.DEG_TO_RAD));const h=this._finalColor,n=this._linearFinalColor;h[0]=s*o,h[1]=i*o,h[2]=a*o,o>=1?(n[0]=Math.pow(s,2.2)*o,n[1]=Math.pow(i,2.2)*o,n[2]=Math.pow(a,2.2)*o):(n[0]=Math.pow(h[0],2.2),n[1]=Math.pow(h[1],2.2),n[2]=Math.pow(h[2],2.2))}setColor(){1===arguments.length?this._color.set(arguments[0].r,arguments[0].g,arguments[0].b):3===arguments.length&&this._color.set(arguments[0],arguments[1],arguments[2]),this._updateFinalColor()}layersDirty(){var t;null!=(t=this._scene)&&t.layers&&(this._scene.layers._dirtyLights=!0)}updateKey(){let t=this._type<<29|(this._castShadows?1:0)<<28|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|A[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12|this._shape<<10|this.numCascades-1<<8|(this.affectSpecularity?1:0)<<7;3===this._cookieChannel.length&&(t|=A[this._cookieChannel.charAt(1)]<<16,t|=A[this._cookieChannel.charAt(2)]<<14),t!==this.key&&null!==this._scene&&this.layersDirty(),this.key=t}}export{F as Light,O as lightTypes};
