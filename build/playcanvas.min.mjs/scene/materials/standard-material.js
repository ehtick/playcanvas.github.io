import"../../core/tracing.js";import{Color as e}from"../../core/math/color.js";import{math as t}from"../../core/math/math.js";import{Vec2 as a}from"../../core/math/vec2.js";import{ShaderProcessorOptions as s}from"../../platform/graphics/shader-processor-options.js";import{CUBEPROJ_BOX as i,SPECULAR_PHONG as r,SHADER_DEPTH as n,SHADER_PICK as h,DETAILMODE_MUL as o,SPECOCC_AO as l,SPECULAR_BLINN as c,FRESNEL_SCHLICK as m,CUBEPROJ_NONE as u}from"../constants.js";import{ShaderPass as p}from"../shader-pass.js";import{EnvLighting as d}from"../graphics/env-lighting.js";import{getProgramLibrary as _}from"../shader-lib/get-program-library.js";import{_matTex2D as f,standard as M}from"../shader-lib/programs/standard.js";import{Material as y}from"./material.js";import{StandardMaterialOptionsBuilder as P}from"./standard-material-options-builder.js";import{standardMaterialTextureParameters as v,standardMaterialCubemapParameters as g}from"./standard-material-parameters.js";const b={},x={};let S=new Set;class A extends y{constructor(){super(),this._dirtyShader=!0,this._assetReferences={},this._activeParams=new Set,this._activeLightingParams=new Set,this.shaderOptBuilder=new P,this.reset()}reset(){Object.keys(b).forEach((e=>{this[`_${e}`]=b[e].value()})),this._chunks={},this._uniformCache={}}set shader(e){}get shader(){return null}set chunks(e){this._dirtyShader=!0,this._chunks=e}get chunks(){return this._dirtyShader=!0,this._chunks}copy(e){super.copy(e),Object.keys(b).forEach((t=>{this[t]=e[t]}));for(const t in e._chunks)e._chunks.hasOwnProperty(t)&&(this._chunks[t]=e._chunks[t]);return this}_setParameter(e,t){S.add(e),this.setParameter(e,t)}_setParameters(e){e.forEach((e=>{this._setParameter(e.name,e.value)}))}_processParameters(e){const t=this[e];t.forEach((e=>{S.has(e)||delete this.parameters[e]})),this[e]=S,S=t,S.clear()}_updateMap(e){const t=e+"Map",a=this[t];if(a){this._setParameter("texture_"+t,a);const e=t+"Transform",s=this.getUniform(e);s&&this._setParameters(s)}}_allocUniform(e,t){let a=this._uniformCache[e];return a||(a=t(),this._uniformCache[e]=a),a}getUniform(e,t,a){return x[e](this,t,a)}updateUniforms(e,t){const a=a=>this.getUniform(a,e,t);if(this._setParameter("material_ambient",a("ambient")),this.diffuseMap&&!this.diffuseTint||this._setParameter("material_diffuse",a("diffuse")),this.useMetalness)if((!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness),this.specularMap&&!this.specularTint||this._setParameter("material_specular",a("specular")),this.specularityFactorMap&&!this.specularityFactorTint||this._setParameter("material_specularityFactor",this.specularityFactor),this.sheenMap&&!this.sheenTint||this._setParameter("material_sheen",a("sheen")),this.sheenGlossMap&&!this.sheenGlossTint||this._setParameter("material_sheenGlossiness",this.sheenGlossiness),this.refractionIndex!==1/1.5){const e=1/this.refractionIndex,t=(e-1)/(e+1);this._setParameter("material_f0",t*t)}else this._setParameter("material_f0",.04);else this.specularMap&&!this.specularTint||this._setParameter("material_specular",a("specular"));this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy),this.clearCoat>0&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGlossiness",this.clearCoatGlossiness),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness)),this._setParameter("material_shininess",a("shininess")),this.emissiveMap&&!this.emissiveTint||this._setParameter("material_emissive",a("emissive")),1!==this.emissiveIntensity&&this._setParameter("material_emissiveIntensity",this.emissiveIntensity),this.refraction>0&&(this._setParameter("material_refraction",this.refraction),this._setParameter("material_refractionIndex",this.refractionIndex)),this.useDynamicRefraction&&(this._setParameter("material_thickness",this.thickness),this._setParameter("material_attenuation",a("attenuation")),this._setParameter("material_invAttenuationDistance",0===this.attenuationDistance?0:1/this.attenuationDistance)),this.useIridescence&&(this._setParameter("material_iridescence",this.iridescence),this._setParameter("material_iridescenceRefractionIndex",this.iridescenceRefractionIndex),this._setParameter("material_iridescenceThicknessMin",this.iridescenceThicknessMin),this._setParameter("material_iridescenceThicknessMax",this.iridescenceThicknessMax)),this._setParameter("material_opacity",this.opacity),!1===this.opacityFadesSpecular&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),this.cubeMapProjection===i&&this._setParameter(a("cubeMapProjectionBox"));for(const e in f)this._updateMap(e);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&this._setParameter("material_heightMapFactor",a("heightMapFactor"));const s=this.shadingModel===r;this.envAtlas&&this.cubeMap&&!s?(this._setParameter("texture_envAtlas",this.envAtlas),this._setParameter("texture_cubeMap",this.cubeMap)):this.envAtlas&&!s?this._setParameter("texture_envAtlas",this.envAtlas):this.cubeMap?this._setParameter("texture_cubeMap",this.cubeMap):this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this._setParameter("material_reflectivity",this.reflectivity),this._processParameters("_activeParams"),this._dirtyShader&&this.clearVariants()}updateEnvUniforms(e,t){const a=this.shadingModel===r;!(this.envAtlas&&!a||this.cubeMap||this.sphereMap)&&this.useSkybox&&(t.envAtlas&&t.skybox&&!a?(this._setParameter("texture_envAtlas",t.envAtlas),this._setParameter("texture_cubeMap",t.skybox)):t.envAtlas&&!a?this._setParameter("texture_envAtlas",t.envAtlas):t.skybox&&this._setParameter("texture_cubeMap",t.skybox)),this._processParameters("_activeLightingParams")}getShaderVariant(e,t,a,i,r,o,l,c){this.updateEnvUniforms(e,t);const m=r===n||r===h||p.isShadow(r);let u=m?M.optionsContextMin:M.optionsContext;m?this.shaderOptBuilder.updateMinRef(u,t,this,a,i,r,o):this.shaderOptBuilder.updateRef(u,t,this,a,i,r,o),this.onUpdateShader&&(u=this.onUpdateShader(u));const d=new s(l,c),f=_(e);f.register("standard",M);const y=f.getProgram("standard",u,d);return this._dirtyShader=!1,y}destroy(){for(const e in this._assetReferences)this._assetReferences[e]._unbind();this._assetReferences=null,super.destroy()}}A.TEXTURE_PARAMETERS=v,A.CUBEMAP_PARAMETERS=g;const T=(e,t)=>{x[e]=t},F=(e,t,a,s)=>{Object.defineProperty(A.prototype,e,{get:s||function(){return this[`_${e}`]},set:a}),b[e]={value:t}},C=e=>{const t=`_${e.name}`,a=e.dirtyShaderFunc||(()=>!0);F(e.name,(()=>e.defaultValue),(function(e){const s=this[t];s!==e&&(this._dirtyShader=this._dirtyShader||a(s,e),this[t]=e)}),e.getterFunc)},k=e=>{const t=`_${e.name}`,a=e.dirtyShaderFunc||(()=>!0);F(e.name,(()=>e.defaultValue.clone()),(function(e){const s=this[t];s.equals(e)||(this._dirtyShader=this._dirtyShader||a(s,e),this[t]=s.copy(e))}),e.getterFunc)},w=e=>e.defaultValue&&e.defaultValue.clone?k(e):C(e);function j(e,s,i,r,n,h){f[e]=i,w({name:`${e}Map`,defaultValue:null,dirtyShaderFunc:(e,t)=>!!e!=!!t||e&&(e.type!==t.type||e.fixCubemapSeams!==t.fixCubemapSeams||e.format!==t.format)}),w({name:`${e}MapTiling`,defaultValue:new a(1,1)}),w({name:`${e}MapOffset`,defaultValue:new a(0,0)}),w({name:`${e}MapRotation`,defaultValue:0}),w({name:`${e}MapUv`,defaultValue:s}),i>0&&w({name:`${e}MapChannel`,defaultValue:r||(i>1?"rgb":"g")}),n&&(w({name:`${e}VertexColor`,defaultValue:!1}),i>0&&w({name:`${e}VertexColorChannel`,defaultValue:r||(i>1?"rgb":"g")})),h&&w({name:`${e}Mode`,defaultValue:o});const l=`${e}MapTiling`,c=`${e}MapOffset`,m=`${e}MapRotation`,u=`${e}MapTransform`;T(u,((e,a,s)=>{const i=e[l],r=e[c],n=e[m];if(1===i.x&&1===i.y&&0===r.x&&0===r.y&&0===n)return null;const h=e._allocUniform(u,(()=>[{name:`texture_${u}0`,value:new Float32Array(3)},{name:`texture_${u}1`,value:new Float32Array(3)}])),o=Math.cos(n*t.DEG_TO_RAD),p=Math.sin(n*t.DEG_TO_RAD),d=h[0].value;d[0]=o*i.x,d[1]=-p*i.y,d[2]=r.x;const _=h[1].value;return _[0]=p*i.x,_[1]=o*i.y,_[2]=1-i.y-r.y,h}))}function V(e,t){w({name:e,defaultValue:t,getterFunc:function(){return this._dirtyShader=!0,this[`_${e}`]}}),T(e,((t,a,s)=>{const i=t._allocUniform(e,(()=>new Float32Array(3))),r=t[e];return t.useGammaTonemap&&s.gammaCorrection?(i[0]=Math.pow(r.r,2.2),i[1]=Math.pow(r.g,2.2),i[2]=Math.pow(r.b,2.2)):(i[0]=r.r,i[1]=r.g,i[2]=r.b),i}))}function R(e,t,a){w({name:e,defaultValue:t,dirtyShaderFunc:(e,t)=>(0===e||1===e)!=(0===t||1===t)}),T(e,a)}function $(e,t){w({name:e,defaultValue:null,dirtyShaderFunc:(e,t)=>!!e==!!t}),T(e,t)}function G(e,t){w({name:e,defaultValue:t})}!function(){V("ambient",new e(.7,.7,.7)),V("diffuse",new e(1,1,1)),V("specular",new e(0,0,0)),V("emissive",new e(0,0,0)),V("sheen",new e(1,1,1)),V("attenuation",new e(1,1,1)),R("emissiveIntensity",1),R("specularityFactor",1),R("sheenGlossiness",0),R("shininess",25,((e,t,a)=>e.shadingModel===r?Math.pow(2,.01*e.shininess*11):.01*e.shininess)),R("heightMapFactor",1,((e,t,a)=>.025*e.heightMapFactor)),R("opacity",1),R("alphaFade",1),R("alphaTest",0),R("bumpiness",1),R("normalDetailMapBumpiness",1),R("reflectivity",1),R("occludeSpecularIntensity",1),R("refraction",0),R("refractionIndex",1/1.5),R("thickness",0),R("attenuationDistance",0),R("metalness",1),R("anisotropy",0),R("clearCoat",0),R("clearCoatGlossiness",1),R("clearCoatBumpiness",1),R("aoUvSet",0,null),R("iridescence",0),R("iridescenceRefractionIndex",1/1.5),R("iridescenceThicknessMin",0),R("iridescenceThicknessMax",0),$("ambientSH"),$("cubeMapProjectionBox",((e,t,a)=>{const s=e._allocUniform("cubeMapProjectionBox",(()=>[{name:"envBoxMin",value:new Float32Array(3)},{name:"envBoxMax",value:new Float32Array(3)}])),i=e.cubeMapProjectionBox.getMin(),r=s[0].value;r[0]=i.x,r[1]=i.y,r[2]=i.z;const n=e.cubeMapProjectionBox.getMax(),h=s[1].value;return h[0]=n.x,h[1]=n.y,h[2]=n.z,s})),G("ambientTint",!1),G("diffuseTint",!1),G("specularTint",!1),G("specularityFactorTint",!1),G("emissiveTint",!1),G("fastTbn",!1),G("useMetalness",!1),G("useMetalnessSpecularColor",!1),G("useSheen",!1),G("enableGGXSpecular",!1),G("occludeDirect",!1),G("normalizeNormalMap",!0),G("conserveEnergy",!0),G("opacityFadesSpecular",!0),G("occludeSpecular",l),G("shadingModel",c),G("fresnelModel",m),G("useDynamicRefraction",!1),G("cubeMapProjection",u),G("customFragmentShader",null),G("forceFragmentPrecision",null),G("useFog",!0),G("useLighting",!0),G("useGammaTonemap",!0),G("useSkybox",!0),G("forceUv1",!1),G("pixelSnap",!1),G("twoSidedLighting",!1),G("nineSlicedMode",void 0),G("msdfTextAttribute",!1),G("useIridescence",!1),j("diffuse",0,3,"",!0),j("specular",0,3,"",!0),j("emissive",0,3,"",!0),j("thickness",0,1,"",!0),j("specularityFactor",0,1,"",!0),j("normal",0,-1,"",!1),j("metalness",0,1,"",!0),j("gloss",0,1,"",!0),j("opacity",0,1,"a",!0),j("refraction",0,1,"",!0),j("height",0,1,"",!1),j("ao",0,1,"",!0),j("light",1,3,"",!0),j("msdf",0,3,"",!1),j("diffuseDetail",0,3,"",!1,!0),j("normalDetail",0,-1,"",!1),j("clearCoat",0,1,"",!0),j("clearCoatGloss",0,1,"",!0),j("clearCoatNormal",0,-1,"",!1),j("sheen",0,3,"",!0),j("sheenGloss",0,1,"",!0),j("iridescence",0,1,"",!0),j("iridescenceThickness",0,1,"",!0),$("cubeMap"),$("sphereMap"),$("envAtlas");const t=[null,null,null,null,null,null];F("prefilteredCubemaps",(()=>t.slice()),(function(e){const t=this._prefilteredCubemaps;e=e||[];let a=!1,s=!0;for(let i=0;i<6;++i){const r=e[i]||null;t[i]!==r&&(t[i]=r,a=!0),s=s&&!!t[i]}a&&(s?this.envAtlas=d.generatePrefilteredAtlas(t,{target:this.envAtlas}):this.envAtlas&&(this.envAtlas.destroy(),this.envAtlas=null),this._dirtyShader=!0)}),(function(){return this._prefilteredCubemaps}))}();export{A as StandardMaterial};
