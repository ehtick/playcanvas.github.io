import"../../core/tracing.js";import{DEVICETYPE_WEBGPU as e,FILTER_NEAREST as r,FILTER_LINEAR_MIPMAP_LINEAR as t,FILTER_LINEAR as a,ADDRESS_CLAMP_TO_EDGE as n,PIXELFORMAT_DEPTHSTENCIL as o,PIXELFORMAT_RGBA8 as s}from"../../platform/graphics/constants.js";import{RenderTarget as i}from"../../platform/graphics/render-target.js";import{Texture as l}from"../../platform/graphics/texture.js";import{LAYERID_DEPTH as d,SHADER_DEPTH as h,LAYERID_WORLD as c}from"../constants.js";import{Layer as u}from"../layer.js";const p=["uSceneDepthMap","uDepthMap"],g=["uSceneColorMap","texture_grabPass"];class f{constructor(r,t){this.scene=t,this.device=r,this.layer=null,this.device.webgl2||this.device.deviceType===e?this.initMainPath():this.initFallbackPath()}static requiresRenderPass(r,t){return!r.webgl2&&r.deviceType!==e&&t.renderSceneDepthMap}setupUniform(e,r,t){(r?p:g).forEach((r=>e.scope.resolve(r).setValue(t)))}allocateTexture(e,o,s,i,d,h){return new l(e,{name:s,format:i,width:o?o.colorBuffer.width:e.width,height:o?o.colorBuffer.height:e.height,mipmaps:h,minFilter:d?r:h?t:a,magFilter:d?r:a,addressU:n,addressV:n})}getSourceColorFormat(e){var r;return null!=(r=null==e?void 0:e.format)?r:this.device.framebufferFormat}shouldReallocate(e,r,t){if(t){if((null==e?void 0:e.colorBuffer.format)!==this.getSourceColorFormat(r))return!0}const a=(null==r?void 0:r.width)||this.device.width,n=(null==r?void 0:r.height)||this.device.height;return!e||a!==e.width||n!==e.height}allocateRenderTarget(e,r,t,a,n,o,s){const l=s?p:g,d=this.allocateTexture(t,r,l[0],a,n,o);return e?(e.destroyFrameBuffers(),n?e._depthBuffer=d:e._colorBuffer=d):e=new i({name:"renderTargetSceneGrab",colorBuffer:n?null:d,depthBuffer:n?d:null,depth:!n,stencil:t.supportsStencil,autoResolve:!1}),e}releaseRenderTarget(e){e&&(e.destroyTextureBuffers(),e.destroy())}initMainPath(){const r=this.device,t=this;this.layer=new u({enabled:!1,name:"Depth",id:d,onDisable:function(){t.releaseRenderTarget(this.depthRenderTarget),this.depthRenderTarget=null,t.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=null},onPreRenderOpaque:function(a){const n=this.cameras[a];if(n.renderSceneColorMap){var s;if(t.shouldReallocate(this.colorRenderTarget,null==(s=n.renderTarget)?void 0:s.colorBuffer,!0)){var i;t.releaseRenderTarget(this.colorRenderTarget);const e=t.getSourceColorFormat(null==(i=n.renderTarget)?void 0:i.colorBuffer);this.colorRenderTarget=t.allocateRenderTarget(this.colorRenderTarget,n.renderTarget,r,e,!1,!0,!1)}const a=this.colorRenderTarget.colorBuffer;r.deviceType===e?r.copyRenderTarget(n.renderTarget,this.colorRenderTarget,!0,!1):(r.copyRenderTarget(r.renderTarget,this.colorRenderTarget,!0,!1),r.activeTexture(r.maxCombinedTextures-1),r.bindTexture(a),r.gl.generateMipmap(a.impl._glTarget)),t.setupUniform(r,!1,a)}var l;n.renderSceneDepthMap&&(t.shouldReallocate(this.depthRenderTarget,null==(l=n.renderTarget)?void 0:l.depthBuffer)&&(t.releaseRenderTarget(this.depthRenderTarget),this.depthRenderTarget=t.allocateRenderTarget(this.depthRenderTarget,n.renderTarget,r,o,!0,!1,!0)),r.copyRenderTarget(r.renderTarget,this.depthRenderTarget,!1,!0),t.setupUniform(r,!0,this.depthRenderTarget.depthBuffer))},onPostRenderOpaque:function(e){}})}initFallbackPath(){const e=this,r=this.device,t=this.scene;this.layer=new u({enabled:!1,name:"Depth",id:d,shaderPass:h,onEnable:function(){this.depthRenderTarget=new i({name:"depthRenderTarget-webgl1",depth:!0,stencil:r.supportsStencil,autoResolve:!1,graphicsDevice:r}),this.renderTarget=this.depthRenderTarget},onDisable:function(){this.depthRenderTarget.destroyTextureBuffers(),this.renderTarget=null,e.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=null},onPostCull:function(a){const n=this.cameras[a];if(n.renderSceneDepthMap){var o;this.depthRenderTarget.depthBuffer&&!e.shouldReallocate(this.depthRenderTarget,null==(o=n.renderTarget)?void 0:o.depthBuffer)||(this.depthRenderTarget.destroyTextureBuffers(),this.depthRenderTarget=e.allocateRenderTarget(this.depthRenderTarget,n.renderTarget,r,s,!1,!1,!0));const i=this.instances.visibleOpaque[a],l=i.list,d=t.layers,h=d.subLayerEnabled,u=d.subLayerList,p=d.getLayerById(c).renderTarget;let g=0;const f=d.layerList;for(let e=0;e<f.length;e++){const r=f[e];if(r===this)break;if(r.renderTarget!==p||!r.enabled||!h[e])continue;const t=r.cameras.indexOf(n);if(t<0)continue;let a=u[e]?r.instances.visibleTransparent[t]:r.instances.visibleOpaque[t];const o=a.length;a=a.list;for(let e=0;e<o;e++){const r=a[e];r.material&&r.material.depthWrite&&!r._noDepthDrawGl1&&(l[g]=r,g++)}}i.length=g}},onPreRenderOpaque:function(t){const a=this.cameras[t];if(a.renderSceneColorMap){var n;if(e.shouldReallocate(this.colorRenderTarget,null==(n=a.renderTarget)?void 0:n.colorBuffer)){var o;e.releaseRenderTarget(this.colorRenderTarget);const t=e.getSourceColorFormat(null==(o=a.renderTarget)?void 0:o.colorBuffer);this.colorRenderTarget=e.allocateRenderTarget(this.colorRenderTarget,a.renderTarget,r,t,!1,!1,!1)}const t=this.colorRenderTarget._colorBuffer;t.impl._glTexture||t.impl.initialize(r,t),r.bindTexture(t);const s=r.gl;s.copyTexImage2D(s.TEXTURE_2D,0,t.impl._glFormat,0,0,t.width,t.height,0),t._needsUpload=!1,t._needsMipmapsUpload=!1,e.setupUniform(r,!1,t)}a.renderSceneDepthMap&&e.setupUniform(r,!0,this.depthRenderTarget.colorBuffer)},onDrawCall:function(){r.setColorWrite(!0,!0,!0,!0)},onPostRenderOpaque:function(e){if(this.cameras[e].renderSceneDepthMap){this.instances.visibleOpaque[e].length=0}}})}patch(e){e.onEnable=this.layer.onEnable,e.onDisable=this.layer.onDisable,e.onPreRenderOpaque=this.layer.onPreRenderOpaque,e.onPostRenderOpaque=this.layer.onPostRenderOpaque,e.shaderPass=this.layer.shaderPass,e.onPostCull=this.layer.onPostCull,e.onDrawCall=this.layer.onDrawCall}}export{f as SceneGrab};
