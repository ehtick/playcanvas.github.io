import"../../../core/tracing.js";import{ADDRESS_CLAMP_TO_EDGE as e,ADDRESS_REPEAT as t,PIXELFORMAT_DXT1 as r,PIXELFORMAT_DXT3 as a,PIXELFORMAT_DXT5 as n,PIXELFORMAT_ETC1 as s,PIXELFORMAT_ETC2_RGB as l,PIXELFORMAT_ETC2_RGBA as i,PIXELFORMAT_PVRTC_4BPP_RGB_1 as o,PIXELFORMAT_PVRTC_2BPP_RGB_1 as m,PIXELFORMAT_PVRTC_4BPP_RGBA_1 as p,PIXELFORMAT_PVRTC_2BPP_RGBA_1 as u,PIXELFORMAT_RGB8 as f,PIXELFORMAT_RGBA8 as c,PIXELFORMAT_SRGB as h,PIXELFORMAT_SRGBA as d,PIXELFORMAT_111110F as g,PIXELFORMAT_RGB16F as b,PIXELFORMAT_RGBA16F as y}from"../../../platform/graphics/constants.js";import{Texture as x}from"../../../platform/graphics/texture.js";import{Asset as O}from"../../asset/asset.js";const v=[1481919403,3140563232,169478669],w={33776:r,33778:a,33779:n,36196:s,37492:l,37496:i,35840:o,35841:m,35842:p,35843:u,32849:f,32856:c,35905:h,35907:d,35898:g,34843:b,34842:y};class A{constructor(e){this.maxRetries=0}load(e,t,r){O.fetchArrayBuffer(e.load,t,r,this.maxRetries)}open(r,a,n){const s=this.parse(a);if(!s)return null;const l=new x(n,{name:r,addressU:s.cubemap?e:t,addressV:s.cubemap?e:t,width:s.width,height:s.height,format:s.format,cubemap:s.cubemap,levels:s.levels});return l.upload(),l}parse(e){const t=new Uint32Array(e);if(v[0]!==t[0]||v[1]!==t[1]||v[2]!==t[2])return null;const r={endianness:t[3],glType:t[4],glTypeSize:t[5],glFormat:t[6],glInternalFormat:t[7],glBaseInternalFormat:t[8],pixelWidth:t[9],pixelHeight:t[10],pixelDepth:t[11],numberOfArrayElements:t[12],numberOfFaces:t[13],numberOfMipmapLevels:t[14],bytesOfKeyValueData:t[15]};if(r.pixelDepth>1)return null;if(0!==r.numberOfArrayElements)return null;const a=w[r.glInternalFormat];if(void 0===a)return null;let n=16+r.bytesOfKeyValueData/4;const s=r.numberOfFaces>1,l=[];for(let p=0;p<(r.numberOfMipmapLevels||1);p++){const r=t[n++];s&&l.push([]);const u=s?l[p]:l;for(let t=0;t<(s?6:1);++t)u.push((i=e,o=4*n,m=r,a===g?new Uint32Array(i,o,m/4):new Uint8Array(i,o,m))),n+=r+3>>2}var i,o,m;return{format:a,width:r.pixelWidth,height:r.pixelHeight,levels:l,cubemap:s}}}export{A as KtxParser};
