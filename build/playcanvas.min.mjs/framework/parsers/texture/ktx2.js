import"../../../core/tracing.js";import{ReadStream as e}from"../../../core/read-stream.js";import{ADDRESS_CLAMP_TO_EDGE as t,ADDRESS_REPEAT as r}from"../../../platform/graphics/constants.js";import{Texture as s}from"../../../platform/graphics/texture.js";import{Asset as a}from"../../asset/asset.js";import{basisTranscode as d}from"../../handlers/basis.js";const o=166;class i{constructor(e,t){this.maxRetries=0,this.device=t}load(e,t,r){a.fetchArrayBuffer(e.load,((s,a)=>{s?t(s,a):this.parse(a,e,t,r)}),r,this.maxRetries)}open(e,a,d){const o=new s(d,{name:e,addressU:a.cubemap?t:r,addressV:a.cubemap?t:r,width:a.width,height:a.height,format:a.format,cubemap:a.cubemap,levels:a.levels});return o.upload(),o}parse(t,r,s,a){const i=new e(t),n=[i.readU32be(),i.readU32be(),i.readU32be()];if(2873840728!==n[0]||540160187!==n[1]||218765834!==n[2])return null;const l={vkFormat:i.readU32(),typeSize:i.readU32(),pixelWidth:i.readU32(),pixelHeight:i.readU32(),pixelDepth:i.readU32(),layerCount:i.readU32(),faceCount:i.readU32(),levelCount:i.readU32(),supercompressionScheme:i.readU32()},p={dfdByteOffset:i.readU32(),dfdByteLength:i.readU32(),kvdByteOffset:i.readU32(),kvdByteLength:i.readU32(),sgdByteOffset:i.readU64(),sgdByteLength:i.readU64()},f=[];for(let e=0;e<Math.max(1,l.levelCount);++e)f.push({byteOffset:i.readU64(),byteLength:i.readU64(),uncompressedByteLength:i.readU64()});if(i.readU32()!==p.kvdByteOffset-p.dfdByteOffset)return null;i.skip(8);const m=i.readU8();if(i.skip(p.dfdByteLength-9),i.skip(p.kvdByteLength),1===l.supercompressionScheme||m===o){var u,h,c;d(this.device,r.load,t,s,{isGGGR:0!=(8&(null==a||null==(u=a.file)||null==(h=u.variants)||null==(c=h.basis)?void 0:c.opt)),isKTX2:!0})||s('Basis module not found. Asset "'+a.name+'" basis texture variant will not be loaded.')}else s("unsupported KTX2 pixel format")}}export{i as Ktx2Parser};
