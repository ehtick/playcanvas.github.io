import{SortedLoopArray as t}from"../../../core/sorted-loop-array.js";import{ScriptAttributes as e}from"../../../script/script-attributes.js";import{Component as i}from"../component.js";import{Entity as s}from"../../entity.js";import"../../../script/script-type.js";import"../../../core/tracing.js";class n extends i{constructor(e,i){super(e,i),this._scripts=[],this._updateList=new t({sortBy:"__executionOrder"}),this._postUpdateList=new t({sortBy:"__executionOrder"}),this._scriptsIndex={},this._destroyedScripts=[],this._destroyed=!1,this._scriptsData=null,this._oldState=!0,this._enabled=!0,this._beingEnabled=!1,this._isLoopingThroughScripts=!1,this._executionOrder=-1,this.on("set_enabled",this._onSetEnabled,this)}set scripts(t){this._scriptsData=t;for(const i in t){if(!t.hasOwnProperty(i))continue;const s=this._scriptsIndex[i];if(s){if("boolean"==typeof t[i].enabled&&(s.enabled=!!t[i].enabled),"object"==typeof t[i].attributes)for(const n in t[i].attributes)if(!e.reservedNames.has(n)){if(!s.__attributes.hasOwnProperty(n)){const t=this.system.app.scripts.get(i);t&&t.attributes.add(n,{})}s[n]=t[i].attributes[n]}}else console.log(this.order)}}get scripts(){return this._scripts}set enabled(t){const e=this._enabled;this._enabled=t,this.fire("set","enabled",e,t)}get enabled(){return this._enabled}onEnable(){this._beingEnabled=!0,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=!1}onDisable(){this._checkState()}onPostStateChange(){const t=this._beginLooping();for(let t=0,e=this.scripts.length;t<e;t++){const e=this.scripts[t];e._initialized&&!e._postInitialized&&e.enabled&&(e._postInitialized=!0,e.postInitialize&&this._scriptMethod(e,n.scriptMethods.postInitialize))}this._endLooping(t)}_beginLooping(){const t=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=!0,t}_endLooping(t){this._isLoopingThroughScripts=t,this._isLoopingThroughScripts||this._removeDestroyedScripts()}_onSetEnabled(t,e,i){this._beingEnabled=!0,this._checkState(),this._beingEnabled=!1}_checkState(){const t=this.enabled&&this.entity.enabled;if(t===this._oldState)return;this._oldState=t,this.fire(t?"enable":"disable"),this.fire("state",t),t?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);const e=this._beginLooping();for(let t=0,e=this.scripts.length;t<e;t++){const e=this.scripts[t];e.enabled=e._enabled}this._endLooping(e)}_onBeforeRemove(){this.fire("remove");const t=this._beginLooping();for(let t=0;t<this.scripts.length;t++){const e=this.scripts[t];e&&this.destroy(e.__scriptType.__name)}this._endLooping(t)}_removeDestroyedScripts(){const t=this._destroyedScripts.length;if(t){for(let e=0;e<t;e++){const t=this._destroyedScripts[e];this._removeScriptInstance(t)}this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length)}}_onInitializeAttributes(){for(let t=0,e=this.scripts.length;t<e;t++)this.scripts[t].__initializeAttributes()}_scriptMethod(t,e,i){t[e](i)}_onInitialize(){const t=this._scripts,e=this._beginLooping();for(let e=0,i=t.length;e<i;e++){const i=t[e];!i._initialized&&i.enabled&&(i._initialized=!0,i.initialize&&this._scriptMethod(i,n.scriptMethods.initialize))}this._endLooping(e)}_onPostInitialize(){this.onPostStateChange()}_onUpdate(t){const e=this._updateList;if(!e.length)return;const i=this._beginLooping();for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){const i=e.items[e.loopIndex];i.enabled&&this._scriptMethod(i,n.scriptMethods.update,t)}this._endLooping(i)}_onPostUpdate(t){const e=this._postUpdateList;if(!e.length)return;const i=this._beginLooping();for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){const i=e.items[e.loopIndex];i.enabled&&this._scriptMethod(i,n.scriptMethods.postUpdate,t)}this._endLooping(i)}_insertScriptInstance(t,e,i){-1===e?(this._scripts.push(t),t.__executionOrder=i,t.update&&this._updateList.append(t),t.postUpdate&&this._postUpdateList.append(t)):(this._scripts.splice(e,0,t),t.__executionOrder=e,this._resetExecutionOrder(e+1,i+1),t.update&&this._updateList.insert(t),t.postUpdate&&this._postUpdateList.insert(t))}_removeScriptInstance(t){const e=this._scripts.indexOf(t);return-1===e||(this._scripts.splice(e,1),t.update&&this._updateList.remove(t),t.postUpdate&&this._postUpdateList.remove(t)),e}_resetExecutionOrder(t,e){for(let i=t;i<e;i++)this._scripts[i].__executionOrder=i}_resolveEntityScriptAttribute(t,e,i,n,r,o){if(t.array){const t=i.length;if(!t)return;const p=i.slice();for(let e=0;e<t;e++){const t=p[e]instanceof s?p[e].getGuid():p[e];o[t]&&(p[e]=n?o[t].getGuid():o[t])}r[e]=p}else{if(i instanceof s)i=i.getGuid();else if("string"!=typeof i)return;o[i]&&(r[e]=o[i])}}has(t){if("string"==typeof t)return!!this._scriptsIndex[t];if(!t)return!1;const e=t,i=e.__name,s=this._scriptsIndex[i];return(s&&s.instance)instanceof e}get(t){if("string"==typeof t){const e=this._scriptsIndex[t];return e?e.instance:null}if(!t)return null;const e=t,i=e.__name,s=this._scriptsIndex[i],n=s&&s.instance;return n instanceof e?n:null}create(t,e={}){const i=this;let s=t,r=t;if("string"==typeof s?s=this.system.app.scripts.get(s):s&&(r=s.__name),s){if(!this._scriptsIndex[r]||!this._scriptsIndex[r].instance){const t=new s({app:this.system.app,entity:this.entity,enabled:!e.hasOwnProperty("enabled")||e.enabled,attributes:e.attributes}),o=this._scripts.length;let p=-1;return"number"==typeof e.ind&&-1!==e.ind&&o>e.ind&&(p=e.ind),this._insertScriptInstance(t,p,o),this._scriptsIndex[r]={instance:t,onSwap:function(){i.swap(r)}},this[r]=t,e.preloading||t.__initializeAttributes(),this.fire("create",r,t),this.fire("create:"+r,t),this.system.app.scripts.on("swap:"+r,this._scriptsIndex[r].onSwap),e.preloading||(t.enabled&&!t._initialized&&(t._initialized=!0,t.initialize&&this._scriptMethod(t,n.scriptMethods.initialize)),t.enabled&&!t._postInitialized&&(t._postInitialized=!0,t.postInitialize&&this._scriptMethod(t,n.scriptMethods.postInitialize))),t}}else this._scriptsIndex[r]={awaiting:!0,ind:this._scripts.length};return null}destroy(t){let e=t,i=t;"string"==typeof i?i=this.system.app.scripts.get(i):i&&(e=i.__name);const s=this._scriptsIndex[e];if(delete this._scriptsIndex[e],!s)return!1;const n=s.instance;if(n&&!n._destroyed)if(n.enabled=!1,n._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(n);else{const t=this._removeScriptInstance(n);t>=0&&this._resetExecutionOrder(t,this._scripts.length)}return this.system.app.scripts.off("swap:"+e,s.onSwap),delete this[e],this.fire("destroy",e,n||null),this.fire("destroy:"+e,n||null),n&&n.fire("destroy"),!0}swap(t){let e=t,i=t;"string"==typeof i?i=this.system.app.scripts.get(i):i&&(e=i.__name);const s=this._scriptsIndex[e];if(!s||!s.instance)return!1;const r=s.instance,o=this._scripts.indexOf(r),p=new i({app:this.system.app,entity:this.entity,enabled:r.enabled,attributes:r.__attributes});return!!p.swap&&(p.__initializeAttributes(),this._scripts[o]=p,this._scriptsIndex[e].instance=p,this[e]=p,p.__executionOrder=o,r.update&&this._updateList.remove(r),r.postUpdate&&this._postUpdateList.remove(r),p.update&&this._updateList.insert(p),p.postUpdate&&this._postUpdateList.insert(p),this._scriptMethod(p,n.scriptMethods.swap,r),this.fire("swap",e,p),this.fire("swap:"+e,p),!0)}resolveDuplicatedEntityReferenceProperties(t,e){const i=this.entity.script;for(const s in t._scriptsIndex){const n=this.system.app.scripts.get(s);if(!n)continue;const r=t._scriptsIndex[s];if(!r||!r.instance)continue;const o=i[s].__attributesRaw,p=i[s].__attributes;if(!o&&!p)continue;const a=!!o,h=r.instance.__attributes;for(const t in h){if(!h[t])continue;const i=n.attributes.get(t);if(i)if("entity"===i.type)this._resolveEntityScriptAttribute(i,t,h[t],a,o||p,e);else if("json"===i.type&&Array.isArray(i.schema)){const s=h[t],n=o?o[t]:p[t];for(let t=0;t<i.schema.length;t++){const r=i.schema[t];if("entity"===r.type)if(i.array)for(let t=0;t<s.length;t++)this._resolveEntityScriptAttribute(r,r.name,s[t][r.name],a,n[t],e);else this._resolveEntityScriptAttribute(r,r.name,s[r.name],a,n,e)}}}}}move(t,e){const i=this._scripts.length;if(e>=i||e<0)return!1;let s=t,n=t;"string"!=typeof n?n=t.__name:s=null;const r=this._scriptsIndex[n];if(!r||!r.instance)return!1;const o=r.instance;if(s&&!(o instanceof s))return!1;const p=this._scripts.indexOf(o);return-1!==p&&p!==e&&(this._scripts.splice(e,0,this._scripts.splice(p,1)[0]),this._resetExecutionOrder(0,i),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",n,o,e,p),this.fire("move:"+n,o,e,p),!0)}}n.scriptMethods={initialize:"initialize",postInitialize:"postInitialize",update:"update",postUpdate:"postUpdate",swap:"swap"};export{n as ScriptComponent};
