import{platform as e}from"../core/platform.js";import{now as s}from"../core/time.js";import{path as t}from"../core/path.js";import"../core/tracing.js";import{EventHandler as i}from"../core/event-handler.js";import{Color as r}from"../core/math/color.js";import{Mat4 as a}from"../core/math/mat4.js";import{math as n}from"../core/math/math.js";import{Quat as h}from"../core/math/quat.js";import{Vec3 as o}from"../core/math/vec3.js";import{PRIMITIVE_TRIANGLES as d,PRIMITIVE_TRISTRIP as l,PRIMITIVE_TRIFAN as c}from"../platform/graphics/constants.js";import{GraphicsDeviceAccess as p}from"../platform/graphics/graphics-device-access.js";import{http as m}from"../platform/net/http.js";import{LAYERID_WORLD as u,LAYERID_SKYBOX as f,SORTMODE_NONE as y,LAYERID_UI as g,SORTMODE_MANUAL as _,LAYERID_IMMEDIATE as b,LAYERID_DEPTH as w,SPECULAR_BLINN as v}from"../scene/constants.js";import{setProgramLibrary as x}from"../scene/shader-lib/get-program-library.js";import{ProgramLibrary as D}from"../scene/shader-lib/program-library.js";import{ForwardRenderer as L}from"../scene/renderer/forward-renderer.js";import{FrameGraph as T}from"../scene/frame-graph.js";import{AreaLightLuts as M}from"../scene/area-light-luts.js";import{Layer as k}from"../scene/layer.js";import{LayerComposition as C}from"../scene/composition/layer-composition.js";import{Scene as A}from"../scene/scene.js";import{Material as S}from"../scene/materials/material.js";import{LightsBuffer as j}from"../scene/lighting/lights-buffer.js";import{StandardMaterial as P}from"../scene/materials/standard-material.js";import{setDefaultMaterial as I}from"../scene/materials/default-material.js";import{Asset as F}from"./asset/asset.js";import{AssetRegistry as H}from"./asset/asset-registry.js";import{BundleRegistry as R}from"./bundle/bundle-registry.js";import{ComponentSystemRegistry as z}from"./components/registry.js";import{SceneGrab as U}from"../scene/graphics/scene-grab.js";import{BundleHandler as E}from"./handlers/bundle.js";import{ResourceLoader as q}from"./handlers/loader.js";import{I18n as O}from"./i18n/i18n.js";import{ScriptRegistry as W}from"./script/script-registry.js";import{Entity as B}from"./entity.js";import{SceneRegistry as G}from"./scene-registry.js";import{script as N}from"./script.js";import{ApplicationStats as Q}from"./stats.js";import{FILLMODE_KEEP_ASPECT as V,RESOLUTION_FIXED as Y,RESOLUTION_AUTO as J,FILLMODE_FILL_WINDOW as K}from"./constants.js";import{setApplication as X,getApplication as Z}from"./globals.js";class ${constructor(e){this.length=e,this.count=0}inc(){this.count++}done(){return this.count===this.length}}let ee=null;class se extends i{constructor(e){super(),se._applications[e.id]=this,X(this),ee=this,this._destroyRequested=!1,this._inFrameUpdate=!1,this._time=0,this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.autoRender=!0,this.renderNextFrame=!1,this.useLegacyScriptAttributeCloning=N.legacy,this._librariesLoaded=!1,this._fillMode=V,this._resolutionMode=Y,this._allowResize=!0,this.context=this}init(e){const s=e.graphicsDevice;this.graphicsDevice=s,p.set(s),this._initDefaultMaterial(),this._initProgramLibrary(),this.stats=new Q(s),this._soundManager=e.soundManager,this.loader=new q(this),j.init(s),this._entityIndex={},this.scene=new A(s),this._registerSceneImmediate(this.scene),this.root=new B,this.root._enabledInHierarchy=!0,this.assets=new H(this.loader),e.assetPrefix&&(this.assets.prefix=e.assetPrefix),this.bundles=new R(this.assets),this.enableBundles="undefined"!=typeof TextDecoder,this.scriptsOrder=e.scriptsOrder||[],this.scripts=new W(this),this.i18n=new O(this),this.scenes=new G(this);const t=this;this.defaultLayerWorld=new k({name:"World",id:u}),this.sceneGrab=new U(this.graphicsDevice,this.scene),this.defaultLayerDepth=this.sceneGrab.layer,this.defaultLayerSkybox=new k({enabled:!0,name:"Skybox",id:f,opaqueSortMode:y}),this.defaultLayerUi=new k({enabled:!0,name:"UI",id:g,transparentSortMode:_,passThrough:!1}),this.defaultLayerImmediate=new k({enabled:!0,name:"Immediate",id:b,opaqueSortMode:y,passThrough:!0});const i=new C("default");i.pushOpaque(this.defaultLayerWorld),i.pushOpaque(this.defaultLayerDepth),i.pushOpaque(this.defaultLayerSkybox),i.pushTransparent(this.defaultLayerWorld),i.pushOpaque(this.defaultLayerImmediate),i.pushTransparent(this.defaultLayerImmediate),i.pushTransparent(this.defaultLayerUi),this.scene.layers=i,this.scene.on("set:layers",(function(e,s){const i=s.layerList;let r;for(let e=0;e<i.length;e++)switch(r=i[e],r.id){case w:t.sceneGrab.patch(r);break;case g:r.passThrough=t.defaultLayerUi.passThrough;break;case b:r.passThrough=t.defaultLayerImmediate.passThrough}})),M.createPlaceholder(s),this.renderer=new L(s),this.renderer.scene=this.scene,this.frameGraph=new T,this.lightmapper=null,e.lightmapper&&(this.lightmapper=new e.lightmapper(s,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this)),this._batcher=null,e.batchManager&&(this._batcher=new e.batchManager(s,this.root,this.scene),this.once("prerender",this._firstBatch,this)),this.keyboard=e.keyboard||null,this.mouse=e.mouse||null,this.touch=e.touch||null,this.gamepads=e.gamepads||null,this.elementInput=e.elementInput||null,this.elementInput&&(this.elementInput.app=this),this.xr=e.xr?new e.xr(this):null,this.elementInput&&this.elementInput.attachSelectEvents(),this._inTools=!1,this._skyboxAsset=null,this._scriptPrefix=e.scriptPrefix||"",this.enableBundles&&this.loader.addHandler("bundle",new E(this)),e.resourceHandlers.forEach((e=>{const s=new e(this);this.loader.addHandler(s.handlerType,s)})),this.systems=new z,e.componentSystems.forEach((e=>{this.systems.add(new e(this))})),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),"undefined"!=typeof document&&(void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1))),this.tick=ie(this)}static getApplication(e){return e?se._applications[e]:Z()}_initDefaultMaterial(){const e=new P;e.name="Default Material",e.shadingModel=v,I(this.graphicsDevice,e)}_initProgramLibrary(){const e=new D(this.graphicsDevice,new P);x(this.graphicsDevice,e)}get soundManager(){return this._soundManager}get batcher(){return this._batcher}get fillMode(){return this._fillMode}get resolutionMode(){return this._resolutionMode}configure(e,s){m.get(e,((e,t)=>{if(e)return void s(e);const i=t.application_properties,r=t.scenes,a=t.assets;this._parseApplicationProperties(i,(e=>{this._parseScenes(r),this._parseAssets(a),s(e||null)}))}))}preload(e){this.fire("preload:start");const s=this.assets.list({preload:!0}),t=new $(s.length);let i=!1;const r=()=>{this.graphicsDevice&&!i&&t.done()&&(i=!0,this.fire("preload:end"),e())},a=s.length;if(t.length){const e=e=>{t.inc(),this.fire("preload:progress",t.count/a),t.done()&&r()},i=(e,s)=>{t.inc(),this.fire("preload:progress",t.count/a),t.done()&&r()};for(let n=0;n<s.length;n++)s[n].loaded?(t.inc(),this.fire("preload:progress",t.count/a),t.done()&&r()):(s[n].once("load",e),s[n].once("error",i),this.assets.load(s[n]))}else r()}_preloadScripts(e,s){if(!N.legacy)return void s();this.systems.script.preloading=!0;const i=this._getScriptReferences(e),r=i.length,a=new $(r),n=/^http(s)?:\/\//;if(r){const e=(e,t)=>{e&&console.error(e),a.inc(),a.done()&&(this.systems.script.preloading=!1,s())};for(let s=0;s<r;s++){let r=i[s];!n.test(r.toLowerCase())&&this._scriptPrefix&&(r=t.join(this._scriptPrefix,i[s])),this.loader.load(r,"script",e)}}else this.systems.script.preloading=!1,s()}_parseApplicationProperties(e,s){if("number"==typeof e.maxAssetRetries&&e.maxAssetRetries>0&&this.loader.enableRetry(e.maxAssetRetries),e.useDevicePixelRatio||(e.useDevicePixelRatio=e.use_device_pixel_ratio),e.resolutionMode||(e.resolutionMode=e.resolution_mode),e.fillMode||(e.fillMode=e.fill_mode),this._width=e.width,this._height=e.height,e.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(e.resolutionMode,this._width,this._height),this.setCanvasFillMode(e.fillMode,this._width,this._height),e.layers&&e.layerOrder){const s=new C("application"),t={};for(const s in e.layers){const i=e.layers[s];i.id=parseInt(s,10),i.enabled=i.id!==w,t[s]=new k(i)}for(let i=0,r=e.layerOrder.length;i<r;i++){const r=e.layerOrder[i],a=t[r.layer];a&&(r.transparent?s.pushTransparent(a):s.pushOpaque(a),s.subLayerEnabled[i]=r.enabled)}this.scene.layers=s}if(e.batchGroups){const s=this.batcher;if(s)for(let t=0,i=e.batchGroups.length;t<i;t++){const i=e.batchGroups[t];s.addGroup(i.name,i.dynamic,i.maxAabbSize,i.id,i.layers)}}e.i18nAssets&&(this.i18n.assets=e.i18nAssets),this._loadLibraries(e.libraries,s)}_loadLibraries(e,s){const i=e.length;let r=i;const a=/^http(s)?:\/\//;if(i){const n=(e,t)=>{r--,e?s(e):0===r&&(this.onLibrariesLoaded(),s(null))};for(let s=0;s<i;++s){let i=e[s];!a.test(i.toLowerCase())&&this._scriptPrefix&&(i=t.join(this._scriptPrefix,i)),this.loader.load(i,"script",n)}}else this.onLibrariesLoaded(),s(null)}_parseScenes(e){if(e)for(let s=0;s<e.length;s++)this.scenes.add(e[s].name,e[s].url)}_parseAssets(e){const s=[],t={},i={};if(N.legacy){if(this.enableBundles)for(const t in e)"bundle"===e[t].type&&(i[t]=!0,s.push(e[t]));for(const t in e)i[t]||s.push(e[t])}else{for(let i=0;i<this.scriptsOrder.length;i++){const r=this.scriptsOrder[i];e[r]&&(t[r]=!0,s.push(e[r]))}if(this.enableBundles)for(const t in e)"bundle"===e[t].type&&(i[t]=!0,s.push(e[t]));for(const r in e)t[r]||i[r]||s.push(e[r])}for(let e=0;e<s.length;e++){const t=s[e],i=new F(t.name,t.type,t.file,t.data);if(i.id=parseInt(t.id,10),i.preload=!!t.preload&&t.preload,i.loaded="script"===t.type&&t.data&&t.data.loadingType>0,i.tags.add(t.tags),t.i18n)for(const e in t.i18n)i.addLocalizedAssetId(e,t.i18n[e]);this.assets.add(i)}}_getScriptReferences(e){let s=[];e.settings.priority_scripts&&(s=e.settings.priority_scripts);const t=[],i={};for(let e=0;e<s.length;e++)t.push(s[e]),i[s[e]]=!0;const r=e.entities;for(const e in r){if(!r[e].components.script)continue;const s=r[e].components.script.scripts;for(let e=0;e<s.length;e++)i[s[e].url]||(t.push(s[e].url),i[s[e].url]=!0)}return t}start(){this.frame=0,this.fire("start",{timestamp:s(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),this.systems.fire("initialize",this.root),this.fire("initialize"),this.systems.fire("postInitialize",this.root),this.systems.fire("postPostInitialize",this.root),this.fire("postinitialize"),this.tick()}inputUpdate(e){this.controller&&this.controller.update(e),this.mouse&&this.mouse.update(),this.keyboard&&this.keyboard.update(),this.gamepads&&this.gamepads.update()}update(e){this.frame++,this.graphicsDevice.updateClientRect(),N.legacy&&this.systems.fire("fixedUpdate",1/60),this.systems.fire(this._inTools?"toolsUpdate":"update",e),this.systems.fire("animationUpdate",e),this.systems.fire("postUpdate",e),this.fire("update",e),this.inputUpdate(e)}render(){this.fire("prerender"),this.root.syncHierarchy(),this._batcher&&this._batcher.updateAll(),this.renderComposition(this.scene.layers),this.fire("postrender")}renderComposition(e){this.renderer.buildFrameGraph(this.frameGraph,e),this.frameGraph.render()}_fillFrameStatsBasic(e,s,t){const i=this.stats.frame;i.dt=s,i.ms=t,e>i._timeToCountFrames?(i.fps=i._fpsAccum,i._fpsAccum=0,i._timeToCountFrames=e+1e3):i._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0}_fillFrameStats(){let e=this.stats.frame;e.cameras=this.renderer._camerasRendered,e.materials=this.renderer._materialSwitches,e.shaders=this.graphicsDevice._shaderSwitchesPerFrame,e.shadowMapUpdates=this.renderer._shadowMapUpdates,e.shadowMapTime=this.renderer._shadowMapTime,e.depthMapTime=this.renderer._depthMapTime,e.forwardTime=this.renderer._forwardTime;const s=this.graphicsDevice._primsPerFrame;e.triangles=s[d]/3+Math.max(s[l]-2,0)+Math.max(s[c]-2,0),e.cullTime=this.renderer._cullTime,e.sortTime=this.renderer._sortTime,e.skinTime=this.renderer._skinTime,e.morphTime=this.renderer._morphTime,e.lightClusters=this.renderer._lightClusters,e.lightClustersTime=this.renderer._lightClustersTime,e.otherPrimitives=0;for(let t=0;t<s.length;t++)t<d&&(e.otherPrimitives+=s[t]),s[t]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,e=this.stats.drawCalls,e.forward=this.renderer._forwardDrawCalls,e.culled=this.renderer._numDrawCallsCulled,e.depth=0,e.shadow=this.renderer._shadowDrawCalls,e.skinned=this.renderer._skinDrawCalls,e.immediate=0,e.instanced=0,e.removedByInstancing=0,e.misc=e.total-(e.forward+e.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,e=this.stats.particles,e.updatesPerFrame=e._updatesPerFrame,e.frameTime=e._frameTime,e._updatesPerFrame=0,e._frameTime=0}setCanvasFillMode(e,s,t){this._fillMode=e,this.resizeCanvas(s,t)}setCanvasResolution(e,s,t){this._resolutionMode=e,e===J&&void 0===s&&(s=this.graphicsDevice.canvas.clientWidth,t=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(s,t)}isHidden(){return document[this._hiddenAttr]}onVisibilityChange(){this.isHidden()?this._soundManager&&this._soundManager.suspend():this._soundManager&&this._soundManager.resume()}resizeCanvas(e,s){if(!this._allowResize)return;if(this.xr&&this.xr.session)return;const t=window.innerWidth,i=window.innerHeight;if(this._fillMode===V){const r=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;r>t/i?s=(e=t)/r:e=(s=i)*r}else this._fillMode===K&&(e=t,s=i);return this.graphicsDevice.canvas.style.width=e+"px",this.graphicsDevice.canvas.style.height=s+"px",this.updateCanvasSize(),{width:e,height:s}}updateCanvasSize(){var e;if(this._allowResize&&(null==(e=this.xr)||!e.active)&&this._resolutionMode===J){const e=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(e.clientWidth,e.clientHeight)}}onLibrariesLoaded(){this._librariesLoaded=!0,this.systems.rigidbody&&this.systems.rigidbody.onLibraryLoaded()}applySceneSettings(e){let s;if(this.systems.rigidbody&&"undefined"!=typeof Ammo){const s=e.physics.gravity;this.systems.rigidbody.gravity.set(s[0],s[1],s[2])}this.scene.applySettings(e),e.render.hasOwnProperty("skybox")&&(e.render.skybox?(s=this.assets.get(e.render.skybox),s?this.setSkybox(s):this.assets.once("add:"+e.render.skybox,this.setSkybox,this)):this.setSkybox(null))}setAreaLightLuts(e,s){e&&s&&M.set(this.graphicsDevice,e,s)}setSkybox(e){if(e!==this._skyboxAsset){const s=()=>{this.setSkybox(null)},t=()=>{this.scene.setSkybox(this._skyboxAsset?this._skyboxAsset.resources:null)};this._skyboxAsset&&(this.assets.off("load:"+this._skyboxAsset.id,t,this),this.assets.off("remove:"+this._skyboxAsset.id,s,this),this._skyboxAsset.off("change",t,this)),this._skyboxAsset=e,this._skyboxAsset&&(this.assets.on("load:"+this._skyboxAsset.id,t,this),this.assets.once("remove:"+this._skyboxAsset.id,s,this),this._skyboxAsset.on("change",t,this),0!==this.scene.skyboxMip||this._skyboxAsset.loadFaces||(this._skyboxAsset.loadFaces=!0),this.assets.load(this._skyboxAsset)),t()}}_firstBake(){var e;null==(e=this.lightmapper)||e.bake(null,this.scene.lightmapMode)}_firstBatch(){var e;null==(e=this.batcher)||e.generate()}_processTimestamp(e){return e}drawLine(e,s,t,i,r){this.scene.drawLine(e,s,t,i,r)}drawLines(e,s,t=!0,i=this.scene.defaultDrawLayer){this.scene.drawLines(e,s,t,i)}drawLineArrays(e,s,t=!0,i=this.scene.defaultDrawLayer){this.scene.drawLineArrays(e,s,t,i)}drawWireSphere(e,s,t=r.WHITE,i=20,a=!0,n=this.scene.defaultDrawLayer){this.scene.immediate.drawWireSphere(e,s,t,i,a,n)}drawWireAlignedBox(e,s,t=r.WHITE,i=!0,a=this.scene.defaultDrawLayer){this.scene.immediate.drawWireAlignedBox(e,s,t,i,a)}drawMeshInstance(e,s=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(null,null,null,e,s)}drawMesh(e,s,t,i=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(s,t,e,null,i)}drawQuad(e,s,t=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(s,e,this.scene.immediate.getQuadMesh(),null,t)}drawTexture(e,s,t,i,r,n,d=this.scene.defaultDrawLayer){const l=new a;l.setTRS(new o(e,s,0),h.IDENTITY,new o(t,i,0)),n||((n=new S).setParameter("colorMap",r),n.shader=this.scene.immediate.getTextureShader(),n.update()),this.drawQuad(l,n,d)}drawDepthTexture(e,s,t,i,r=this.scene.defaultDrawLayer){const a=new S;a.shader=this.scene.immediate.getDepthTextureShader(),a.update(),this.drawTexture(e,s,t,i,null,a,r)}destroy(){var e;if(this._inFrameUpdate)return void(this._destroyRequested=!0);const s=this.graphicsDevice.canvas.id;this.off("librariesloaded"),"undefined"!=typeof document&&(document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)),this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.controller&&(this.controller=null),this.systems.destroy(),this.scene.layers&&this.scene.layers.destroy();const t=this.assets.list();for(let e=0;e<t.length;e++)t[e].unload(),t[e].off();this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null;for(const e in this.loader.getHandler("script")._cache){const s=this.loader.getHandler("script")._cache[e],t=s.parentNode;t&&t.removeChild(s)}this.loader.getHandler("script")._cache={},this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=null,this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,null==(e=this.lightmapper)||e.destroy(),this.lightmapper=null,this._batcher&&(this._batcher.destroy(),this._batcher=null),this._entityIndex={},this.defaultLayerDepth.onPreRenderOpaque=null,this.defaultLayerDepth.onPostRenderOpaque=null,this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,null==this||this.xr.end(),null==this||this.xr.destroy(),this.renderer.destroy(),this.renderer=null,this.graphicsDevice.destroy(),this.graphicsDevice=null,this.tick=null,this.off(),this._soundManager&&(this._soundManager.destroy(),this._soundManager=null),N.app=null,se._applications[s]=null,Z()===this&&X(null)}getEntityFromIndex(e){return this._entityIndex[e]}_registerSceneImmediate(e){this.on("postrender",e.immediate.onPostRender,e.immediate)}}se._applications={};const te={},ie=function(t){const i=t;let r;return function(t,a){var h;if(!i.graphicsDevice)return;X(i),r&&(window.cancelAnimationFrame(r),r=null),ee=i;const o=i._processTimestamp(t)||s(),d=o-(i._time||o);let l=d/1e3;if(l=n.clamp(l,0,i.maxDeltaTime),l*=i.timeScale,i._time=o,r=null!=(h=i.xr)&&h.session?i.xr.session.requestAnimationFrame(i.tick):e.browser?window.requestAnimationFrame(i.tick):null,i.graphicsDevice.contextLost)return;i._fillFrameStatsBasic(o,l,d),i._inFrameUpdate=!0,i.fire("frameupdate",d);let c=!0;var p;a?(c=null==(p=i.xr)?void 0:p.update(a),i.graphicsDevice.defaultFramebuffer=a.session.renderState.baseLayer.framebuffer):i.graphicsDevice.defaultFramebuffer=null;c&&(i.update(l),i.fire("framerender"),(i.autoRender||i.renderNextFrame)&&(i.updateCanvasSize(),i.render(),i.renderNextFrame=!1),te.timestamp=s(),te.target=i,i.fire("frameend",te)),i._inFrameUpdate=!1,i._destroyRequested&&i.destroy()}};export{se as AppBase,ee as app};
